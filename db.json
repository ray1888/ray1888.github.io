{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/stun/source/css/index.styl","path":"css/index.styl","modified":0,"renderable":1},{"_id":"themes/stun/source/images/algolia.svg","path":"images/algolia.svg","modified":0,"renderable":1},{"_id":"themes/stun/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/stun/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/stun/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/stun/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/stun/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/stun/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/stun/source/images/loading.svg","path":"images/loading.svg","modified":0,"renderable":1},{"_id":"themes/stun/source/js/header.js","path":"js/header.js","modified":0,"renderable":1},{"_id":"themes/stun/source/js/scroll.js","path":"js/scroll.js","modified":0,"renderable":1},{"_id":"themes/stun/source/js/sidebar.js","path":"js/sidebar.js","modified":0,"renderable":1},{"_id":"themes/stun/source/js/stun-boot.js","path":"js/stun-boot.js","modified":0,"renderable":1},{"_id":"themes/stun/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/stun/source/images/icons/favicon-16x16.png","path":"images/icons/favicon-16x16.png","modified":0,"renderable":1},{"_id":"themes/stun/source/images/icons/favicon-32x32.png","path":"images/icons/favicon-32x32.png","modified":0,"renderable":1},{"_id":"themes/stun/source/images/icons/stun-logo.svg","path":"images/icons/stun-logo.svg","modified":0,"renderable":1},{"_id":"themes/stun/source/images/background.jpg","path":"images/background.jpg","modified":0,"renderable":1},{"_id":"source/images/favicon.ico","path":"images/favicon.ico","modified":0,"renderable":0},{"_id":"source/images/gdut.jpg","path":"images/gdut.jpg","modified":0,"renderable":0},{"_id":"source/images/profile.png","path":"images/profile.png","modified":0,"renderable":0},{"_id":"source/images/programmingebooks.png","path":"images/programmingebooks.png","modified":0,"renderable":0},{"_id":"source/images/sandstone.png","path":"images/sandstone.png","modified":0,"renderable":0},{"_id":"source/images/styleguide.png","path":"images/styleguide.png","modified":0,"renderable":0},{"_id":"source/images/zoom.jpg","path":"images/zoom.jpg","modified":0,"renderable":0},{"_id":"source/images/posts/Prometheus.png","path":"images/posts/Prometheus.png","modified":0,"renderable":0},{"_id":"source/images/posts/deploy-using-github-pages-and-travis.png","path":"images/posts/deploy-using-github-pages-and-travis.png","modified":0,"renderable":0},{"_id":"source/images/posts/devlopr-starter.png","path":"images/posts/devlopr-starter.png","modified":0,"renderable":0},{"_id":"source/images/posts/devlopr.png","path":"images/posts/devlopr.png","modified":0,"renderable":0},{"_id":"source/images/posts/distributed-db.jpg","path":"images/posts/distributed-db.jpg","modified":0,"renderable":0},{"_id":"source/images/posts/distributed-system.png","path":"images/posts/distributed-system.png","modified":0,"renderable":0},{"_id":"source/images/posts/docker.png","path":"images/posts/docker.png","modified":0,"renderable":0},{"_id":"source/images/posts/go.png","path":"images/posts/go.png","modified":0,"renderable":0},{"_id":"source/images/posts/hello.jpg","path":"images/posts/hello.jpg","modified":0,"renderable":0},{"_id":"source/images/posts/siteleaf.jpg","path":"images/posts/siteleaf.jpg","modified":0,"renderable":0},{"_id":"source/images/posts/sql.jfif","path":"images/posts/sql.jfif","modified":0,"renderable":0},{"_id":"source/images/posts/prometheus/DiscoverManager.png","path":"images/posts/prometheus/DiscoverManager.png","modified":0,"renderable":0},{"_id":"source/images/posts/siteleaf/1.png","path":"images/posts/siteleaf/1.png","modified":0,"renderable":0},{"_id":"source/images/posts/siteleaf/2.png","path":"images/posts/siteleaf/2.png","modified":0,"renderable":0},{"_id":"source/images/posts/siteleaf/3.png","path":"images/posts/siteleaf/3.png","modified":0,"renderable":0},{"_id":"source/images/posts/siteleaf/4.png","path":"images/posts/siteleaf/4.png","modified":0,"renderable":0},{"_id":"source/images/posts/siteleaf/5.png","path":"images/posts/siteleaf/5.png","modified":0,"renderable":0},{"_id":"source/images/posts/siteleaf/6.png","path":"images/posts/siteleaf/6.png","modified":0,"renderable":0},{"_id":"source/images/posts/siteleaf/8.png","path":"images/posts/siteleaf/8.png","modified":0,"renderable":0},{"_id":"source/images/posts/siteleaf/9.png","path":"images/posts/siteleaf/9.png","modified":0,"renderable":0}],"Cache":[{"_id":"source/_posts/hello-world.md","hash":"7d98d6592de80fdcd2949bd7401cec12afd98cdf","modified":1611195039720},{"_id":"themes/stun/.editorconfig","hash":"1ca001b8a7ed235eb9f5c21360b3a11eedb84ae7","modified":1611195879133},{"_id":"themes/stun/.commitlintrc.js","hash":"af8f006fbdfc6a1880605c7a35e63de300d6929b","modified":1611195879133},{"_id":"themes/stun/.cz-config.js","hash":"fbb89df58c60cf4f3827059d0574accc8407e1bb","modified":1611195879133},{"_id":"themes/stun/.eslintrc","hash":"1ba4f0ddd4bef04884c7fda6ef04f9d9697a62b4","modified":1611195879133},{"_id":"themes/stun/.gitignore","hash":"7745f04d70b1ea58b02d68dde999708836343c7a","modified":1611195879133},{"_id":"themes/stun/.prettierrc","hash":"4b6589404c509f4538daf6f3b8b3ee2ec37d2f4c","modified":1611195879133},{"_id":"themes/stun/CHANGELOG.md","hash":"28a248f28bbe27f6ca9234be2026d74dc7bf4387","modified":1611195879133},{"_id":"themes/stun/FAQ.md","hash":"df56d44b1297fe507d8b4edefb303629f4b23c67","modified":1611195879133},{"_id":"themes/stun/.stylintrc","hash":"3305c42a95c986341d7c7dd03ed9f37a42da343c","modified":1611195879133},{"_id":"themes/stun/LICENSE","hash":"c79ab3fe0ee8f2388376574dfe704b3df0c70a69","modified":1611195879133},{"_id":"themes/stun/README.md","hash":"b77f5b18bfe474178fee322ff6065f960f33c96d","modified":1611195879133},{"_id":"themes/stun/README_en-US.md","hash":"5e7bff4bcd02badcd3207379d353c5d1ea403a4f","modified":1611195879133},{"_id":"themes/stun/package.json","hash":"73b9d4773d487897e7c2bc28409771ff553044b6","modified":1611195879137},{"_id":"themes/stun/.github/FUNDING.yml","hash":"963cf7fb304865af888ad4bbb87a0f5991f3790f","modified":1611195879133},{"_id":"themes/stun/languages/en.yml","hash":"e1348852aa00d2d57f5215c83709f6428f8e8a71","modified":1611195879133},{"_id":"themes/stun/_config.yml","hash":"9862b4d55700dd208dd89f2a064ffbb8a4979a97","modified":1611201629087},{"_id":"themes/stun/languages/es.yml","hash":"e150c8a1f56ae9ed065611951aa124fb548577fc","modified":1611195879133},{"_id":"themes/stun/languages/zh-CN.yml","hash":"ef231652f77466527465788089ff91228d6eff54","modified":1611201565966},{"_id":"themes/stun/languages/zh-HK.yml","hash":"aef25f329cc05dbe8e38753fccd98d63c9fcd174","modified":1611195879133},{"_id":"themes/stun/layout/archive.pug","hash":"d45d078ae4196add83e21fcaed3ef168b237af90","modified":1611195879137},{"_id":"themes/stun/layout/_layout.pug","hash":"5052ee5040ae736d78ad208df7352be69b61b0d1","modified":1611195879133},{"_id":"themes/stun/layout/category.pug","hash":"24153408b2971542d177227f09e93da7754bf75e","modified":1611195879137},{"_id":"themes/stun/layout/index.pug","hash":"df40cf1f051fd29f0f51ace74e9f7394f6ea2ab7","modified":1611195879137},{"_id":"themes/stun/layout/page.pug","hash":"22ba5928bd9ae8c56b3242b7caa5fc3ec471b082","modified":1611195879137},{"_id":"themes/stun/layout/post.pug","hash":"a4d16dbb919df5d4ffdb5a1d0114a4e1c8c21197","modified":1611195879137},{"_id":"themes/stun/layout/tag.pug","hash":"46f956ad7e2aed879999ddf5e768d80c4bbe5b5f","modified":1611195879137},{"_id":"themes/stun/scripts/engine.js","hash":"a63a57c9206a77a79f93dbd86e86204447d7d904","modified":1611195879137},{"_id":"themes/stun/scripts/merge-config.js","hash":"bb914100129c5ca2d1a9e087fffd7bedcb6ae6a6","modified":1611195879137},{"_id":"themes/stun/.github/ISSUE_TEMPLATE/feature-request_en.md","hash":"af7175a0d0f7edfbfbeef3eeb949e20d1e41bf38","modified":1611195879133},{"_id":"themes/stun/.github/ISSUE_TEMPLATE/feature-request_zh.md","hash":"1ecd119a1f4c6fbe3886c885b7d13f1fcc048a5b","modified":1611195879133},{"_id":"themes/stun/.github/ISSUE_TEMPLATE/other_en.md","hash":"6b6afbfc66ee51624f7eeaeb5a1fc959e290e06d","modified":1611195879133},{"_id":"themes/stun/.github/ISSUE_TEMPLATE/other_zh.md","hash":"a9f7abd311731c21082fa5e553251f4704e555c5","modified":1611195879133},{"_id":"themes/stun/.github/ISSUE_TEMPLATE/bug-report_zh.md","hash":"0b42693e9577d3203473caa11ceaa9f64096a67c","modified":1611195879133},{"_id":"themes/stun/.github/workflows/files-shaking.yml","hash":"3593429efe2f5b196a44d185e810b226cef26714","modified":1611195879133},{"_id":"themes/stun/layout/_mixins/gallery.pug","hash":"3054e2c09bc205173c517fb1c36321f7c4c0db63","modified":1611195879133},{"_id":"themes/stun/.github/ISSUE_TEMPLATE/bug-report_en.md","hash":"70022617d944b410a21c28d2abafcfe0b2928f01","modified":1611195879133},{"_id":"themes/stun/layout/_mixins/menu-item.pug","hash":"93c4454e48a6f1456c29aeb9d1332be186b49d4f","modified":1611195879133},{"_id":"themes/stun/layout/_mixins/meta-item.pug","hash":"3d74dc8ba8651efd4a605e56a21e314678d04057","modified":1611195879133},{"_id":"themes/stun/layout/_partials/config.pug","hash":"4fb832652485161148ea957067c06d50ed11578b","modified":1611195879133},{"_id":"themes/stun/layout/_scripts/stun.pug","hash":"961554914427578b57ea3912d751d398f4eb381d","modified":1611195879137},{"_id":"themes/stun/layout/_mixins/timeline.pug","hash":"4e19a670f002d3c6bc740a2d6ef03964e6b59c09","modified":1611195879133},{"_id":"themes/stun/layout/_scripts/vendors.pug","hash":"62a6831d3b1d90d6c8335ce3402efc50e141eafb","modified":1611195879137},{"_id":"themes/stun/.github/workflows/codeql-analysis.yml","hash":"7a9d289addb10720f6b666157efe170d47774906","modified":1611195879133},{"_id":"themes/stun/scripts/filters/external-link.js","hash":"f5369becfd8cc6e43d6dc3595b1edbe014d9aa7c","modified":1611195879137},{"_id":"themes/stun/layout/_mixins/post-header.pug","hash":"9486d07e56acf7bcc5d691bef93c19e2e5c98022","modified":1611195879133},{"_id":"themes/stun/scripts/filters/lazyload.js","hash":"d5baf39faeff5368182be1f59fb598d023985cde","modified":1611195879137},{"_id":"themes/stun/scripts/filters/post-heading.js","hash":"6785e981bfcf87ca587bef36231be430bba2254d","modified":1611195879137},{"_id":"themes/stun/scripts/filters/image-setting.js","hash":"412318b6d189d5355dbcc52c9762072f7ecdaad4","modified":1611195879137},{"_id":"themes/stun/scripts/filters/wrap-table.js","hash":"888c9eaaddcdb9b88d07837a9091aa39ed3fe677","modified":1611195879137},{"_id":"themes/stun/scripts/filters/shake-file.js","hash":"159dff6e4f7020545c9b151108398cd383d613e2","modified":1611195879137},{"_id":"themes/stun/scripts/tags/note.js","hash":"b436593a56e3bab8dd59c71e73ac9efbc8fa29d4","modified":1611195879137},{"_id":"themes/stun/scripts/tags/table.js","hash":"177061e1bfb296981a101643f51a27ccc1469307","modified":1611195879137},{"_id":"themes/stun/source/css/index.styl","hash":"8a75ec81fb064b0da2f978a064cc5bec2395f27d","modified":1611195879141},{"_id":"themes/stun/scripts/tags/friends.js","hash":"c2fe1e8e128f464d772bcb7534efef54ad224310","modified":1611195879137},{"_id":"themes/stun/source/images/algolia.svg","hash":"90322f80db6ad0daf26ea3ec71dea6f691a8b2f1","modified":1611195879141},{"_id":"themes/stun/source/images/cc-by-nc-nd.svg","hash":"017ad912874686a982ebceae359299b8f2a492e2","modified":1611195879141},{"_id":"themes/stun/source/images/cc-by-nc.svg","hash":"4608189edbe7636dd651df65473298a3c5afb20d","modified":1611195879141},{"_id":"themes/stun/source/images/cc-by-nc-sa.svg","hash":"71d035c34219f924dbf1bf852166ee8fb58d2f24","modified":1611195879141},{"_id":"themes/stun/layout/_third-party/quicklink.pug","hash":"2bed65ed4d314dc587e2359e20ae099b46181ed5","modified":1611195879137},{"_id":"themes/stun/source/images/cc-by-nd.svg","hash":"20c66ae3c393903e6eab3bc8cf7c3be6d753f9f8","modified":1611195879141},{"_id":"themes/stun/source/images/cc-by.svg","hash":"77f74c241902447424207869c74cb9d9264bdced","modified":1611195879141},{"_id":"themes/stun/source/images/cc-by-sa.svg","hash":"0455a8857ba096925d4145a56e8d10537fccb378","modified":1611195879141},{"_id":"themes/stun/source/images/loading.svg","hash":"32a6e770d217ae6c0cf0f6beef3172f1b5b9a0a2","modified":1611195879141},{"_id":"themes/stun/source/js/scroll.js","hash":"8926ab87181a49c730ce5132518b608c54b8cdb1","modified":1611195879141},{"_id":"themes/stun/source/js/stun-boot.js","hash":"8358ac0d879c0ca340c52e4de606523c2a91e156","modified":1611195879141},{"_id":"themes/stun/source/js/sidebar.js","hash":"20adff7f54bcd8299d32690d41ebc7a4eb7a8728","modified":1611195879141},{"_id":"themes/stun/layout/_partials/analytics/busuanzi.pug","hash":"80d2f4f8706a96b367ac1e89f5b56ada4684d571","modified":1611195879133},{"_id":"themes/stun/source/js/header.js","hash":"63d407ee6f80114e220171ba829b79b28d420fe0","modified":1611195879141},{"_id":"themes/stun/layout/_partials/head/kill-old-ie.pug","hash":"427a95d02844f29e63c5e9f014ede3609aec1a5b","modified":1611195879133},{"_id":"themes/stun/layout/_partials/footer/footer.pug","hash":"9a8e56bcc504f251c13ee3d0d18a08142fb7ee43","modified":1611195879133},{"_id":"themes/stun/layout/_partials/post/post-list.pug","hash":"c049078009aa251fc76cd948837c7a5efdd39cb2","modified":1611195879133},{"_id":"themes/stun/layout/_partials/search/algolia.pug","hash":"61181bece0e27929fe00df5204fefd8dee31a354","modified":1611195879133},{"_id":"themes/stun/layout/_partials/search/assist-btns.pug","hash":"7e6dc0d975ccbe291116487b15277d27a391fb9a","modified":1611195879133},{"_id":"themes/stun/layout/_partials/header/header.pug","hash":"7ecbe18da15d3a52c56f69c542540291b6178763","modified":1611195879133},{"_id":"themes/stun/layout/_partials/search/index.pug","hash":"0f84aa013a96e7eb3bb25b87f20bab9b7ac55538","modified":1611195879133},{"_id":"themes/stun/layout/_partials/head/head.pug","hash":"c7909a6a50c7a76a6c1810b700a5d72bcb1e20c9","modified":1611195879133},{"_id":"themes/stun/layout/_partials/search/localsearch.pug","hash":"4d8e0bc33f92a603e0b2a5f4296af6bcc7cc31b8","modified":1611195879133},{"_id":"themes/stun/layout/_partials/sidebar/sidebar.pug","hash":"18173a2acf99db39748c392f2e669acd805b4090","modified":1611195879133},{"_id":"themes/stun/layout/_partials/widgets/back2top.pug","hash":"48b7fedeb472bd01fd1f3317359a10e83ca919e1","modified":1611195879133},{"_id":"themes/stun/layout/_partials/widgets/loading-bar.pug","hash":"6cda7866f9589c9ffc05ce4a3d7c33b706e70324","modified":1611195879133},{"_id":"themes/stun/layout/_partials/widgets/copyright.pug","hash":"0938c885697f6eb388b28ddbf88f5631d024fe73","modified":1611195879133},{"_id":"themes/stun/source/js/utils.js","hash":"b570eafe77e47d7701348f172a4dbaaba6fa8123","modified":1611195879141},{"_id":"themes/stun/layout/_partials/widgets/comments.pug","hash":"af1b16be74c7e1242e0f57986672dc73e93546e2","modified":1611195879133},{"_id":"themes/stun/layout/_partials/widgets/night-mode.pug","hash":"c7f9bd67cd231b9bd40a84123644e009ac8d8ef3","modified":1611195879133},{"_id":"themes/stun/layout/_third-party/pjax.pug","hash":"4a786459a8e6a4f378a9d834502f8b11aa66f185","modified":1611195879137},{"_id":"themes/stun/layout/_partials/widgets/share.pug","hash":"1bb3d25298b7ee6a28150aa286ed6b0ae42ead4f","modified":1611195879133},{"_id":"themes/stun/layout/_partials/widgets/reward.pug","hash":"c9081c1dcf0ca18df06d23638654d8f43b28d55c","modified":1611195879133},{"_id":"themes/stun/layout/_partials/widgets/sticky-top.pug","hash":"bf86b2f9f4b1471afb8b31965d3230f6088682ae","modified":1611195879133},{"_id":"themes/stun/layout/_partials/widgets/paginator.pug","hash":"b0045dcb9b151ee31f1db5b7d741f10ef3b74be0","modified":1611195879133},{"_id":"themes/stun/layout/_third-party/advertising/google-adsense.pug","hash":"e489020f1130976d3ec2245915ede6319d89b89c","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/advertising/index.pug","hash":"1285cd65a873f688ae3c51846c1284447f502adc","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/analytics/baidu-analytics.pug","hash":"f7300991a29dbe2e8091a588dfa8c65c3dee6302","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/analytics/busuanzi.pug","hash":"78a4fc9c9380e31536f5b500638f2d005accd361","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/analytics/index.pug","hash":"0d72f844bf9532b3be644c27b0af7cb4331fc46c","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/analytics/google-analytics.pug","hash":"4eef66fbb8a8ad55e0868cf4b77a6b7bca0e7f35","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/analytics/tencent-analytics.pug","hash":"f88fb0f085812db6023c30308ba3458da7742993","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/comments/disqus.pug","hash":"57bcbaac3d237d9168dd8f4b682f34351f11d250","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/comments/fbcomments.pug","hash":"fb651812c87dc5e2134d7fb7d8f98d4d4227f1f6","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/comments/gitalk.pug","hash":"c2a90e80c51b5b99e6804dbed5457a071b980bbd","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/comments/index.pug","hash":"bec4d9c8ea360637e7da3314fa987e33facd8071","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/comments/livere.pug","hash":"687f74a998519608944b40a41f3a98ccf4535139","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/comments/minivaline.pug","hash":"5584ade7dd19deca418373115bde9d563d37d826","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/comments/utterances.pug","hash":"6418baeb3aedcddb02a64bd89b26ac12e18551c8","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/math/katex.pug","hash":"345c59fe76a7c83b529328e5144d1036cb14f533","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/comments/valine.pug","hash":"b519a6948d6ef37c037385e3e3f9590c17f7ad62","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/comments/waline.pug","hash":"fd4c958b13777752f176556c7b109b7dede7cc68","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/math/index.pug","hash":"e952be6c736545e73c0e02f833f87a4f8c5a2582","modified":1611195879137},{"_id":"themes/stun/source/css/_common/index.styl","hash":"86057db6cb18263866d62a6669feee8752882398","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/math/mathjax.pug","hash":"72d51538cc85f01c8c64db74b9219ccaf334c9e9","modified":1611195879137},{"_id":"themes/stun/source/css/_common/responsive.styl","hash":"618c6005f1bc7c482fa37ae3ce15729a64044d9d","modified":1611195879137},{"_id":"themes/stun/source/css/_custom/index.styl","hash":"0d1adc70250941074c742f94f7801b3b43a7f1db","modified":1611195879137},{"_id":"themes/stun/source/css/_mixins/index.styl","hash":"f3060519f3acd05cb4b26bb5f6a5c6b857cb0d68","modified":1611195879137},{"_id":"themes/stun/source/css/_variables/index.styl","hash":"c81aac4285eb058026b255e31282d35f55a820ab","modified":1611195879141},{"_id":"themes/stun/source/images/icons/favicon-16x16.png","hash":"7bfd64eac26e17ea162f0c399a4a40164c26b412","modified":1611195879141},{"_id":"themes/stun/source/images/icons/favicon-32x32.png","hash":"02fead07726920400ede57ddfdbf071dd7203fd5","modified":1611195879141},{"_id":"themes/stun/source/images/icons/stun-logo.svg","hash":"069dc7590ad152373f1c346d892e32faa2bbdd87","modified":1611195879141},{"_id":"themes/stun/source/css/_common/components/index.styl","hash":"a54720db94121efd1a34ac88d344197c8206837e","modified":1611195879137},{"_id":"themes/stun/source/css/_common/outline/index.styl","hash":"467d4171c0690a95d40fbecea02e6b212b7c74f1","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/search/localsearch.pug","hash":"d98db7ed7e3e4c574212fa9d75adba681f3d0687","modified":1611195879137},{"_id":"themes/stun/source/css/_common/outline/macro.styl","hash":"13b96f239de15e1cfdc14d9c80e6959506556dd2","modified":1611195879137},{"_id":"themes/stun/source/css/_common/scaffolding/base.styl","hash":"4064a7e2c3f71d2ed72a47edd60e9be01af6c354","modified":1611195879137},{"_id":"themes/stun/source/css/_common/scaffolding/index.styl","hash":"e750f2dae9eb3385039ee018ff8001b0e6ec3b64","modified":1611195879137},{"_id":"themes/stun/source/css/_common/scaffolding/normalize.styl","hash":"c15a9616fddb267431416304d709185aeb3d45f5","modified":1611195879137},{"_id":"themes/stun/source/css/_common/scaffolding/utils.styl","hash":"7e62f34521ea539a25a101f25e1684e3a3ac4be8","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/analytics/busuanzi.styl","hash":"d196c88ea2e9b851e8d8f9c5a315dfc2929eb897","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/analytics/index.styl","hash":"339a43fd5ee97a77775b723118f6ab1af754fed4","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/footer/index.styl","hash":"14464841145cf3ecab66f1094653daa033c261eb","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/header/index.styl","hash":"904af0e73cdf0767ec781271856d7b5b63e043ef","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/highlight/diff.styl","hash":"056e70f6dfe45ec50427d7ab293d33361c9b956f","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/highlight/highlight.styl","hash":"bc0b01021a0d19b2c98f0c5c9fa1af96d67c1099","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/highlight/index.styl","hash":"85848179cbc78152d2521b601ac9f888dea4e255","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/highlight/theme.styl","hash":"dfc99b05302f8203040431e563c9f63d63da46de","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/pages/index.styl","hash":"463a4e6a92ec5f757e167fbeb171e4e92e83a822","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/search/algolia.pug","hash":"54233748e22ceae063f70ee49b44c4bd0a78f391","modified":1611195879137},{"_id":"themes/stun/layout/_third-party/search/index.pug","hash":"0f84aa013a96e7eb3bb25b87f20bab9b7ac55538","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/pages/timeline.styl","hash":"21e9c8def1613030f0927e2ce80f4ecc721f078e","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/pages/page.styl","hash":"df732e267dfd9f1bda6a8cf1ede3198a205925f9","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/plugins/friends.styl","hash":"bdb015173f8e5fa391fc4fb2b2a8d42787022c4b","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/plugins/index.styl","hash":"c35d0cf421c6669ee0458c2f0264dca05769c01d","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/plugins/note.styl","hash":"ae0ad9b44a87839d220792336478a9ae6db11c47","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/plugins/table.styl","hash":"98cacc91e42f5e45279e2174a90ab26171085e2f","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/post/index.styl","hash":"08aad11e329cda0550efef226e0c4d0bb4540454","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/post/post-list.styl","hash":"d0ed844e28533f832cbd9b3f09203d16936628f7","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/post/post.styl","hash":"8b7b22225b40d028efee689d3700a9796291cb8d","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/search/algolia.styl","hash":"fb62e4baf25a66e46c27783be5d79353ec394b44","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/search/common.styl","hash":"1939b7dfbcf557794a188fbf8fec4ef2b5afa437","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/search/index.styl","hash":"1990d2c2a9bfe8e09d656f0c2ae6cf0c9f7f5542","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/search/localsearch.styl","hash":"bf1ac1b8ee8c4daaa7e6b47eec097a176624e6d0","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/copy-button.styl","hash":"378961fa7c986e3313053814806902bf76204a93","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/back2top.styl","hash":"b3da5ea71a9947e781056d1bd7d42e4045fa2aca","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/sidebar/index.styl","hash":"02138647437f7e8ee8927cae225d41072d936bdc","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/comments.styl","hash":"41d229ac4fa02a3a8b46687ccbafa7a608008e2f","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/copyright.styl","hash":"1d28fc8f76f7164a306ed81a9ede21c0a2b0f7cd","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/ending.styl","hash":"63985ca9a3f6c481cc60207966fa1267de14d945","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/fancybox.styl","hash":"3d677c0323d77199bb9fbfefd65e97d8b882d7b3","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/font-icon.styl","hash":"bdda0953611378e93a8d6387cbdc93e1de4f7f0a","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/gallery-image.styl","hash":"99b1cc42f38816083f93233778b299422b6d8f32","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/index.styl","hash":"03ffdc55fd5fb64c3158bc222d0e8e9d7844686b","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/lazyload.styl","hash":"eced96235f0ff5dc6a8fd068d4ed05934a29b430","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/loading-bar.styl","hash":"9f23e8762d01fb4a3cbf5e786fdead2926849e8a","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/night-mode.styl","hash":"9caeef13a913aba38976f082e1f0ca191bffc64e","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/paginator.styl","hash":"71ddb6a1e9664a4fde04a0ce143b8786ba6e0089","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/reward.styl","hash":"de1130ec3765879884cbdc77a15b458da6e37bcc","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/share.styl","hash":"fe32e3434107d92cefd7aacfdcef526a93c4b865","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/sticky-top.styl","hash":"f0e37944168a74a64b18dc54c6fde2308e4bf023","modified":1611195879137},{"_id":"themes/stun/source/css/_common/components/widgets/zoom-image.styl","hash":"40f832a199320642debabe32910c1168e3c6e40c","modified":1611195879137},{"_id":"themes/stun/package-lock.json","hash":"1da56d61e769a1f6d47444631d3ff29aecbf569b","modified":1611195879137},{"_id":"source/categories/index.md","hash":"ccd50c0021343ed02de529105275dad022f9f8d0","modified":1611200958283},{"_id":"source/tags/index.md","hash":"d7b0d8c4c7bb7ce8c8298fcba3cf2ae22f168066","modified":1611197601625},{"_id":"source/pics/background.jpg","hash":"d6e5f05e371fbd474d6d2183485c556c2aa52842","modified":1611197848489},{"_id":"themes/stun/source/images/background.jpg","hash":"d6e5f05e371fbd474d6d2183485c556c2aa52842","modified":1611197848489},{"_id":"public/categories/index.html","hash":"a1c7bc94e425f41d136ba9bcbf1ab1e858c6baa2","modified":1611200509055},{"_id":"public/tags/index.html","hash":"c4f9071dba02fee1923dbd9b4ea758377a7f1475","modified":1611200509055},{"_id":"public/2021/01/21/hello-world/index.html","hash":"8c74a26033fefb9797f280527f9fee6eed70478e","modified":1611200509055},{"_id":"public/archives/index.html","hash":"07fad6332542789a48d4e9b0051a1f4f61e91349","modified":1611200509055},{"_id":"public/archives/2021/index.html","hash":"464b3d51a5aec9707ca583932466345897ed7e25","modified":1611200509055},{"_id":"public/archives/2021/01/index.html","hash":"838f417e0de41d07e1df50c51ed1d338306f762c","modified":1611200509055},{"_id":"public/index.html","hash":"f057d1d93906f928792344d07554bc167fca6f16","modified":1611200509055},{"_id":"public/images/algolia.svg","hash":"90322f80db6ad0daf26ea3ec71dea6f691a8b2f1","modified":1611200509055},{"_id":"public/images/cc-by-nc-nd.svg","hash":"017ad912874686a982ebceae359299b8f2a492e2","modified":1611200509055},{"_id":"public/images/cc-by-nc-sa.svg","hash":"71d035c34219f924dbf1bf852166ee8fb58d2f24","modified":1611200509055},{"_id":"public/images/cc-by-nc.svg","hash":"4608189edbe7636dd651df65473298a3c5afb20d","modified":1611200509055},{"_id":"public/images/cc-by-nd.svg","hash":"20c66ae3c393903e6eab3bc8cf7c3be6d753f9f8","modified":1611200509055},{"_id":"public/images/cc-by-sa.svg","hash":"0455a8857ba096925d4145a56e8d10537fccb378","modified":1611200509055},{"_id":"public/images/cc-by.svg","hash":"77f74c241902447424207869c74cb9d9264bdced","modified":1611200509055},{"_id":"public/images/loading.svg","hash":"32a6e770d217ae6c0cf0f6beef3172f1b5b9a0a2","modified":1611200509055},{"_id":"public/images/icons/favicon-16x16.png","hash":"7bfd64eac26e17ea162f0c399a4a40164c26b412","modified":1611200509055},{"_id":"public/images/icons/favicon-32x32.png","hash":"02fead07726920400ede57ddfdbf071dd7203fd5","modified":1611200509055},{"_id":"public/images/icons/stun-logo.svg","hash":"069dc7590ad152373f1c346d892e32faa2bbdd87","modified":1611200509055},{"_id":"public/js/header.js","hash":"63d407ee6f80114e220171ba829b79b28d420fe0","modified":1611200509055},{"_id":"public/js/scroll.js","hash":"8926ab87181a49c730ce5132518b608c54b8cdb1","modified":1611200509055},{"_id":"public/js/sidebar.js","hash":"20adff7f54bcd8299d32690d41ebc7a4eb7a8728","modified":1611200509055},{"_id":"public/js/stun-boot.js","hash":"8358ac0d879c0ca340c52e4de606523c2a91e156","modified":1611200509055},{"_id":"public/css/index.css","hash":"4e00e962943eb85f788cd779eb26ea96813132fb","modified":1611200509055},{"_id":"public/js/utils.js","hash":"b570eafe77e47d7701348f172a4dbaaba6fa8123","modified":1611200509055},{"_id":"public/images/background.jpg","hash":"d6e5f05e371fbd474d6d2183485c556c2aa52842","modified":1611200509055},{"_id":"source/images/favicon.ico","hash":"bc2865e9aa14213954a065a601068fca82e30e48","modified":1611209774298},{"_id":"source/_posts/raft-lab-2.md","hash":"dcb48d1ca95ead3354b92aae1bd81a7a920885bd","modified":1611214096144},{"_id":"source/images/gdut.jpg","hash":"2a1b444969cd4ea3542c7765667691ede8cb89d4","modified":1611209774446},{"_id":"source/_posts/intro-distributed-system.md","hash":"c61f2a1a5aec392a6826648b8493592bee654147","modified":1611214054188},{"_id":"source/images/profile.png","hash":"24ca9409baced46858ea8a6ace5e4df1e56fab50","modified":1611209774562},{"_id":"source/images/sandstone.png","hash":"d9376295a520b26f3fffcad510d712fb55b4c0aa","modified":1611209774849},{"_id":"source/_posts/intro-distributed-system/SchdulerTimeJump.png","hash":"96bf07ff85553f0488994840d42abeee01b60ff7","modified":1611210290568},{"_id":"source/_posts/intro-distributed-system/TimeJump.png","hash":"06b9f53d7f1de9513ebc82f966da61f8c3245945","modified":1611210159454},{"_id":"source/images/posts/GoSlice.png","hash":"4479fa57bd48c6b5416534c3fd47c70ab1f5cdf0","modified":1611209764955},{"_id":"source/images/posts/Lab3-Process.png","hash":"ae7f4c8dfb423391ad0a308c67f7c53200cc55b1","modified":1611209764955},{"_id":"source/images/posts/GoSliceExtend.png","hash":"775b4081f260a70834ec1a3dfe95df1b3836c8ee","modified":1611209764955},{"_id":"source/images/posts/Prometheus.png","hash":"0506d03706999d9ef6aa1eac1cd6aa38e64481d2","modified":1611209764955},{"_id":"source/images/posts/RaftStateMachine.png","hash":"70b9c110053df72419c3b49b9af9dd0756a6746e","modified":1611209764959},{"_id":"source/images/posts/distributed-system.png","hash":"a8d43e346d395b6b3c821397b243b02269b5465b","modified":1611209764959},{"_id":"source/images/posts/docker.png","hash":"fa387d66e00872926990aeee452d8f4ed27dabf1","modified":1611209764959},{"_id":"source/images/posts/distributed-db.jpg","hash":"d12869dd81ffa87b28edf9ea658adda8c683925a","modified":1611209764959},{"_id":"source/images/posts/lab4.png","hash":"cd009a7990265f919125c0215a60c2c15da1ec88","modified":1611209764959},{"_id":"source/images/posts/go.png","hash":"700cd88adaaa4c83be5580dad2edea8a64779551","modified":1611209764959},{"_id":"source/images/posts/more-detail-line.png","hash":"72f5da21dcf6e130fcf2244d3e19a756f82accb7","modified":1611209764963},{"_id":"source/images/posts/sql.jfif","hash":"2af4d52a366d09c72de7edd73bb0943d26697bde","modified":1611209764963},{"_id":"source/images/posts/prometheus/ScrapeModule.png","hash":"2f5e7b38d366dd450f7c722887f3d7ed2d592bc3","modified":1611209764963},{"_id":"source/images/posts/prometheus/DiscoverManager.png","hash":"a373230ea1eff40b760eefd994f389ed079f5924","modified":1611209764963},{"_id":"source/images/posts/siteleaf/4.png","hash":"aee718d91c1957564223454555708230e193dfd8","modified":1611209764963},{"_id":"source/images/posts/siteleaf/1.png","hash":"2914adca89d0679239e50045f69176b4ed71d75a","modified":1611209764963},{"_id":"source/images/posts/siteleaf/2.png","hash":"705e3e4bfc44a38fcc1e86e3ae02e59d73855c84","modified":1611209764963},{"_id":"source/images/posts/siteleaf/3.png","hash":"ba54eaeab0f941bde9017e742fc434469aa0d22a","modified":1611209764963},{"_id":"source/images/posts/sqlJoin/FULL_OUTER_JOIN.png","hash":"328ffe185f047de564ee058df5782e0ac4d7e288","modified":1611209764963},{"_id":"source/images/posts/sqlJoin/INNER_JOIN.png","hash":"4855ad7e617ff7bd5d50661933f11397e98ead33","modified":1611209764963},{"_id":"source/images/posts/sqlJoin/LEFT_EXCLUDING_JOIN.png","hash":"d8fbfb2ff1f3f7edcf7eb151d004063b64672593","modified":1611209764967},{"_id":"source/images/posts/siteleaf/5.png","hash":"cce46cc1dc0036a3b8b676c690a9a47d1482f5c1","modified":1611209764963},{"_id":"source/images/posts/sqlJoin/LEFT_JOIN.png","hash":"6bebcdbb03998cee42b0eb8796366324937899c1","modified":1611209764967},{"_id":"source/images/posts/sqlJoin/OUTER_EXCLUDING_JOIN.png","hash":"80bfd5ad46985693297d43a9c199a8fa7149caa9","modified":1611209764967},{"_id":"source/images/posts/sqlJoin/RIGHT_EXCLUDING_JOIN.png","hash":"d25f73221c620d82f62519dacd7b826d7fa6ec7b","modified":1611209764967},{"_id":"source/images/posts/siteleaf/8.png","hash":"82ec6fb7698807e6a156c6c9b64c391bc7dbecc4","modified":1611209764963},{"_id":"source/images/posts/sqlJoin/RIGHT_JOIN.png","hash":"9508b89fabef50db34cd895df23e8dfca1f32e55","modified":1611209764967},{"_id":"source/images/posts/sqlPost/Union-1.png","hash":"a0b8d009947052d2860a5bfe38bea6ce2ddd319b","modified":1611209764967},{"_id":"source/images/posts/sqlPost/Union-2.png","hash":"f789f29d1f6499fdab82e0337f5c65827353d781","modified":1611209764967},{"_id":"source/images/posts/sqlPost/Union-3.png","hash":"b92a5c84b769dca861306b8533b90a220e3fec3e","modified":1611209764967},{"_id":"source/_posts/distribute-system-consensus.md","hash":"ba90ffad2d8bf94c4b80bccfd38768b633207602","modified":1611214055444},{"_id":"source/_posts/intro-distributed-system/lockingproblem.png","hash":"fbb0f4ff829fbf4e7efd142690838d7c0ebeea5b","modified":1611210326067},{"_id":"source/images/posts/RaftProcess.png","hash":"e0ba0d2b3bb78cb49e1a925c6f6d39810c6919a4","modified":1611209764955},{"_id":"source/images/posts/deploy-using-github-pages-and-travis.png","hash":"55cb8ef319aa7efa31bf54faab1f7018099fe8be","modified":1611209764959},{"_id":"source/images/posts/devlopr-starter.png","hash":"a111df6ea8403c12b4855d0f105d93b43897084f","modified":1611209764959},{"_id":"source/images/posts/generate-line.png","hash":"af91ca7e6f039d4f2275074b90b2a03a75ff8de3","modified":1611209764959},{"_id":"source/images/posts/hello.jpg","hash":"a704aa62155f81ea564f25b7c936bab812a96bdf","modified":1611209764959},{"_id":"source/images/posts/siteleaf.jpg","hash":"03af20db7719e4f3349754a87ae14e65bcfdb61b","modified":1611209764963},{"_id":"source/images/posts/siteleaf/9.png","hash":"75846cd0289eb17778e9abea0b2a9cd580296738","modified":1611209764963},{"_id":"source/images/posts/siteleaf/6.png","hash":"fa55614cca7f2977f82a90b069afa4e17b4ede5d","modified":1611209764963},{"_id":"source/_posts/intro-distributed-system/Time&EventMissmatch.png","hash":"3c475b8773138ddc1860c09f4dab36da63a600a9","modified":1611210249156},{"_id":"source/_posts/intro-distributed-system/lockingproblem2.png","hash":"1e26a196fc0d38387a04bfca2f72e232494ba5df","modified":1611210326270},{"_id":"source/images/posts/LamportTimestamp.png","hash":"cd9167f36d443923340bc6696f2b2e9451845f54","modified":1611209764955},{"_id":"source/images/posts/sqlJoin/Visual_SQL_JOINS_orig.jpg","hash":"680a869474697bae045105b4ea3fb7db14cbdce9","modified":1611209764967},{"_id":"source/images/zoom.jpg","hash":"9990a9c0a92cc394e8ca19b12f57bfbaf3be875b","modified":1611209775084},{"_id":"source/images/posts/devlopr.png","hash":"a97e9f2070caed1fde9c0f3918f6e475bfa75252","modified":1611209764959},{"_id":"source/images/posts/line-final.png","hash":"b9d5a320acd4afd4bde5ff371d39083ec1d42e27","modified":1611209764959},{"_id":"source/images/posts/quroum-fail.png","hash":"a232d6ebba1f33265a1032cb348637d664f34e2f","modified":1611209764963},{"_id":"source/images/styleguide.png","hash":"c1a26070904f41146df18ce223ecc3f3df4a12d6","modified":1611209774970},{"_id":"source/images/posts/non-linearized-example.png","hash":"aa4ad4b7808ba88b228868f8c193cad6c965048d","modified":1611209764963},{"_id":"source/images/programmingebooks.png","hash":"7037191f871a1b8660268927c5beb259274e57ce","modified":1611209774727},{"_id":"source/_posts/effective-go.md","hash":"716d8adb324d5e00e9ebdc76c253dc34968cb1ee","modified":1611213125053},{"_id":"source/_posts/go-slice.md","hash":"9b1c481ead84a9f2722ee23020cd4bc97a579e6a","modified":1611213135553},{"_id":"source/_posts/golang-sync-map.md","hash":"20988a5e14c5170f555391ad14706763dcc1e03e","modified":1611213119301},{"_id":"source/_posts/mit-6824.md","hash":"f71721aa48210cb44175e141d5960e26b2ca35b0","modified":1611210733007},{"_id":"source/_posts/prometheus-scrape.md","hash":"65481b647c9b4aa790e9471bcb9590bbe1619735","modified":1611212918213},{"_id":"source/_posts/prometheus-service-discovery.md","hash":"e5ffc35bc404edcae5aebf5a492dd10a641fc4d1","modified":1611213015109},{"_id":"source/_posts/raft-lab-3.md","hash":"0612c0d26f0ba261ef27c0100f5360fa4571cdea","modified":1611214052636},{"_id":"source/_posts/raft-lab-4.md","hash":"8a4cb3ce69d04296302a8dc1fe27f7f701e40130","modified":1611214108088},{"_id":"source/_posts/sql-revise.md","hash":"f8d9b9ab0ab61c13616dc9caaae26f1138a59330","modified":1611212506844},{"_id":"source/draft/docker.md","hash":"f8197dccf3a24f24087cfb426a5685575166ce91","modified":1611213188981},{"_id":"source/draft/dp.md","hash":"1bf9b724052baa79ccc10780c335bc332eb3b280","modified":1611213169145},{"_id":"source/draft/mst.md","hash":"0a48be713fe8780386a9fac5239505686d7cf86e","modified":1611213177413},{"_id":"source/_posts/distribute-system-consensus/more-detail-line.png","hash":"72f5da21dcf6e130fcf2244d3e19a756f82accb7","modified":1611211012089},{"_id":"source/_posts/go-slice/GoSlice.png","hash":"4479fa57bd48c6b5416534c3fd47c70ab1f5cdf0","modified":1611212029689},{"_id":"source/_posts/go-slice/GoSliceExtend.png","hash":"775b4081f260a70834ec1a3dfe95df1b3836c8ee","modified":1611212029848},{"_id":"source/_posts/prometheus-scrape/ScrapeModule.png","hash":"2f5e7b38d366dd450f7c722887f3d7ed2d592bc3","modified":1611212884698},{"_id":"source/_posts/raft-lab-2/RaftStateMachine.png","hash":"70b9c110053df72419c3b49b9af9dd0756a6746e","modified":1611211201891},{"_id":"source/_posts/raft-lab-3/Lab3-Process.png","hash":"ae7f4c8dfb423391ad0a308c67f7c53200cc55b1","modified":1611211724159},{"_id":"source/_posts/raft-lab-4/lab4.png","hash":"cd009a7990265f919125c0215a60c2c15da1ec88","modified":1611211792204},{"_id":"source/_posts/sql-revise/FULL_OUTER_JOIN.png","hash":"328ffe185f047de564ee058df5782e0ac4d7e288","modified":1611212186805},{"_id":"source/_posts/sql-revise/INNER_JOIN.png","hash":"4855ad7e617ff7bd5d50661933f11397e98ead33","modified":1611212186616},{"_id":"source/_posts/sql-revise/LEFT_EXCLUDING_JOIN.png","hash":"d8fbfb2ff1f3f7edcf7eb151d004063b64672593","modified":1611212186419},{"_id":"source/_posts/sql-revise/LEFT_JOIN.png","hash":"6bebcdbb03998cee42b0eb8796366324937899c1","modified":1611212186286},{"_id":"source/_posts/sql-revise/OUTER_EXCLUDING_JOIN.png","hash":"80bfd5ad46985693297d43a9c199a8fa7149caa9","modified":1611212186026},{"_id":"source/_posts/sql-revise/RIGHT_EXCLUDING_JOIN.png","hash":"d25f73221c620d82f62519dacd7b826d7fa6ec7b","modified":1611212185695},{"_id":"source/_posts/sql-revise/RIGHT_JOIN.png","hash":"9508b89fabef50db34cd895df23e8dfca1f32e55","modified":1611212185406},{"_id":"source/_posts/sql-revise/Union-1.png","hash":"a0b8d009947052d2860a5bfe38bea6ce2ddd319b","modified":1611212171338},{"_id":"source/_posts/sql-revise/Union-2.png","hash":"f789f29d1f6499fdab82e0337f5c65827353d781","modified":1611212171225},{"_id":"source/_posts/sql-revise/Union-3.png","hash":"b92a5c84b769dca861306b8533b90a220e3fec3e","modified":1611212171033},{"_id":"source/_posts/distribute-system-consensus/generate-line.png","hash":"af91ca7e6f039d4f2275074b90b2a03a75ff8de3","modified":1611210997155},{"_id":"source/_posts/raft-lab-2/RaftProcess.png","hash":"e0ba0d2b3bb78cb49e1a925c6f6d39810c6919a4","modified":1611211201686},{"_id":"source/_posts/distribute-system-consensus/LamportTimestamp.png","hash":"cd9167f36d443923340bc6696f2b2e9451845f54","modified":1611210834129},{"_id":"source/_posts/distribute-system-consensus/line-final.png","hash":"b9d5a320acd4afd4bde5ff371d39083ec1d42e27","modified":1611210962261},{"_id":"source/_posts/sql-revise/Visual_SQL_JOINS_orig.jpg","hash":"680a869474697bae045105b4ea3fb7db14cbdce9","modified":1611212185259},{"_id":"source/_posts/distribute-system-consensus/quroum-fail.png","hash":"a232d6ebba1f33265a1032cb348637d664f34e2f","modified":1611210902828},{"_id":"source/_posts/distribute-system-consensus/non-linearized-example.png","hash":"aa4ad4b7808ba88b228868f8c193cad6c965048d","modified":1611211049907},{"_id":"source/_posts/_posts/golang-sync-map.md","hash":"20988a5e14c5170f555391ad14706763dcc1e03e","modified":1611283639011},{"_id":"source/_posts/_posts/go-slice.md","hash":"9b1c481ead84a9f2722ee23020cd4bc97a579e6a","modified":1611283639011},{"_id":"source/_posts/_posts/mit-6824.md","hash":"f71721aa48210cb44175e141d5960e26b2ca35b0","modified":1611283639015},{"_id":"source/_posts/_posts/effective-go.md","hash":"716d8adb324d5e00e9ebdc76c253dc34968cb1ee","modified":1611283639011},{"_id":"source/_posts/_posts/prometheus-scrape.md","hash":"65481b647c9b4aa790e9471bcb9590bbe1619735","modified":1611283639015},{"_id":"source/_posts/_posts/raft-lab-2.md","hash":"dcb48d1ca95ead3354b92aae1bd81a7a920885bd","modified":1611283639015},{"_id":"source/_posts/_posts/prometheus-service-discovery.md","hash":"e5ffc35bc404edcae5aebf5a492dd10a641fc4d1","modified":1611283639015},{"_id":"source/_posts/_posts/intro-distributed-system.md","hash":"c61f2a1a5aec392a6826648b8493592bee654147","modified":1611283639011},{"_id":"source/_posts/_posts/raft-lab-3.md","hash":"0612c0d26f0ba261ef27c0100f5360fa4571cdea","modified":1611283639019},{"_id":"source/_posts/categories/index.md","hash":"ccd50c0021343ed02de529105275dad022f9f8d0","modified":1611283639019},{"_id":"source/_posts/images/favicon.ico","hash":"bc2865e9aa14213954a065a601068fca82e30e48","modified":1611283639019},{"_id":"source/_posts/_posts/raft-lab-4.md","hash":"8a4cb3ce69d04296302a8dc1fe27f7f701e40130","modified":1611283639019},{"_id":"source/_posts/images/gdut.jpg","hash":"2a1b444969cd4ea3542c7765667691ede8cb89d4","modified":1611283639019},{"_id":"source/_posts/_posts/sql-revise.md","hash":"f8d9b9ab0ab61c13616dc9caaae26f1138a59330","modified":1611283639019},{"_id":"source/_posts/images/profile.png","hash":"24ca9409baced46858ea8a6ace5e4df1e56fab50","modified":1611283639027},{"_id":"source/_posts/images/sandstone.png","hash":"d9376295a520b26f3fffcad510d712fb55b4c0aa","modified":1611283639027},{"_id":"source/_posts/tags/index.md","hash":"d7b0d8c4c7bb7ce8c8298fcba3cf2ae22f168066","modified":1611283639031},{"_id":"source/_posts/_posts/go-slice/GoSlice.png","hash":"4479fa57bd48c6b5416534c3fd47c70ab1f5cdf0","modified":1611283639011},{"_id":"source/_posts/_posts/distribute-system-consensus/more-detail-line.png","hash":"72f5da21dcf6e130fcf2244d3e19a756f82accb7","modified":1611283639007},{"_id":"source/_posts/_posts/go-slice/GoSliceExtend.png","hash":"775b4081f260a70834ec1a3dfe95df1b3836c8ee","modified":1611283639011},{"_id":"source/_posts/_posts/intro-distributed-system/SchdulerTimeJump.png","hash":"96bf07ff85553f0488994840d42abeee01b60ff7","modified":1611283639011},{"_id":"source/_posts/_posts/intro-distributed-system/TimeJump.png","hash":"06b9f53d7f1de9513ebc82f966da61f8c3245945","modified":1611283639015},{"_id":"source/_posts/_posts/prometheus-scrape/ScrapeModule.png","hash":"2f5e7b38d366dd450f7c722887f3d7ed2d592bc3","modified":1611283639015},{"_id":"source/_posts/_posts/raft-lab-2/RaftStateMachine.png","hash":"70b9c110053df72419c3b49b9af9dd0756a6746e","modified":1611283639019},{"_id":"source/_posts/_posts/raft-lab-3/Lab3-Process.png","hash":"ae7f4c8dfb423391ad0a308c67f7c53200cc55b1","modified":1611283639019},{"_id":"source/_posts/_posts/sql-revise/FULL_OUTER_JOIN.png","hash":"328ffe185f047de564ee058df5782e0ac4d7e288","modified":1611283639019},{"_id":"source/_posts/_posts/sql-revise/INNER_JOIN.png","hash":"4855ad7e617ff7bd5d50661933f11397e98ead33","modified":1611283639019},{"_id":"source/_posts/_posts/raft-lab-4/lab4.png","hash":"cd009a7990265f919125c0215a60c2c15da1ec88","modified":1611283639019},{"_id":"source/_posts/_posts/sql-revise/LEFT_EXCLUDING_JOIN.png","hash":"d8fbfb2ff1f3f7edcf7eb151d004063b64672593","modified":1611283639019},{"_id":"source/_posts/_posts/sql-revise/LEFT_JOIN.png","hash":"6bebcdbb03998cee42b0eb8796366324937899c1","modified":1611283639019},{"_id":"source/_posts/_posts/sql-revise/OUTER_EXCLUDING_JOIN.png","hash":"80bfd5ad46985693297d43a9c199a8fa7149caa9","modified":1611283639019},{"_id":"source/_posts/_posts/sql-revise/RIGHT_EXCLUDING_JOIN.png","hash":"d25f73221c620d82f62519dacd7b826d7fa6ec7b","modified":1611283639019},{"_id":"source/_posts/_posts/sql-revise/Union-3.png","hash":"b92a5c84b769dca861306b8533b90a220e3fec3e","modified":1611283639019},{"_id":"source/_posts/images/posts/Prometheus.png","hash":"0506d03706999d9ef6aa1eac1cd6aa38e64481d2","modified":1611283639019},{"_id":"source/_posts/images/posts/distributed-db.jpg","hash":"d12869dd81ffa87b28edf9ea658adda8c683925a","modified":1611283639023},{"_id":"source/_posts/images/posts/distributed-system.png","hash":"a8d43e346d395b6b3c821397b243b02269b5465b","modified":1611283639023},{"_id":"source/_posts/images/posts/docker.png","hash":"fa387d66e00872926990aeee452d8f4ed27dabf1","modified":1611283639023},{"_id":"source/_posts/images/posts/go.png","hash":"700cd88adaaa4c83be5580dad2edea8a64779551","modified":1611283639023},{"_id":"source/_posts/_posts/sql-revise/RIGHT_JOIN.png","hash":"9508b89fabef50db34cd895df23e8dfca1f32e55","modified":1611283639019},{"_id":"source/_posts/_posts/sql-revise/Union-1.png","hash":"a0b8d009947052d2860a5bfe38bea6ce2ddd319b","modified":1611283639019},{"_id":"source/_posts/images/posts/sql.jfif","hash":"2af4d52a366d09c72de7edd73bb0943d26697bde","modified":1611283639027},{"_id":"source/_posts/_posts/sql-revise/Union-2.png","hash":"f789f29d1f6499fdab82e0337f5c65827353d781","modified":1611283639019},{"_id":"source/_posts/images/posts/siteleaf/1.png","hash":"2914adca89d0679239e50045f69176b4ed71d75a","modified":1611283639023},{"_id":"source/_posts/images/posts/prometheus/DiscoverManager.png","hash":"a373230ea1eff40b760eefd994f389ed079f5924","modified":1611283639023},{"_id":"source/_posts/images/posts/siteleaf/2.png","hash":"705e3e4bfc44a38fcc1e86e3ae02e59d73855c84","modified":1611283639023},{"_id":"source/_posts/images/posts/siteleaf/3.png","hash":"ba54eaeab0f941bde9017e742fc434469aa0d22a","modified":1611283639027},{"_id":"source/_posts/images/posts/siteleaf/5.png","hash":"cce46cc1dc0036a3b8b676c690a9a47d1482f5c1","modified":1611283639027},{"_id":"source/_posts/images/posts/siteleaf/4.png","hash":"aee718d91c1957564223454555708230e193dfd8","modified":1611283639027},{"_id":"source/_posts/images/posts/siteleaf/8.png","hash":"82ec6fb7698807e6a156c6c9b64c391bc7dbecc4","modified":1611283639027},{"_id":"source/_posts/_posts/distribute-system-consensus.md","hash":"ba90ffad2d8bf94c4b80bccfd38768b633207602","modified":1611283639003},{"_id":"source/_posts/_posts/distribute-system-consensus/generate-line.png","hash":"af91ca7e6f039d4f2275074b90b2a03a75ff8de3","modified":1611283639007},{"_id":"source/_posts/_posts/intro-distributed-system/lockingproblem.png","hash":"fbb0f4ff829fbf4e7efd142690838d7c0ebeea5b","modified":1611283639015},{"_id":"source/_posts/_posts/raft-lab-2/RaftProcess.png","hash":"e0ba0d2b3bb78cb49e1a925c6f6d39810c6919a4","modified":1611283639019},{"_id":"source/_posts/images/posts/deploy-using-github-pages-and-travis.png","hash":"55cb8ef319aa7efa31bf54faab1f7018099fe8be","modified":1611283639019},{"_id":"source/_posts/images/posts/devlopr-starter.png","hash":"a111df6ea8403c12b4855d0f105d93b43897084f","modified":1611283639023},{"_id":"source/_posts/images/posts/hello.jpg","hash":"a704aa62155f81ea564f25b7c936bab812a96bdf","modified":1611283639023},{"_id":"source/_posts/images/posts/siteleaf.jpg","hash":"03af20db7719e4f3349754a87ae14e65bcfdb61b","modified":1611283639023},{"_id":"source/_posts/images/posts/siteleaf/6.png","hash":"fa55614cca7f2977f82a90b069afa4e17b4ede5d","modified":1611283639027},{"_id":"source/_posts/images/posts/siteleaf/9.png","hash":"75846cd0289eb17778e9abea0b2a9cd580296738","modified":1611283639027},{"_id":"source/_posts/_posts/distribute-system-consensus/line-final.png","hash":"b9d5a320acd4afd4bde5ff371d39083ec1d42e27","modified":1611283639007},{"_id":"source/_posts/_posts/distribute-system-consensus/LamportTimestamp.png","hash":"cd9167f36d443923340bc6696f2b2e9451845f54","modified":1611283639003},{"_id":"source/_posts/_posts/intro-distributed-system/lockingproblem2.png","hash":"1e26a196fc0d38387a04bfca2f72e232494ba5df","modified":1611283639015},{"_id":"source/_posts/_posts/intro-distributed-system/Time&EventMissmatch.png","hash":"3c475b8773138ddc1860c09f4dab36da63a600a9","modified":1611283639015},{"_id":"source/_posts/_posts/sql-revise/Visual_SQL_JOINS_orig.jpg","hash":"680a869474697bae045105b4ea3fb7db14cbdce9","modified":1611283639019},{"_id":"source/_posts/images/styleguide.png","hash":"c1a26070904f41146df18ce223ecc3f3df4a12d6","modified":1611283639031},{"_id":"source/_posts/_posts/distribute-system-consensus/quroum-fail.png","hash":"a232d6ebba1f33265a1032cb348637d664f34e2f","modified":1611283639011},{"_id":"source/_posts/images/zoom.jpg","hash":"9990a9c0a92cc394e8ca19b12f57bfbaf3be875b","modified":1611283639031},{"_id":"source/_posts/_posts/distribute-system-consensus/non-linearized-example.png","hash":"aa4ad4b7808ba88b228868f8c193cad6c965048d","modified":1611283639011},{"_id":"source/_posts/images/posts/devlopr.png","hash":"a97e9f2070caed1fde9c0f3918f6e475bfa75252","modified":1611283639023},{"_id":"source/_posts/images/programmingebooks.png","hash":"7037191f871a1b8660268927c5beb259274e57ce","modified":1611283639027}],"Category":[],"Data":[],"Page":[{"type":"categories","_content":"Golang  \nBackendDevelop\nDevops\nMonitorSystem\n","source":"categories/index.md","raw":"---\ntype: \"categories\"\n---\nGolang  \nBackendDevelop\nDevops\nMonitorSystem\n","date":"2021-01-21T03:49:18.287Z","updated":"2021-01-21T03:49:18.283Z","path":"categories/index.html","_id":"ckk68q9f90000lpi53xl4h3wk","title":"","comments":1,"layout":"page","content":"<p>Golang<br>BackendDevelop<br>Devops<br>MonitorSystem</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Golang<br>BackendDevelop<br>Devops<br>MonitorSystem</p>\n"},{"type":"tags","_content":"","source":"tags/index.md","raw":"---\ntype: \"tags\"\n---\n","date":"2021-01-21T02:53:21.625Z","updated":"2021-01-21T02:53:21.625Z","path":"tags/index.html","_id":"ckk69ad5n0000w1i5dc7d9par","title":"","comments":1,"layout":"page","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"MIT6.824 Lab2 ","date":"2019-08-28T07:05:38.000Z","_content":"\n<!-- ---\nlayout: post\ntitle:\nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: distributed-system\nsummary: MIT6.824 Lab2 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n# \n1. [Raft](#PaperReading)  \n2. [](#Detail)    \n        2.1 [Raft](#2.1)    \n        2.2 [Raft](#2.2)  \n        2.3 [Raft](#2.3)  \n\n# <a id=\"PaperReading\"><span class=\"toptitle\"></span></a>\n\n\n1. RaftRaftPaxos\n2. \n3. Paxos\n4. RaftPaxos\n5. Raft\n6. Raft\n7. Raft\n8. ClientRaft\n\nFigure2\n\n# <a id=\"Detail\"><span class=\"toptitle\"></span></a>\n## <a id=\"2.1\"><span class=\"secondtitle\"> Raft</span></a>\n\n<!-- ![Raft](/assets/img/posts/RaftProcess.png) -->\n{% asset_img RaftProcess.png Raft %}\n\n\nRaft\n![](https://raft.github.io/)\n\n## <a id=\"2.2\"><span class=\"secondtitle\"> Raft</span></a>\n<!-- ![Raft](/assets/img/posts/RaftStateMachine.png) -->\n{% asset_img RaftStateMachine.png Raft %}\n\n\n\n\n\n## <a id=\"2.3\"><span class=\"secondtitle\"> Raft</span></a>\nLab3part\n1. PartA  \n2. PartB  \n3. PartC  \n\n\n### PartA  \nRequestVote RPC  AppendEntries RPC \nTerm\n\nRPCGoRoutine\nAppendEntries\n```\n    logs := make([]Log, 0)\n    tmpIndex := min(max(0, rf.nextIndex[number]-1), rf.logs[rf.getLen()].Index)\n    if tmpIndex < rf.logs[rf.getLen()].Index {\n        logs = rf.logs[tmpIndex+1-firstIndex:]\n        //DPrintf(\"server %d is Leader, tmpIndex is %d, firstIndex is %d, len of log is %d, commited index is %d\",\n        //\trf.me, tmpIndex, firstIndex, len(rf.logs), rf.commitedIndex)\n    }\n    args := AppendEntriesArgs{Term: rf.currentTerm, LeaderId: rf.me,\n        PrevLogTerm: rf.logs[tmpIndex-firstIndex].Term, PrevLogIndex: tmpIndex,\n        Entries: logs, Leadercommited: rf.commitedIndex}\n    //  Goroutine\n    go func(args AppendEntriesArgs, number int) {\n        reply := AppendEntriesReply{}\n        ok := rf.sendAppendEntires(number, &args, &reply)\n        rf.mu.Lock()\n        defer rf.mu.Unlock()\n        if !ok {\n            DPrintf(\"allAppendEntries server %d call remote %d rpc AppendEntries failed\", rf.me, number)\n        }\n        if args.Term != rf.currentTerm {\n            return\n        }\n        if reply.Term > rf.currentTerm {\n            //rf.mu.Lock()\n            rf.state = Follower\n            rf.currentTerm = reply.Term\n            // TODO why Term voliate needed to persist?\n            rf.persist()\n            //rf.mu.Unlock()\n            return\n        }\n        if reply.Success == true && rf.state == Leader {\n            if len(args.Entries) > 0 {\n                rf.nextIndex[number] = args.Entries[len(args.Entries)-1].Index + 1\n                rf.matchIndex[number] = rf.nextIndex[number] - 1\n                if rf.matchIndex[number] > rf.commitedIndex {\n                    rf.updateCommit()\n                }\n            }\n        } else if rf.state == Leader {\n            if rf.nextIndex[number] > reply.PrevIndex+1 {\n                rf.nextIndex[number] = reply.PrevIndex + 1\n            } else {\n                rf.nextIndex[number] = max(rf.nextIndex[number]-1, 1)\n            }\n        }\n    }(args, number)\n```\n\n\n\n### PartB\nLogLogLog\n\nStartLeaderRaftLeaderLeader\n```\nfunc (rf *Raft) Start(command interface{}) (int, int, bool) {\n\tindex := -1\n\tterm := -1\n\tisLeader := true\n\t// Wanring: do not double add lock for GetState function\n\trf.mu.Lock()\n\tdefer rf.mu.Unlock()\n\tterm, isLeader = rf.GetState()\n\tif isLeader {\n\t\tindex = rf.logs[rf.getLen()].Index + 1\n\t\t//oldLogLen := len(rf.logs)\n\t\trf.logs = append(rf.logs, Log{command, term, index})\n\t\t//DPrintf(\"server %d is Leader. new log has been appended, old length is %d, now is %d.  index number is %d, commitedindex is %d\",\n\t\t//\trf.me, oldLogLen, len(rf.logs), index, rf.commitedIndex)\n\t\tif len(rf.chanNewLog) == 0 {\n\t\t\trf.chanNewLog <- 1\n\t\t}\n\t\trf.persist()\n\t}\n\treturn index, term, isLeader\n}\n```\nnextIndexMatchIndex \n#### Apply\nStart, MakeApplyChapply\n```\nfunc (rf *Raft) doApply() {\n\tfor {\n\t\trf.mu.Lock()\n\t\tst := rf.state\n\t\trf.mu.Unlock()\n\t\tif st == Killed {\n\t\t\treturn\n\t\t}\n\t\tselect {\n\t\tcase <-rf.chanCommit:\n\t\t\tfor {\n\t\t\t\trf.mu.Lock()\n\t\t\t\tif !(rf.lastApplied < rf.commitedIndex && rf.lastApplied < rf.logs[rf.getLen()].Index) {\n\t\t\t\t\trf.mu.Unlock()\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tFirstIndex := rf.logs[0].Index\n\t\t\t\tif rf.lastApplied+1 >= FirstIndex {\n\t\t\t\t\tindex := min(rf.lastApplied+1-FirstIndex, rf.getLen())\n\t\t\t\t\tmsg := ApplyMsg{CommandValid: true, Command: rf.logs[index].Command, CommandIndex: rf.lastApplied + 1}\n\t\t\t\t\trf.lastApplied++\n\t\t\t\t\trf.mu.Unlock()\n\t\t\t\t\t//can't lock when send in channel, dead lock\n\t\t\t\t\t// canApplychan is to block the new\n\t\t\t\t\trf.chanCanApply <- 1\n\t\t\t\t\trf.chanApplyMsg <- msg\n\t\t\t\t\t<-rf.chanCanApply\n\t\t\t\t\trf.mu.Lock()\n\t\t\t\t}\n\t\t\t\trf.mu.Unlock()\n\t\t\t}\n\t\t}\n\t}\n}\n\n```\n\n\n### PartC\n\n```\nfunc (rf *Raft) InstallSnapshot(args *InstallSnapshotArgs, reply *InstallSnapshotReply) {\n\trf.chanCanApply <- 1\n\trf.mu.Lock()\n\treply.Success = false\n\tpersistFlag := 0\n\tif args.Term < rf.currentTerm {\n\t\treply.Term = rf.currentTerm\n\t\trf.mu.Unlock()\n\t\t<-rf.chanCanApply\n\t\treturn\n\t}\n\tif rf.currentTerm < args.Term {\n\t\trf.currentTerm = args.Term\n\t\trf.ClearChan()\n\t\trf.voteFor = -1\n\t\trf.state = Follower\n\t\tpersistFlag = 1\n\t}\n\treply.Term = rf.currentTerm\n\t// similar to appendEntries receive call\n\trf.chanAppendEntries <- 1\n\tfirstIndex := rf.logs[0].Index\n\tnowIndex := args.LastIncludeIndex - firstIndex\n\tif nowIndex < 0 {\n\t\tif persistFlag == 1 {\n\t\t\trf.persist()\n\t\t}\n\t\treply.PrevIndex = firstIndex\n\t\trf.mu.Unlock()\n\t\t<-rf.chanCanApply\n\t\treturn\n\t}\n\trf.logs = args.Logs\n\trf.lastApplied = args.LastIncludeIndex\n\trf.commitedIndex = args.LeaderCommitIndex\n\trf.persister.SaveStateAndSnapshot(rf.getPersistByte(), args.Snapshot)\n\tmsg := ApplyMsg{CommandValid: false, Snapshot: args.Snapshot}\n\trf.mu.Unlock()\n\trf.chanApplyMsg <- msg\n\t<-rf.chanCanApply\n\treply.Success = true\n\n}\n\n```\n\n```\n// Snapshotload\nrf.readPersist(persister.ReadRaftState())\n```\n\nSaftyRequestVote RPCTermTerm\n```\nfunc (rf *Raft) updateCommit() {\n\tN := rf.commitedIndex\n\tFirstIndex := rf.logs[0].Index\n\tfor i := max(rf.commitedIndex+1, FirstIndex+1); i <= rf.logs[rf.getLen()].Index; i++ {\n\t\tnum := 1\n\t\tfor j := range rf.peers {\n\t\t\tif j != rf.me {\n\t\t\t\tif rf.matchIndex[j] >= i {\n\t\t\t\t\t/*\n\t\t\t\t\t\tthis part is paper 5.4.2 limit, only can count replicate when log's term\n\t\t\t\t\t\tis equals to currentTerm\n\t\t\t\t\t*/\n\t\t\t\t\tif rf.logs[i-FirstIndex].Term == rf.currentTerm {\n\t\t\t\t\t\tnum++\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif num > len(rf.peers)/2 {\n\t\t\tN = i\n\t\t}\n\t}\n\tif N > rf.commitedIndex && rf.state == Leader {\n\t\trf.commitedIndex = min(N, rf.logs[rf.getLen()].Index)\n\t\trf.chanCommit <- 1\n\t}\n}\n```","source":"_posts/raft-lab-2.md","raw":"---\ntitle:  MIT6.824 Lab2 \ndate: 2019-08-28 15:05:38\ntags:  distributed-system\n---\n\n<!-- ---\nlayout: post\ntitle:\nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: distributed-system\nsummary: MIT6.824 Lab2 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n# \n1. [Raft](#PaperReading)  \n2. [](#Detail)    \n        2.1 [Raft](#2.1)    \n        2.2 [Raft](#2.2)  \n        2.3 [Raft](#2.3)  \n\n# <a id=\"PaperReading\"><span class=\"toptitle\"></span></a>\n\n\n1. RaftRaftPaxos\n2. \n3. Paxos\n4. RaftPaxos\n5. Raft\n6. Raft\n7. Raft\n8. ClientRaft\n\nFigure2\n\n# <a id=\"Detail\"><span class=\"toptitle\"></span></a>\n## <a id=\"2.1\"><span class=\"secondtitle\"> Raft</span></a>\n\n<!-- ![Raft](/assets/img/posts/RaftProcess.png) -->\n{% asset_img RaftProcess.png Raft %}\n\n\nRaft\n![](https://raft.github.io/)\n\n## <a id=\"2.2\"><span class=\"secondtitle\"> Raft</span></a>\n<!-- ![Raft](/assets/img/posts/RaftStateMachine.png) -->\n{% asset_img RaftStateMachine.png Raft %}\n\n\n\n\n\n## <a id=\"2.3\"><span class=\"secondtitle\"> Raft</span></a>\nLab3part\n1. PartA  \n2. PartB  \n3. PartC  \n\n\n### PartA  \nRequestVote RPC  AppendEntries RPC \nTerm\n\nRPCGoRoutine\nAppendEntries\n```\n    logs := make([]Log, 0)\n    tmpIndex := min(max(0, rf.nextIndex[number]-1), rf.logs[rf.getLen()].Index)\n    if tmpIndex < rf.logs[rf.getLen()].Index {\n        logs = rf.logs[tmpIndex+1-firstIndex:]\n        //DPrintf(\"server %d is Leader, tmpIndex is %d, firstIndex is %d, len of log is %d, commited index is %d\",\n        //\trf.me, tmpIndex, firstIndex, len(rf.logs), rf.commitedIndex)\n    }\n    args := AppendEntriesArgs{Term: rf.currentTerm, LeaderId: rf.me,\n        PrevLogTerm: rf.logs[tmpIndex-firstIndex].Term, PrevLogIndex: tmpIndex,\n        Entries: logs, Leadercommited: rf.commitedIndex}\n    //  Goroutine\n    go func(args AppendEntriesArgs, number int) {\n        reply := AppendEntriesReply{}\n        ok := rf.sendAppendEntires(number, &args, &reply)\n        rf.mu.Lock()\n        defer rf.mu.Unlock()\n        if !ok {\n            DPrintf(\"allAppendEntries server %d call remote %d rpc AppendEntries failed\", rf.me, number)\n        }\n        if args.Term != rf.currentTerm {\n            return\n        }\n        if reply.Term > rf.currentTerm {\n            //rf.mu.Lock()\n            rf.state = Follower\n            rf.currentTerm = reply.Term\n            // TODO why Term voliate needed to persist?\n            rf.persist()\n            //rf.mu.Unlock()\n            return\n        }\n        if reply.Success == true && rf.state == Leader {\n            if len(args.Entries) > 0 {\n                rf.nextIndex[number] = args.Entries[len(args.Entries)-1].Index + 1\n                rf.matchIndex[number] = rf.nextIndex[number] - 1\n                if rf.matchIndex[number] > rf.commitedIndex {\n                    rf.updateCommit()\n                }\n            }\n        } else if rf.state == Leader {\n            if rf.nextIndex[number] > reply.PrevIndex+1 {\n                rf.nextIndex[number] = reply.PrevIndex + 1\n            } else {\n                rf.nextIndex[number] = max(rf.nextIndex[number]-1, 1)\n            }\n        }\n    }(args, number)\n```\n\n\n\n### PartB\nLogLogLog\n\nStartLeaderRaftLeaderLeader\n```\nfunc (rf *Raft) Start(command interface{}) (int, int, bool) {\n\tindex := -1\n\tterm := -1\n\tisLeader := true\n\t// Wanring: do not double add lock for GetState function\n\trf.mu.Lock()\n\tdefer rf.mu.Unlock()\n\tterm, isLeader = rf.GetState()\n\tif isLeader {\n\t\tindex = rf.logs[rf.getLen()].Index + 1\n\t\t//oldLogLen := len(rf.logs)\n\t\trf.logs = append(rf.logs, Log{command, term, index})\n\t\t//DPrintf(\"server %d is Leader. new log has been appended, old length is %d, now is %d.  index number is %d, commitedindex is %d\",\n\t\t//\trf.me, oldLogLen, len(rf.logs), index, rf.commitedIndex)\n\t\tif len(rf.chanNewLog) == 0 {\n\t\t\trf.chanNewLog <- 1\n\t\t}\n\t\trf.persist()\n\t}\n\treturn index, term, isLeader\n}\n```\nnextIndexMatchIndex \n#### Apply\nStart, MakeApplyChapply\n```\nfunc (rf *Raft) doApply() {\n\tfor {\n\t\trf.mu.Lock()\n\t\tst := rf.state\n\t\trf.mu.Unlock()\n\t\tif st == Killed {\n\t\t\treturn\n\t\t}\n\t\tselect {\n\t\tcase <-rf.chanCommit:\n\t\t\tfor {\n\t\t\t\trf.mu.Lock()\n\t\t\t\tif !(rf.lastApplied < rf.commitedIndex && rf.lastApplied < rf.logs[rf.getLen()].Index) {\n\t\t\t\t\trf.mu.Unlock()\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tFirstIndex := rf.logs[0].Index\n\t\t\t\tif rf.lastApplied+1 >= FirstIndex {\n\t\t\t\t\tindex := min(rf.lastApplied+1-FirstIndex, rf.getLen())\n\t\t\t\t\tmsg := ApplyMsg{CommandValid: true, Command: rf.logs[index].Command, CommandIndex: rf.lastApplied + 1}\n\t\t\t\t\trf.lastApplied++\n\t\t\t\t\trf.mu.Unlock()\n\t\t\t\t\t//can't lock when send in channel, dead lock\n\t\t\t\t\t// canApplychan is to block the new\n\t\t\t\t\trf.chanCanApply <- 1\n\t\t\t\t\trf.chanApplyMsg <- msg\n\t\t\t\t\t<-rf.chanCanApply\n\t\t\t\t\trf.mu.Lock()\n\t\t\t\t}\n\t\t\t\trf.mu.Unlock()\n\t\t\t}\n\t\t}\n\t}\n}\n\n```\n\n\n### PartC\n\n```\nfunc (rf *Raft) InstallSnapshot(args *InstallSnapshotArgs, reply *InstallSnapshotReply) {\n\trf.chanCanApply <- 1\n\trf.mu.Lock()\n\treply.Success = false\n\tpersistFlag := 0\n\tif args.Term < rf.currentTerm {\n\t\treply.Term = rf.currentTerm\n\t\trf.mu.Unlock()\n\t\t<-rf.chanCanApply\n\t\treturn\n\t}\n\tif rf.currentTerm < args.Term {\n\t\trf.currentTerm = args.Term\n\t\trf.ClearChan()\n\t\trf.voteFor = -1\n\t\trf.state = Follower\n\t\tpersistFlag = 1\n\t}\n\treply.Term = rf.currentTerm\n\t// similar to appendEntries receive call\n\trf.chanAppendEntries <- 1\n\tfirstIndex := rf.logs[0].Index\n\tnowIndex := args.LastIncludeIndex - firstIndex\n\tif nowIndex < 0 {\n\t\tif persistFlag == 1 {\n\t\t\trf.persist()\n\t\t}\n\t\treply.PrevIndex = firstIndex\n\t\trf.mu.Unlock()\n\t\t<-rf.chanCanApply\n\t\treturn\n\t}\n\trf.logs = args.Logs\n\trf.lastApplied = args.LastIncludeIndex\n\trf.commitedIndex = args.LeaderCommitIndex\n\trf.persister.SaveStateAndSnapshot(rf.getPersistByte(), args.Snapshot)\n\tmsg := ApplyMsg{CommandValid: false, Snapshot: args.Snapshot}\n\trf.mu.Unlock()\n\trf.chanApplyMsg <- msg\n\t<-rf.chanCanApply\n\treply.Success = true\n\n}\n\n```\n\n```\n// Snapshotload\nrf.readPersist(persister.ReadRaftState())\n```\n\nSaftyRequestVote RPCTermTerm\n```\nfunc (rf *Raft) updateCommit() {\n\tN := rf.commitedIndex\n\tFirstIndex := rf.logs[0].Index\n\tfor i := max(rf.commitedIndex+1, FirstIndex+1); i <= rf.logs[rf.getLen()].Index; i++ {\n\t\tnum := 1\n\t\tfor j := range rf.peers {\n\t\t\tif j != rf.me {\n\t\t\t\tif rf.matchIndex[j] >= i {\n\t\t\t\t\t/*\n\t\t\t\t\t\tthis part is paper 5.4.2 limit, only can count replicate when log's term\n\t\t\t\t\t\tis equals to currentTerm\n\t\t\t\t\t*/\n\t\t\t\t\tif rf.logs[i-FirstIndex].Term == rf.currentTerm {\n\t\t\t\t\t\tnum++\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif num > len(rf.peers)/2 {\n\t\t\tN = i\n\t\t}\n\t}\n\tif N > rf.commitedIndex && rf.state == Leader {\n\t\trf.commitedIndex = min(N, rf.logs[rf.getLen()].Index)\n\t\trf.chanCommit <- 1\n\t}\n}\n```","slug":"raft-lab-2","published":1,"updated":"2021-01-21T07:28:16.144Z","_id":"ckk6h2epb0000eci53tuy7iuk","comments":1,"layout":"post","photos":[],"link":"","content":"<!-- ---\nlayout: post\ntitle:\nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: distributed-system\nsummary: MIT6.824 Lab2 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#PaperReading\">Raft</a>  </li>\n<li><a href=\"#Detail\"></a>    <pre><code> 2.1 [Raft](#2.1)    \n 2.2 [Raft](#2.2)  \n 2.3 [Raft](#2.3)  </code></pre>\n</li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p></p>\n<ol>\n<li>RaftRaftPaxos</li>\n<li></li>\n<li>Paxos</li>\n<li>RaftPaxos</li>\n<li>Raft</li>\n<li>Raft</li>\n<li>Raft</li>\n<li>ClientRaft</li>\n</ol>\n<p>Figure2</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"Raft\"   >\n          <a href=\"#Raft\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Raft</h2>\n      <!-- ![Raft](/assets/img/posts/RaftProcess.png) -->\n<img src=\"/2019/08/28/raft-lab-2/RaftProcess.png\" class=\"\" title=\"Raft\">\n\n<p><br>Raft<br><img src=\"https://raft.github.io/\" alt=\"\"></p>\n\n        <h2 id=\"Raft\"   >\n          <a href=\"#Raft\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Raft</h2>\n      <!-- ![Raft](/assets/img/posts/RaftStateMachine.png) -->\n<img src=\"/2019/08/28/raft-lab-2/RaftStateMachine.png\" class=\"\" title=\"Raft\">\n\n<p></p>\n\n        <h2 id=\"Raft\"   >\n          <a href=\"#Raft\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Raft</h2>\n      <p>Lab3part</p>\n<ol>\n<li>PartA  </li>\n<li>PartB  </li>\n<li>PartC  </li>\n</ol>\n\n        <h3 id=\"PartA-\"   >\n          <a href=\"#PartA-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>PartA </h3>\n      <p>RequestVote RPC  AppendEntries RPC <br>Term</p>\n<p>RPCGoRoutine<br>AppendEntries</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">logs :&#x3D; make([]Log, 0)</span><br><span class=\"line\">tmpIndex :&#x3D; min(max(0, rf.nextIndex[number]-1), rf.logs[rf.getLen()].Index)</span><br><span class=\"line\">if tmpIndex &lt; rf.logs[rf.getLen()].Index &#123;</span><br><span class=\"line\">    logs &#x3D; rf.logs[tmpIndex+1-firstIndex:]</span><br><span class=\"line\">    &#x2F;&#x2F;DPrintf(&quot;server %d is Leader, tmpIndex is %d, firstIndex is %d, len of log is %d, commited index is %d&quot;,</span><br><span class=\"line\">    &#x2F;&#x2F;\trf.me, tmpIndex, firstIndex, len(rf.logs), rf.commitedIndex)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">args :&#x3D; AppendEntriesArgs&#123;Term: rf.currentTerm, LeaderId: rf.me,</span><br><span class=\"line\">    PrevLogTerm: rf.logs[tmpIndex-firstIndex].Term, PrevLogIndex: tmpIndex,</span><br><span class=\"line\">    Entries: logs, Leadercommited: rf.commitedIndex&#125;</span><br><span class=\"line\">&#x2F;&#x2F;  Goroutine</span><br><span class=\"line\">go func(args AppendEntriesArgs, number int) &#123;</span><br><span class=\"line\">    reply :&#x3D; AppendEntriesReply&#123;&#125;</span><br><span class=\"line\">    ok :&#x3D; rf.sendAppendEntires(number, &amp;args, &amp;reply)</span><br><span class=\"line\">    rf.mu.Lock()</span><br><span class=\"line\">    defer rf.mu.Unlock()</span><br><span class=\"line\">    if !ok &#123;</span><br><span class=\"line\">        DPrintf(&quot;allAppendEntries server %d call remote %d rpc AppendEntries failed&quot;, rf.me, number)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if args.Term !&#x3D; rf.currentTerm &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if reply.Term &gt; rf.currentTerm &#123;</span><br><span class=\"line\">        &#x2F;&#x2F;rf.mu.Lock()</span><br><span class=\"line\">        rf.state &#x3D; Follower</span><br><span class=\"line\">        rf.currentTerm &#x3D; reply.Term</span><br><span class=\"line\">        &#x2F;&#x2F; TODO why Term voliate needed to persist?</span><br><span class=\"line\">        rf.persist()</span><br><span class=\"line\">        &#x2F;&#x2F;rf.mu.Unlock()</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if reply.Success &#x3D;&#x3D; true &amp;&amp; rf.state &#x3D;&#x3D; Leader &#123;</span><br><span class=\"line\">        if len(args.Entries) &gt; 0 &#123;</span><br><span class=\"line\">            rf.nextIndex[number] &#x3D; args.Entries[len(args.Entries)-1].Index + 1</span><br><span class=\"line\">            rf.matchIndex[number] &#x3D; rf.nextIndex[number] - 1</span><br><span class=\"line\">            if rf.matchIndex[number] &gt; rf.commitedIndex &#123;</span><br><span class=\"line\">                rf.updateCommit()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; else if rf.state &#x3D;&#x3D; Leader &#123;</span><br><span class=\"line\">        if rf.nextIndex[number] &gt; reply.PrevIndex+1 &#123;</span><br><span class=\"line\">            rf.nextIndex[number] &#x3D; reply.PrevIndex + 1</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            rf.nextIndex[number] &#x3D; max(rf.nextIndex[number]-1, 1)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;(args, number)</span><br></pre></td></tr></table></div></figure>\n<p></p>\n\n        <h3 id=\"PartB\"   >\n          <a href=\"#PartB\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>PartB</h3>\n      <p>LogLogLog</p>\n<p>StartLeaderRaftLeaderLeader</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (rf *Raft) Start(command interface&#123;&#125;) (int, int, bool) &#123;</span><br><span class=\"line\">\tindex :&#x3D; -1</span><br><span class=\"line\">\tterm :&#x3D; -1</span><br><span class=\"line\">\tisLeader :&#x3D; true</span><br><span class=\"line\">\t&#x2F;&#x2F; Wanring: do not double add lock for GetState function</span><br><span class=\"line\">\trf.mu.Lock()</span><br><span class=\"line\">\tdefer rf.mu.Unlock()</span><br><span class=\"line\">\tterm, isLeader &#x3D; rf.GetState()</span><br><span class=\"line\">\tif isLeader &#123;</span><br><span class=\"line\">\t\tindex &#x3D; rf.logs[rf.getLen()].Index + 1</span><br><span class=\"line\">\t\t&#x2F;&#x2F;oldLogLen :&#x3D; len(rf.logs)</span><br><span class=\"line\">\t\trf.logs &#x3D; append(rf.logs, Log&#123;command, term, index&#125;)</span><br><span class=\"line\">\t\t&#x2F;&#x2F;DPrintf(&quot;server %d is Leader. new log has been appended, old length is %d, now is %d.  index number is %d, commitedindex is %d&quot;,</span><br><span class=\"line\">\t\t&#x2F;&#x2F;\trf.me, oldLogLen, len(rf.logs), index, rf.commitedIndex)</span><br><span class=\"line\">\t\tif len(rf.chanNewLog) &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\trf.chanNewLog &lt;- 1</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\trf.persist()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn index, term, isLeader</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>nextIndexMatchIndex </p>\n\n        <h4 id=\"Apply\"   >\n          <a href=\"#Apply\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Apply</h4>\n      <p>Start, MakeApplyChapply</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (rf *Raft) doApply() &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\trf.mu.Lock()</span><br><span class=\"line\">\t\tst :&#x3D; rf.state</span><br><span class=\"line\">\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\tif st &#x3D;&#x3D; Killed &#123;</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-rf.chanCommit:</span><br><span class=\"line\">\t\t\tfor &#123;</span><br><span class=\"line\">\t\t\t\trf.mu.Lock()</span><br><span class=\"line\">\t\t\t\tif !(rf.lastApplied &lt; rf.commitedIndex &amp;&amp; rf.lastApplied &lt; rf.logs[rf.getLen()].Index) &#123;</span><br><span class=\"line\">\t\t\t\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t\t\t\tbreak</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tFirstIndex :&#x3D; rf.logs[0].Index</span><br><span class=\"line\">\t\t\t\tif rf.lastApplied+1 &gt;&#x3D; FirstIndex &#123;</span><br><span class=\"line\">\t\t\t\t\tindex :&#x3D; min(rf.lastApplied+1-FirstIndex, rf.getLen())</span><br><span class=\"line\">\t\t\t\t\tmsg :&#x3D; ApplyMsg&#123;CommandValid: true, Command: rf.logs[index].Command, CommandIndex: rf.lastApplied + 1&#125;</span><br><span class=\"line\">\t\t\t\t\trf.lastApplied++</span><br><span class=\"line\">\t\t\t\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t\t\t\t&#x2F;&#x2F;can&#39;t lock when send in channel, dead lock</span><br><span class=\"line\">\t\t\t\t\t&#x2F;&#x2F; canApplychan is to block the new</span><br><span class=\"line\">\t\t\t\t\trf.chanCanApply &lt;- 1</span><br><span class=\"line\">\t\t\t\t\trf.chanApplyMsg &lt;- msg</span><br><span class=\"line\">\t\t\t\t\t&lt;-rf.chanCanApply</span><br><span class=\"line\">\t\t\t\t\trf.mu.Lock()</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n\n        <h3 id=\"PartC\"   >\n          <a href=\"#PartC\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>PartC</h3>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (rf *Raft) InstallSnapshot(args *InstallSnapshotArgs, reply *InstallSnapshotReply) &#123;</span><br><span class=\"line\">\trf.chanCanApply &lt;- 1</span><br><span class=\"line\">\trf.mu.Lock()</span><br><span class=\"line\">\treply.Success &#x3D; false</span><br><span class=\"line\">\tpersistFlag :&#x3D; 0</span><br><span class=\"line\">\tif args.Term &lt; rf.currentTerm &#123;</span><br><span class=\"line\">\t\treply.Term &#x3D; rf.currentTerm</span><br><span class=\"line\">\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t&lt;-rf.chanCanApply</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif rf.currentTerm &lt; args.Term &#123;</span><br><span class=\"line\">\t\trf.currentTerm &#x3D; args.Term</span><br><span class=\"line\">\t\trf.ClearChan()</span><br><span class=\"line\">\t\trf.voteFor &#x3D; -1</span><br><span class=\"line\">\t\trf.state &#x3D; Follower</span><br><span class=\"line\">\t\tpersistFlag &#x3D; 1</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treply.Term &#x3D; rf.currentTerm</span><br><span class=\"line\">\t&#x2F;&#x2F; similar to appendEntries receive call</span><br><span class=\"line\">\trf.chanAppendEntries &lt;- 1</span><br><span class=\"line\">\tfirstIndex :&#x3D; rf.logs[0].Index</span><br><span class=\"line\">\tnowIndex :&#x3D; args.LastIncludeIndex - firstIndex</span><br><span class=\"line\">\tif nowIndex &lt; 0 &#123;</span><br><span class=\"line\">\t\tif persistFlag &#x3D;&#x3D; 1 &#123;</span><br><span class=\"line\">\t\t\trf.persist()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treply.PrevIndex &#x3D; firstIndex</span><br><span class=\"line\">\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t&lt;-rf.chanCanApply</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\trf.logs &#x3D; args.Logs</span><br><span class=\"line\">\trf.lastApplied &#x3D; args.LastIncludeIndex</span><br><span class=\"line\">\trf.commitedIndex &#x3D; args.LeaderCommitIndex</span><br><span class=\"line\">\trf.persister.SaveStateAndSnapshot(rf.getPersistByte(), args.Snapshot)</span><br><span class=\"line\">\tmsg :&#x3D; ApplyMsg&#123;CommandValid: false, Snapshot: args.Snapshot&#125;</span><br><span class=\"line\">\trf.mu.Unlock()</span><br><span class=\"line\">\trf.chanApplyMsg &lt;- msg</span><br><span class=\"line\">\t&lt;-rf.chanCanApply</span><br><span class=\"line\">\treply.Success &#x3D; true</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; Snapshotload</span><br><span class=\"line\">rf.readPersist(persister.ReadRaftState())</span><br></pre></td></tr></table></div></figure>\n<p>SaftyRequestVote RPCTermTerm</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (rf *Raft) updateCommit() &#123;</span><br><span class=\"line\">\tN :&#x3D; rf.commitedIndex</span><br><span class=\"line\">\tFirstIndex :&#x3D; rf.logs[0].Index</span><br><span class=\"line\">\tfor i :&#x3D; max(rf.commitedIndex+1, FirstIndex+1); i &lt;&#x3D; rf.logs[rf.getLen()].Index; i++ &#123;</span><br><span class=\"line\">\t\tnum :&#x3D; 1</span><br><span class=\"line\">\t\tfor j :&#x3D; range rf.peers &#123;</span><br><span class=\"line\">\t\t\tif j !&#x3D; rf.me &#123;</span><br><span class=\"line\">\t\t\t\tif rf.matchIndex[j] &gt;&#x3D; i &#123;</span><br><span class=\"line\">\t\t\t\t\t&#x2F;*</span><br><span class=\"line\">\t\t\t\t\t\tthis part is paper 5.4.2 limit, only can count replicate when log&#39;s term</span><br><span class=\"line\">\t\t\t\t\t\tis equals to currentTerm</span><br><span class=\"line\">\t\t\t\t\t*&#x2F;</span><br><span class=\"line\">\t\t\t\t\tif rf.logs[i-FirstIndex].Term &#x3D;&#x3D; rf.currentTerm &#123;</span><br><span class=\"line\">\t\t\t\t\t\tnum++</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tif num &gt; len(rf.peers)&#x2F;2 &#123;</span><br><span class=\"line\">\t\t\tN &#x3D; i</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif N &gt; rf.commitedIndex &amp;&amp; rf.state &#x3D;&#x3D; Leader &#123;</span><br><span class=\"line\">\t\trf.commitedIndex &#x3D; min(N, rf.logs[rf.getLen()].Index)</span><br><span class=\"line\">\t\trf.chanCommit &lt;- 1</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>","site":{"data":{}},"excerpt":"","more":"<!-- ---\nlayout: post\ntitle:\nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: distributed-system\nsummary: MIT6.824 Lab2 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#PaperReading\">Raft</a>  </li>\n<li><a href=\"#Detail\"></a>    <pre><code> 2.1 [Raft](#2.1)    \n 2.2 [Raft](#2.2)  \n 2.3 [Raft](#2.3)  </code></pre>\n</li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p></p>\n<ol>\n<li>RaftRaftPaxos</li>\n<li></li>\n<li>Paxos</li>\n<li>RaftPaxos</li>\n<li>Raft</li>\n<li>Raft</li>\n<li>Raft</li>\n<li>ClientRaft</li>\n</ol>\n<p>Figure2</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"Raft\"   >\n          <a href=\"#Raft\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Raft</h2>\n      <!-- ![Raft](/assets/img/posts/RaftProcess.png) -->\n<img src=\"/2019/08/28/raft-lab-2/RaftProcess.png\" class=\"\" title=\"Raft\">\n\n<p><br>Raft<br><img src=\"https://raft.github.io/\" alt=\"\"></p>\n\n        <h2 id=\"Raft\"   >\n          <a href=\"#Raft\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Raft</h2>\n      <!-- ![Raft](/assets/img/posts/RaftStateMachine.png) -->\n<img src=\"/2019/08/28/raft-lab-2/RaftStateMachine.png\" class=\"\" title=\"Raft\">\n\n<p></p>\n\n        <h2 id=\"Raft\"   >\n          <a href=\"#Raft\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Raft</h2>\n      <p>Lab3part</p>\n<ol>\n<li>PartA  </li>\n<li>PartB  </li>\n<li>PartC  </li>\n</ol>\n\n        <h3 id=\"PartA-\"   >\n          <a href=\"#PartA-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>PartA </h3>\n      <p>RequestVote RPC  AppendEntries RPC <br>Term</p>\n<p>RPCGoRoutine<br>AppendEntries</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">logs :&#x3D; make([]Log, 0)</span><br><span class=\"line\">tmpIndex :&#x3D; min(max(0, rf.nextIndex[number]-1), rf.logs[rf.getLen()].Index)</span><br><span class=\"line\">if tmpIndex &lt; rf.logs[rf.getLen()].Index &#123;</span><br><span class=\"line\">    logs &#x3D; rf.logs[tmpIndex+1-firstIndex:]</span><br><span class=\"line\">    &#x2F;&#x2F;DPrintf(&quot;server %d is Leader, tmpIndex is %d, firstIndex is %d, len of log is %d, commited index is %d&quot;,</span><br><span class=\"line\">    &#x2F;&#x2F;\trf.me, tmpIndex, firstIndex, len(rf.logs), rf.commitedIndex)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">args :&#x3D; AppendEntriesArgs&#123;Term: rf.currentTerm, LeaderId: rf.me,</span><br><span class=\"line\">    PrevLogTerm: rf.logs[tmpIndex-firstIndex].Term, PrevLogIndex: tmpIndex,</span><br><span class=\"line\">    Entries: logs, Leadercommited: rf.commitedIndex&#125;</span><br><span class=\"line\">&#x2F;&#x2F;  Goroutine</span><br><span class=\"line\">go func(args AppendEntriesArgs, number int) &#123;</span><br><span class=\"line\">    reply :&#x3D; AppendEntriesReply&#123;&#125;</span><br><span class=\"line\">    ok :&#x3D; rf.sendAppendEntires(number, &amp;args, &amp;reply)</span><br><span class=\"line\">    rf.mu.Lock()</span><br><span class=\"line\">    defer rf.mu.Unlock()</span><br><span class=\"line\">    if !ok &#123;</span><br><span class=\"line\">        DPrintf(&quot;allAppendEntries server %d call remote %d rpc AppendEntries failed&quot;, rf.me, number)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if args.Term !&#x3D; rf.currentTerm &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if reply.Term &gt; rf.currentTerm &#123;</span><br><span class=\"line\">        &#x2F;&#x2F;rf.mu.Lock()</span><br><span class=\"line\">        rf.state &#x3D; Follower</span><br><span class=\"line\">        rf.currentTerm &#x3D; reply.Term</span><br><span class=\"line\">        &#x2F;&#x2F; TODO why Term voliate needed to persist?</span><br><span class=\"line\">        rf.persist()</span><br><span class=\"line\">        &#x2F;&#x2F;rf.mu.Unlock()</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if reply.Success &#x3D;&#x3D; true &amp;&amp; rf.state &#x3D;&#x3D; Leader &#123;</span><br><span class=\"line\">        if len(args.Entries) &gt; 0 &#123;</span><br><span class=\"line\">            rf.nextIndex[number] &#x3D; args.Entries[len(args.Entries)-1].Index + 1</span><br><span class=\"line\">            rf.matchIndex[number] &#x3D; rf.nextIndex[number] - 1</span><br><span class=\"line\">            if rf.matchIndex[number] &gt; rf.commitedIndex &#123;</span><br><span class=\"line\">                rf.updateCommit()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; else if rf.state &#x3D;&#x3D; Leader &#123;</span><br><span class=\"line\">        if rf.nextIndex[number] &gt; reply.PrevIndex+1 &#123;</span><br><span class=\"line\">            rf.nextIndex[number] &#x3D; reply.PrevIndex + 1</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            rf.nextIndex[number] &#x3D; max(rf.nextIndex[number]-1, 1)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;(args, number)</span><br></pre></td></tr></table></div></figure>\n<p></p>\n\n        <h3 id=\"PartB\"   >\n          <a href=\"#PartB\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>PartB</h3>\n      <p>LogLogLog</p>\n<p>StartLeaderRaftLeaderLeader</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (rf *Raft) Start(command interface&#123;&#125;) (int, int, bool) &#123;</span><br><span class=\"line\">\tindex :&#x3D; -1</span><br><span class=\"line\">\tterm :&#x3D; -1</span><br><span class=\"line\">\tisLeader :&#x3D; true</span><br><span class=\"line\">\t&#x2F;&#x2F; Wanring: do not double add lock for GetState function</span><br><span class=\"line\">\trf.mu.Lock()</span><br><span class=\"line\">\tdefer rf.mu.Unlock()</span><br><span class=\"line\">\tterm, isLeader &#x3D; rf.GetState()</span><br><span class=\"line\">\tif isLeader &#123;</span><br><span class=\"line\">\t\tindex &#x3D; rf.logs[rf.getLen()].Index + 1</span><br><span class=\"line\">\t\t&#x2F;&#x2F;oldLogLen :&#x3D; len(rf.logs)</span><br><span class=\"line\">\t\trf.logs &#x3D; append(rf.logs, Log&#123;command, term, index&#125;)</span><br><span class=\"line\">\t\t&#x2F;&#x2F;DPrintf(&quot;server %d is Leader. new log has been appended, old length is %d, now is %d.  index number is %d, commitedindex is %d&quot;,</span><br><span class=\"line\">\t\t&#x2F;&#x2F;\trf.me, oldLogLen, len(rf.logs), index, rf.commitedIndex)</span><br><span class=\"line\">\t\tif len(rf.chanNewLog) &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\trf.chanNewLog &lt;- 1</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\trf.persist()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn index, term, isLeader</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>nextIndexMatchIndex </p>\n\n        <h4 id=\"Apply\"   >\n          <a href=\"#Apply\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Apply</h4>\n      <p>Start, MakeApplyChapply</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (rf *Raft) doApply() &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\trf.mu.Lock()</span><br><span class=\"line\">\t\tst :&#x3D; rf.state</span><br><span class=\"line\">\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\tif st &#x3D;&#x3D; Killed &#123;</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-rf.chanCommit:</span><br><span class=\"line\">\t\t\tfor &#123;</span><br><span class=\"line\">\t\t\t\trf.mu.Lock()</span><br><span class=\"line\">\t\t\t\tif !(rf.lastApplied &lt; rf.commitedIndex &amp;&amp; rf.lastApplied &lt; rf.logs[rf.getLen()].Index) &#123;</span><br><span class=\"line\">\t\t\t\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t\t\t\tbreak</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tFirstIndex :&#x3D; rf.logs[0].Index</span><br><span class=\"line\">\t\t\t\tif rf.lastApplied+1 &gt;&#x3D; FirstIndex &#123;</span><br><span class=\"line\">\t\t\t\t\tindex :&#x3D; min(rf.lastApplied+1-FirstIndex, rf.getLen())</span><br><span class=\"line\">\t\t\t\t\tmsg :&#x3D; ApplyMsg&#123;CommandValid: true, Command: rf.logs[index].Command, CommandIndex: rf.lastApplied + 1&#125;</span><br><span class=\"line\">\t\t\t\t\trf.lastApplied++</span><br><span class=\"line\">\t\t\t\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t\t\t\t&#x2F;&#x2F;can&#39;t lock when send in channel, dead lock</span><br><span class=\"line\">\t\t\t\t\t&#x2F;&#x2F; canApplychan is to block the new</span><br><span class=\"line\">\t\t\t\t\trf.chanCanApply &lt;- 1</span><br><span class=\"line\">\t\t\t\t\trf.chanApplyMsg &lt;- msg</span><br><span class=\"line\">\t\t\t\t\t&lt;-rf.chanCanApply</span><br><span class=\"line\">\t\t\t\t\trf.mu.Lock()</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n\n        <h3 id=\"PartC\"   >\n          <a href=\"#PartC\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>PartC</h3>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (rf *Raft) InstallSnapshot(args *InstallSnapshotArgs, reply *InstallSnapshotReply) &#123;</span><br><span class=\"line\">\trf.chanCanApply &lt;- 1</span><br><span class=\"line\">\trf.mu.Lock()</span><br><span class=\"line\">\treply.Success &#x3D; false</span><br><span class=\"line\">\tpersistFlag :&#x3D; 0</span><br><span class=\"line\">\tif args.Term &lt; rf.currentTerm &#123;</span><br><span class=\"line\">\t\treply.Term &#x3D; rf.currentTerm</span><br><span class=\"line\">\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t&lt;-rf.chanCanApply</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif rf.currentTerm &lt; args.Term &#123;</span><br><span class=\"line\">\t\trf.currentTerm &#x3D; args.Term</span><br><span class=\"line\">\t\trf.ClearChan()</span><br><span class=\"line\">\t\trf.voteFor &#x3D; -1</span><br><span class=\"line\">\t\trf.state &#x3D; Follower</span><br><span class=\"line\">\t\tpersistFlag &#x3D; 1</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treply.Term &#x3D; rf.currentTerm</span><br><span class=\"line\">\t&#x2F;&#x2F; similar to appendEntries receive call</span><br><span class=\"line\">\trf.chanAppendEntries &lt;- 1</span><br><span class=\"line\">\tfirstIndex :&#x3D; rf.logs[0].Index</span><br><span class=\"line\">\tnowIndex :&#x3D; args.LastIncludeIndex - firstIndex</span><br><span class=\"line\">\tif nowIndex &lt; 0 &#123;</span><br><span class=\"line\">\t\tif persistFlag &#x3D;&#x3D; 1 &#123;</span><br><span class=\"line\">\t\t\trf.persist()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treply.PrevIndex &#x3D; firstIndex</span><br><span class=\"line\">\t\trf.mu.Unlock()</span><br><span class=\"line\">\t\t&lt;-rf.chanCanApply</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\trf.logs &#x3D; args.Logs</span><br><span class=\"line\">\trf.lastApplied &#x3D; args.LastIncludeIndex</span><br><span class=\"line\">\trf.commitedIndex &#x3D; args.LeaderCommitIndex</span><br><span class=\"line\">\trf.persister.SaveStateAndSnapshot(rf.getPersistByte(), args.Snapshot)</span><br><span class=\"line\">\tmsg :&#x3D; ApplyMsg&#123;CommandValid: false, Snapshot: args.Snapshot&#125;</span><br><span class=\"line\">\trf.mu.Unlock()</span><br><span class=\"line\">\trf.chanApplyMsg &lt;- msg</span><br><span class=\"line\">\t&lt;-rf.chanCanApply</span><br><span class=\"line\">\treply.Success &#x3D; true</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; Snapshotload</span><br><span class=\"line\">rf.readPersist(persister.ReadRaftState())</span><br></pre></td></tr></table></div></figure>\n<p>SaftyRequestVote RPCTermTerm</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (rf *Raft) updateCommit() &#123;</span><br><span class=\"line\">\tN :&#x3D; rf.commitedIndex</span><br><span class=\"line\">\tFirstIndex :&#x3D; rf.logs[0].Index</span><br><span class=\"line\">\tfor i :&#x3D; max(rf.commitedIndex+1, FirstIndex+1); i &lt;&#x3D; rf.logs[rf.getLen()].Index; i++ &#123;</span><br><span class=\"line\">\t\tnum :&#x3D; 1</span><br><span class=\"line\">\t\tfor j :&#x3D; range rf.peers &#123;</span><br><span class=\"line\">\t\t\tif j !&#x3D; rf.me &#123;</span><br><span class=\"line\">\t\t\t\tif rf.matchIndex[j] &gt;&#x3D; i &#123;</span><br><span class=\"line\">\t\t\t\t\t&#x2F;*</span><br><span class=\"line\">\t\t\t\t\t\tthis part is paper 5.4.2 limit, only can count replicate when log&#39;s term</span><br><span class=\"line\">\t\t\t\t\t\tis equals to currentTerm</span><br><span class=\"line\">\t\t\t\t\t*&#x2F;</span><br><span class=\"line\">\t\t\t\t\tif rf.logs[i-FirstIndex].Term &#x3D;&#x3D; rf.currentTerm &#123;</span><br><span class=\"line\">\t\t\t\t\t\tnum++</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tif num &gt; len(rf.peers)&#x2F;2 &#123;</span><br><span class=\"line\">\t\t\tN &#x3D; i</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif N &gt; rf.commitedIndex &amp;&amp; rf.state &#x3D;&#x3D; Leader &#123;</span><br><span class=\"line\">\t\trf.commitedIndex &#x3D; min(N, rf.logs[rf.getLen()].Index)</span><br><span class=\"line\">\t\trf.chanCommit &lt;- 1</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>"},{"title":"","date":"2019-08-28T13:08:38.000Z","_content":"\n<!-- ---\ntitle: \nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 11:08:38 +0800'\ncategory: \nsummary: Distributed System Consistency and Consensus\nthumbnail: distributed-system.png\n--- -->\n\n# \n1. [](#PromiseAbstraction)  \n   1.1 [](#1.1)  \n2. [](#atomic)  \n   2.1 [](#2.1)  \n   2.2 [](#2.2)  \n        2.2.1 [](#2.2.1)  \n        2.2.2 [](#2.2.2)  \n3. [](#Capability)  \n   3.1  [](#3.1)  \n   3.2  [](#3.2)  \n4. [ShareNote](#ShareNote)  \n\n# <a id=\"PromiseAbstraction\"><span class=\"toptitle\"></span></a>\n\n## <a id=\"1.1\"><span class=\"secondtitle\">()</span></a>\nN>=2)  \nAuroraRiakCassandra\n\n\n\n### \nMVCC   \n  \n  \n\n# <a id=\"atomic\"><span class=\"toptitle\"></span></a>\n## <a id=\"2.1\"><span class=\"secondtitle\"></span></a>\nDDIA9\n   \n### \n\n<!-- ![](/assets/img/posts/non-linearized-example.png)   -->\n{% asset_img non-linearized-example.png  %}\n\n  \nRefereeAliceSlave-1 BobSlave-2AliceBob\n\n### <span class=\"thirdtitle\"></span>\n\n<b><font color=\"#FF0000\"> </font></b>  \n  \n:\n   \n -> -> ->   \n![](https://ray1888.github.io/distributed-system/2019/08/20/chanllange-of-distributed-system/)  \n\n X)  \n<!-- ![](/assets/img/posts/generate-line.png)   -->\n{% asset_img generate-line.png  %}\n\n1. read(x)  Xv\n2. write(x,v) XVr()\n\nreadwriteread2  \n1. readwrite(0)  \n2. readwrite (1)  \n\n  \n<!-- ![](/assets/img/posts/more-detail-line.png)   -->\n{% asset_img more-detail-line.png  %}\nx01  \n AX1BA  \nB11  \n<!-- ![](/assets/img/posts/line-final.png) -->\n{% asset_img line-final.png  %}\n\n\n```\nCAS(compare and swap):\n```\n\n  \n \nAcCasx42casA4\n\n```\n//\n#### \n\n#### \n  \n```\n\n### <span class=\"thirdtitle\"></span>\n1. \nEtcdZooKeeper\n2. \n\n3. \n\n\n### \n#### \n\n1. \n  \n    1. \n    2. \n2. \n\n3. \n\n4. \nDynamoQuroumQuroum\n\nQuroum  \n   \n\n<!-- ![QuroumFail](/assets/img/posts/quroum-fail.png)   -->\n{% asset_img quroum-fail.png QuroumFail %}\n\nQuroumAliceBobQuroum\n\n### \n\n<font color=\"#FF0000\"></font>\n\n\n\n\nCAP\n```\nCAP : \n```\nCAP\n\n\n\n\n## <a id=\"2.2\"><span class=\"secondtitle\"></span></a>\n\n\n### <a id=\"2.2.1\"><span class=\"thirdtitle\"></span>\n#### <span class=\"fourth\"></span>\n\n \n\n#### <span class=\"fourth\"></span>\n\n513  \n{a,b}  {b,c}  \n\n  \n  \n    \n    \n    \n  \n  \n\n#### <span class=\"fourth\"></span>\n\n\n\n\n#### <span class=\"fourth\"></span>\n  \n  \n ABAB    \n  \n\n  \n  \n    1.   \n    2. Timestamp  \n    3. A1-1000B1001-2000  \n\n  \n?  \n1ID  \n2   \n3 sharding1-1000  \n\n  \n\nLeslie LamportLamport TimeStamp  \n\n#### <span class=\"fourth\">LamportTimeStamp</span>\n<!-- ![LamportTimeStamp](/assets/img/posts/LamportTimestamp.png)   -->\n{% asset_img LamportTimestamp.png LamportTimeStamp %}\n0 LamportRaftRPCRaftTermRaft\n\nLamportTimeStamp  \n  \n        \n  \n    1.   \n    2.   \n\n\n\n\n### <a id=\"2.2.2\"><span class=\"thirdtitle\"></span></a>\n  \n  \n   \n    1.   \n    2.   \n\n#### <span class=\"fourth\"></span>\nZookeeperEtcd  \n\n  \n\n  \n  \n    1.    \n    2.Fencing  \n\n#### \n  \n  \n    1.   \n    2.   \n    3.   \n  \n\n    1. ETCD  \n    2. ZooKeeper  \n    3.   \n\nCAS\n\n# <a id=\"Capability\"><span class=\"toptitle\"></span></a>\n   \n  \n    1.   \n    2.   \n2PC2ZooKeeper Raft  \n\n## <a id=\"3.1\"><span class=\"secondtitle\"> </span></a>\n  \n  \n  \n  \n    1.   \n    2.   \n\n  \n    1.     \n    2.   \n    3.   \n  \n\n   \n--  \n\n  \n\n### 2PC \n2PC\n\n##### 2PC\n1. ID\n2. ID\n3. ID\n4. \n5. WAL\n6. / ()\n\n\n\n2pc\n\n2PC\n\n### \n### \n\n+MQ\n\n\n\n\n<b></b>\n\nXA\n\n## <a id=\"3.2\"><span class=\"secondtitle\"></span></a>\n \n\n\n    1. \n    2. \n    3. V, V\n    4. \n\n  \n  \n  \n  \n\n\n\n### \n\n(RaftPaxosZab)  \n\n   \n\n\n\n1. \n2. \n3.  \n4. \n\n### Epoch  Quorum\n\nEpoch\nEpochEpoch\nQuorumEpoch\n\n\n1.  2.\n\n QuorumEpoch\n\n2PC 2PC\n\n### \n\n\n\n\n1. \n2. 3\n3. \n4. \n5. \n\n### \n\nZooKeeperEtcdAPI\n\n#### \n\n1. \n\n2. \nFencing\n3. \n\n4. \n\n\n#### \n1. \n(Yarn)Multi-RaftShardMaster)\n2. \n(consul)\n3. \n\n\n### \nMit6.824PingCap tikv \n\n\n# <a id=\"ShareNote\">ShareNote</a>\n1. [Dynamo](https://pdos.csail.mit.edu/6.824/papers/dynamo.pdf)\n2. [Riak](https://github.com/basho/riak_core)\n3. [Cassandra](http://cassandra.apache.org/)\n4. [](https://book.douban.com/subject/30329536/)","source":"_posts/distribute-system-consensus.md","raw":"---\ntitle: \ndate: 2019-08-28 21:08:38\ntags: distributed-system\n---\n\n<!-- ---\ntitle: \nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 11:08:38 +0800'\ncategory: \nsummary: Distributed System Consistency and Consensus\nthumbnail: distributed-system.png\n--- -->\n\n# \n1. [](#PromiseAbstraction)  \n   1.1 [](#1.1)  \n2. [](#atomic)  \n   2.1 [](#2.1)  \n   2.2 [](#2.2)  \n        2.2.1 [](#2.2.1)  \n        2.2.2 [](#2.2.2)  \n3. [](#Capability)  \n   3.1  [](#3.1)  \n   3.2  [](#3.2)  \n4. [ShareNote](#ShareNote)  \n\n# <a id=\"PromiseAbstraction\"><span class=\"toptitle\"></span></a>\n\n## <a id=\"1.1\"><span class=\"secondtitle\">()</span></a>\nN>=2)  \nAuroraRiakCassandra\n\n\n\n### \nMVCC   \n  \n  \n\n# <a id=\"atomic\"><span class=\"toptitle\"></span></a>\n## <a id=\"2.1\"><span class=\"secondtitle\"></span></a>\nDDIA9\n   \n### \n\n<!-- ![](/assets/img/posts/non-linearized-example.png)   -->\n{% asset_img non-linearized-example.png  %}\n\n  \nRefereeAliceSlave-1 BobSlave-2AliceBob\n\n### <span class=\"thirdtitle\"></span>\n\n<b><font color=\"#FF0000\"> </font></b>  \n  \n:\n   \n -> -> ->   \n![](https://ray1888.github.io/distributed-system/2019/08/20/chanllange-of-distributed-system/)  \n\n X)  \n<!-- ![](/assets/img/posts/generate-line.png)   -->\n{% asset_img generate-line.png  %}\n\n1. read(x)  Xv\n2. write(x,v) XVr()\n\nreadwriteread2  \n1. readwrite(0)  \n2. readwrite (1)  \n\n  \n<!-- ![](/assets/img/posts/more-detail-line.png)   -->\n{% asset_img more-detail-line.png  %}\nx01  \n AX1BA  \nB11  \n<!-- ![](/assets/img/posts/line-final.png) -->\n{% asset_img line-final.png  %}\n\n\n```\nCAS(compare and swap):\n```\n\n  \n \nAcCasx42casA4\n\n```\n//\n#### \n\n#### \n  \n```\n\n### <span class=\"thirdtitle\"></span>\n1. \nEtcdZooKeeper\n2. \n\n3. \n\n\n### \n#### \n\n1. \n  \n    1. \n    2. \n2. \n\n3. \n\n4. \nDynamoQuroumQuroum\n\nQuroum  \n   \n\n<!-- ![QuroumFail](/assets/img/posts/quroum-fail.png)   -->\n{% asset_img quroum-fail.png QuroumFail %}\n\nQuroumAliceBobQuroum\n\n### \n\n<font color=\"#FF0000\"></font>\n\n\n\n\nCAP\n```\nCAP : \n```\nCAP\n\n\n\n\n## <a id=\"2.2\"><span class=\"secondtitle\"></span></a>\n\n\n### <a id=\"2.2.1\"><span class=\"thirdtitle\"></span>\n#### <span class=\"fourth\"></span>\n\n \n\n#### <span class=\"fourth\"></span>\n\n513  \n{a,b}  {b,c}  \n\n  \n  \n    \n    \n    \n  \n  \n\n#### <span class=\"fourth\"></span>\n\n\n\n\n#### <span class=\"fourth\"></span>\n  \n  \n ABAB    \n  \n\n  \n  \n    1.   \n    2. Timestamp  \n    3. A1-1000B1001-2000  \n\n  \n?  \n1ID  \n2   \n3 sharding1-1000  \n\n  \n\nLeslie LamportLamport TimeStamp  \n\n#### <span class=\"fourth\">LamportTimeStamp</span>\n<!-- ![LamportTimeStamp](/assets/img/posts/LamportTimestamp.png)   -->\n{% asset_img LamportTimestamp.png LamportTimeStamp %}\n0 LamportRaftRPCRaftTermRaft\n\nLamportTimeStamp  \n  \n        \n  \n    1.   \n    2.   \n\n\n\n\n### <a id=\"2.2.2\"><span class=\"thirdtitle\"></span></a>\n  \n  \n   \n    1.   \n    2.   \n\n#### <span class=\"fourth\"></span>\nZookeeperEtcd  \n\n  \n\n  \n  \n    1.    \n    2.Fencing  \n\n#### \n  \n  \n    1.   \n    2.   \n    3.   \n  \n\n    1. ETCD  \n    2. ZooKeeper  \n    3.   \n\nCAS\n\n# <a id=\"Capability\"><span class=\"toptitle\"></span></a>\n   \n  \n    1.   \n    2.   \n2PC2ZooKeeper Raft  \n\n## <a id=\"3.1\"><span class=\"secondtitle\"> </span></a>\n  \n  \n  \n  \n    1.   \n    2.   \n\n  \n    1.     \n    2.   \n    3.   \n  \n\n   \n--  \n\n  \n\n### 2PC \n2PC\n\n##### 2PC\n1. ID\n2. ID\n3. ID\n4. \n5. WAL\n6. / ()\n\n\n\n2pc\n\n2PC\n\n### \n### \n\n+MQ\n\n\n\n\n<b></b>\n\nXA\n\n## <a id=\"3.2\"><span class=\"secondtitle\"></span></a>\n \n\n\n    1. \n    2. \n    3. V, V\n    4. \n\n  \n  \n  \n  \n\n\n\n### \n\n(RaftPaxosZab)  \n\n   \n\n\n\n1. \n2. \n3.  \n4. \n\n### Epoch  Quorum\n\nEpoch\nEpochEpoch\nQuorumEpoch\n\n\n1.  2.\n\n QuorumEpoch\n\n2PC 2PC\n\n### \n\n\n\n\n1. \n2. 3\n3. \n4. \n5. \n\n### \n\nZooKeeperEtcdAPI\n\n#### \n\n1. \n\n2. \nFencing\n3. \n\n4. \n\n\n#### \n1. \n(Yarn)Multi-RaftShardMaster)\n2. \n(consul)\n3. \n\n\n### \nMit6.824PingCap tikv \n\n\n# <a id=\"ShareNote\">ShareNote</a>\n1. [Dynamo](https://pdos.csail.mit.edu/6.824/papers/dynamo.pdf)\n2. [Riak](https://github.com/basho/riak_core)\n3. [Cassandra](http://cassandra.apache.org/)\n4. [](https://book.douban.com/subject/30329536/)","slug":"distribute-system-consensus","published":1,"updated":"2021-01-21T07:27:35.444Z","_id":"ckk6h2epk0003eci51vj6gdyl","comments":1,"layout":"post","photos":[],"link":"","content":"<!-- ---\ntitle: \nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 11:08:38 +0800'\ncategory: \nsummary: Distributed System Consistency and Consensus\nthumbnail: distributed-system.png\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#PromiseAbstraction\"></a><br>1.1 <a href=\"#1.1\"></a>  </li>\n<li><a href=\"#atomic\"></a><br>2.1 <a href=\"#2.1\"></a><br>2.2 <a href=\"#2.2\"></a>  <pre><code> 2.2.1 [](#2.2.1)  \n 2.2.2 [](#2.2.2)  </code></pre>\n</li>\n<li><a href=\"#Capability\"></a><br>3.1  <a href=\"#3.1\"></a><br>3.2  <a href=\"#3.2\"></a>  </li>\n<li><a href=\"#ShareNote\">ShareNote</a>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"--\"   >\n          <a href=\"#--\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>()</h2>\n      <p>N&gt;=2)<br>AuroraRiakCassandra</p>\n<p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>MVCC <br><br>  </p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>DDIA9<br>   </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <!-- ![](/assets/img/posts/non-linearized-example.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/non-linearized-example.png\" class=\"\" title=\"\">\n\n<p><br>RefereeAliceSlave-1 BobSlave-2AliceBob</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><b><font color=\"#FF0000\"> </font></b><br><br>:<br> <br> -&gt; -&gt; -&gt; <br><img src=\"https://ray1888.github.io/distributed-system/2019/08/20/chanllange-of-distributed-system/\" alt=\"\">  </p>\n<p> X)  </p>\n<!-- ![](/assets/img/posts/generate-line.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/generate-line.png\" class=\"\" title=\"\">\n<p></p>\n<ol>\n<li>read(x)  Xv</li>\n<li>write(x,v) XVr()</li>\n</ol>\n<p>readwriteread2  </p>\n<ol>\n<li>readwrite(0)  </li>\n<li>readwrite (1)  </li>\n</ol>\n<p>  </p>\n<!-- ![](/assets/img/posts/more-detail-line.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/more-detail-line.png\" class=\"\" title=\"\">\n<p>x01<br> AX1BA<br>B11  </p>\n<!-- ![](/assets/img/posts/line-final.png) -->\n<img src=\"/2019/08/28/distribute-system-consensus/line-final.png\" class=\"\" title=\"\">\n<p><br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CAS(compare and swap):</span><br></pre></td></tr></table></div></figure>\n<p><br><br> <br>AcCasx42casA4</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;</span><br><span class=\"line\">#### </span><br><span class=\"line\"></span><br><span class=\"line\">#### </span><br><span class=\"line\">  </span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li><br>EtcdZooKeeper</li>\n<li><br></li>\n<li><br></li>\n</ol>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      \n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n<ol>\n<li><br>  <ol>\n<li></li>\n<li></li>\n</ol>\n</li>\n<li><br></li>\n<li><br></li>\n<li><br>DynamoQuroumQuroum</li>\n</ol>\n<p>Quroum<br>   </p>\n<!-- ![QuroumFail](/assets/img/posts/quroum-fail.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/quroum-fail.png\" class=\"\" title=\"QuroumFail\">\n\n<p>QuroumAliceBobQuroum</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><font color=\"#FF0000\"></font></p>\n<p><br></p>\n<p>CAP</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CAP : </span><br></pre></td></tr></table></div></figure>\n<p>CAP</p>\n<p><br></p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      \n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>513<br>{a,b}  {b,c}  </p>\n<p><br><br><br><br><br><br>  </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><br><br></p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><br><br> ABAB<br>  </p>\n<p><br><br>    1. <br>    2. Timestamp<br>    3. A1-1000B1001-2000  </p>\n<p><br>?<br>1ID<br>2 <br>3 sharding1-1000  </p>\n<p>  </p>\n<p>Leslie LamportLamport TimeStamp  </p>\n\n        <h4 id=\"LamportTimeStamp\"   >\n          <a href=\"#LamportTimeStamp\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>LamportTimeStamp</h4>\n      <!-- ![LamportTimeStamp](/assets/img/posts/LamportTimestamp.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/LamportTimestamp.png\" class=\"\" title=\"LamportTimeStamp\">\n<p>0 LamportRaftRPCRaftTermRaft</p>\n<p>LamportTimeStamp<br><br>    <br><br>    1. <br>    2. <br></p>\n<p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><br><br> <br>    1. <br>    2.   </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>ZookeeperEtcd  </p>\n<p>  </p>\n<p><br><br>    1.<br>    2.Fencing  </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><br><br>    1. <br>    2. <br>    3. <br><br><br>    1. ETCD<br>    2. ZooKeeper<br>    3.   </p>\n<p>CAS</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p> <br><br>    1. <br>    2. <br>2PC2ZooKeeper Raft  </p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p><br><br><br><br>    1. <br>    2.   </p>\n<p><br>    1. <br>    2. <br>    3. <br>  </p>\n<p><br>--  </p>\n<p>  </p>\n\n        <h3 id=\"2PC\"   >\n          <a href=\"#2PC\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2PC</h3>\n      <p>2PC</p>\n\n        <h5 id=\"2PC\"   >\n          <a href=\"#2PC\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2PC</h5>\n      <ol>\n<li>ID</li>\n<li>ID</li>\n<li>ID</li>\n<li></li>\n<li>WAL</li>\n<li>/ ()</li>\n</ol>\n<p><br><br>2pc</p>\n<p>2PC</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      \n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><br>+MQ</p>\n<p><br></p>\n<p><b></b></p>\n<p>XA</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p> </p>\n<p><br>    1. <br>    2. <br>    3. V, V<br>    4. </p>\n<p><br><br><br>  </p>\n<p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>(RaftPaxosZab)  </p>\n<p> <br></p>\n<p></p>\n<ol>\n<li></li>\n<li></li>\n<li> </li>\n<li></li>\n</ol>\n\n        <h3 id=\"Epoch--Quorum\"   >\n          <a href=\"#Epoch--Quorum\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Epoch  Quorum</h3>\n      <p>Epoch<br>EpochEpoch<br>QuorumEpoch<br></p>\n<p>1.  2.</p>\n<p> QuorumEpoch</p>\n<p>2PC 2PC</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p></p>\n<p></p>\n<ol>\n<li></li>\n<li>3</li>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>ZooKeeperEtcdAPI</p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n<ol>\n<li><br></li>\n<li><br>Fencing</li>\n<li><br></li>\n<li><br></li>\n</ol>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <ol>\n<li><br>(Yarn)Multi-RaftShardMaster)</li>\n<li><br>(consul)</li>\n<li><br></li>\n</ol>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>Mit6.824PingCap tikv </p>\n\n        <h1 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote</h1>\n      <ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://pdos.csail.mit.edu/6.824/papers/dynamo.pdf\" >Dynamo</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/basho/riak_core\" >Riak</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"http://cassandra.apache.org/\" >Cassandra</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://book.douban.com/subject/30329536/\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<!-- ---\ntitle: \nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 11:08:38 +0800'\ncategory: \nsummary: Distributed System Consistency and Consensus\nthumbnail: distributed-system.png\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#PromiseAbstraction\"></a><br>1.1 <a href=\"#1.1\"></a>  </li>\n<li><a href=\"#atomic\"></a><br>2.1 <a href=\"#2.1\"></a><br>2.2 <a href=\"#2.2\"></a>  <pre><code> 2.2.1 [](#2.2.1)  \n 2.2.2 [](#2.2.2)  </code></pre>\n</li>\n<li><a href=\"#Capability\"></a><br>3.1  <a href=\"#3.1\"></a><br>3.2  <a href=\"#3.2\"></a>  </li>\n<li><a href=\"#ShareNote\">ShareNote</a>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"--\"   >\n          <a href=\"#--\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>()</h2>\n      <p>N&gt;=2)<br>AuroraRiakCassandra</p>\n<p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>MVCC <br><br>  </p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>DDIA9<br>   </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <!-- ![](/assets/img/posts/non-linearized-example.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/non-linearized-example.png\" class=\"\" title=\"\">\n\n<p><br>RefereeAliceSlave-1 BobSlave-2AliceBob</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><b><font color=\"#FF0000\"> </font></b><br><br>:<br> <br> -&gt; -&gt; -&gt; <br><img src=\"https://ray1888.github.io/distributed-system/2019/08/20/chanllange-of-distributed-system/\" alt=\"\">  </p>\n<p> X)  </p>\n<!-- ![](/assets/img/posts/generate-line.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/generate-line.png\" class=\"\" title=\"\">\n<p></p>\n<ol>\n<li>read(x)  Xv</li>\n<li>write(x,v) XVr()</li>\n</ol>\n<p>readwriteread2  </p>\n<ol>\n<li>readwrite(0)  </li>\n<li>readwrite (1)  </li>\n</ol>\n<p>  </p>\n<!-- ![](/assets/img/posts/more-detail-line.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/more-detail-line.png\" class=\"\" title=\"\">\n<p>x01<br> AX1BA<br>B11  </p>\n<!-- ![](/assets/img/posts/line-final.png) -->\n<img src=\"/2019/08/28/distribute-system-consensus/line-final.png\" class=\"\" title=\"\">\n<p><br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CAS(compare and swap):</span><br></pre></td></tr></table></div></figure>\n<p><br><br> <br>AcCasx42casA4</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;</span><br><span class=\"line\">#### </span><br><span class=\"line\"></span><br><span class=\"line\">#### </span><br><span class=\"line\">  </span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li><br>EtcdZooKeeper</li>\n<li><br></li>\n<li><br></li>\n</ol>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      \n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n<ol>\n<li><br>  <ol>\n<li></li>\n<li></li>\n</ol>\n</li>\n<li><br></li>\n<li><br></li>\n<li><br>DynamoQuroumQuroum</li>\n</ol>\n<p>Quroum<br>   </p>\n<!-- ![QuroumFail](/assets/img/posts/quroum-fail.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/quroum-fail.png\" class=\"\" title=\"QuroumFail\">\n\n<p>QuroumAliceBobQuroum</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><font color=\"#FF0000\"></font></p>\n<p><br></p>\n<p>CAP</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CAP : </span><br></pre></td></tr></table></div></figure>\n<p>CAP</p>\n<p><br></p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      \n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>513<br>{a,b}  {b,c}  </p>\n<p><br><br><br><br><br><br>  </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><br><br></p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><br><br> ABAB<br>  </p>\n<p><br><br>    1. <br>    2. Timestamp<br>    3. A1-1000B1001-2000  </p>\n<p><br>?<br>1ID<br>2 <br>3 sharding1-1000  </p>\n<p>  </p>\n<p>Leslie LamportLamport TimeStamp  </p>\n\n        <h4 id=\"LamportTimeStamp\"   >\n          <a href=\"#LamportTimeStamp\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>LamportTimeStamp</h4>\n      <!-- ![LamportTimeStamp](/assets/img/posts/LamportTimestamp.png)   -->\n<img src=\"/2019/08/28/distribute-system-consensus/LamportTimestamp.png\" class=\"\" title=\"LamportTimeStamp\">\n<p>0 LamportRaftRPCRaftTermRaft</p>\n<p>LamportTimeStamp<br><br>    <br><br>    1. <br>    2. <br></p>\n<p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><br><br> <br>    1. <br>    2.   </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>ZookeeperEtcd  </p>\n<p>  </p>\n<p><br><br>    1.<br>    2.Fencing  </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><br><br>    1. <br>    2. <br>    3. <br><br><br>    1. ETCD<br>    2. ZooKeeper<br>    3.   </p>\n<p>CAS</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p> <br><br>    1. <br>    2. <br>2PC2ZooKeeper Raft  </p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p><br><br><br><br>    1. <br>    2.   </p>\n<p><br>    1. <br>    2. <br>    3. <br>  </p>\n<p><br>--  </p>\n<p>  </p>\n\n        <h3 id=\"2PC\"   >\n          <a href=\"#2PC\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2PC</h3>\n      <p>2PC</p>\n\n        <h5 id=\"2PC\"   >\n          <a href=\"#2PC\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2PC</h5>\n      <ol>\n<li>ID</li>\n<li>ID</li>\n<li>ID</li>\n<li></li>\n<li>WAL</li>\n<li>/ ()</li>\n</ol>\n<p><br><br>2pc</p>\n<p>2PC</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      \n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><br>+MQ</p>\n<p><br></p>\n<p><b></b></p>\n<p>XA</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p> </p>\n<p><br>    1. <br>    2. <br>    3. V, V<br>    4. </p>\n<p><br><br><br>  </p>\n<p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>(RaftPaxosZab)  </p>\n<p> <br></p>\n<p></p>\n<ol>\n<li></li>\n<li></li>\n<li> </li>\n<li></li>\n</ol>\n\n        <h3 id=\"Epoch--Quorum\"   >\n          <a href=\"#Epoch--Quorum\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Epoch  Quorum</h3>\n      <p>Epoch<br>EpochEpoch<br>QuorumEpoch<br></p>\n<p>1.  2.</p>\n<p> QuorumEpoch</p>\n<p>2PC 2PC</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p></p>\n<p></p>\n<ol>\n<li></li>\n<li>3</li>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>ZooKeeperEtcdAPI</p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n<ol>\n<li><br></li>\n<li><br>Fencing</li>\n<li><br></li>\n<li><br></li>\n</ol>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <ol>\n<li><br>(Yarn)Multi-RaftShardMaster)</li>\n<li><br>(consul)</li>\n<li><br></li>\n</ol>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>Mit6.824PingCap tikv </p>\n\n        <h1 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote</h1>\n      <ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://pdos.csail.mit.edu/6.824/papers/dynamo.pdf\" >Dynamo</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/basho/riak_core\" >Riak</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"http://cassandra.apache.org/\" >Cassandra</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://book.douban.com/subject/30329536/\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n"},{"title":"","date":"2019-08-21T13:07:38.000Z","_content":"\n<!-- ---\n\nauthor: Ray Chan(ray1888)\ndate: 2019-08-20 11:07:38\ncategory: \nsummary: introduction of distributed system and its problem\nthumbnail: distributed-system.png\n--- -->\n\n#  \n1. [](#Introduction)  \n2. [](#Purpose)  \n   2.1 [](#2.1)  \n   2.2 [](#2.2)  \n   2.3 [](#2.3)  \n3. [](#Problem)  \n   3.1 [](#3.1)  \n   3.2 [](#3.2)  \n   3.3 [](#3.3)  \n4. [](#ConditionAssumtion)  \n   4.1 [](#4.1)  \n   4.2 [](#4.2)  \n5. [ShareNote](#ShareNote)  \n\n\n# <a id=\"Introduction\"><span class=\"toptitle\">#</span></a>\n\n### \n\n```\n// Definantion from IBM Site \nA distributed computer system consists of multiple software components that are on multiple computers, but run as a single system. The computers that are in a distributed \nsystem can be physically close together and connected by a local network, or they can be geographically distant and connected by a wide area network. A distributed system can consist of any number of possible configurations, such as mainframes, personal computers, workstations, minicomputers, and so on. The goal of distributed computing is to make such a network work as a single computer.\n```\n\n\n  \n\n# <a id=\"Purpose\"><span class=\"toptitle\">#</span></a>\n\n###  <a id=\"2.1\"><span class=\"secondtitle\">2.1. </span></a>\n\n  \n\n1.Scale UP  \n:\n  \n    1.   \n    2.   \n    3.   \n   SAN(storage area network)  \n\n2.Scale Out()  \n  \nbigtabledistributed filesystem mapreduce)  \n    1. HDDNVME SSD  \n    2.   \n    3.   \n\n### <a id=\"2.2\"><span class=\"secondtitle\">2.2 </span></a>\n1. (Scalability)  \n2. (Redundancy)  \n\n### <a id=\"2.3\"><span class=\"secondtitle\">2.3 </span></a>\n  \n1.   \n  \n2.   \n  \n3.   \n\n\n# <a id=\"Problem\"><span class=\"toptitle\"></span></a>\nDDIA8  \n    \n  \n```\n\n```\n\n### \n1. 7*24\n2. \n3. IP(Fiber Channel)\n\n  \n\n4. \n5. \n\n<b><font color=\"#FF0000\"></font></b>\n\n### <strong><font color=\"#FF0000\"></font></strong>\n1.   \n2.   \n3.   \n\n## <a id=\"3.1\"><span class=\"secondtitle\"></span></a>\n\n\n\n1.   \n2.   \n3.   \n4.   \n5.   \n6.    \n\n\n\n```\nNetwork Partition\n```\n\n() \n\n\n```\n\n1. \n2. \n3. \n4. Rabbitmqweb\n5. \n```\n\n\n### \n\n\n   \n1.   \n2.   \n\n#### \n TCP/IP  \n   \n\n```\n// \n1. \n2. Linux\n3. TCP\n```\n\n#### \n  \n1.   \n2.   \n3.   \n\n,\n\n```\n1. Akka Cassandra Hytrsix\n2. AIOPSAPM(Application Performance Metric)\n```\n\n## <a id=\"3.2\"><span class=\"secondtitle\"></span></a>\n\n\n\n1. \n2. \n\n### \n\n1. \n2. NTPChrony\n\n\n1. \n2.  \n3. NTP>=10Chrony\n4. \n\nGoogleSpannerGPS5\n\n### \n\n\n1. \n:API\n2. \nID\n\n#### \n\n<!-- ![](/assets/img/posts/TimeJump.png)   -->\n{% asset_img TimeJump.png  %}\n\n\n\n<b><font color=\"\">1.  </font> </b><br>\nLinuxdateapi\n\n\n<b><font color=\"\">2. </font></b><br>\n     \n    \n    1.     \n    2.     \n\n#### \n\n\n#### \n\nRaftPaxosRiakAB  \n<!-- ![](/assets/img/posts/Time&EventMissmatch.png) -->\n{% asset_img Time&EventMissmatch.png  %}\nBABAABBBA  \n  \n\n#### \n\n<b>1   </b>  \n<!-- ![](/assets/img/posts/SchdulerTimeJump.png)   -->\n{% asset_img SchdulerTimeJump.png  %}\n     \n       \n        \n    last    \n        \n      \n  \n<b>2  </b><br>\n        \n    Ceph Mgrint64  \n      \n      \n      \n      \n\n#### \n ID\n\n \n\n## <a id=\"3.3\"><span class=\"secondtitle\"></span></a>\n\n\n1. GCGC(Garbage collection) halt\n2. \n3. \n4. \n5. fsync\n6. \n\n# <a id=\"ConditionAssumtion\"><span class=\"toptitle\">#</span></a>\n\nDDIA8    \n\n## <a id=\"4.1\"><span class=\"secondtitle\"></span></a>\n.\n```\n1. \n2. \n3. GC halt\n```\n    \nQuorumm>=(n+1)/2,\n\n\n```\n\n1. Multi-Raft\n2. \n```\n\n### <span class=\"thirdtitle\"></span>\n\n  \n<!-- ![](/assets/img/posts/lockingproblem.png)   -->\n{% asset_img lockingproblem.png  %}\nAhaltGC\nA haltBAHaltA\n  \n### <span class=\"thirdtitle\"></span>\nFencing()  \n<!-- ![Fencing](/assets/img/posts/lockingproblem2.png)   -->\n{% asset_img lockingproblem2.png Fencing %}\nA33 B34  \nB3435 A33  \n\n\n\n## <a id=\"4.2\"><span class=\"secondtitle\"></span></a>\n \n\n<h3><b><span class=\"thirdtitle\"></span></b></h3>\n#### \n\n#### \n\n#### \n\n\n<h3><b><span class=\"thirdtitle\"></span></b></h3>\n#### -\n\n#### -\n\n#### \n  \n + \n\n -+  \n\n### <span class=\"thirdtitle\"></span>\n1.   \n  \n2.   \nxtx yty, xytx < ty  \n3.   \n  \n\n#### \nFLP  \n   \n   \n\n  \n  \n\n# <a id=\"ShareNote\"><span class=\"toptitle\">ShareNote</span></a>\nPS: PDF[](https://github.com/hyhlinux/DDIA/blob/master/ch8.md)\n1. [IBM Defination of Distributed System](https://www.ibm.com/support/knowledgecenter/en/SSAL2T_8.2.0/com.ibm.cics.tx.doc/concepts/c_wht_is_distd_comptg.html)\n2. [](https://book.douban.com/subject/30329536/)\n3. [FLP Impossibility](https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/)\n4. [](https://en.wikipedia.org/wiki/Byzantine_fault)\n5. [](https://www.usenix.org/legacy/events/osdi99/full_papers/castro/castro_html/castro.html)\n6. [Riak](https://github.com/basho/riak_core)","source":"_posts/intro-distributed-system.md","raw":"---\ntitle: \ndate: 2019-08-21 21:07:38\ntags: distributed-system\n---\n\n<!-- ---\n\nauthor: Ray Chan(ray1888)\ndate: 2019-08-20 11:07:38\ncategory: \nsummary: introduction of distributed system and its problem\nthumbnail: distributed-system.png\n--- -->\n\n#  \n1. [](#Introduction)  \n2. [](#Purpose)  \n   2.1 [](#2.1)  \n   2.2 [](#2.2)  \n   2.3 [](#2.3)  \n3. [](#Problem)  \n   3.1 [](#3.1)  \n   3.2 [](#3.2)  \n   3.3 [](#3.3)  \n4. [](#ConditionAssumtion)  \n   4.1 [](#4.1)  \n   4.2 [](#4.2)  \n5. [ShareNote](#ShareNote)  \n\n\n# <a id=\"Introduction\"><span class=\"toptitle\">#</span></a>\n\n### \n\n```\n// Definantion from IBM Site \nA distributed computer system consists of multiple software components that are on multiple computers, but run as a single system. The computers that are in a distributed \nsystem can be physically close together and connected by a local network, or they can be geographically distant and connected by a wide area network. A distributed system can consist of any number of possible configurations, such as mainframes, personal computers, workstations, minicomputers, and so on. The goal of distributed computing is to make such a network work as a single computer.\n```\n\n\n  \n\n# <a id=\"Purpose\"><span class=\"toptitle\">#</span></a>\n\n###  <a id=\"2.1\"><span class=\"secondtitle\">2.1. </span></a>\n\n  \n\n1.Scale UP  \n:\n  \n    1.   \n    2.   \n    3.   \n   SAN(storage area network)  \n\n2.Scale Out()  \n  \nbigtabledistributed filesystem mapreduce)  \n    1. HDDNVME SSD  \n    2.   \n    3.   \n\n### <a id=\"2.2\"><span class=\"secondtitle\">2.2 </span></a>\n1. (Scalability)  \n2. (Redundancy)  \n\n### <a id=\"2.3\"><span class=\"secondtitle\">2.3 </span></a>\n  \n1.   \n  \n2.   \n  \n3.   \n\n\n# <a id=\"Problem\"><span class=\"toptitle\"></span></a>\nDDIA8  \n    \n  \n```\n\n```\n\n### \n1. 7*24\n2. \n3. IP(Fiber Channel)\n\n  \n\n4. \n5. \n\n<b><font color=\"#FF0000\"></font></b>\n\n### <strong><font color=\"#FF0000\"></font></strong>\n1.   \n2.   \n3.   \n\n## <a id=\"3.1\"><span class=\"secondtitle\"></span></a>\n\n\n\n1.   \n2.   \n3.   \n4.   \n5.   \n6.    \n\n\n\n```\nNetwork Partition\n```\n\n() \n\n\n```\n\n1. \n2. \n3. \n4. Rabbitmqweb\n5. \n```\n\n\n### \n\n\n   \n1.   \n2.   \n\n#### \n TCP/IP  \n   \n\n```\n// \n1. \n2. Linux\n3. TCP\n```\n\n#### \n  \n1.   \n2.   \n3.   \n\n,\n\n```\n1. Akka Cassandra Hytrsix\n2. AIOPSAPM(Application Performance Metric)\n```\n\n## <a id=\"3.2\"><span class=\"secondtitle\"></span></a>\n\n\n\n1. \n2. \n\n### \n\n1. \n2. NTPChrony\n\n\n1. \n2.  \n3. NTP>=10Chrony\n4. \n\nGoogleSpannerGPS5\n\n### \n\n\n1. \n:API\n2. \nID\n\n#### \n\n<!-- ![](/assets/img/posts/TimeJump.png)   -->\n{% asset_img TimeJump.png  %}\n\n\n\n<b><font color=\"\">1.  </font> </b><br>\nLinuxdateapi\n\n\n<b><font color=\"\">2. </font></b><br>\n     \n    \n    1.     \n    2.     \n\n#### \n\n\n#### \n\nRaftPaxosRiakAB  \n<!-- ![](/assets/img/posts/Time&EventMissmatch.png) -->\n{% asset_img Time&EventMissmatch.png  %}\nBABAABBBA  \n  \n\n#### \n\n<b>1   </b>  \n<!-- ![](/assets/img/posts/SchdulerTimeJump.png)   -->\n{% asset_img SchdulerTimeJump.png  %}\n     \n       \n        \n    last    \n        \n      \n  \n<b>2  </b><br>\n        \n    Ceph Mgrint64  \n      \n      \n      \n      \n\n#### \n ID\n\n \n\n## <a id=\"3.3\"><span class=\"secondtitle\"></span></a>\n\n\n1. GCGC(Garbage collection) halt\n2. \n3. \n4. \n5. fsync\n6. \n\n# <a id=\"ConditionAssumtion\"><span class=\"toptitle\">#</span></a>\n\nDDIA8    \n\n## <a id=\"4.1\"><span class=\"secondtitle\"></span></a>\n.\n```\n1. \n2. \n3. GC halt\n```\n    \nQuorumm>=(n+1)/2,\n\n\n```\n\n1. Multi-Raft\n2. \n```\n\n### <span class=\"thirdtitle\"></span>\n\n  \n<!-- ![](/assets/img/posts/lockingproblem.png)   -->\n{% asset_img lockingproblem.png  %}\nAhaltGC\nA haltBAHaltA\n  \n### <span class=\"thirdtitle\"></span>\nFencing()  \n<!-- ![Fencing](/assets/img/posts/lockingproblem2.png)   -->\n{% asset_img lockingproblem2.png Fencing %}\nA33 B34  \nB3435 A33  \n\n\n\n## <a id=\"4.2\"><span class=\"secondtitle\"></span></a>\n \n\n<h3><b><span class=\"thirdtitle\"></span></b></h3>\n#### \n\n#### \n\n#### \n\n\n<h3><b><span class=\"thirdtitle\"></span></b></h3>\n#### -\n\n#### -\n\n#### \n  \n + \n\n -+  \n\n### <span class=\"thirdtitle\"></span>\n1.   \n  \n2.   \nxtx yty, xytx < ty  \n3.   \n  \n\n#### \nFLP  \n   \n   \n\n  \n  \n\n# <a id=\"ShareNote\"><span class=\"toptitle\">ShareNote</span></a>\nPS: PDF[](https://github.com/hyhlinux/DDIA/blob/master/ch8.md)\n1. [IBM Defination of Distributed System](https://www.ibm.com/support/knowledgecenter/en/SSAL2T_8.2.0/com.ibm.cics.tx.doc/concepts/c_wht_is_distd_comptg.html)\n2. [](https://book.douban.com/subject/30329536/)\n3. [FLP Impossibility](https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/)\n4. [](https://en.wikipedia.org/wiki/Byzantine_fault)\n5. [](https://www.usenix.org/legacy/events/osdi99/full_papers/castro/castro_html/castro.html)\n6. [Riak](https://github.com/basho/riak_core)","slug":"intro-distributed-system","published":1,"updated":"2021-01-21T07:27:34.188Z","_id":"ckk6h2epk0004eci5cgca101l","comments":1,"layout":"post","photos":[],"link":"","content":"<!-- ---\n\nauthor: Ray Chan(ray1888)\ndate: 2019-08-20 11:07:38\ncategory: \nsummary: introduction of distributed system and its problem\nthumbnail: distributed-system.png\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#Introduction\"></a>  </li>\n<li><a href=\"#Purpose\"></a><br>2.1 <a href=\"#2.1\"></a><br>2.2 <a href=\"#2.2\"></a><br>2.3 <a href=\"#2.3\"></a>  </li>\n<li><a href=\"#Problem\"></a><br>3.1 <a href=\"#3.1\"></a><br>3.2 <a href=\"#3.2\"></a><br>3.3 <a href=\"#3.3\"></a>  </li>\n<li><a href=\"#ConditionAssumtion\"></a><br>4.1 <a href=\"#4.1\"></a><br>4.2 <a href=\"#4.2\"></a>  </li>\n<li><a href=\"#ShareNote\">ShareNote</a>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>#</h1>\n      \n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; Definantion from IBM Site </span><br><span class=\"line\">A distributed computer system consists of multiple software components that are on multiple computers, but run as a single system. The computers that are in a distributed </span><br><span class=\"line\">system can be physically close together and connected by a local network, or they can be geographically distant and connected by a wide area network. A distributed system can consist of any number of possible configurations, such as mainframes, personal computers, workstations, minicomputers, and so on. The goal of distributed computing is to make such a network work as a single computer.</span><br></pre></td></tr></table></div></figure>\n<p><br>  </p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>#</h1>\n      \n        <h3 id=\"2-1-\"   >\n          <a href=\"#2-1-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2.1. </h3>\n      <p>  </p>\n<p>1.Scale UP<br>:<br><br>    1. <br>    2. <br>    3. <br>   SAN(storage area network)  </p>\n<p>2.Scale Out()<br><br>bigtabledistributed filesystem mapreduce)<br>    1. HDDNVME SSD<br>    2. <br>    3.   </p>\n\n        <h3 id=\"2-2-\"   >\n          <a href=\"#2-2-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2.2 </h3>\n      <ol>\n<li>(Scalability)  </li>\n<li>(Redundancy)  </li>\n</ol>\n\n        <h3 id=\"2-3-\"   >\n          <a href=\"#2-3-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2.3 </h3>\n      <p>  </p>\n<ol>\n<li><br>  </li>\n<li><br>  </li>\n<li>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>DDIA8<br><br>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li>7*24</li>\n<li></li>\n<li>IP(Fiber Channel)</li>\n</ol>\n<p>  </p>\n<ol start=\"4\">\n<li></li>\n<li></li>\n</ol>\n<p><b><font color=\"#FF0000\"></font></b></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p></p>\n<p></p>\n<ol>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n<li>   </li>\n</ol>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Network Partition</span><br></pre></td></tr></table></div></figure>\n<p>() </p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">1. </span><br><span class=\"line\">2. </span><br><span class=\"line\">3. </span><br><span class=\"line\">4. Rabbitmqweb</span><br><span class=\"line\">5. </span><br></pre></td></tr></table></div></figure>\n<p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p></p>\n<p>   </p>\n<ol>\n<li>  </li>\n<li>  </li>\n</ol>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> TCP/IP<br>   </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">1. </span><br><span class=\"line\">2. Linux</span><br><span class=\"line\">3. TCP</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>  </p>\n<ol>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n</ol>\n<p>,<br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. Akka Cassandra Hytrsix</span><br><span class=\"line\">2. AIOPSAPM(Application Performance Metric)</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p></p>\n<p></p>\n<ol>\n<li></li>\n<li></li>\n</ol>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p></p>\n<ol>\n<li></li>\n<li>NTPChrony</li>\n</ol>\n<p></p>\n<ol>\n<li></li>\n<li> </li>\n<li>NTP&gt;=10Chrony</li>\n<li></li>\n</ol>\n<p>GoogleSpannerGPS5</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p></p>\n<ol>\n<li><br>:API</li>\n<li><br>ID</li>\n</ol>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n<!-- ![](/assets/img/posts/TimeJump.png)   -->\n<img src=\"/2019/08/21/intro-distributed-system/TimeJump.png\" class=\"\" title=\"\">\n<p><br></p>\n<p><b><font color=\"\">1.  </font> </b><br><br>Linuxdateapi<br></p>\n<p><b><font color=\"\">2. </font></b><br><br> <br><br>    1. <br>    2.     </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>RaftPaxosRiakAB  </p>\n<!-- ![](/assets/img/posts/Time&EventMissmatch.png) -->\n<img src=\"/2019/08/21/intro-distributed-system/Time&EventMissmatch.png\" class=\"\" title=\"\">\n<p>BABAABBBA<br>  </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><b>1   </b>  </p>\n<!-- ![](/assets/img/posts/SchdulerTimeJump.png)   -->\n<img src=\"/2019/08/21/intro-distributed-system/SchdulerTimeJump.png\" class=\"\" title=\"\">\n<pre><code> \n   \n    \nlast    \n    \n  </code></pre>\n<p><b>2  </b><br><br>    <br>    Ceph Mgrint64<br>    <br>    <br>    <br>      </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> ID<br><br> </p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p></p>\n<ol>\n<li>GCGC(Garbage collection) halt</li>\n<li></li>\n<li></li>\n<li></li>\n<li>fsync</li>\n<li></li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>#</h1>\n      <p>DDIA8    </p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>.</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. </span><br><span class=\"line\">2. </span><br><span class=\"line\">3. GC halt</span><br></pre></td></tr></table></div></figure>\n<p><br>Quorumm&gt;=(n+1)/2,</p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">1. Multi-Raft</span><br><span class=\"line\">2. </span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><br>  </p>\n<!-- ![](/assets/img/posts/lockingproblem.png)   -->\n<img src=\"/2019/08/21/intro-distributed-system/lockingproblem.png\" class=\"\" title=\"\">\n<p>AhaltGC<br>A haltBAHaltA<br>  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>Fencing()  </p>\n<!-- ![Fencing](/assets/img/posts/lockingproblem2.png)   -->\n<img src=\"/2019/08/21/intro-distributed-system/lockingproblem2.png\" class=\"\" title=\"Fencing\">\n<p>A33 B34<br>B3435 A33<br></p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p> </p>\n<h3><b><span class=\"thirdtitle\"></span></b></h3>\n#### \n\n#### \n\n#### \n\n\n<h3><b><span class=\"thirdtitle\"></span></b></h3>\n#### -\n\n#### -\n\n#### \n  \n + \n\n<p> -+  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li><br>  </li>\n<li><br>xtx yty, xytx &lt; ty  </li>\n<li><br>  </li>\n</ol>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>FLP<br> <br>   </p>\n<p><br>  </p>\n\n        <h1 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote</h1>\n      <p>PS: PDF<span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/hyhlinux/DDIA/blob/master/ch8.md\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.ibm.com/support/knowledgecenter/en/SSAL2T_8.2.0/com.ibm.cics.tx.doc/concepts/c_wht_is_distd_comptg.html\" >IBM Defination of Distributed System</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://book.douban.com/subject/30329536/\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/\" >FLP Impossibility</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://en.wikipedia.org/wiki/Byzantine_fault\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.usenix.org/legacy/events/osdi99/full_papers/castro/castro_html/castro.html\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/basho/riak_core\" >Riak</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<!-- ---\n\nauthor: Ray Chan(ray1888)\ndate: 2019-08-20 11:07:38\ncategory: \nsummary: introduction of distributed system and its problem\nthumbnail: distributed-system.png\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#Introduction\"></a>  </li>\n<li><a href=\"#Purpose\"></a><br>2.1 <a href=\"#2.1\"></a><br>2.2 <a href=\"#2.2\"></a><br>2.3 <a href=\"#2.3\"></a>  </li>\n<li><a href=\"#Problem\"></a><br>3.1 <a href=\"#3.1\"></a><br>3.2 <a href=\"#3.2\"></a><br>3.3 <a href=\"#3.3\"></a>  </li>\n<li><a href=\"#ConditionAssumtion\"></a><br>4.1 <a href=\"#4.1\"></a><br>4.2 <a href=\"#4.2\"></a>  </li>\n<li><a href=\"#ShareNote\">ShareNote</a>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>#</h1>\n      \n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; Definantion from IBM Site </span><br><span class=\"line\">A distributed computer system consists of multiple software components that are on multiple computers, but run as a single system. The computers that are in a distributed </span><br><span class=\"line\">system can be physically close together and connected by a local network, or they can be geographically distant and connected by a wide area network. A distributed system can consist of any number of possible configurations, such as mainframes, personal computers, workstations, minicomputers, and so on. The goal of distributed computing is to make such a network work as a single computer.</span><br></pre></td></tr></table></div></figure>\n<p><br>  </p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>#</h1>\n      \n        <h3 id=\"2-1-\"   >\n          <a href=\"#2-1-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2.1. </h3>\n      <p>  </p>\n<p>1.Scale UP<br>:<br><br>    1. <br>    2. <br>    3. <br>   SAN(storage area network)  </p>\n<p>2.Scale Out()<br><br>bigtabledistributed filesystem mapreduce)<br>    1. HDDNVME SSD<br>    2. <br>    3.   </p>\n\n        <h3 id=\"2-2-\"   >\n          <a href=\"#2-2-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2.2 </h3>\n      <ol>\n<li>(Scalability)  </li>\n<li>(Redundancy)  </li>\n</ol>\n\n        <h3 id=\"2-3-\"   >\n          <a href=\"#2-3-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>2.3 </h3>\n      <p>  </p>\n<ol>\n<li><br>  </li>\n<li><br>  </li>\n<li>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>DDIA8<br><br>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li>7*24</li>\n<li></li>\n<li>IP(Fiber Channel)</li>\n</ol>\n<p>  </p>\n<ol start=\"4\">\n<li></li>\n<li></li>\n</ol>\n<p><b><font color=\"#FF0000\"></font></b></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p></p>\n<p></p>\n<ol>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n<li>   </li>\n</ol>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Network Partition</span><br></pre></td></tr></table></div></figure>\n<p>() </p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">1. </span><br><span class=\"line\">2. </span><br><span class=\"line\">3. </span><br><span class=\"line\">4. Rabbitmqweb</span><br><span class=\"line\">5. </span><br></pre></td></tr></table></div></figure>\n<p></p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p></p>\n<p>   </p>\n<ol>\n<li>  </li>\n<li>  </li>\n</ol>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> TCP/IP<br>   </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">1. </span><br><span class=\"line\">2. Linux</span><br><span class=\"line\">3. TCP</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>  </p>\n<ol>\n<li>  </li>\n<li>  </li>\n<li>  </li>\n</ol>\n<p>,<br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. Akka Cassandra Hytrsix</span><br><span class=\"line\">2. AIOPSAPM(Application Performance Metric)</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p></p>\n<p></p>\n<ol>\n<li></li>\n<li></li>\n</ol>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p></p>\n<ol>\n<li></li>\n<li>NTPChrony</li>\n</ol>\n<p></p>\n<ol>\n<li></li>\n<li> </li>\n<li>NTP&gt;=10Chrony</li>\n<li></li>\n</ol>\n<p>GoogleSpannerGPS5</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p></p>\n<ol>\n<li><br>:API</li>\n<li><br>ID</li>\n</ol>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n<!-- ![](/assets/img/posts/TimeJump.png)   -->\n<img src=\"/2019/08/21/intro-distributed-system/TimeJump.png\" class=\"\" title=\"\">\n<p><br></p>\n<p><b><font color=\"\">1.  </font> </b><br><br>Linuxdateapi<br></p>\n<p><b><font color=\"\">2. </font></b><br><br> <br><br>    1. <br>    2.     </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>RaftPaxosRiakAB  </p>\n<!-- ![](/assets/img/posts/Time&EventMissmatch.png) -->\n<img src=\"/2019/08/21/intro-distributed-system/Time&EventMissmatch.png\" class=\"\" title=\"\">\n<p>BABAABBBA<br>  </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><b>1   </b>  </p>\n<!-- ![](/assets/img/posts/SchdulerTimeJump.png)   -->\n<img src=\"/2019/08/21/intro-distributed-system/SchdulerTimeJump.png\" class=\"\" title=\"\">\n<pre><code> \n   \n    \nlast    \n    \n  </code></pre>\n<p><b>2  </b><br><br>    <br>    Ceph Mgrint64<br>    <br>    <br>    <br>      </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> ID<br><br> </p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p></p>\n<ol>\n<li>GCGC(Garbage collection) halt</li>\n<li></li>\n<li></li>\n<li></li>\n<li>fsync</li>\n<li></li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>#</h1>\n      <p>DDIA8    </p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>.</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. </span><br><span class=\"line\">2. </span><br><span class=\"line\">3. GC halt</span><br></pre></td></tr></table></div></figure>\n<p><br>Quorumm&gt;=(n+1)/2,</p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">1. Multi-Raft</span><br><span class=\"line\">2. </span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p><br>  </p>\n<!-- ![](/assets/img/posts/lockingproblem.png)   -->\n<img src=\"/2019/08/21/intro-distributed-system/lockingproblem.png\" class=\"\" title=\"\">\n<p>AhaltGC<br>A haltBAHaltA<br>  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>Fencing()  </p>\n<!-- ![Fencing](/assets/img/posts/lockingproblem2.png)   -->\n<img src=\"/2019/08/21/intro-distributed-system/lockingproblem2.png\" class=\"\" title=\"Fencing\">\n<p>A33 B34<br>B3435 A33<br></p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p> </p>\n<h3><b><span class=\"thirdtitle\"></span></b></h3>\n#### \n\n#### \n\n#### \n\n\n<h3><b><span class=\"thirdtitle\"></span></b></h3>\n#### -\n\n#### -\n\n#### \n  \n + \n\n<p> -+  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li><br>  </li>\n<li><br>xtx yty, xytx &lt; ty  </li>\n<li><br>  </li>\n</ol>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>FLP<br> <br>   </p>\n<p><br>  </p>\n\n        <h1 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote</h1>\n      <p>PS: PDF<span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/hyhlinux/DDIA/blob/master/ch8.md\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.ibm.com/support/knowledgecenter/en/SSAL2T_8.2.0/com.ibm.cics.tx.doc/concepts/c_wht_is_distd_comptg.html\" >IBM Defination of Distributed System</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://book.douban.com/subject/30329536/\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/\" >FLP Impossibility</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://en.wikipedia.org/wiki/Byzantine_fault\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.usenix.org/legacy/events/osdi99/full_papers/castro/castro_html/castro.html\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/basho/riak_core\" >Riak</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n"},{"title":"Go","date":"2019-09-03T02:07:38.000Z","_content":"\n\n<!-- ---\nlayout: post\ntitle: \nauthor: Ray Chan(ray1888)\ndate: '2019-09-03 10:07:38 +0800'\ncategory: go\nsummary: Go Slice \nthumbnail: go.png\n--- -->\n\n\n\n# \n\n##  \n```\nvar a []int\n//  (\nappend(a, 0)\n// (\nappend(a, []int{1,2,3}...)\n```\n\n## \n```\nvar a []int\n//  (  \na = append([]int{1}, a...)\n// (  \na = append([]int{1,2,3}, a...)  \n```\n\n## \n  \n```\nvar a []int\na = append(a[:i], append([]int{1,2}, a[i:]...)...)  // i\na = append(a[:i], append([]int{1}, a[i:]...)...)     //  i\n```\n\n\n```\n//  \na = append(a, 0)\ncopy(a[i+1:],  a[i:])\na[i] = x \n\n//  (\n//  b= []int{1,2,3}\na = append(a,b..)\ncopy(a[i+len(b):],  a[i:])\ncopy(a[i:], b) \n```\n\n\n# \n\n## \n```\na = []int{1,2,3}\n// \na = a[:len(a)-1]\n// \na = a[:len(a)-N]\n```\n\n## \n```\na = []int{1,2,3}\n// \na = a[1:]\n// \na = a[N:]\n```\n  \n()   \n```\na = []int{1,2,3}\n// \na = append(a[:0], a[1:]...)  \n// \na =  append(a[:0], a[N:]...)  \n\n//  Copy\na = []int{1,2,3}\na = a[:copy(a, a[1:])]\na = a[:copy(a, a[N:])]\n```\n\n## \n```\na = []int{1,2,3,4,5}\na = append(a[:i], a[i+1:]...)\na = append(a[:i], a[i+N:]...)\n\na = a[:i+copy(a[i:], a[i+1:])]\na = a[:i+copy(a[i:], a[i+N:])]\n```\n\n#   \n  \n```\ntype SliceHeader struct{\n    Data uintptr\n    Len   int  //  \n    Cap   int  //  \n}\n```\n\n<!-- ![goSlice](/assets/img/posts/GoSlice.png) -->\n{% asset_img GoSlice.png goSlice %}\n\n\n  \n\n<!-- ![goSliceE](/assets/img/posts/GoSliceExtend.png) -->\n{% asset_img GoSliceExtend.png goSliceE %}\n\n  \nSliceSliceReference Count   \n\n## \n1. appendlen = cap \n2. cap=0, len=0, nil, len($slice_name) == 0 \n\n## GC\nGC\n\n### \n```\nfunc FindPhoneNumber(filename string) []byte{\n\tb, _ := ioutil.ReadFile(filename)\n\treturn regexp.MustCompile(\"[0-9]+\").Find(b)\n}\n```\n\nbb  \n\n\n```\nfunc FindPhoneNumber(filename string) []byte{\n\tb, _ := ioutil.ReadFile(filename)\n\tb =  regexp.MustCompile(\"[0-9]+\").Find(b)\n    return append([]byte{}, b)\n}\n```\n\n### \n\n```\nvar a *[]int{1,2,3,4,4,5,6}\na = a[:len(a)-1] // \n```\n\n, nil\n```\nvar a *[]int{1,2,3,4,4,5,6}\na[len(a)-1] = nil\na = a[:len(a)-1] // \n```","source":"_posts/go-slice.md","raw":"---\ntitle: Go\ndate: 2019-09-03 10:07:38\ntags: Go\n---\n\n\n<!-- ---\nlayout: post\ntitle: \nauthor: Ray Chan(ray1888)\ndate: '2019-09-03 10:07:38 +0800'\ncategory: go\nsummary: Go Slice \nthumbnail: go.png\n--- -->\n\n\n\n# \n\n##  \n```\nvar a []int\n//  (\nappend(a, 0)\n// (\nappend(a, []int{1,2,3}...)\n```\n\n## \n```\nvar a []int\n//  (  \na = append([]int{1}, a...)\n// (  \na = append([]int{1,2,3}, a...)  \n```\n\n## \n  \n```\nvar a []int\na = append(a[:i], append([]int{1,2}, a[i:]...)...)  // i\na = append(a[:i], append([]int{1}, a[i:]...)...)     //  i\n```\n\n\n```\n//  \na = append(a, 0)\ncopy(a[i+1:],  a[i:])\na[i] = x \n\n//  (\n//  b= []int{1,2,3}\na = append(a,b..)\ncopy(a[i+len(b):],  a[i:])\ncopy(a[i:], b) \n```\n\n\n# \n\n## \n```\na = []int{1,2,3}\n// \na = a[:len(a)-1]\n// \na = a[:len(a)-N]\n```\n\n## \n```\na = []int{1,2,3}\n// \na = a[1:]\n// \na = a[N:]\n```\n  \n()   \n```\na = []int{1,2,3}\n// \na = append(a[:0], a[1:]...)  \n// \na =  append(a[:0], a[N:]...)  \n\n//  Copy\na = []int{1,2,3}\na = a[:copy(a, a[1:])]\na = a[:copy(a, a[N:])]\n```\n\n## \n```\na = []int{1,2,3,4,5}\na = append(a[:i], a[i+1:]...)\na = append(a[:i], a[i+N:]...)\n\na = a[:i+copy(a[i:], a[i+1:])]\na = a[:i+copy(a[i:], a[i+N:])]\n```\n\n#   \n  \n```\ntype SliceHeader struct{\n    Data uintptr\n    Len   int  //  \n    Cap   int  //  \n}\n```\n\n<!-- ![goSlice](/assets/img/posts/GoSlice.png) -->\n{% asset_img GoSlice.png goSlice %}\n\n\n  \n\n<!-- ![goSliceE](/assets/img/posts/GoSliceExtend.png) -->\n{% asset_img GoSliceExtend.png goSliceE %}\n\n  \nSliceSliceReference Count   \n\n## \n1. appendlen = cap \n2. cap=0, len=0, nil, len($slice_name) == 0 \n\n## GC\nGC\n\n### \n```\nfunc FindPhoneNumber(filename string) []byte{\n\tb, _ := ioutil.ReadFile(filename)\n\treturn regexp.MustCompile(\"[0-9]+\").Find(b)\n}\n```\n\nbb  \n\n\n```\nfunc FindPhoneNumber(filename string) []byte{\n\tb, _ := ioutil.ReadFile(filename)\n\tb =  regexp.MustCompile(\"[0-9]+\").Find(b)\n    return append([]byte{}, b)\n}\n```\n\n### \n\n```\nvar a *[]int{1,2,3,4,4,5,6}\na = a[:len(a)-1] // \n```\n\n, nil\n```\nvar a *[]int{1,2,3,4,4,5,6}\na[len(a)-1] = nil\na = a[:len(a)-1] // \n```","slug":"go-slice","published":1,"updated":"2021-01-21T07:12:15.553Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk6irar50001k9i59fu05t2q","content":"<!-- ---\nlayout: post\ntitle: \nauthor: Ray Chan(ray1888)\ndate: '2019-09-03 10:07:38 +0800'\ncategory: go\nsummary: Go Slice \nthumbnail: go.png\n--- -->\n\n\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a []int</span><br><span class=\"line\">&#x2F;&#x2F;  (</span><br><span class=\"line\">append(a, 0)</span><br><span class=\"line\">&#x2F;&#x2F; (</span><br><span class=\"line\">append(a, []int&#123;1,2,3&#125;...)</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a []int</span><br><span class=\"line\">&#x2F;&#x2F;  (  </span><br><span class=\"line\">a &#x3D; append([]int&#123;1&#125;, a...)</span><br><span class=\"line\">&#x2F;&#x2F; (  </span><br><span class=\"line\">a &#x3D; append([]int&#123;1,2,3&#125;, a...)  </span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a []int</span><br><span class=\"line\">a &#x3D; append(a[:i], append([]int&#123;1,2&#125;, a[i:]...)...)  &#x2F;&#x2F; i</span><br><span class=\"line\">a &#x3D; append(a[:i], append([]int&#123;1&#125;, a[i:]...)...)     &#x2F;&#x2F;  i</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  </span><br><span class=\"line\">a &#x3D; append(a, 0)</span><br><span class=\"line\">copy(a[i+1:],  a[i:])</span><br><span class=\"line\">a[i] &#x3D; x </span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;  (</span><br><span class=\"line\">&#x2F;&#x2F;  b&#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">a &#x3D; append(a,b..)</span><br><span class=\"line\">copy(a[i+len(b):],  a[i:])</span><br><span class=\"line\">copy(a[i:], b) </span><br></pre></td></tr></table></div></figure>\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a &#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; a[:len(a)-1]</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; a[:len(a)-N]</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a &#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; a[1:]</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; a[N:]</span><br></pre></td></tr></table></div></figure>\n\n<p>()   </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a &#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; append(a[:0], a[1:]...)  </span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D;  append(a[:0], a[N:]...)  </span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;  Copy</span><br><span class=\"line\">a &#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">a &#x3D; a[:copy(a, a[1:])]</span><br><span class=\"line\">a &#x3D; a[:copy(a, a[N:])]</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a &#x3D; []int&#123;1,2,3,4,5&#125;</span><br><span class=\"line\">a &#x3D; append(a[:i], a[i+1:]...)</span><br><span class=\"line\">a &#x3D; append(a[:i], a[i+N:]...)</span><br><span class=\"line\"></span><br><span class=\"line\">a &#x3D; a[:i+copy(a[i:], a[i+1:])]</span><br><span class=\"line\">a &#x3D; a[:i+copy(a[i:], a[i+N:])]</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type SliceHeader struct&#123;</span><br><span class=\"line\">    Data uintptr</span><br><span class=\"line\">    Len   int  &#x2F;&#x2F;  </span><br><span class=\"line\">    Cap   int  &#x2F;&#x2F;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<!-- ![goSlice](/assets/img/posts/GoSlice.png) -->\n<img src=\"/2019/09/03/go-slice/GoSlice.png\" class=\"\" title=\"goSlice\">\n\n\n<p>  </p>\n<!-- ![goSliceE](/assets/img/posts/GoSliceExtend.png) -->\n<img src=\"/2019/09/03/go-slice/GoSliceExtend.png\" class=\"\" title=\"goSliceE\">\n\n\n<p>SliceSliceReference Count   </p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <ol>\n<li>appendlen = cap </li>\n<li>cap=0, len=0, nil, len($slice_name) == 0 </li>\n</ol>\n\n        <h2 id=\"GC\"   >\n          <a href=\"#GC\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>GC</h2>\n      <p>GC</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func FindPhoneNumber(filename string) []byte&#123;</span><br><span class=\"line\">\tb, _ :&#x3D; ioutil.ReadFile(filename)</span><br><span class=\"line\">\treturn regexp.MustCompile(&quot;[0-9]+&quot;).Find(b)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>bb  </p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func FindPhoneNumber(filename string) []byte&#123;</span><br><span class=\"line\">\tb, _ :&#x3D; ioutil.ReadFile(filename)</span><br><span class=\"line\">\tb &#x3D;  regexp.MustCompile(&quot;[0-9]+&quot;).Find(b)</span><br><span class=\"line\">    return append([]byte&#123;&#125;, b)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a *[]int&#123;1,2,3,4,4,5,6&#125;</span><br><span class=\"line\">a &#x3D; a[:len(a)-1] &#x2F;&#x2F; </span><br></pre></td></tr></table></div></figure>\n<p>, nil</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a *[]int&#123;1,2,3,4,4,5,6&#125;</span><br><span class=\"line\">a[len(a)-1] &#x3D; nil</span><br><span class=\"line\">a &#x3D; a[:len(a)-1] &#x2F;&#x2F; </span><br></pre></td></tr></table></div></figure>","site":{"data":{}},"excerpt":"","more":"<!-- ---\nlayout: post\ntitle: \nauthor: Ray Chan(ray1888)\ndate: '2019-09-03 10:07:38 +0800'\ncategory: go\nsummary: Go Slice \nthumbnail: go.png\n--- -->\n\n\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a []int</span><br><span class=\"line\">&#x2F;&#x2F;  (</span><br><span class=\"line\">append(a, 0)</span><br><span class=\"line\">&#x2F;&#x2F; (</span><br><span class=\"line\">append(a, []int&#123;1,2,3&#125;...)</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a []int</span><br><span class=\"line\">&#x2F;&#x2F;  (  </span><br><span class=\"line\">a &#x3D; append([]int&#123;1&#125;, a...)</span><br><span class=\"line\">&#x2F;&#x2F; (  </span><br><span class=\"line\">a &#x3D; append([]int&#123;1,2,3&#125;, a...)  </span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a []int</span><br><span class=\"line\">a &#x3D; append(a[:i], append([]int&#123;1,2&#125;, a[i:]...)...)  &#x2F;&#x2F; i</span><br><span class=\"line\">a &#x3D; append(a[:i], append([]int&#123;1&#125;, a[i:]...)...)     &#x2F;&#x2F;  i</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  </span><br><span class=\"line\">a &#x3D; append(a, 0)</span><br><span class=\"line\">copy(a[i+1:],  a[i:])</span><br><span class=\"line\">a[i] &#x3D; x </span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;  (</span><br><span class=\"line\">&#x2F;&#x2F;  b&#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">a &#x3D; append(a,b..)</span><br><span class=\"line\">copy(a[i+len(b):],  a[i:])</span><br><span class=\"line\">copy(a[i:], b) </span><br></pre></td></tr></table></div></figure>\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a &#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; a[:len(a)-1]</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; a[:len(a)-N]</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a &#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; a[1:]</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; a[N:]</span><br></pre></td></tr></table></div></figure>\n\n<p>()   </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a &#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D; append(a[:0], a[1:]...)  </span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">a &#x3D;  append(a[:0], a[N:]...)  </span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;  Copy</span><br><span class=\"line\">a &#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">a &#x3D; a[:copy(a, a[1:])]</span><br><span class=\"line\">a &#x3D; a[:copy(a, a[N:])]</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a &#x3D; []int&#123;1,2,3,4,5&#125;</span><br><span class=\"line\">a &#x3D; append(a[:i], a[i+1:]...)</span><br><span class=\"line\">a &#x3D; append(a[:i], a[i+N:]...)</span><br><span class=\"line\"></span><br><span class=\"line\">a &#x3D; a[:i+copy(a[i:], a[i+1:])]</span><br><span class=\"line\">a &#x3D; a[:i+copy(a[i:], a[i+N:])]</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type SliceHeader struct&#123;</span><br><span class=\"line\">    Data uintptr</span><br><span class=\"line\">    Len   int  &#x2F;&#x2F;  </span><br><span class=\"line\">    Cap   int  &#x2F;&#x2F;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<!-- ![goSlice](/assets/img/posts/GoSlice.png) -->\n<img src=\"/2019/09/03/go-slice/GoSlice.png\" class=\"\" title=\"goSlice\">\n\n\n<p>  </p>\n<!-- ![goSliceE](/assets/img/posts/GoSliceExtend.png) -->\n<img src=\"/2019/09/03/go-slice/GoSliceExtend.png\" class=\"\" title=\"goSliceE\">\n\n\n<p>SliceSliceReference Count   </p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <ol>\n<li>appendlen = cap </li>\n<li>cap=0, len=0, nil, len($slice_name) == 0 </li>\n</ol>\n\n        <h2 id=\"GC\"   >\n          <a href=\"#GC\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>GC</h2>\n      <p>GC</p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func FindPhoneNumber(filename string) []byte&#123;</span><br><span class=\"line\">\tb, _ :&#x3D; ioutil.ReadFile(filename)</span><br><span class=\"line\">\treturn regexp.MustCompile(&quot;[0-9]+&quot;).Find(b)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>bb  </p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func FindPhoneNumber(filename string) []byte&#123;</span><br><span class=\"line\">\tb, _ :&#x3D; ioutil.ReadFile(filename)</span><br><span class=\"line\">\tb &#x3D;  regexp.MustCompile(&quot;[0-9]+&quot;).Find(b)</span><br><span class=\"line\">    return append([]byte&#123;&#125;, b)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a *[]int&#123;1,2,3,4,4,5,6&#125;</span><br><span class=\"line\">a &#x3D; a[:len(a)-1] &#x2F;&#x2F; </span><br></pre></td></tr></table></div></figure>\n<p>, nil</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var a *[]int&#123;1,2,3,4,4,5,6&#125;</span><br><span class=\"line\">a[len(a)-1] &#x3D; nil</span><br><span class=\"line\">a &#x3D; a[:len(a)-1] &#x2F;&#x2F; </span><br></pre></td></tr></table></div></figure>"},{"title":"sync.Map ","date":"2020-12-10T08:07:38.000Z","_content":"\n\n<!-- ---\nlayout: post\ntitle: sync.Map\nauthor: Ray Chan(ray1888)\ndate: '2020-12-10 16:07:38 +0800'\ncategory: Golang\nsummary: sync.Map implate \nthumbnail: go.png\n--- -->\n\n\n# \nSync.Map  Golang  mapGolang mapsync.Map\n\n# \n## \n```\ntype Map struct {\n    mu Mutex\n\n    // read contains the portion of the map's contents that are safe for\n    // concurrent access (with or without mu held).\n    //\n    // The read field itself is always safe to load, but must only be stored with\n    // mu held.\n    //\n    // Entries stored in read may be updated concurrently without mu, but updating\n    // a previously-expunged entry requires that the entry be copied to the dirty\n    // map and unexpunged with mu held.\n    read atomic.Value // readOnly\n\n    // dirty contains the portion of the map's contents that require mu to be\n    // held. To ensure that the dirty map can be promoted to the read map quickly,\n    // it also includes all of the non-expunged entries in the read map.\n    //\n    // Expunged entries are not stored in the dirty map. An expunged entry in the\n    // clean map must be unexpunged and added to the dirty map before a new value\n    // can be stored to it.\n    //\n    // If the dirty map is nil, the next write to the map will initialize it by\n    // making a shallow copy of the clean map, omitting stale entries.\n    dirty map[interface{}]*entry\n\n    // misses counts the number of loads since the read map was last updated that\n    // needed to lock mu to determine whether the key was present.\n    //\n    // Once enough misses have occurred to cover the cost of copying the dirty\n    // map, the dirty map will be promoted to the read map (in the unamended\n    // state) and the next store to the map will make a new dirty copy.\n    misses int\n}\n\n// readOnly is an immutable struct stored atomically in the Map.read field.\ntype readOnly struct {\n    m       map[interface{}]*entry\n    amended bool // true if the dirty map contains some key not in m.\n}\ntype entry struct {\n    // p points to the interface{} value stored for the entry.\n    //\n    // If p == nil, the entry has been deleted and m.dirty == nil.\n    //\n    // If p == expunged, the entry has been deleted, m.dirty != nil, and the entry\n    // is missing from m.dirty.\n    //\n    // Otherwise, the entry is valid and recorded in m.read.m[key] and, if m.dirty\n    // != nil, in m.dirty[key].\n    //\n    // An entry can be deleted by atomic replacement with nil: when m.dirty is\n    // next created, it will atomically replace nil with expunged and leave\n    // m.dirty[key] unset.\n    //\n    // An entry's associated value can be updated by atomic replacement, provided\n    // p != expunged. If p == expunged, an entry's associated value can be updated\n    // only after first setting m.dirty[key] = e so that lookups using the dirty\n    // map find the entry.\n    p unsafe.Pointer // *interface{}\n}\n```\n\nsync.Map \n1.readatomic.Value map interface\n2. dirty golangMap\n\n## \n```\n1.  KeyReadreadcas\n2.  dirty\n      \n      1. Readcaskeymarkkeydirty\n      2. dirty \n      3. Keydirtykeyreaddirty,Flagread.amend = true\n3. \n```\n keyReadcas\n## \n1.  ReadKey\n2.  keyread\n3.  dirtyread\n\n## LoadORStore \n\n\n# sync.Map\n```\npackage main\n\nimport (\n    \"fmt\"\n    \"sync\"\n)\n\nfunc main() {\n    // for testing sync.map work\n\n    var ma sync.Map\n    k, _ := ma.Load(\"a\")\n    fmt.Println(k)\n\n    ma.Store(\"a\", 1)\n    _, _ = ma.Load(\"a\")\n    ma.Store(\"b\", 2)\n    ma.Store(\"a\", 2)\n    ma.Store(\"a\", 3)\n    p, _ := ma.Load(\"a\")\n    fmt.Println(p)\n}\n\n```\n\n\n```\n\n```\n\n\n\n","source":"_posts/golang-sync-map.md","raw":"---\ntitle: sync.Map \ndate: 2020-12-10 16:07:38\ntags: Go\n---\n\n\n<!-- ---\nlayout: post\ntitle: sync.Map\nauthor: Ray Chan(ray1888)\ndate: '2020-12-10 16:07:38 +0800'\ncategory: Golang\nsummary: sync.Map implate \nthumbnail: go.png\n--- -->\n\n\n# \nSync.Map  Golang  mapGolang mapsync.Map\n\n# \n## \n```\ntype Map struct {\n    mu Mutex\n\n    // read contains the portion of the map's contents that are safe for\n    // concurrent access (with or without mu held).\n    //\n    // The read field itself is always safe to load, but must only be stored with\n    // mu held.\n    //\n    // Entries stored in read may be updated concurrently without mu, but updating\n    // a previously-expunged entry requires that the entry be copied to the dirty\n    // map and unexpunged with mu held.\n    read atomic.Value // readOnly\n\n    // dirty contains the portion of the map's contents that require mu to be\n    // held. To ensure that the dirty map can be promoted to the read map quickly,\n    // it also includes all of the non-expunged entries in the read map.\n    //\n    // Expunged entries are not stored in the dirty map. An expunged entry in the\n    // clean map must be unexpunged and added to the dirty map before a new value\n    // can be stored to it.\n    //\n    // If the dirty map is nil, the next write to the map will initialize it by\n    // making a shallow copy of the clean map, omitting stale entries.\n    dirty map[interface{}]*entry\n\n    // misses counts the number of loads since the read map was last updated that\n    // needed to lock mu to determine whether the key was present.\n    //\n    // Once enough misses have occurred to cover the cost of copying the dirty\n    // map, the dirty map will be promoted to the read map (in the unamended\n    // state) and the next store to the map will make a new dirty copy.\n    misses int\n}\n\n// readOnly is an immutable struct stored atomically in the Map.read field.\ntype readOnly struct {\n    m       map[interface{}]*entry\n    amended bool // true if the dirty map contains some key not in m.\n}\ntype entry struct {\n    // p points to the interface{} value stored for the entry.\n    //\n    // If p == nil, the entry has been deleted and m.dirty == nil.\n    //\n    // If p == expunged, the entry has been deleted, m.dirty != nil, and the entry\n    // is missing from m.dirty.\n    //\n    // Otherwise, the entry is valid and recorded in m.read.m[key] and, if m.dirty\n    // != nil, in m.dirty[key].\n    //\n    // An entry can be deleted by atomic replacement with nil: when m.dirty is\n    // next created, it will atomically replace nil with expunged and leave\n    // m.dirty[key] unset.\n    //\n    // An entry's associated value can be updated by atomic replacement, provided\n    // p != expunged. If p == expunged, an entry's associated value can be updated\n    // only after first setting m.dirty[key] = e so that lookups using the dirty\n    // map find the entry.\n    p unsafe.Pointer // *interface{}\n}\n```\n\nsync.Map \n1.readatomic.Value map interface\n2. dirty golangMap\n\n## \n```\n1.  KeyReadreadcas\n2.  dirty\n      \n      1. Readcaskeymarkkeydirty\n      2. dirty \n      3. Keydirtykeyreaddirty,Flagread.amend = true\n3. \n```\n keyReadcas\n## \n1.  ReadKey\n2.  keyread\n3.  dirtyread\n\n## LoadORStore \n\n\n# sync.Map\n```\npackage main\n\nimport (\n    \"fmt\"\n    \"sync\"\n)\n\nfunc main() {\n    // for testing sync.map work\n\n    var ma sync.Map\n    k, _ := ma.Load(\"a\")\n    fmt.Println(k)\n\n    ma.Store(\"a\", 1)\n    _, _ = ma.Load(\"a\")\n    ma.Store(\"b\", 2)\n    ma.Store(\"a\", 2)\n    ma.Store(\"a\", 3)\n    p, _ := ma.Load(\"a\")\n    fmt.Println(p)\n}\n\n```\n\n\n```\n\n```\n\n\n\n","slug":"golang-sync-map","published":1,"updated":"2021-01-21T07:11:59.301Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk6irar90003k9i55pq9f6d4","content":"<!-- ---\nlayout: post\ntitle: sync.Map\nauthor: Ray Chan(ray1888)\ndate: '2020-12-10 16:07:38 +0800'\ncategory: Golang\nsummary: sync.Map implate \nthumbnail: go.png\n--- -->\n\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>Sync.Map  Golang  mapGolang mapsync.Map</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Map struct &#123;</span><br><span class=\"line\">    mu Mutex</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x2F;&#x2F; read contains the portion of the map&#39;s contents that are safe for</span><br><span class=\"line\">    &#x2F;&#x2F; concurrent access (with or without mu held).</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; The read field itself is always safe to load, but must only be stored with</span><br><span class=\"line\">    &#x2F;&#x2F; mu held.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; Entries stored in read may be updated concurrently without mu, but updating</span><br><span class=\"line\">    &#x2F;&#x2F; a previously-expunged entry requires that the entry be copied to the dirty</span><br><span class=\"line\">    &#x2F;&#x2F; map and unexpunged with mu held.</span><br><span class=\"line\">    read atomic.Value &#x2F;&#x2F; readOnly</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x2F;&#x2F; dirty contains the portion of the map&#39;s contents that require mu to be</span><br><span class=\"line\">    &#x2F;&#x2F; held. To ensure that the dirty map can be promoted to the read map quickly,</span><br><span class=\"line\">    &#x2F;&#x2F; it also includes all of the non-expunged entries in the read map.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; Expunged entries are not stored in the dirty map. An expunged entry in the</span><br><span class=\"line\">    &#x2F;&#x2F; clean map must be unexpunged and added to the dirty map before a new value</span><br><span class=\"line\">    &#x2F;&#x2F; can be stored to it.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; If the dirty map is nil, the next write to the map will initialize it by</span><br><span class=\"line\">    &#x2F;&#x2F; making a shallow copy of the clean map, omitting stale entries.</span><br><span class=\"line\">    dirty map[interface&#123;&#125;]*entry</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x2F;&#x2F; misses counts the number of loads since the read map was last updated that</span><br><span class=\"line\">    &#x2F;&#x2F; needed to lock mu to determine whether the key was present.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; Once enough misses have occurred to cover the cost of copying the dirty</span><br><span class=\"line\">    &#x2F;&#x2F; map, the dirty map will be promoted to the read map (in the unamended</span><br><span class=\"line\">    &#x2F;&#x2F; state) and the next store to the map will make a new dirty copy.</span><br><span class=\"line\">    misses int</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; readOnly is an immutable struct stored atomically in the Map.read field.</span><br><span class=\"line\">type readOnly struct &#123;</span><br><span class=\"line\">    m       map[interface&#123;&#125;]*entry</span><br><span class=\"line\">    amended bool &#x2F;&#x2F; true if the dirty map contains some key not in m.</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type entry struct &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; p points to the interface&#123;&#125; value stored for the entry.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; If p &#x3D;&#x3D; nil, the entry has been deleted and m.dirty &#x3D;&#x3D; nil.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; If p &#x3D;&#x3D; expunged, the entry has been deleted, m.dirty !&#x3D; nil, and the entry</span><br><span class=\"line\">    &#x2F;&#x2F; is missing from m.dirty.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; Otherwise, the entry is valid and recorded in m.read.m[key] and, if m.dirty</span><br><span class=\"line\">    &#x2F;&#x2F; !&#x3D; nil, in m.dirty[key].</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; An entry can be deleted by atomic replacement with nil: when m.dirty is</span><br><span class=\"line\">    &#x2F;&#x2F; next created, it will atomically replace nil with expunged and leave</span><br><span class=\"line\">    &#x2F;&#x2F; m.dirty[key] unset.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; An entry&#39;s associated value can be updated by atomic replacement, provided</span><br><span class=\"line\">    &#x2F;&#x2F; p !&#x3D; expunged. If p &#x3D;&#x3D; expunged, an entry&#39;s associated value can be updated</span><br><span class=\"line\">    &#x2F;&#x2F; only after first setting m.dirty[key] &#x3D; e so that lookups using the dirty</span><br><span class=\"line\">    &#x2F;&#x2F; map find the entry.</span><br><span class=\"line\">    p unsafe.Pointer &#x2F;&#x2F; *interface&#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>sync.Map <br>1.readatomic.Value map interface<br>2. dirty golangMap</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.  KeyReadreadcas</span><br><span class=\"line\">2.  dirty</span><br><span class=\"line\">      </span><br><span class=\"line\">      1. Readcaskeymarkkeydirty</span><br><span class=\"line\">      2. dirty </span><br><span class=\"line\">      3. Keydirtykeyreaddirty,Flagread.amend &#x3D; true</span><br><span class=\"line\">3. </span><br></pre></td></tr></table></div></figure>\n<p> keyReadcas</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <ol>\n<li> ReadKey</li>\n<li> keyread</li>\n<li> dirtyread</li>\n</ol>\n\n        <h2 id=\"LoadORStore-\"   >\n          <a href=\"#LoadORStore-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>LoadORStore </h2>\n      \n        <h1 id=\"sync-Map\"   >\n          <a href=\"#sync-Map\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>sync.Map</h1>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">    &quot;fmt&quot;</span><br><span class=\"line\">    &quot;sync&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; for testing sync.map work</span><br><span class=\"line\"></span><br><span class=\"line\">    var ma sync.Map</span><br><span class=\"line\">    k, _ :&#x3D; ma.Load(&quot;a&quot;)</span><br><span class=\"line\">    fmt.Println(k)</span><br><span class=\"line\"></span><br><span class=\"line\">    ma.Store(&quot;a&quot;, 1)</span><br><span class=\"line\">    _, _ &#x3D; ma.Load(&quot;a&quot;)</span><br><span class=\"line\">    ma.Store(&quot;b&quot;, 2)</span><br><span class=\"line\">    ma.Store(&quot;a&quot;, 2)</span><br><span class=\"line\">    ma.Store(&quot;a&quot;, 3)</span><br><span class=\"line\">    p, _ :&#x3D; ma.Load(&quot;a&quot;)</span><br><span class=\"line\">    fmt.Println(p)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n\n","site":{"data":{}},"excerpt":"","more":"<!-- ---\nlayout: post\ntitle: sync.Map\nauthor: Ray Chan(ray1888)\ndate: '2020-12-10 16:07:38 +0800'\ncategory: Golang\nsummary: sync.Map implate \nthumbnail: go.png\n--- -->\n\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>Sync.Map  Golang  mapGolang mapsync.Map</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Map struct &#123;</span><br><span class=\"line\">    mu Mutex</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x2F;&#x2F; read contains the portion of the map&#39;s contents that are safe for</span><br><span class=\"line\">    &#x2F;&#x2F; concurrent access (with or without mu held).</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; The read field itself is always safe to load, but must only be stored with</span><br><span class=\"line\">    &#x2F;&#x2F; mu held.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; Entries stored in read may be updated concurrently without mu, but updating</span><br><span class=\"line\">    &#x2F;&#x2F; a previously-expunged entry requires that the entry be copied to the dirty</span><br><span class=\"line\">    &#x2F;&#x2F; map and unexpunged with mu held.</span><br><span class=\"line\">    read atomic.Value &#x2F;&#x2F; readOnly</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x2F;&#x2F; dirty contains the portion of the map&#39;s contents that require mu to be</span><br><span class=\"line\">    &#x2F;&#x2F; held. To ensure that the dirty map can be promoted to the read map quickly,</span><br><span class=\"line\">    &#x2F;&#x2F; it also includes all of the non-expunged entries in the read map.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; Expunged entries are not stored in the dirty map. An expunged entry in the</span><br><span class=\"line\">    &#x2F;&#x2F; clean map must be unexpunged and added to the dirty map before a new value</span><br><span class=\"line\">    &#x2F;&#x2F; can be stored to it.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; If the dirty map is nil, the next write to the map will initialize it by</span><br><span class=\"line\">    &#x2F;&#x2F; making a shallow copy of the clean map, omitting stale entries.</span><br><span class=\"line\">    dirty map[interface&#123;&#125;]*entry</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x2F;&#x2F; misses counts the number of loads since the read map was last updated that</span><br><span class=\"line\">    &#x2F;&#x2F; needed to lock mu to determine whether the key was present.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; Once enough misses have occurred to cover the cost of copying the dirty</span><br><span class=\"line\">    &#x2F;&#x2F; map, the dirty map will be promoted to the read map (in the unamended</span><br><span class=\"line\">    &#x2F;&#x2F; state) and the next store to the map will make a new dirty copy.</span><br><span class=\"line\">    misses int</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; readOnly is an immutable struct stored atomically in the Map.read field.</span><br><span class=\"line\">type readOnly struct &#123;</span><br><span class=\"line\">    m       map[interface&#123;&#125;]*entry</span><br><span class=\"line\">    amended bool &#x2F;&#x2F; true if the dirty map contains some key not in m.</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type entry struct &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; p points to the interface&#123;&#125; value stored for the entry.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; If p &#x3D;&#x3D; nil, the entry has been deleted and m.dirty &#x3D;&#x3D; nil.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; If p &#x3D;&#x3D; expunged, the entry has been deleted, m.dirty !&#x3D; nil, and the entry</span><br><span class=\"line\">    &#x2F;&#x2F; is missing from m.dirty.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; Otherwise, the entry is valid and recorded in m.read.m[key] and, if m.dirty</span><br><span class=\"line\">    &#x2F;&#x2F; !&#x3D; nil, in m.dirty[key].</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; An entry can be deleted by atomic replacement with nil: when m.dirty is</span><br><span class=\"line\">    &#x2F;&#x2F; next created, it will atomically replace nil with expunged and leave</span><br><span class=\"line\">    &#x2F;&#x2F; m.dirty[key] unset.</span><br><span class=\"line\">    &#x2F;&#x2F;</span><br><span class=\"line\">    &#x2F;&#x2F; An entry&#39;s associated value can be updated by atomic replacement, provided</span><br><span class=\"line\">    &#x2F;&#x2F; p !&#x3D; expunged. If p &#x3D;&#x3D; expunged, an entry&#39;s associated value can be updated</span><br><span class=\"line\">    &#x2F;&#x2F; only after first setting m.dirty[key] &#x3D; e so that lookups using the dirty</span><br><span class=\"line\">    &#x2F;&#x2F; map find the entry.</span><br><span class=\"line\">    p unsafe.Pointer &#x2F;&#x2F; *interface&#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>sync.Map <br>1.readatomic.Value map interface<br>2. dirty golangMap</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.  KeyReadreadcas</span><br><span class=\"line\">2.  dirty</span><br><span class=\"line\">      </span><br><span class=\"line\">      1. Readcaskeymarkkeydirty</span><br><span class=\"line\">      2. dirty </span><br><span class=\"line\">      3. Keydirtykeyreaddirty,Flagread.amend &#x3D; true</span><br><span class=\"line\">3. </span><br></pre></td></tr></table></div></figure>\n<p> keyReadcas</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <ol>\n<li> ReadKey</li>\n<li> keyread</li>\n<li> dirtyread</li>\n</ol>\n\n        <h2 id=\"LoadORStore-\"   >\n          <a href=\"#LoadORStore-\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>LoadORStore </h2>\n      \n        <h1 id=\"sync-Map\"   >\n          <a href=\"#sync-Map\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>sync.Map</h1>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">    &quot;fmt&quot;</span><br><span class=\"line\">    &quot;sync&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; for testing sync.map work</span><br><span class=\"line\"></span><br><span class=\"line\">    var ma sync.Map</span><br><span class=\"line\">    k, _ :&#x3D; ma.Load(&quot;a&quot;)</span><br><span class=\"line\">    fmt.Println(k)</span><br><span class=\"line\"></span><br><span class=\"line\">    ma.Store(&quot;a&quot;, 1)</span><br><span class=\"line\">    _, _ &#x3D; ma.Load(&quot;a&quot;)</span><br><span class=\"line\">    ma.Store(&quot;b&quot;, 2)</span><br><span class=\"line\">    ma.Store(&quot;a&quot;, 2)</span><br><span class=\"line\">    ma.Store(&quot;a&quot;, 3)</span><br><span class=\"line\">    p, _ :&#x3D; ma.Load(&quot;a&quot;)</span><br><span class=\"line\">    fmt.Println(p)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n\n"},{"title":"MIT6.824","date":"2019-08-20T03:38:23.000Z","_content":"\n# MIT6.824 \nMIT6.824\n\n## \n```\n6.824 is a core 12-unit graduate subject with lectures, readings, programming labs, an optional project, a mid-term exam, and a final exam.\nIt will present abstractions and implementation techniques for engineering distributed systems.\nMajor topics include fault tolerance, replication, and consistency. Much of the class consists of studying \nand discussing case studies of distributed systems.\n\n\n6.824\n```\n\nMIT6.824\n\n## \nSummary\n\n1. \n\n\n2. Debug\nDebugIdeDebugLogDebug\n\n\n\n3. &\nlab2labMITLabHint,\n\nTestCaseDebugGo Channel\n\n## \n1. MapReduce\n2. Raft2Tikv3Etcd\n3. 2RaftKV\n4. 2RaftMulti-raft\n\n## ShareNote:\n1. [HomePage for MIT6.824](https://pdos.csail.mit.edu/6.824/)\n2. [tikv](https://github.com/tikv/tikv)\n3. [etcd](https://github.com/etcd-io/etcd)\n4. [](https://www.zhihu.com/question/24750289/answer/111351130)\n5. [MIT6.824](https://www.zhihu.com/question/29597104)\n","source":"_posts/mit-6824.md","raw":"---\ntitle: MIT6.824\ndate: 2019-08-20 11:38:23\ntags: distributed-system, mit6.824\n---\n\n# MIT6.824 \nMIT6.824\n\n## \n```\n6.824 is a core 12-unit graduate subject with lectures, readings, programming labs, an optional project, a mid-term exam, and a final exam.\nIt will present abstractions and implementation techniques for engineering distributed systems.\nMajor topics include fault tolerance, replication, and consistency. Much of the class consists of studying \nand discussing case studies of distributed systems.\n\n\n6.824\n```\n\nMIT6.824\n\n## \nSummary\n\n1. \n\n\n2. Debug\nDebugIdeDebugLogDebug\n\n\n\n3. &\nlab2labMITLabHint,\n\nTestCaseDebugGo Channel\n\n## \n1. MapReduce\n2. Raft2Tikv3Etcd\n3. 2RaftKV\n4. 2RaftMulti-raft\n\n## ShareNote:\n1. [HomePage for MIT6.824](https://pdos.csail.mit.edu/6.824/)\n2. [tikv](https://github.com/tikv/tikv)\n3. [etcd](https://github.com/etcd-io/etcd)\n4. [](https://www.zhihu.com/question/24750289/answer/111351130)\n5. [MIT6.824](https://www.zhihu.com/question/29597104)\n","slug":"mit-6824","published":1,"updated":"2021-01-21T06:32:13.007Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk6irarc0005k9i5b6x757te","content":"\n        <h1 id=\"MIT6-824\"   >\n          <a href=\"#MIT6-824\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>MIT6.824</h1>\n      <p>MIT6.824</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">6.824 is a core 12-unit graduate subject with lectures, readings, programming labs, an optional project, a mid-term exam, and a final exam.</span><br><span class=\"line\">It will present abstractions and implementation techniques for engineering distributed systems.</span><br><span class=\"line\">Major topics include fault tolerance, replication, and consistency. Much of the class consists of studying </span><br><span class=\"line\">and discussing case studies of distributed systems.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">6.824</span><br></pre></td></tr></table></div></figure>\n<p>MIT6.824</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>Summary</p>\n<ol>\n<li><p><br></p>\n</li>\n<li><p>Debug<br>DebugIdeDebugLogDebug</p>\n</li>\n</ol>\n<p></p>\n<ol start=\"3\">\n<li>&amp;<br>lab2labMITLabHint,</li>\n</ol>\n<p>TestCaseDebugGo Channel</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <ol>\n<li>MapReduce</li>\n<li>Raft2Tikv3Etcd</li>\n<li>2RaftKV</li>\n<li>2RaftMulti-raft</li>\n</ol>\n\n        <h2 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote:</h2>\n      <ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://pdos.csail.mit.edu/6.824/\" >HomePage for MIT6.824</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/tikv/tikv\" >tikv</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/etcd-io/etcd\" >etcd</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.zhihu.com/question/24750289/answer/111351130\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.zhihu.com/question/29597104\" >MIT6.824</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"\n        <h1 id=\"MIT6-824\"   >\n          <a href=\"#MIT6-824\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>MIT6.824</h1>\n      <p>MIT6.824</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">6.824 is a core 12-unit graduate subject with lectures, readings, programming labs, an optional project, a mid-term exam, and a final exam.</span><br><span class=\"line\">It will present abstractions and implementation techniques for engineering distributed systems.</span><br><span class=\"line\">Major topics include fault tolerance, replication, and consistency. Much of the class consists of studying </span><br><span class=\"line\">and discussing case studies of distributed systems.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">6.824</span><br></pre></td></tr></table></div></figure>\n<p>MIT6.824</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>Summary</p>\n<ol>\n<li><p><br></p>\n</li>\n<li><p>Debug<br>DebugIdeDebugLogDebug</p>\n</li>\n</ol>\n<p></p>\n<ol start=\"3\">\n<li>&amp;<br>lab2labMITLabHint,</li>\n</ol>\n<p>TestCaseDebugGo Channel</p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <ol>\n<li>MapReduce</li>\n<li>Raft2Tikv3Etcd</li>\n<li>2RaftKV</li>\n<li>2RaftMulti-raft</li>\n</ol>\n\n        <h2 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote:</h2>\n      <ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://pdos.csail.mit.edu/6.824/\" >HomePage for MIT6.824</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/tikv/tikv\" >tikv</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/etcd-io/etcd\" >etcd</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.zhihu.com/question/24750289/answer/111351130\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.zhihu.com/question/29597104\" >MIT6.824</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n"},{"title":"Prometheus(1)- ","date":"2019-10-06T07:31:38.000Z","_content":"\n<!-- ---\nlayout: post\ntitle: Prometheus\nauthor: Ray Chan(ray1888)\ndate: '2019-10-06 15:31:38 +0800'\ncategory: Prometheus\nsummary: Prometheus Scrape Module\nthumbnail: Prometheus.png\n--- -->\n\n\n# \n1. \n2. \n\n# \n\n prometheusmaster branch5a554df0855bf707a8c333c0dd830067d03422cf commit\n\n# \n\nPrometheus PullScrapePrometheus\n\n```\n\nmain.go\n// line 356\nscrapeManager = scrape.NewManager(log.With(logger, \"component\", \"scrape manager\"), fanoutStorage)\n// line 427\nscrapeManager.ApplyConfig\n// line 555\nerr := scrapeManager.Run(discoveryManagerScrape.SyncCh())\n```\n\n#  \n\n## \n\n<!-- ![ServiceDiscoveryModule](/assets/img/posts/prometheus/ScrapeModule.png) -->\n{% asset_img ScrapeModule.png ServiceDiscoveryModule %}\n\n## \n```\n-rw-r--r-- 1 ray 197121  2239 9  30 16:09 helpers_test.go\n-rw-r--r-- 1 ray 197121  7543 9  30 16:09 manager.go   //Manager\n-rw-r--r-- 1 ray 197121 10727 9  30 16:09 manager_test.go\n-rw-r--r-- 1 ray 197121 35749 9  30 16:09 scrape.go    // \n-rw-r--r-- 1 ray 197121 40682 9  30 16:09 scrape_test.go\n-rw-r--r-- 1 ray 197121 11743 9  30 16:09 target.go    //  \n-rw-r--r-- 1 ray 197121  9542 9  30 16:09 target_test.go\n\n```\n\n## \nScrapeManager \n```\ntype Manager struct {\n\tlogger    log.Logger\n\tappend    Appendable\n\tgraceShut chan struct{}\n\n\tjitterSeed    uint64     // Global jitterSeed seed is used to spread scrape workload across HA setup.\n\tmtxScrape     sync.Mutex // Guards the fields below.\n\tscrapeConfigs map[string]*config.ScrapeConfig\n\tscrapePools   map[string]*scrapePool\n\ttargetSets    map[string][]*targetgroup.Group\n\n\ttriggerReload chan struct{}\n}\n```\n\nScrapePools Job\n```\nappendable Appendable\n\tlogger     log.Logger\n\n\tmtx    sync.RWMutex\n\tconfig *config.ScrapeConfig\n\tclient *http.Client\n\t// Targets and loops must always be synchronized to have the same\n\t// set of hashes.\n\tactiveTargets  map[uint64]*Target\n\tdroppedTargets []*Target\n\tloops          map[uint64]loop\n\tcancel         context.CancelFunc\n\n\t// Constructor for new scrape loops. This is settable for testing convenience.\n\tnewLoop func(scrapeLoopOptions) loop\n```\n\nloopTargetScrapeLoop\n```\ntype loop interface {\n\trun(interval, timeout time.Duration, errc chan<- error)\n\tstop()\n}\n\ntype scrapeLoop struct {\n\tscraper         scraper\n\tl               log.Logger\n\tcache           *scrapeCache\n\tlastScrapeSize  int\n\tbuffers         *pool.Pool\n\tjitterSeed      uint64\n\thonorTimestamps bool\n\n\tappender            func() storage.Appender\n\tsampleMutator       labelsMutator\n\treportSampleMutator labelsMutator\n\n\tparentCtx context.Context\n\tctx       context.Context\n\tcancel    func()\n\tstopped   chan struct{}\n}\n\n```\n\nscraperscrapeLoopscraper, PrometheustargetScraper\n\n```\ntype scraper interface {\n\tscrape(ctx context.Context, w io.Writer) (string, error) // \n\treport(start time.Time, dur time.Duration, err error)    // \n\toffset(interval time.Duration, jitterSeed uint64) time.Duration // \n}\n\ntype targetScraper struct {\n\t*Target  //reportoffset\n\n\tclient  *http.Client //Prometheusexporterhttphttpclient\n\treq     *http.Request\n\ttimeout time.Duration\n\n\tgzipr *gzip.Reader\n\tbuf   *bufio.Reader\n}\n\n\n```\n\n## \n\nmanagerApplyConfig\n```\nfunc (m *Manager) ApplyConfig(cfg *config.Config) error {\n\tm.mtxScrape.Lock()\n\tdefer m.mtxScrape.Unlock()\n\n\tc := make(map[string]*config.ScrapeConfig)\n    \n\tfor _, scfg := range cfg.ScrapeConfigs {\n\t\tc[scfg.JobName] = scfg\n\t}\n\tm.scrapeConfigs = c\n    // seed\n\tif err := m.setJitterSeed(cfg.GlobalConfig.ExternalLabels); err != nil {\n\t\treturn err\n\t}\n\n\t// Cleanup and reload pool if the configuration has changed.\n\tvar failed bool\n    // ScrapePool \n\tfor name, sp := range m.scrapePools {\n\t\tif cfg, ok := m.scrapeConfigs[name]; !ok {\n\t\t\tsp.stop()\n\t\t\tdelete(m.scrapePools, name)\n\t\t} else if !reflect.DeepEqual(sp.config, cfg) {\n\t\t\terr := sp.reload(cfg)\n\t\t\tif err != nil {\n\t\t\t\tlevel.Error(m.logger).Log(\"msg\", \"error reloading scrape pool\", \"err\", err, \"scrape_pool\", name)\n\t\t\t\tfailed = true\n\t\t\t}\n\t\t}\n\t}\n\n\tif failed {\n\t\treturn errors.New(\"failed to apply the new configuration\")\n\t}\n\treturn nil\n}\n\nfunc (sp *scrapePool) reload(cfg *config.ScrapeConfig) error {\n\ttargetScrapePoolReloads.Inc()\n\tstart := time.Now()\n\n\tsp.mtx.Lock()\n\tdefer sp.mtx.Unlock()\n\n\tclient, err := config_util.NewClientFromConfig(cfg.HTTPClientConfig, cfg.JobName, false)\n\tif err != nil {\n\t\ttargetScrapePoolReloadsFailed.Inc()\n\t\treturn errors.Wrap(err, \"error creating HTTP client\")\n\t}\n\tsp.config = cfg\n\toldClient := sp.client\n\tsp.client = client\n\n\tvar (\n\t\twg              sync.WaitGroup\n\t\tinterval        = time.Duration(sp.config.ScrapeInterval)\n\t\ttimeout         = time.Duration(sp.config.ScrapeTimeout)\n\t\tlimit           = int(sp.config.SampleLimit)\n\t\thonorLabels     = sp.config.HonorLabels\n\t\thonorTimestamps = sp.config.HonorTimestamps\n\t\tmrc             = sp.config.MetricRelabelConfigs\n\t)\n\n\tfor fp, oldLoop := range sp.loops {\n\t\tvar (\n\t\t\tt       = sp.activeTargets[fp]\n\t\t\ts       = &targetScraper{Target: t, client: sp.client, timeout: timeout}\n\t\t\tnewLoop = sp.newLoop(scrapeLoopOptions{\n\t\t\t\ttarget:          t,\n\t\t\t\tscraper:         s,\n\t\t\t\tlimit:           limit,\n\t\t\t\thonorLabels:     honorLabels,\n\t\t\t\thonorTimestamps: honorTimestamps,\n\t\t\t\tmrc:             mrc,\n\t\t\t})\n\t\t)\n\t\twg.Add(1)\n\n\t\tgo func(oldLoop, newLoop loop) {\n\t\t\toldLoop.stop()\n\t\t\twg.Done()\n\n\t\t\tgo newLoop.run(interval, timeout, nil)\n\t\t}(oldLoop, newLoop)\n\n\t\tsp.loops[fp] = newLoop\n\t}\n\n\twg.Wait()\n\toldClient.CloseIdleConnections()\n\ttargetReloadIntervalLength.WithLabelValues(interval.String()).Observe(\n\t\ttime.Since(start).Seconds(),\n\t)\n\treturn nil\n}\n\n```\n\n1. jobNamekeyValuemap\n2. reload scraper pool\n3. Reload reloadscrapePoolscraperPool.Sync()ManagertargetSetSync\n\nRun()\n```\nfunc (m *Manager) Run(tsets <-chan map[string][]*targetgroup.Group) error {\n\tgo m.reloader()\n\tfor {\n\t\tselect {\n\t\tcase ts := <-tsets:\n\t\t\tm.updateTsets(ts)\n\n\t\t\tselect {\n\t\t\tcase m.triggerReload <- struct{}{}:\n\t\t\tdefault:\n\t\t\t}\n\n\t\tcase <-m.graceShut:\n\t\t\treturn nil\n\t\t}\n\t}\n}\n\n\nfunc (m *Manager) reloader() {\n\tticker := time.NewTicker(5 * time.Second)\n\tdefer ticker.Stop()\n\n\tfor {\n\t\tselect {\n\t\tcase <-m.graceShut:\n\t\t\treturn\n\t\tcase <-ticker.C:\n\t\t\tselect {\n\t\t\tcase <-m.triggerReload:\n\t\t\t\tm.reload()\n\t\t\tcase <-m.graceShut:\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}\n}\n```\n\n1. Main.godiscoveryManagerSyncChTargetset\n2. ReloaderReloaderReloadtriggerReload channel,reload\n\n\n## \n\n### ScraperPool\n```\n// Sync converts target groups into actual scrape targets and synchronizes\n// the currently running scraper with the resulting set and returns all scraped and dropped targets.\nfunc (sp *scrapePool) Sync(tgs []*targetgroup.Group) {\n\tstart := time.Now()\n\n\tvar all []*Target\n\tsp.mtx.Lock()\n\tsp.droppedTargets = []*Target{}\n\tfor _, tg := range tgs {\n\t\ttargets, err := targetsFromGroup(tg, sp.config)\n\t\tif err != nil {\n\t\t\tlevel.Error(sp.logger).Log(\"msg\", \"creating targets failed\", \"err\", err)\n\t\t\tcontinue\n\t\t}\n\t\tfor _, t := range targets {\n\t\t\tif t.Labels().Len() > 0 {\n\t\t\t\tall = append(all, t)\n\t\t\t} else if t.DiscoveredLabels().Len() > 0 {\n\t\t\t\tsp.droppedTargets = append(sp.droppedTargets, t)\n\t\t\t}\n\t\t}\n\t}\n\tsp.mtx.Unlock()\n\tsp.sync(all)\n\n\ttargetSyncIntervalLength.WithLabelValues(sp.config.JobName).Observe(\n\t\ttime.Since(start).Seconds(),\n\t)\n\ttargetScrapePoolSyncsCounter.WithLabelValues(sp.config.JobName).Inc()\n}\n```\n\nSync\n1. target\n2. sync()\n3. \n\nAppend\n\n\n```\n// sync takes a list of potentially duplicated targets, deduplicates them, starts\n// scrape loops for new targets, and stops scrape loops for disappeared targets.\n// It returns after all stopped scrape loops terminated.\nfunc (sp *scrapePool) sync(targets []*Target) {\n\tsp.mtx.Lock()\n\tdefer sp.mtx.Unlock()\n\n\tvar (\n\t\tuniqueTargets   = map[uint64]struct{}{}\n\t\tinterval        = time.Duration(sp.config.ScrapeInterval)\n\t\ttimeout         = time.Duration(sp.config.ScrapeTimeout)\n\t\tlimit           = int(sp.config.SampleLimit)\n\t\thonorLabels     = sp.config.HonorLabels\n\t\thonorTimestamps = sp.config.HonorTimestamps\n\t\tmrc             = sp.config.MetricRelabelConfigs\n\t)\n\n\tfor _, t := range targets {\n\t\tt := t\n\t\thash := t.hash()\n\t\tuniqueTargets[hash] = struct{}{}\n\n\t\tif _, ok := sp.activeTargets[hash]; !ok {\n\t\t\ts := &targetScraper{Target: t, client: sp.client, timeout: timeout}\n\t\t\tl := sp.newLoop(scrapeLoopOptions{\n\t\t\t\ttarget:          t,\n\t\t\t\tscraper:         s,\n\t\t\t\tlimit:           limit,\n\t\t\t\thonorLabels:     honorLabels,\n\t\t\t\thonorTimestamps: honorTimestamps,\n\t\t\t\tmrc:             mrc,\n\t\t\t})\n\n\t\t\tsp.activeTargets[hash] = t\n\t\t\tsp.loops[hash] = l\n\n\t\t\tgo l.run(interval, timeout, nil)\n\t\t} else {\n\t\t\t// Need to keep the most updated labels information\n\t\t\t// for displaying it in the Service Discovery web page.\n\t\t\tsp.activeTargets[hash].SetDiscoveredLabels(t.DiscoveredLabels())\n\t\t}\n\t}\n\n\tvar wg sync.WaitGroup\n\n\t// Stop and remove old targets and scraper loops.\n\tfor hash := range sp.activeTargets {\n\t\tif _, ok := uniqueTargets[hash]; !ok {\n\t\t\twg.Add(1)\n\t\t\tgo func(l loop) {\n\n\t\t\t\tl.stop()\n\n\t\t\t\twg.Done()\n\t\t\t}(sp.loops[hash])\n\n\t\t\tdelete(sp.loops, hash)\n\t\t\tdelete(sp.activeTargets, hash)\n\t\t}\n\t}\n\n\t// Wait for all potentially stopped scrapers to terminate.\n\t// This covers the case of flapping targets. If the server is under high load, a new scraper\n\t// may be active and tries to insert. The old scraper that didn't terminate yet could still\n\t// be inserting a previous sample set.\n\twg.Wait()\n}\n```\n\n\n1. Target\n   1.1 targetactivemap targetScrapertargetScraperLoopLoop.run()\n   1.2  \n\n### ScraperLoop\n\n```\nfunc (sl *scrapeLoop) run(interval, timeout time.Duration, errc chan<- error) {\n\tselect {\n\tcase <-time.After(sl.scraper.offset(interval, sl.jitterSeed)):\n\t\t// Continue after a scraping offset.\n\tcase <-sl.ctx.Done():\n\t\tclose(sl.stopped)\n\t\treturn\n\t}\n\n\tvar last time.Time\n\n\tticker := time.NewTicker(interval)\n\tdefer ticker.Stop()\n\nmainLoop:\n\tfor {\n\t\tselect {\n\t\tcase <-sl.parentCtx.Done():\n\t\t\tclose(sl.stopped)\n\t\t\treturn\n\t\tcase <-sl.ctx.Done():\n\t\t\tbreak mainLoop\n\t\tdefault:\n\t\t}\n\n\t\tvar (\n\t\t\tstart             = time.Now()\n\t\t\tscrapeCtx, cancel = context.WithTimeout(sl.ctx, timeout)\n\t\t)\n\n\t\t// Only record after the first scrape.\n\t\tif !last.IsZero() {\n\t\t\ttargetIntervalLength.WithLabelValues(interval.String()).Observe(\n\t\t\t\ttime.Since(last).Seconds(),\n\t\t\t)\n\t\t}\n\n\t\tb := sl.buffers.Get(sl.lastScrapeSize).([]byte)\n\t\tbuf := bytes.NewBuffer(b)\n\n\t\tcontentType, scrapeErr := sl.scraper.scrape(scrapeCtx, buf)\n\t\tcancel()\n\n\t\tif scrapeErr == nil {\n\t\t\tb = buf.Bytes()\n\t\t\t// NOTE: There were issues with misbehaving clients in the past\n\t\t\t// that occasionally returned empty results. We don't want those\n\t\t\t// to falsely reset our buffer size.\n\t\t\tif len(b) > 0 {\n\t\t\t\tsl.lastScrapeSize = len(b)\n\t\t\t}\n\t\t} else {\n\t\t\tlevel.Debug(sl.l).Log(\"msg\", \"Scrape failed\", \"err\", scrapeErr.Error())\n\t\t\tif errc != nil {\n\t\t\t\terrc <- scrapeErr\n\t\t\t}\n\t\t}\n\n\t\t// A failed scrape is the same as an empty scrape,\n\t\t// we still call sl.append to trigger stale markers.\n\t\ttotal, added, seriesAdded, appErr := sl.append(b, contentType, start)\n\t\tif appErr != nil {\n\t\t\tlevel.Warn(sl.l).Log(\"msg\", \"append failed\", \"err\", appErr)\n\t\t\t// The append failed, probably due to a parse error or sample limit.\n\t\t\t// Call sl.append again with an empty scrape to trigger stale markers.\n\t\t\tif _, _, _, err := sl.append([]byte{}, \"\", start); err != nil {\n\t\t\t\tlevel.Warn(sl.l).Log(\"msg\", \"append failed\", \"err\", err)\n\t\t\t}\n\t\t}\n\n\t\tsl.buffers.Put(b)\n\n\t\tif scrapeErr == nil {\n\t\t\tscrapeErr = appErr\n\t\t}\n\n\t\tif err := sl.report(start, time.Since(start), total, added, seriesAdded, scrapeErr); err != nil {\n\t\t\tlevel.Warn(sl.l).Log(\"msg\", \"appending scrape report failed\", \"err\", err)\n\t\t}\n\t\tlast = start\n\n\t\tselect {\n\t\tcase <-sl.parentCtx.Done():\n\t\t\tclose(sl.stopped)\n\t\t\treturn\n\t\tcase <-sl.ctx.Done():\n\t\t\tbreak mainLoop\n\t\tcase <-ticker.C:\n\t\t}\n\t}\n\n\tclose(sl.stopped)\n\n\tsl.endOfRunStaleness(last, ticker, interval)\n}\n```\n\nScraperLoopTargetscraperScrapeStroageAppenderScraperScrape\n\nScraperLoopScraper\n1. SelectOffset\n2. Scrape\n3. reportScraperTarget\n\n\n\n### TargerScraper\n```\nfunc (s *targetScraper) scrape(ctx context.Context, w io.Writer) (string, error) {\n\tif s.req == nil {\n\t\treq, err := http.NewRequest(\"GET\", s.URL().String(), nil)\n\t\tif err != nil {\n\t\t\treturn \"\", err\n\t\t}\n\t\treq.Header.Add(\"Accept\", acceptHeader)\n\t\treq.Header.Add(\"Accept-Encoding\", \"gzip\")\n\t\treq.Header.Set(\"User-Agent\", userAgentHeader)\n\t\treq.Header.Set(\"X-Prometheus-Scrape-Timeout-Seconds\", fmt.Sprintf(\"%f\", s.timeout.Seconds()))\n\n\t\ts.req = req\n\t}\n\n\tresp, err := s.client.Do(s.req.WithContext(ctx))\n\tif err != nil {\n\t\treturn \"\", err\n\t}\n\tdefer func() {\n\t\tio.Copy(ioutil.Discard, resp.Body)\n\t\tresp.Body.Close()\n\t}()\n\n\tif resp.StatusCode != http.StatusOK {\n\t\treturn \"\", errors.Errorf(\"server returned HTTP status %s\", resp.Status)\n\t}\n\n\tif resp.Header.Get(\"Content-Encoding\") != \"gzip\" {\n\t\t_, err = io.Copy(w, resp.Body)\n\t\tif err != nil {\n\t\t\treturn \"\", err\n\t\t}\n\t\treturn resp.Header.Get(\"Content-Type\"), nil\n\t}\n\n\tif s.gzipr == nil {\n\t\ts.buf = bufio.NewReader(resp.Body)\n\t\ts.gzipr, err = gzip.NewReader(s.buf)\n\t\tif err != nil {\n\t\t\treturn \"\", err\n\t\t}\n\t} else {\n\t\ts.buf.Reset(resp.Body)\n\t\tif err = s.gzipr.Reset(s.buf); err != nil {\n\t\t\treturn \"\", err\n\t\t}\n\t}\n\n\t_, err = io.Copy(w, s.gzipr)\n\ts.gzipr.Close()\n\tif err != nil {\n\t\treturn \"\", err\n\t}\n\treturn resp.Header.Get(\"Content-Type\"), nil\n}\n\n```\n\nScrapeHttpClienttarget url contextScraperLoopRun","source":"_posts/prometheus-scrape.md","raw":"---\ntitle:  Prometheus(1)- \ndate: 2019-10-06 15:31:38\ntags: Prometheus\n---\n\n<!-- ---\nlayout: post\ntitle: Prometheus\nauthor: Ray Chan(ray1888)\ndate: '2019-10-06 15:31:38 +0800'\ncategory: Prometheus\nsummary: Prometheus Scrape Module\nthumbnail: Prometheus.png\n--- -->\n\n\n# \n1. \n2. \n\n# \n\n prometheusmaster branch5a554df0855bf707a8c333c0dd830067d03422cf commit\n\n# \n\nPrometheus PullScrapePrometheus\n\n```\n\nmain.go\n// line 356\nscrapeManager = scrape.NewManager(log.With(logger, \"component\", \"scrape manager\"), fanoutStorage)\n// line 427\nscrapeManager.ApplyConfig\n// line 555\nerr := scrapeManager.Run(discoveryManagerScrape.SyncCh())\n```\n\n#  \n\n## \n\n<!-- ![ServiceDiscoveryModule](/assets/img/posts/prometheus/ScrapeModule.png) -->\n{% asset_img ScrapeModule.png ServiceDiscoveryModule %}\n\n## \n```\n-rw-r--r-- 1 ray 197121  2239 9  30 16:09 helpers_test.go\n-rw-r--r-- 1 ray 197121  7543 9  30 16:09 manager.go   //Manager\n-rw-r--r-- 1 ray 197121 10727 9  30 16:09 manager_test.go\n-rw-r--r-- 1 ray 197121 35749 9  30 16:09 scrape.go    // \n-rw-r--r-- 1 ray 197121 40682 9  30 16:09 scrape_test.go\n-rw-r--r-- 1 ray 197121 11743 9  30 16:09 target.go    //  \n-rw-r--r-- 1 ray 197121  9542 9  30 16:09 target_test.go\n\n```\n\n## \nScrapeManager \n```\ntype Manager struct {\n\tlogger    log.Logger\n\tappend    Appendable\n\tgraceShut chan struct{}\n\n\tjitterSeed    uint64     // Global jitterSeed seed is used to spread scrape workload across HA setup.\n\tmtxScrape     sync.Mutex // Guards the fields below.\n\tscrapeConfigs map[string]*config.ScrapeConfig\n\tscrapePools   map[string]*scrapePool\n\ttargetSets    map[string][]*targetgroup.Group\n\n\ttriggerReload chan struct{}\n}\n```\n\nScrapePools Job\n```\nappendable Appendable\n\tlogger     log.Logger\n\n\tmtx    sync.RWMutex\n\tconfig *config.ScrapeConfig\n\tclient *http.Client\n\t// Targets and loops must always be synchronized to have the same\n\t// set of hashes.\n\tactiveTargets  map[uint64]*Target\n\tdroppedTargets []*Target\n\tloops          map[uint64]loop\n\tcancel         context.CancelFunc\n\n\t// Constructor for new scrape loops. This is settable for testing convenience.\n\tnewLoop func(scrapeLoopOptions) loop\n```\n\nloopTargetScrapeLoop\n```\ntype loop interface {\n\trun(interval, timeout time.Duration, errc chan<- error)\n\tstop()\n}\n\ntype scrapeLoop struct {\n\tscraper         scraper\n\tl               log.Logger\n\tcache           *scrapeCache\n\tlastScrapeSize  int\n\tbuffers         *pool.Pool\n\tjitterSeed      uint64\n\thonorTimestamps bool\n\n\tappender            func() storage.Appender\n\tsampleMutator       labelsMutator\n\treportSampleMutator labelsMutator\n\n\tparentCtx context.Context\n\tctx       context.Context\n\tcancel    func()\n\tstopped   chan struct{}\n}\n\n```\n\nscraperscrapeLoopscraper, PrometheustargetScraper\n\n```\ntype scraper interface {\n\tscrape(ctx context.Context, w io.Writer) (string, error) // \n\treport(start time.Time, dur time.Duration, err error)    // \n\toffset(interval time.Duration, jitterSeed uint64) time.Duration // \n}\n\ntype targetScraper struct {\n\t*Target  //reportoffset\n\n\tclient  *http.Client //Prometheusexporterhttphttpclient\n\treq     *http.Request\n\ttimeout time.Duration\n\n\tgzipr *gzip.Reader\n\tbuf   *bufio.Reader\n}\n\n\n```\n\n## \n\nmanagerApplyConfig\n```\nfunc (m *Manager) ApplyConfig(cfg *config.Config) error {\n\tm.mtxScrape.Lock()\n\tdefer m.mtxScrape.Unlock()\n\n\tc := make(map[string]*config.ScrapeConfig)\n    \n\tfor _, scfg := range cfg.ScrapeConfigs {\n\t\tc[scfg.JobName] = scfg\n\t}\n\tm.scrapeConfigs = c\n    // seed\n\tif err := m.setJitterSeed(cfg.GlobalConfig.ExternalLabels); err != nil {\n\t\treturn err\n\t}\n\n\t// Cleanup and reload pool if the configuration has changed.\n\tvar failed bool\n    // ScrapePool \n\tfor name, sp := range m.scrapePools {\n\t\tif cfg, ok := m.scrapeConfigs[name]; !ok {\n\t\t\tsp.stop()\n\t\t\tdelete(m.scrapePools, name)\n\t\t} else if !reflect.DeepEqual(sp.config, cfg) {\n\t\t\terr := sp.reload(cfg)\n\t\t\tif err != nil {\n\t\t\t\tlevel.Error(m.logger).Log(\"msg\", \"error reloading scrape pool\", \"err\", err, \"scrape_pool\", name)\n\t\t\t\tfailed = true\n\t\t\t}\n\t\t}\n\t}\n\n\tif failed {\n\t\treturn errors.New(\"failed to apply the new configuration\")\n\t}\n\treturn nil\n}\n\nfunc (sp *scrapePool) reload(cfg *config.ScrapeConfig) error {\n\ttargetScrapePoolReloads.Inc()\n\tstart := time.Now()\n\n\tsp.mtx.Lock()\n\tdefer sp.mtx.Unlock()\n\n\tclient, err := config_util.NewClientFromConfig(cfg.HTTPClientConfig, cfg.JobName, false)\n\tif err != nil {\n\t\ttargetScrapePoolReloadsFailed.Inc()\n\t\treturn errors.Wrap(err, \"error creating HTTP client\")\n\t}\n\tsp.config = cfg\n\toldClient := sp.client\n\tsp.client = client\n\n\tvar (\n\t\twg              sync.WaitGroup\n\t\tinterval        = time.Duration(sp.config.ScrapeInterval)\n\t\ttimeout         = time.Duration(sp.config.ScrapeTimeout)\n\t\tlimit           = int(sp.config.SampleLimit)\n\t\thonorLabels     = sp.config.HonorLabels\n\t\thonorTimestamps = sp.config.HonorTimestamps\n\t\tmrc             = sp.config.MetricRelabelConfigs\n\t)\n\n\tfor fp, oldLoop := range sp.loops {\n\t\tvar (\n\t\t\tt       = sp.activeTargets[fp]\n\t\t\ts       = &targetScraper{Target: t, client: sp.client, timeout: timeout}\n\t\t\tnewLoop = sp.newLoop(scrapeLoopOptions{\n\t\t\t\ttarget:          t,\n\t\t\t\tscraper:         s,\n\t\t\t\tlimit:           limit,\n\t\t\t\thonorLabels:     honorLabels,\n\t\t\t\thonorTimestamps: honorTimestamps,\n\t\t\t\tmrc:             mrc,\n\t\t\t})\n\t\t)\n\t\twg.Add(1)\n\n\t\tgo func(oldLoop, newLoop loop) {\n\t\t\toldLoop.stop()\n\t\t\twg.Done()\n\n\t\t\tgo newLoop.run(interval, timeout, nil)\n\t\t}(oldLoop, newLoop)\n\n\t\tsp.loops[fp] = newLoop\n\t}\n\n\twg.Wait()\n\toldClient.CloseIdleConnections()\n\ttargetReloadIntervalLength.WithLabelValues(interval.String()).Observe(\n\t\ttime.Since(start).Seconds(),\n\t)\n\treturn nil\n}\n\n```\n\n1. jobNamekeyValuemap\n2. reload scraper pool\n3. Reload reloadscrapePoolscraperPool.Sync()ManagertargetSetSync\n\nRun()\n```\nfunc (m *Manager) Run(tsets <-chan map[string][]*targetgroup.Group) error {\n\tgo m.reloader()\n\tfor {\n\t\tselect {\n\t\tcase ts := <-tsets:\n\t\t\tm.updateTsets(ts)\n\n\t\t\tselect {\n\t\t\tcase m.triggerReload <- struct{}{}:\n\t\t\tdefault:\n\t\t\t}\n\n\t\tcase <-m.graceShut:\n\t\t\treturn nil\n\t\t}\n\t}\n}\n\n\nfunc (m *Manager) reloader() {\n\tticker := time.NewTicker(5 * time.Second)\n\tdefer ticker.Stop()\n\n\tfor {\n\t\tselect {\n\t\tcase <-m.graceShut:\n\t\t\treturn\n\t\tcase <-ticker.C:\n\t\t\tselect {\n\t\t\tcase <-m.triggerReload:\n\t\t\t\tm.reload()\n\t\t\tcase <-m.graceShut:\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}\n}\n```\n\n1. Main.godiscoveryManagerSyncChTargetset\n2. ReloaderReloaderReloadtriggerReload channel,reload\n\n\n## \n\n### ScraperPool\n```\n// Sync converts target groups into actual scrape targets and synchronizes\n// the currently running scraper with the resulting set and returns all scraped and dropped targets.\nfunc (sp *scrapePool) Sync(tgs []*targetgroup.Group) {\n\tstart := time.Now()\n\n\tvar all []*Target\n\tsp.mtx.Lock()\n\tsp.droppedTargets = []*Target{}\n\tfor _, tg := range tgs {\n\t\ttargets, err := targetsFromGroup(tg, sp.config)\n\t\tif err != nil {\n\t\t\tlevel.Error(sp.logger).Log(\"msg\", \"creating targets failed\", \"err\", err)\n\t\t\tcontinue\n\t\t}\n\t\tfor _, t := range targets {\n\t\t\tif t.Labels().Len() > 0 {\n\t\t\t\tall = append(all, t)\n\t\t\t} else if t.DiscoveredLabels().Len() > 0 {\n\t\t\t\tsp.droppedTargets = append(sp.droppedTargets, t)\n\t\t\t}\n\t\t}\n\t}\n\tsp.mtx.Unlock()\n\tsp.sync(all)\n\n\ttargetSyncIntervalLength.WithLabelValues(sp.config.JobName).Observe(\n\t\ttime.Since(start).Seconds(),\n\t)\n\ttargetScrapePoolSyncsCounter.WithLabelValues(sp.config.JobName).Inc()\n}\n```\n\nSync\n1. target\n2. sync()\n3. \n\nAppend\n\n\n```\n// sync takes a list of potentially duplicated targets, deduplicates them, starts\n// scrape loops for new targets, and stops scrape loops for disappeared targets.\n// It returns after all stopped scrape loops terminated.\nfunc (sp *scrapePool) sync(targets []*Target) {\n\tsp.mtx.Lock()\n\tdefer sp.mtx.Unlock()\n\n\tvar (\n\t\tuniqueTargets   = map[uint64]struct{}{}\n\t\tinterval        = time.Duration(sp.config.ScrapeInterval)\n\t\ttimeout         = time.Duration(sp.config.ScrapeTimeout)\n\t\tlimit           = int(sp.config.SampleLimit)\n\t\thonorLabels     = sp.config.HonorLabels\n\t\thonorTimestamps = sp.config.HonorTimestamps\n\t\tmrc             = sp.config.MetricRelabelConfigs\n\t)\n\n\tfor _, t := range targets {\n\t\tt := t\n\t\thash := t.hash()\n\t\tuniqueTargets[hash] = struct{}{}\n\n\t\tif _, ok := sp.activeTargets[hash]; !ok {\n\t\t\ts := &targetScraper{Target: t, client: sp.client, timeout: timeout}\n\t\t\tl := sp.newLoop(scrapeLoopOptions{\n\t\t\t\ttarget:          t,\n\t\t\t\tscraper:         s,\n\t\t\t\tlimit:           limit,\n\t\t\t\thonorLabels:     honorLabels,\n\t\t\t\thonorTimestamps: honorTimestamps,\n\t\t\t\tmrc:             mrc,\n\t\t\t})\n\n\t\t\tsp.activeTargets[hash] = t\n\t\t\tsp.loops[hash] = l\n\n\t\t\tgo l.run(interval, timeout, nil)\n\t\t} else {\n\t\t\t// Need to keep the most updated labels information\n\t\t\t// for displaying it in the Service Discovery web page.\n\t\t\tsp.activeTargets[hash].SetDiscoveredLabels(t.DiscoveredLabels())\n\t\t}\n\t}\n\n\tvar wg sync.WaitGroup\n\n\t// Stop and remove old targets and scraper loops.\n\tfor hash := range sp.activeTargets {\n\t\tif _, ok := uniqueTargets[hash]; !ok {\n\t\t\twg.Add(1)\n\t\t\tgo func(l loop) {\n\n\t\t\t\tl.stop()\n\n\t\t\t\twg.Done()\n\t\t\t}(sp.loops[hash])\n\n\t\t\tdelete(sp.loops, hash)\n\t\t\tdelete(sp.activeTargets, hash)\n\t\t}\n\t}\n\n\t// Wait for all potentially stopped scrapers to terminate.\n\t// This covers the case of flapping targets. If the server is under high load, a new scraper\n\t// may be active and tries to insert. The old scraper that didn't terminate yet could still\n\t// be inserting a previous sample set.\n\twg.Wait()\n}\n```\n\n\n1. Target\n   1.1 targetactivemap targetScrapertargetScraperLoopLoop.run()\n   1.2  \n\n### ScraperLoop\n\n```\nfunc (sl *scrapeLoop) run(interval, timeout time.Duration, errc chan<- error) {\n\tselect {\n\tcase <-time.After(sl.scraper.offset(interval, sl.jitterSeed)):\n\t\t// Continue after a scraping offset.\n\tcase <-sl.ctx.Done():\n\t\tclose(sl.stopped)\n\t\treturn\n\t}\n\n\tvar last time.Time\n\n\tticker := time.NewTicker(interval)\n\tdefer ticker.Stop()\n\nmainLoop:\n\tfor {\n\t\tselect {\n\t\tcase <-sl.parentCtx.Done():\n\t\t\tclose(sl.stopped)\n\t\t\treturn\n\t\tcase <-sl.ctx.Done():\n\t\t\tbreak mainLoop\n\t\tdefault:\n\t\t}\n\n\t\tvar (\n\t\t\tstart             = time.Now()\n\t\t\tscrapeCtx, cancel = context.WithTimeout(sl.ctx, timeout)\n\t\t)\n\n\t\t// Only record after the first scrape.\n\t\tif !last.IsZero() {\n\t\t\ttargetIntervalLength.WithLabelValues(interval.String()).Observe(\n\t\t\t\ttime.Since(last).Seconds(),\n\t\t\t)\n\t\t}\n\n\t\tb := sl.buffers.Get(sl.lastScrapeSize).([]byte)\n\t\tbuf := bytes.NewBuffer(b)\n\n\t\tcontentType, scrapeErr := sl.scraper.scrape(scrapeCtx, buf)\n\t\tcancel()\n\n\t\tif scrapeErr == nil {\n\t\t\tb = buf.Bytes()\n\t\t\t// NOTE: There were issues with misbehaving clients in the past\n\t\t\t// that occasionally returned empty results. We don't want those\n\t\t\t// to falsely reset our buffer size.\n\t\t\tif len(b) > 0 {\n\t\t\t\tsl.lastScrapeSize = len(b)\n\t\t\t}\n\t\t} else {\n\t\t\tlevel.Debug(sl.l).Log(\"msg\", \"Scrape failed\", \"err\", scrapeErr.Error())\n\t\t\tif errc != nil {\n\t\t\t\terrc <- scrapeErr\n\t\t\t}\n\t\t}\n\n\t\t// A failed scrape is the same as an empty scrape,\n\t\t// we still call sl.append to trigger stale markers.\n\t\ttotal, added, seriesAdded, appErr := sl.append(b, contentType, start)\n\t\tif appErr != nil {\n\t\t\tlevel.Warn(sl.l).Log(\"msg\", \"append failed\", \"err\", appErr)\n\t\t\t// The append failed, probably due to a parse error or sample limit.\n\t\t\t// Call sl.append again with an empty scrape to trigger stale markers.\n\t\t\tif _, _, _, err := sl.append([]byte{}, \"\", start); err != nil {\n\t\t\t\tlevel.Warn(sl.l).Log(\"msg\", \"append failed\", \"err\", err)\n\t\t\t}\n\t\t}\n\n\t\tsl.buffers.Put(b)\n\n\t\tif scrapeErr == nil {\n\t\t\tscrapeErr = appErr\n\t\t}\n\n\t\tif err := sl.report(start, time.Since(start), total, added, seriesAdded, scrapeErr); err != nil {\n\t\t\tlevel.Warn(sl.l).Log(\"msg\", \"appending scrape report failed\", \"err\", err)\n\t\t}\n\t\tlast = start\n\n\t\tselect {\n\t\tcase <-sl.parentCtx.Done():\n\t\t\tclose(sl.stopped)\n\t\t\treturn\n\t\tcase <-sl.ctx.Done():\n\t\t\tbreak mainLoop\n\t\tcase <-ticker.C:\n\t\t}\n\t}\n\n\tclose(sl.stopped)\n\n\tsl.endOfRunStaleness(last, ticker, interval)\n}\n```\n\nScraperLoopTargetscraperScrapeStroageAppenderScraperScrape\n\nScraperLoopScraper\n1. SelectOffset\n2. Scrape\n3. reportScraperTarget\n\n\n\n### TargerScraper\n```\nfunc (s *targetScraper) scrape(ctx context.Context, w io.Writer) (string, error) {\n\tif s.req == nil {\n\t\treq, err := http.NewRequest(\"GET\", s.URL().String(), nil)\n\t\tif err != nil {\n\t\t\treturn \"\", err\n\t\t}\n\t\treq.Header.Add(\"Accept\", acceptHeader)\n\t\treq.Header.Add(\"Accept-Encoding\", \"gzip\")\n\t\treq.Header.Set(\"User-Agent\", userAgentHeader)\n\t\treq.Header.Set(\"X-Prometheus-Scrape-Timeout-Seconds\", fmt.Sprintf(\"%f\", s.timeout.Seconds()))\n\n\t\ts.req = req\n\t}\n\n\tresp, err := s.client.Do(s.req.WithContext(ctx))\n\tif err != nil {\n\t\treturn \"\", err\n\t}\n\tdefer func() {\n\t\tio.Copy(ioutil.Discard, resp.Body)\n\t\tresp.Body.Close()\n\t}()\n\n\tif resp.StatusCode != http.StatusOK {\n\t\treturn \"\", errors.Errorf(\"server returned HTTP status %s\", resp.Status)\n\t}\n\n\tif resp.Header.Get(\"Content-Encoding\") != \"gzip\" {\n\t\t_, err = io.Copy(w, resp.Body)\n\t\tif err != nil {\n\t\t\treturn \"\", err\n\t\t}\n\t\treturn resp.Header.Get(\"Content-Type\"), nil\n\t}\n\n\tif s.gzipr == nil {\n\t\ts.buf = bufio.NewReader(resp.Body)\n\t\ts.gzipr, err = gzip.NewReader(s.buf)\n\t\tif err != nil {\n\t\t\treturn \"\", err\n\t\t}\n\t} else {\n\t\ts.buf.Reset(resp.Body)\n\t\tif err = s.gzipr.Reset(s.buf); err != nil {\n\t\t\treturn \"\", err\n\t\t}\n\t}\n\n\t_, err = io.Copy(w, s.gzipr)\n\ts.gzipr.Close()\n\tif err != nil {\n\t\treturn \"\", err\n\t}\n\treturn resp.Header.Get(\"Content-Type\"), nil\n}\n\n```\n\nScrapeHttpClienttarget url contextScraperLoopRun","slug":"prometheus-scrape","published":1,"updated":"2021-01-21T07:08:38.213Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk6irard0006k9i5gsd7bfrr","content":"<!-- ---\nlayout: post\ntitle: Prometheus\nauthor: Ray Chan(ray1888)\ndate: '2019-10-06 15:31:38 +0800'\ncategory: Prometheus\nsummary: Prometheus Scrape Module\nthumbnail: Prometheus.png\n--- -->\n\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li></li>\n<li></li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p> prometheusmaster branch5a554df0855bf707a8c333c0dd830067d03422cf commit</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>Prometheus PullScrapePrometheus</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">main.go</span><br><span class=\"line\">&#x2F;&#x2F; line 356</span><br><span class=\"line\">scrapeManager &#x3D; scrape.NewManager(log.With(logger, &quot;component&quot;, &quot;scrape manager&quot;), fanoutStorage)</span><br><span class=\"line\">&#x2F;&#x2F; line 427</span><br><span class=\"line\">scrapeManager.ApplyConfig</span><br><span class=\"line\">&#x2F;&#x2F; line 555</span><br><span class=\"line\">err :&#x3D; scrapeManager.Run(discoveryManagerScrape.SyncCh())</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <!-- ![ServiceDiscoveryModule](/assets/img/posts/prometheus/ScrapeModule.png) -->\n<img src=\"/2019/10/06/prometheus-scrape/ScrapeModule.png\" class=\"\" title=\"ServiceDiscoveryModule\">\n\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-rw-r--r-- 1 ray 197121  2239 9  30 16:09 helpers_test.go</span><br><span class=\"line\">-rw-r--r-- 1 ray 197121  7543 9  30 16:09 manager.go   &#x2F;&#x2F;Manager</span><br><span class=\"line\">-rw-r--r-- 1 ray 197121 10727 9  30 16:09 manager_test.go</span><br><span class=\"line\">-rw-r--r-- 1 ray 197121 35749 9  30 16:09 scrape.go    &#x2F;&#x2F; </span><br><span class=\"line\">-rw-r--r-- 1 ray 197121 40682 9  30 16:09 scrape_test.go</span><br><span class=\"line\">-rw-r--r-- 1 ray 197121 11743 9  30 16:09 target.go    &#x2F;&#x2F;  </span><br><span class=\"line\">-rw-r--r-- 1 ray 197121  9542 9  30 16:09 target_test.go</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>ScrapeManager </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Manager struct &#123;</span><br><span class=\"line\">\tlogger    log.Logger</span><br><span class=\"line\">\tappend    Appendable</span><br><span class=\"line\">\tgraceShut chan struct&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tjitterSeed    uint64     &#x2F;&#x2F; Global jitterSeed seed is used to spread scrape workload across HA setup.</span><br><span class=\"line\">\tmtxScrape     sync.Mutex &#x2F;&#x2F; Guards the fields below.</span><br><span class=\"line\">\tscrapeConfigs map[string]*config.ScrapeConfig</span><br><span class=\"line\">\tscrapePools   map[string]*scrapePool</span><br><span class=\"line\">\ttargetSets    map[string][]*targetgroup.Group</span><br><span class=\"line\"></span><br><span class=\"line\">\ttriggerReload chan struct&#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>ScrapePools Job</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">appendable Appendable</span><br><span class=\"line\">\tlogger     log.Logger</span><br><span class=\"line\"></span><br><span class=\"line\">\tmtx    sync.RWMutex</span><br><span class=\"line\">\tconfig *config.ScrapeConfig</span><br><span class=\"line\">\tclient *http.Client</span><br><span class=\"line\">\t&#x2F;&#x2F; Targets and loops must always be synchronized to have the same</span><br><span class=\"line\">\t&#x2F;&#x2F; set of hashes.</span><br><span class=\"line\">\tactiveTargets  map[uint64]*Target</span><br><span class=\"line\">\tdroppedTargets []*Target</span><br><span class=\"line\">\tloops          map[uint64]loop</span><br><span class=\"line\">\tcancel         context.CancelFunc</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; Constructor for new scrape loops. This is settable for testing convenience.</span><br><span class=\"line\">\tnewLoop func(scrapeLoopOptions) loop</span><br></pre></td></tr></table></div></figure>\n<p>loopTargetScrapeLoop</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type loop interface &#123;</span><br><span class=\"line\">\trun(interval, timeout time.Duration, errc chan&lt;- error)</span><br><span class=\"line\">\tstop()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type scrapeLoop struct &#123;</span><br><span class=\"line\">\tscraper         scraper</span><br><span class=\"line\">\tl               log.Logger</span><br><span class=\"line\">\tcache           *scrapeCache</span><br><span class=\"line\">\tlastScrapeSize  int</span><br><span class=\"line\">\tbuffers         *pool.Pool</span><br><span class=\"line\">\tjitterSeed      uint64</span><br><span class=\"line\">\thonorTimestamps bool</span><br><span class=\"line\"></span><br><span class=\"line\">\tappender            func() storage.Appender</span><br><span class=\"line\">\tsampleMutator       labelsMutator</span><br><span class=\"line\">\treportSampleMutator labelsMutator</span><br><span class=\"line\"></span><br><span class=\"line\">\tparentCtx context.Context</span><br><span class=\"line\">\tctx       context.Context</span><br><span class=\"line\">\tcancel    func()</span><br><span class=\"line\">\tstopped   chan struct&#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>scraperscrapeLoopscraper, PrometheustargetScraper</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type scraper interface &#123;</span><br><span class=\"line\">\tscrape(ctx context.Context, w io.Writer) (string, error) &#x2F;&#x2F; </span><br><span class=\"line\">\treport(start time.Time, dur time.Duration, err error)    &#x2F;&#x2F; </span><br><span class=\"line\">\toffset(interval time.Duration, jitterSeed uint64) time.Duration &#x2F;&#x2F; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type targetScraper struct &#123;</span><br><span class=\"line\">\t*Target  &#x2F;&#x2F;reportoffset</span><br><span class=\"line\"></span><br><span class=\"line\">\tclient  *http.Client &#x2F;&#x2F;Prometheusexporterhttphttpclient</span><br><span class=\"line\">\treq     *http.Request</span><br><span class=\"line\">\ttimeout time.Duration</span><br><span class=\"line\"></span><br><span class=\"line\">\tgzipr *gzip.Reader</span><br><span class=\"line\">\tbuf   *bufio.Reader</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>managerApplyConfig</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (m *Manager) ApplyConfig(cfg *config.Config) error &#123;</span><br><span class=\"line\">\tm.mtxScrape.Lock()</span><br><span class=\"line\">\tdefer m.mtxScrape.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\tc :&#x3D; make(map[string]*config.ScrapeConfig)</span><br><span class=\"line\">    </span><br><span class=\"line\">\tfor _, scfg :&#x3D; range cfg.ScrapeConfigs &#123;</span><br><span class=\"line\">\t\tc[scfg.JobName] &#x3D; scfg</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tm.scrapeConfigs &#x3D; c</span><br><span class=\"line\">    &#x2F;&#x2F; seed</span><br><span class=\"line\">\tif err :&#x3D; m.setJitterSeed(cfg.GlobalConfig.ExternalLabels); err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\treturn err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; Cleanup and reload pool if the configuration has changed.</span><br><span class=\"line\">\tvar failed bool</span><br><span class=\"line\">    &#x2F;&#x2F; ScrapePool </span><br><span class=\"line\">\tfor name, sp :&#x3D; range m.scrapePools &#123;</span><br><span class=\"line\">\t\tif cfg, ok :&#x3D; m.scrapeConfigs[name]; !ok &#123;</span><br><span class=\"line\">\t\t\tsp.stop()</span><br><span class=\"line\">\t\t\tdelete(m.scrapePools, name)</span><br><span class=\"line\">\t\t&#125; else if !reflect.DeepEqual(sp.config, cfg) &#123;</span><br><span class=\"line\">\t\t\terr :&#x3D; sp.reload(cfg)</span><br><span class=\"line\">\t\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\tlevel.Error(m.logger).Log(&quot;msg&quot;, &quot;error reloading scrape pool&quot;, &quot;err&quot;, err, &quot;scrape_pool&quot;, name)</span><br><span class=\"line\">\t\t\t\tfailed &#x3D; true</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif failed &#123;</span><br><span class=\"line\">\t\treturn errors.New(&quot;failed to apply the new configuration&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (sp *scrapePool) reload(cfg *config.ScrapeConfig) error &#123;</span><br><span class=\"line\">\ttargetScrapePoolReloads.Inc()</span><br><span class=\"line\">\tstart :&#x3D; time.Now()</span><br><span class=\"line\"></span><br><span class=\"line\">\tsp.mtx.Lock()</span><br><span class=\"line\">\tdefer sp.mtx.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\tclient, err :&#x3D; config_util.NewClientFromConfig(cfg.HTTPClientConfig, cfg.JobName, false)</span><br><span class=\"line\">\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\ttargetScrapePoolReloadsFailed.Inc()</span><br><span class=\"line\">\t\treturn errors.Wrap(err, &quot;error creating HTTP client&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tsp.config &#x3D; cfg</span><br><span class=\"line\">\toldClient :&#x3D; sp.client</span><br><span class=\"line\">\tsp.client &#x3D; client</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar (</span><br><span class=\"line\">\t\twg              sync.WaitGroup</span><br><span class=\"line\">\t\tinterval        &#x3D; time.Duration(sp.config.ScrapeInterval)</span><br><span class=\"line\">\t\ttimeout         &#x3D; time.Duration(sp.config.ScrapeTimeout)</span><br><span class=\"line\">\t\tlimit           &#x3D; int(sp.config.SampleLimit)</span><br><span class=\"line\">\t\thonorLabels     &#x3D; sp.config.HonorLabels</span><br><span class=\"line\">\t\thonorTimestamps &#x3D; sp.config.HonorTimestamps</span><br><span class=\"line\">\t\tmrc             &#x3D; sp.config.MetricRelabelConfigs</span><br><span class=\"line\">\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor fp, oldLoop :&#x3D; range sp.loops &#123;</span><br><span class=\"line\">\t\tvar (</span><br><span class=\"line\">\t\t\tt       &#x3D; sp.activeTargets[fp]</span><br><span class=\"line\">\t\t\ts       &#x3D; &amp;targetScraper&#123;Target: t, client: sp.client, timeout: timeout&#125;</span><br><span class=\"line\">\t\t\tnewLoop &#x3D; sp.newLoop(scrapeLoopOptions&#123;</span><br><span class=\"line\">\t\t\t\ttarget:          t,</span><br><span class=\"line\">\t\t\t\tscraper:         s,</span><br><span class=\"line\">\t\t\t\tlimit:           limit,</span><br><span class=\"line\">\t\t\t\thonorLabels:     honorLabels,</span><br><span class=\"line\">\t\t\t\thonorTimestamps: honorTimestamps,</span><br><span class=\"line\">\t\t\t\tmrc:             mrc,</span><br><span class=\"line\">\t\t\t&#125;)</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t\twg.Add(1)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tgo func(oldLoop, newLoop loop) &#123;</span><br><span class=\"line\">\t\t\toldLoop.stop()</span><br><span class=\"line\">\t\t\twg.Done()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tgo newLoop.run(interval, timeout, nil)</span><br><span class=\"line\">\t\t&#125;(oldLoop, newLoop)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tsp.loops[fp] &#x3D; newLoop</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\twg.Wait()</span><br><span class=\"line\">\toldClient.CloseIdleConnections()</span><br><span class=\"line\">\ttargetReloadIntervalLength.WithLabelValues(interval.String()).Observe(</span><br><span class=\"line\">\t\ttime.Since(start).Seconds(),</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\treturn nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<ol>\n<li>jobNamekeyValuemap</li>\n<li>reload scraper pool</li>\n<li>Reload reloadscrapePoolscraperPool.Sync()ManagertargetSetSync</li>\n</ol>\n<p>Run()</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (m *Manager) Run(tsets &lt;-chan map[string][]*targetgroup.Group) error &#123;</span><br><span class=\"line\">\tgo m.reloader()</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase ts :&#x3D; &lt;-tsets:</span><br><span class=\"line\">\t\t\tm.updateTsets(ts)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase m.triggerReload &lt;- struct&#123;&#125;&#123;&#125;:</span><br><span class=\"line\">\t\t\tdefault:</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcase &lt;-m.graceShut:</span><br><span class=\"line\">\t\t\treturn nil</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func (m *Manager) reloader() &#123;</span><br><span class=\"line\">\tticker :&#x3D; time.NewTicker(5 * time.Second)</span><br><span class=\"line\">\tdefer ticker.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-m.graceShut:</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase &lt;-ticker.C:</span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase &lt;-m.triggerReload:</span><br><span class=\"line\">\t\t\t\tm.reload()</span><br><span class=\"line\">\t\t\tcase &lt;-m.graceShut:</span><br><span class=\"line\">\t\t\t\treturn</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<ol>\n<li>Main.godiscoveryManagerSyncChTargetset</li>\n<li>ReloaderReloaderReloadtriggerReload channel,reload</li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      \n        <h3 id=\"ScraperPool\"   >\n          <a href=\"#ScraperPool\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ScraperPool</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; Sync converts target groups into actual scrape targets and synchronizes</span><br><span class=\"line\">&#x2F;&#x2F; the currently running scraper with the resulting set and returns all scraped and dropped targets.</span><br><span class=\"line\">func (sp *scrapePool) Sync(tgs []*targetgroup.Group) &#123;</span><br><span class=\"line\">\tstart :&#x3D; time.Now()</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar all []*Target</span><br><span class=\"line\">\tsp.mtx.Lock()</span><br><span class=\"line\">\tsp.droppedTargets &#x3D; []*Target&#123;&#125;</span><br><span class=\"line\">\tfor _, tg :&#x3D; range tgs &#123;</span><br><span class=\"line\">\t\ttargets, err :&#x3D; targetsFromGroup(tg, sp.config)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tlevel.Error(sp.logger).Log(&quot;msg&quot;, &quot;creating targets failed&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t\tcontinue</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tfor _, t :&#x3D; range targets &#123;</span><br><span class=\"line\">\t\t\tif t.Labels().Len() &gt; 0 &#123;</span><br><span class=\"line\">\t\t\t\tall &#x3D; append(all, t)</span><br><span class=\"line\">\t\t\t&#125; else if t.DiscoveredLabels().Len() &gt; 0 &#123;</span><br><span class=\"line\">\t\t\t\tsp.droppedTargets &#x3D; append(sp.droppedTargets, t)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tsp.mtx.Unlock()</span><br><span class=\"line\">\tsp.sync(all)</span><br><span class=\"line\"></span><br><span class=\"line\">\ttargetSyncIntervalLength.WithLabelValues(sp.config.JobName).Observe(</span><br><span class=\"line\">\t\ttime.Since(start).Seconds(),</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\ttargetScrapePoolSyncsCounter.WithLabelValues(sp.config.JobName).Inc()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Sync</p>\n<ol>\n<li>target</li>\n<li>sync()</li>\n<li></li>\n</ol>\n<p>Append</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; sync takes a list of potentially duplicated targets, deduplicates them, starts</span><br><span class=\"line\">&#x2F;&#x2F; scrape loops for new targets, and stops scrape loops for disappeared targets.</span><br><span class=\"line\">&#x2F;&#x2F; It returns after all stopped scrape loops terminated.</span><br><span class=\"line\">func (sp *scrapePool) sync(targets []*Target) &#123;</span><br><span class=\"line\">\tsp.mtx.Lock()</span><br><span class=\"line\">\tdefer sp.mtx.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar (</span><br><span class=\"line\">\t\tuniqueTargets   &#x3D; map[uint64]struct&#123;&#125;&#123;&#125;</span><br><span class=\"line\">\t\tinterval        &#x3D; time.Duration(sp.config.ScrapeInterval)</span><br><span class=\"line\">\t\ttimeout         &#x3D; time.Duration(sp.config.ScrapeTimeout)</span><br><span class=\"line\">\t\tlimit           &#x3D; int(sp.config.SampleLimit)</span><br><span class=\"line\">\t\thonorLabels     &#x3D; sp.config.HonorLabels</span><br><span class=\"line\">\t\thonorTimestamps &#x3D; sp.config.HonorTimestamps</span><br><span class=\"line\">\t\tmrc             &#x3D; sp.config.MetricRelabelConfigs</span><br><span class=\"line\">\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor _, t :&#x3D; range targets &#123;</span><br><span class=\"line\">\t\tt :&#x3D; t</span><br><span class=\"line\">\t\thash :&#x3D; t.hash()</span><br><span class=\"line\">\t\tuniqueTargets[hash] &#x3D; struct&#123;&#125;&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif _, ok :&#x3D; sp.activeTargets[hash]; !ok &#123;</span><br><span class=\"line\">\t\t\ts :&#x3D; &amp;targetScraper&#123;Target: t, client: sp.client, timeout: timeout&#125;</span><br><span class=\"line\">\t\t\tl :&#x3D; sp.newLoop(scrapeLoopOptions&#123;</span><br><span class=\"line\">\t\t\t\ttarget:          t,</span><br><span class=\"line\">\t\t\t\tscraper:         s,</span><br><span class=\"line\">\t\t\t\tlimit:           limit,</span><br><span class=\"line\">\t\t\t\thonorLabels:     honorLabels,</span><br><span class=\"line\">\t\t\t\thonorTimestamps: honorTimestamps,</span><br><span class=\"line\">\t\t\t\tmrc:             mrc,</span><br><span class=\"line\">\t\t\t&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsp.activeTargets[hash] &#x3D; t</span><br><span class=\"line\">\t\t\tsp.loops[hash] &#x3D; l</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tgo l.run(interval, timeout, nil)</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Need to keep the most updated labels information</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; for displaying it in the Service Discovery web page.</span><br><span class=\"line\">\t\t\tsp.activeTargets[hash].SetDiscoveredLabels(t.DiscoveredLabels())</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar wg sync.WaitGroup</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; Stop and remove old targets and scraper loops.</span><br><span class=\"line\">\tfor hash :&#x3D; range sp.activeTargets &#123;</span><br><span class=\"line\">\t\tif _, ok :&#x3D; uniqueTargets[hash]; !ok &#123;</span><br><span class=\"line\">\t\t\twg.Add(1)</span><br><span class=\"line\">\t\t\tgo func(l loop) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tl.stop()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\twg.Done()</span><br><span class=\"line\">\t\t\t&#125;(sp.loops[hash])</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tdelete(sp.loops, hash)</span><br><span class=\"line\">\t\t\tdelete(sp.activeTargets, hash)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; Wait for all potentially stopped scrapers to terminate.</span><br><span class=\"line\">\t&#x2F;&#x2F; This covers the case of flapping targets. If the server is under high load, a new scraper</span><br><span class=\"line\">\t&#x2F;&#x2F; may be active and tries to insert. The old scraper that didn&#39;t terminate yet could still</span><br><span class=\"line\">\t&#x2F;&#x2F; be inserting a previous sample set.</span><br><span class=\"line\">\twg.Wait()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<ol>\n<li>Target<br>1.1 targetactivemap targetScrapertargetScraperLoopLoop.run()<br>1.2  </li>\n</ol>\n\n        <h3 id=\"ScraperLoop\"   >\n          <a href=\"#ScraperLoop\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ScraperLoop</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (sl *scrapeLoop) run(interval, timeout time.Duration, errc chan&lt;- error) &#123;</span><br><span class=\"line\">\tselect &#123;</span><br><span class=\"line\">\tcase &lt;-time.After(sl.scraper.offset(interval, sl.jitterSeed)):</span><br><span class=\"line\">\t\t&#x2F;&#x2F; Continue after a scraping offset.</span><br><span class=\"line\">\tcase &lt;-sl.ctx.Done():</span><br><span class=\"line\">\t\tclose(sl.stopped)</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar last time.Time</span><br><span class=\"line\"></span><br><span class=\"line\">\tticker :&#x3D; time.NewTicker(interval)</span><br><span class=\"line\">\tdefer ticker.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">mainLoop:</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-sl.parentCtx.Done():</span><br><span class=\"line\">\t\t\tclose(sl.stopped)</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase &lt;-sl.ctx.Done():</span><br><span class=\"line\">\t\t\tbreak mainLoop</span><br><span class=\"line\">\t\tdefault:</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tvar (</span><br><span class=\"line\">\t\t\tstart             &#x3D; time.Now()</span><br><span class=\"line\">\t\t\tscrapeCtx, cancel &#x3D; context.WithTimeout(sl.ctx, timeout)</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#x2F;&#x2F; Only record after the first scrape.</span><br><span class=\"line\">\t\tif !last.IsZero() &#123;</span><br><span class=\"line\">\t\t\ttargetIntervalLength.WithLabelValues(interval.String()).Observe(</span><br><span class=\"line\">\t\t\t\ttime.Since(last).Seconds(),</span><br><span class=\"line\">\t\t\t)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tb :&#x3D; sl.buffers.Get(sl.lastScrapeSize).([]byte)</span><br><span class=\"line\">\t\tbuf :&#x3D; bytes.NewBuffer(b)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcontentType, scrapeErr :&#x3D; sl.scraper.scrape(scrapeCtx, buf)</span><br><span class=\"line\">\t\tcancel()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif scrapeErr &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tb &#x3D; buf.Bytes()</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; NOTE: There were issues with misbehaving clients in the past</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; that occasionally returned empty results. We don&#39;t want those</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; to falsely reset our buffer size.</span><br><span class=\"line\">\t\t\tif len(b) &gt; 0 &#123;</span><br><span class=\"line\">\t\t\t\tsl.lastScrapeSize &#x3D; len(b)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\tlevel.Debug(sl.l).Log(&quot;msg&quot;, &quot;Scrape failed&quot;, &quot;err&quot;, scrapeErr.Error())</span><br><span class=\"line\">\t\t\tif errc !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\terrc &lt;- scrapeErr</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#x2F;&#x2F; A failed scrape is the same as an empty scrape,</span><br><span class=\"line\">\t\t&#x2F;&#x2F; we still call sl.append to trigger stale markers.</span><br><span class=\"line\">\t\ttotal, added, seriesAdded, appErr :&#x3D; sl.append(b, contentType, start)</span><br><span class=\"line\">\t\tif appErr !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tlevel.Warn(sl.l).Log(&quot;msg&quot;, &quot;append failed&quot;, &quot;err&quot;, appErr)</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; The append failed, probably due to a parse error or sample limit.</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Call sl.append again with an empty scrape to trigger stale markers.</span><br><span class=\"line\">\t\t\tif _, _, _, err :&#x3D; sl.append([]byte&#123;&#125;, &quot;&quot;, start); err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\tlevel.Warn(sl.l).Log(&quot;msg&quot;, &quot;append failed&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tsl.buffers.Put(b)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif scrapeErr &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tscrapeErr &#x3D; appErr</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif err :&#x3D; sl.report(start, time.Since(start), total, added, seriesAdded, scrapeErr); err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tlevel.Warn(sl.l).Log(&quot;msg&quot;, &quot;appending scrape report failed&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tlast &#x3D; start</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-sl.parentCtx.Done():</span><br><span class=\"line\">\t\t\tclose(sl.stopped)</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase &lt;-sl.ctx.Done():</span><br><span class=\"line\">\t\t\tbreak mainLoop</span><br><span class=\"line\">\t\tcase &lt;-ticker.C:</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tclose(sl.stopped)</span><br><span class=\"line\"></span><br><span class=\"line\">\tsl.endOfRunStaleness(last, ticker, interval)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>ScraperLoopTargetscraperScrapeStroageAppenderScraperScrape</p>\n<p>ScraperLoopScraper</p>\n<ol>\n<li>SelectOffset</li>\n<li>Scrape</li>\n<li>reportScraperTarget</li>\n</ol>\n\n        <h3 id=\"TargerScraper\"   >\n          <a href=\"#TargerScraper\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>TargerScraper</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (s *targetScraper) scrape(ctx context.Context, w io.Writer) (string, error) &#123;</span><br><span class=\"line\">\tif s.req &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\treq, err :&#x3D; http.NewRequest(&quot;GET&quot;, s.URL().String(), nil)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treq.Header.Add(&quot;Accept&quot;, acceptHeader)</span><br><span class=\"line\">\t\treq.Header.Add(&quot;Accept-Encoding&quot;, &quot;gzip&quot;)</span><br><span class=\"line\">\t\treq.Header.Set(&quot;User-Agent&quot;, userAgentHeader)</span><br><span class=\"line\">\t\treq.Header.Set(&quot;X-Prometheus-Scrape-Timeout-Seconds&quot;, fmt.Sprintf(&quot;%f&quot;, s.timeout.Seconds()))</span><br><span class=\"line\"></span><br><span class=\"line\">\t\ts.req &#x3D; req</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tresp, err :&#x3D; s.client.Do(s.req.WithContext(ctx))</span><br><span class=\"line\">\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tdefer func() &#123;</span><br><span class=\"line\">\t\tio.Copy(ioutil.Discard, resp.Body)</span><br><span class=\"line\">\t\tresp.Body.Close()</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\tif resp.StatusCode !&#x3D; http.StatusOK &#123;</span><br><span class=\"line\">\t\treturn &quot;&quot;, errors.Errorf(&quot;server returned HTTP status %s&quot;, resp.Status)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif resp.Header.Get(&quot;Content-Encoding&quot;) !&#x3D; &quot;gzip&quot; &#123;</span><br><span class=\"line\">\t\t_, err &#x3D; io.Copy(w, resp.Body)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treturn resp.Header.Get(&quot;Content-Type&quot;), nil</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif s.gzipr &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\ts.buf &#x3D; bufio.NewReader(resp.Body)</span><br><span class=\"line\">\t\ts.gzipr, err &#x3D; gzip.NewReader(s.buf)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\ts.buf.Reset(resp.Body)</span><br><span class=\"line\">\t\tif err &#x3D; s.gzipr.Reset(s.buf); err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t_, err &#x3D; io.Copy(w, s.gzipr)</span><br><span class=\"line\">\ts.gzipr.Close()</span><br><span class=\"line\">\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn resp.Header.Get(&quot;Content-Type&quot;), nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>ScrapeHttpClienttarget url contextScraperLoopRun</p>\n","site":{"data":{}},"excerpt":"","more":"<!-- ---\nlayout: post\ntitle: Prometheus\nauthor: Ray Chan(ray1888)\ndate: '2019-10-06 15:31:38 +0800'\ncategory: Prometheus\nsummary: Prometheus Scrape Module\nthumbnail: Prometheus.png\n--- -->\n\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li></li>\n<li></li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p> prometheusmaster branch5a554df0855bf707a8c333c0dd830067d03422cf commit</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>Prometheus PullScrapePrometheus</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">main.go</span><br><span class=\"line\">&#x2F;&#x2F; line 356</span><br><span class=\"line\">scrapeManager &#x3D; scrape.NewManager(log.With(logger, &quot;component&quot;, &quot;scrape manager&quot;), fanoutStorage)</span><br><span class=\"line\">&#x2F;&#x2F; line 427</span><br><span class=\"line\">scrapeManager.ApplyConfig</span><br><span class=\"line\">&#x2F;&#x2F; line 555</span><br><span class=\"line\">err :&#x3D; scrapeManager.Run(discoveryManagerScrape.SyncCh())</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <!-- ![ServiceDiscoveryModule](/assets/img/posts/prometheus/ScrapeModule.png) -->\n<img src=\"/2019/10/06/prometheus-scrape/ScrapeModule.png\" class=\"\" title=\"ServiceDiscoveryModule\">\n\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-rw-r--r-- 1 ray 197121  2239 9  30 16:09 helpers_test.go</span><br><span class=\"line\">-rw-r--r-- 1 ray 197121  7543 9  30 16:09 manager.go   &#x2F;&#x2F;Manager</span><br><span class=\"line\">-rw-r--r-- 1 ray 197121 10727 9  30 16:09 manager_test.go</span><br><span class=\"line\">-rw-r--r-- 1 ray 197121 35749 9  30 16:09 scrape.go    &#x2F;&#x2F; </span><br><span class=\"line\">-rw-r--r-- 1 ray 197121 40682 9  30 16:09 scrape_test.go</span><br><span class=\"line\">-rw-r--r-- 1 ray 197121 11743 9  30 16:09 target.go    &#x2F;&#x2F;  </span><br><span class=\"line\">-rw-r--r-- 1 ray 197121  9542 9  30 16:09 target_test.go</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>ScrapeManager </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Manager struct &#123;</span><br><span class=\"line\">\tlogger    log.Logger</span><br><span class=\"line\">\tappend    Appendable</span><br><span class=\"line\">\tgraceShut chan struct&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tjitterSeed    uint64     &#x2F;&#x2F; Global jitterSeed seed is used to spread scrape workload across HA setup.</span><br><span class=\"line\">\tmtxScrape     sync.Mutex &#x2F;&#x2F; Guards the fields below.</span><br><span class=\"line\">\tscrapeConfigs map[string]*config.ScrapeConfig</span><br><span class=\"line\">\tscrapePools   map[string]*scrapePool</span><br><span class=\"line\">\ttargetSets    map[string][]*targetgroup.Group</span><br><span class=\"line\"></span><br><span class=\"line\">\ttriggerReload chan struct&#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>ScrapePools Job</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">appendable Appendable</span><br><span class=\"line\">\tlogger     log.Logger</span><br><span class=\"line\"></span><br><span class=\"line\">\tmtx    sync.RWMutex</span><br><span class=\"line\">\tconfig *config.ScrapeConfig</span><br><span class=\"line\">\tclient *http.Client</span><br><span class=\"line\">\t&#x2F;&#x2F; Targets and loops must always be synchronized to have the same</span><br><span class=\"line\">\t&#x2F;&#x2F; set of hashes.</span><br><span class=\"line\">\tactiveTargets  map[uint64]*Target</span><br><span class=\"line\">\tdroppedTargets []*Target</span><br><span class=\"line\">\tloops          map[uint64]loop</span><br><span class=\"line\">\tcancel         context.CancelFunc</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; Constructor for new scrape loops. This is settable for testing convenience.</span><br><span class=\"line\">\tnewLoop func(scrapeLoopOptions) loop</span><br></pre></td></tr></table></div></figure>\n<p>loopTargetScrapeLoop</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type loop interface &#123;</span><br><span class=\"line\">\trun(interval, timeout time.Duration, errc chan&lt;- error)</span><br><span class=\"line\">\tstop()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type scrapeLoop struct &#123;</span><br><span class=\"line\">\tscraper         scraper</span><br><span class=\"line\">\tl               log.Logger</span><br><span class=\"line\">\tcache           *scrapeCache</span><br><span class=\"line\">\tlastScrapeSize  int</span><br><span class=\"line\">\tbuffers         *pool.Pool</span><br><span class=\"line\">\tjitterSeed      uint64</span><br><span class=\"line\">\thonorTimestamps bool</span><br><span class=\"line\"></span><br><span class=\"line\">\tappender            func() storage.Appender</span><br><span class=\"line\">\tsampleMutator       labelsMutator</span><br><span class=\"line\">\treportSampleMutator labelsMutator</span><br><span class=\"line\"></span><br><span class=\"line\">\tparentCtx context.Context</span><br><span class=\"line\">\tctx       context.Context</span><br><span class=\"line\">\tcancel    func()</span><br><span class=\"line\">\tstopped   chan struct&#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>scraperscrapeLoopscraper, PrometheustargetScraper</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type scraper interface &#123;</span><br><span class=\"line\">\tscrape(ctx context.Context, w io.Writer) (string, error) &#x2F;&#x2F; </span><br><span class=\"line\">\treport(start time.Time, dur time.Duration, err error)    &#x2F;&#x2F; </span><br><span class=\"line\">\toffset(interval time.Duration, jitterSeed uint64) time.Duration &#x2F;&#x2F; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type targetScraper struct &#123;</span><br><span class=\"line\">\t*Target  &#x2F;&#x2F;reportoffset</span><br><span class=\"line\"></span><br><span class=\"line\">\tclient  *http.Client &#x2F;&#x2F;Prometheusexporterhttphttpclient</span><br><span class=\"line\">\treq     *http.Request</span><br><span class=\"line\">\ttimeout time.Duration</span><br><span class=\"line\"></span><br><span class=\"line\">\tgzipr *gzip.Reader</span><br><span class=\"line\">\tbuf   *bufio.Reader</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>managerApplyConfig</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (m *Manager) ApplyConfig(cfg *config.Config) error &#123;</span><br><span class=\"line\">\tm.mtxScrape.Lock()</span><br><span class=\"line\">\tdefer m.mtxScrape.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\tc :&#x3D; make(map[string]*config.ScrapeConfig)</span><br><span class=\"line\">    </span><br><span class=\"line\">\tfor _, scfg :&#x3D; range cfg.ScrapeConfigs &#123;</span><br><span class=\"line\">\t\tc[scfg.JobName] &#x3D; scfg</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tm.scrapeConfigs &#x3D; c</span><br><span class=\"line\">    &#x2F;&#x2F; seed</span><br><span class=\"line\">\tif err :&#x3D; m.setJitterSeed(cfg.GlobalConfig.ExternalLabels); err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\treturn err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; Cleanup and reload pool if the configuration has changed.</span><br><span class=\"line\">\tvar failed bool</span><br><span class=\"line\">    &#x2F;&#x2F; ScrapePool </span><br><span class=\"line\">\tfor name, sp :&#x3D; range m.scrapePools &#123;</span><br><span class=\"line\">\t\tif cfg, ok :&#x3D; m.scrapeConfigs[name]; !ok &#123;</span><br><span class=\"line\">\t\t\tsp.stop()</span><br><span class=\"line\">\t\t\tdelete(m.scrapePools, name)</span><br><span class=\"line\">\t\t&#125; else if !reflect.DeepEqual(sp.config, cfg) &#123;</span><br><span class=\"line\">\t\t\terr :&#x3D; sp.reload(cfg)</span><br><span class=\"line\">\t\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\tlevel.Error(m.logger).Log(&quot;msg&quot;, &quot;error reloading scrape pool&quot;, &quot;err&quot;, err, &quot;scrape_pool&quot;, name)</span><br><span class=\"line\">\t\t\t\tfailed &#x3D; true</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif failed &#123;</span><br><span class=\"line\">\t\treturn errors.New(&quot;failed to apply the new configuration&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (sp *scrapePool) reload(cfg *config.ScrapeConfig) error &#123;</span><br><span class=\"line\">\ttargetScrapePoolReloads.Inc()</span><br><span class=\"line\">\tstart :&#x3D; time.Now()</span><br><span class=\"line\"></span><br><span class=\"line\">\tsp.mtx.Lock()</span><br><span class=\"line\">\tdefer sp.mtx.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\tclient, err :&#x3D; config_util.NewClientFromConfig(cfg.HTTPClientConfig, cfg.JobName, false)</span><br><span class=\"line\">\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\ttargetScrapePoolReloadsFailed.Inc()</span><br><span class=\"line\">\t\treturn errors.Wrap(err, &quot;error creating HTTP client&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tsp.config &#x3D; cfg</span><br><span class=\"line\">\toldClient :&#x3D; sp.client</span><br><span class=\"line\">\tsp.client &#x3D; client</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar (</span><br><span class=\"line\">\t\twg              sync.WaitGroup</span><br><span class=\"line\">\t\tinterval        &#x3D; time.Duration(sp.config.ScrapeInterval)</span><br><span class=\"line\">\t\ttimeout         &#x3D; time.Duration(sp.config.ScrapeTimeout)</span><br><span class=\"line\">\t\tlimit           &#x3D; int(sp.config.SampleLimit)</span><br><span class=\"line\">\t\thonorLabels     &#x3D; sp.config.HonorLabels</span><br><span class=\"line\">\t\thonorTimestamps &#x3D; sp.config.HonorTimestamps</span><br><span class=\"line\">\t\tmrc             &#x3D; sp.config.MetricRelabelConfigs</span><br><span class=\"line\">\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor fp, oldLoop :&#x3D; range sp.loops &#123;</span><br><span class=\"line\">\t\tvar (</span><br><span class=\"line\">\t\t\tt       &#x3D; sp.activeTargets[fp]</span><br><span class=\"line\">\t\t\ts       &#x3D; &amp;targetScraper&#123;Target: t, client: sp.client, timeout: timeout&#125;</span><br><span class=\"line\">\t\t\tnewLoop &#x3D; sp.newLoop(scrapeLoopOptions&#123;</span><br><span class=\"line\">\t\t\t\ttarget:          t,</span><br><span class=\"line\">\t\t\t\tscraper:         s,</span><br><span class=\"line\">\t\t\t\tlimit:           limit,</span><br><span class=\"line\">\t\t\t\thonorLabels:     honorLabels,</span><br><span class=\"line\">\t\t\t\thonorTimestamps: honorTimestamps,</span><br><span class=\"line\">\t\t\t\tmrc:             mrc,</span><br><span class=\"line\">\t\t\t&#125;)</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\">\t\twg.Add(1)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tgo func(oldLoop, newLoop loop) &#123;</span><br><span class=\"line\">\t\t\toldLoop.stop()</span><br><span class=\"line\">\t\t\twg.Done()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tgo newLoop.run(interval, timeout, nil)</span><br><span class=\"line\">\t\t&#125;(oldLoop, newLoop)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tsp.loops[fp] &#x3D; newLoop</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\twg.Wait()</span><br><span class=\"line\">\toldClient.CloseIdleConnections()</span><br><span class=\"line\">\ttargetReloadIntervalLength.WithLabelValues(interval.String()).Observe(</span><br><span class=\"line\">\t\ttime.Since(start).Seconds(),</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\treturn nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<ol>\n<li>jobNamekeyValuemap</li>\n<li>reload scraper pool</li>\n<li>Reload reloadscrapePoolscraperPool.Sync()ManagertargetSetSync</li>\n</ol>\n<p>Run()</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (m *Manager) Run(tsets &lt;-chan map[string][]*targetgroup.Group) error &#123;</span><br><span class=\"line\">\tgo m.reloader()</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase ts :&#x3D; &lt;-tsets:</span><br><span class=\"line\">\t\t\tm.updateTsets(ts)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase m.triggerReload &lt;- struct&#123;&#125;&#123;&#125;:</span><br><span class=\"line\">\t\t\tdefault:</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcase &lt;-m.graceShut:</span><br><span class=\"line\">\t\t\treturn nil</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func (m *Manager) reloader() &#123;</span><br><span class=\"line\">\tticker :&#x3D; time.NewTicker(5 * time.Second)</span><br><span class=\"line\">\tdefer ticker.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-m.graceShut:</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase &lt;-ticker.C:</span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase &lt;-m.triggerReload:</span><br><span class=\"line\">\t\t\t\tm.reload()</span><br><span class=\"line\">\t\t\tcase &lt;-m.graceShut:</span><br><span class=\"line\">\t\t\t\treturn</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<ol>\n<li>Main.godiscoveryManagerSyncChTargetset</li>\n<li>ReloaderReloaderReloadtriggerReload channel,reload</li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      \n        <h3 id=\"ScraperPool\"   >\n          <a href=\"#ScraperPool\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ScraperPool</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; Sync converts target groups into actual scrape targets and synchronizes</span><br><span class=\"line\">&#x2F;&#x2F; the currently running scraper with the resulting set and returns all scraped and dropped targets.</span><br><span class=\"line\">func (sp *scrapePool) Sync(tgs []*targetgroup.Group) &#123;</span><br><span class=\"line\">\tstart :&#x3D; time.Now()</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar all []*Target</span><br><span class=\"line\">\tsp.mtx.Lock()</span><br><span class=\"line\">\tsp.droppedTargets &#x3D; []*Target&#123;&#125;</span><br><span class=\"line\">\tfor _, tg :&#x3D; range tgs &#123;</span><br><span class=\"line\">\t\ttargets, err :&#x3D; targetsFromGroup(tg, sp.config)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tlevel.Error(sp.logger).Log(&quot;msg&quot;, &quot;creating targets failed&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t\tcontinue</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tfor _, t :&#x3D; range targets &#123;</span><br><span class=\"line\">\t\t\tif t.Labels().Len() &gt; 0 &#123;</span><br><span class=\"line\">\t\t\t\tall &#x3D; append(all, t)</span><br><span class=\"line\">\t\t\t&#125; else if t.DiscoveredLabels().Len() &gt; 0 &#123;</span><br><span class=\"line\">\t\t\t\tsp.droppedTargets &#x3D; append(sp.droppedTargets, t)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tsp.mtx.Unlock()</span><br><span class=\"line\">\tsp.sync(all)</span><br><span class=\"line\"></span><br><span class=\"line\">\ttargetSyncIntervalLength.WithLabelValues(sp.config.JobName).Observe(</span><br><span class=\"line\">\t\ttime.Since(start).Seconds(),</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\ttargetScrapePoolSyncsCounter.WithLabelValues(sp.config.JobName).Inc()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Sync</p>\n<ol>\n<li>target</li>\n<li>sync()</li>\n<li></li>\n</ol>\n<p>Append</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; sync takes a list of potentially duplicated targets, deduplicates them, starts</span><br><span class=\"line\">&#x2F;&#x2F; scrape loops for new targets, and stops scrape loops for disappeared targets.</span><br><span class=\"line\">&#x2F;&#x2F; It returns after all stopped scrape loops terminated.</span><br><span class=\"line\">func (sp *scrapePool) sync(targets []*Target) &#123;</span><br><span class=\"line\">\tsp.mtx.Lock()</span><br><span class=\"line\">\tdefer sp.mtx.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar (</span><br><span class=\"line\">\t\tuniqueTargets   &#x3D; map[uint64]struct&#123;&#125;&#123;&#125;</span><br><span class=\"line\">\t\tinterval        &#x3D; time.Duration(sp.config.ScrapeInterval)</span><br><span class=\"line\">\t\ttimeout         &#x3D; time.Duration(sp.config.ScrapeTimeout)</span><br><span class=\"line\">\t\tlimit           &#x3D; int(sp.config.SampleLimit)</span><br><span class=\"line\">\t\thonorLabels     &#x3D; sp.config.HonorLabels</span><br><span class=\"line\">\t\thonorTimestamps &#x3D; sp.config.HonorTimestamps</span><br><span class=\"line\">\t\tmrc             &#x3D; sp.config.MetricRelabelConfigs</span><br><span class=\"line\">\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor _, t :&#x3D; range targets &#123;</span><br><span class=\"line\">\t\tt :&#x3D; t</span><br><span class=\"line\">\t\thash :&#x3D; t.hash()</span><br><span class=\"line\">\t\tuniqueTargets[hash] &#x3D; struct&#123;&#125;&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif _, ok :&#x3D; sp.activeTargets[hash]; !ok &#123;</span><br><span class=\"line\">\t\t\ts :&#x3D; &amp;targetScraper&#123;Target: t, client: sp.client, timeout: timeout&#125;</span><br><span class=\"line\">\t\t\tl :&#x3D; sp.newLoop(scrapeLoopOptions&#123;</span><br><span class=\"line\">\t\t\t\ttarget:          t,</span><br><span class=\"line\">\t\t\t\tscraper:         s,</span><br><span class=\"line\">\t\t\t\tlimit:           limit,</span><br><span class=\"line\">\t\t\t\thonorLabels:     honorLabels,</span><br><span class=\"line\">\t\t\t\thonorTimestamps: honorTimestamps,</span><br><span class=\"line\">\t\t\t\tmrc:             mrc,</span><br><span class=\"line\">\t\t\t&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsp.activeTargets[hash] &#x3D; t</span><br><span class=\"line\">\t\t\tsp.loops[hash] &#x3D; l</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tgo l.run(interval, timeout, nil)</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Need to keep the most updated labels information</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; for displaying it in the Service Discovery web page.</span><br><span class=\"line\">\t\t\tsp.activeTargets[hash].SetDiscoveredLabels(t.DiscoveredLabels())</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar wg sync.WaitGroup</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; Stop and remove old targets and scraper loops.</span><br><span class=\"line\">\tfor hash :&#x3D; range sp.activeTargets &#123;</span><br><span class=\"line\">\t\tif _, ok :&#x3D; uniqueTargets[hash]; !ok &#123;</span><br><span class=\"line\">\t\t\twg.Add(1)</span><br><span class=\"line\">\t\t\tgo func(l loop) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tl.stop()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\twg.Done()</span><br><span class=\"line\">\t\t\t&#125;(sp.loops[hash])</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tdelete(sp.loops, hash)</span><br><span class=\"line\">\t\t\tdelete(sp.activeTargets, hash)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; Wait for all potentially stopped scrapers to terminate.</span><br><span class=\"line\">\t&#x2F;&#x2F; This covers the case of flapping targets. If the server is under high load, a new scraper</span><br><span class=\"line\">\t&#x2F;&#x2F; may be active and tries to insert. The old scraper that didn&#39;t terminate yet could still</span><br><span class=\"line\">\t&#x2F;&#x2F; be inserting a previous sample set.</span><br><span class=\"line\">\twg.Wait()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<ol>\n<li>Target<br>1.1 targetactivemap targetScrapertargetScraperLoopLoop.run()<br>1.2  </li>\n</ol>\n\n        <h3 id=\"ScraperLoop\"   >\n          <a href=\"#ScraperLoop\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ScraperLoop</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (sl *scrapeLoop) run(interval, timeout time.Duration, errc chan&lt;- error) &#123;</span><br><span class=\"line\">\tselect &#123;</span><br><span class=\"line\">\tcase &lt;-time.After(sl.scraper.offset(interval, sl.jitterSeed)):</span><br><span class=\"line\">\t\t&#x2F;&#x2F; Continue after a scraping offset.</span><br><span class=\"line\">\tcase &lt;-sl.ctx.Done():</span><br><span class=\"line\">\t\tclose(sl.stopped)</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar last time.Time</span><br><span class=\"line\"></span><br><span class=\"line\">\tticker :&#x3D; time.NewTicker(interval)</span><br><span class=\"line\">\tdefer ticker.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">mainLoop:</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-sl.parentCtx.Done():</span><br><span class=\"line\">\t\t\tclose(sl.stopped)</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase &lt;-sl.ctx.Done():</span><br><span class=\"line\">\t\t\tbreak mainLoop</span><br><span class=\"line\">\t\tdefault:</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tvar (</span><br><span class=\"line\">\t\t\tstart             &#x3D; time.Now()</span><br><span class=\"line\">\t\t\tscrapeCtx, cancel &#x3D; context.WithTimeout(sl.ctx, timeout)</span><br><span class=\"line\">\t\t)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#x2F;&#x2F; Only record after the first scrape.</span><br><span class=\"line\">\t\tif !last.IsZero() &#123;</span><br><span class=\"line\">\t\t\ttargetIntervalLength.WithLabelValues(interval.String()).Observe(</span><br><span class=\"line\">\t\t\t\ttime.Since(last).Seconds(),</span><br><span class=\"line\">\t\t\t)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tb :&#x3D; sl.buffers.Get(sl.lastScrapeSize).([]byte)</span><br><span class=\"line\">\t\tbuf :&#x3D; bytes.NewBuffer(b)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcontentType, scrapeErr :&#x3D; sl.scraper.scrape(scrapeCtx, buf)</span><br><span class=\"line\">\t\tcancel()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif scrapeErr &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tb &#x3D; buf.Bytes()</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; NOTE: There were issues with misbehaving clients in the past</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; that occasionally returned empty results. We don&#39;t want those</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; to falsely reset our buffer size.</span><br><span class=\"line\">\t\t\tif len(b) &gt; 0 &#123;</span><br><span class=\"line\">\t\t\t\tsl.lastScrapeSize &#x3D; len(b)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\tlevel.Debug(sl.l).Log(&quot;msg&quot;, &quot;Scrape failed&quot;, &quot;err&quot;, scrapeErr.Error())</span><br><span class=\"line\">\t\t\tif errc !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\terrc &lt;- scrapeErr</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#x2F;&#x2F; A failed scrape is the same as an empty scrape,</span><br><span class=\"line\">\t\t&#x2F;&#x2F; we still call sl.append to trigger stale markers.</span><br><span class=\"line\">\t\ttotal, added, seriesAdded, appErr :&#x3D; sl.append(b, contentType, start)</span><br><span class=\"line\">\t\tif appErr !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tlevel.Warn(sl.l).Log(&quot;msg&quot;, &quot;append failed&quot;, &quot;err&quot;, appErr)</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; The append failed, probably due to a parse error or sample limit.</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Call sl.append again with an empty scrape to trigger stale markers.</span><br><span class=\"line\">\t\t\tif _, _, _, err :&#x3D; sl.append([]byte&#123;&#125;, &quot;&quot;, start); err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\tlevel.Warn(sl.l).Log(&quot;msg&quot;, &quot;append failed&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tsl.buffers.Put(b)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif scrapeErr &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tscrapeErr &#x3D; appErr</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif err :&#x3D; sl.report(start, time.Since(start), total, added, seriesAdded, scrapeErr); err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tlevel.Warn(sl.l).Log(&quot;msg&quot;, &quot;appending scrape report failed&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tlast &#x3D; start</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-sl.parentCtx.Done():</span><br><span class=\"line\">\t\t\tclose(sl.stopped)</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase &lt;-sl.ctx.Done():</span><br><span class=\"line\">\t\t\tbreak mainLoop</span><br><span class=\"line\">\t\tcase &lt;-ticker.C:</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tclose(sl.stopped)</span><br><span class=\"line\"></span><br><span class=\"line\">\tsl.endOfRunStaleness(last, ticker, interval)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>ScraperLoopTargetscraperScrapeStroageAppenderScraperScrape</p>\n<p>ScraperLoopScraper</p>\n<ol>\n<li>SelectOffset</li>\n<li>Scrape</li>\n<li>reportScraperTarget</li>\n</ol>\n\n        <h3 id=\"TargerScraper\"   >\n          <a href=\"#TargerScraper\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>TargerScraper</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (s *targetScraper) scrape(ctx context.Context, w io.Writer) (string, error) &#123;</span><br><span class=\"line\">\tif s.req &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\treq, err :&#x3D; http.NewRequest(&quot;GET&quot;, s.URL().String(), nil)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treq.Header.Add(&quot;Accept&quot;, acceptHeader)</span><br><span class=\"line\">\t\treq.Header.Add(&quot;Accept-Encoding&quot;, &quot;gzip&quot;)</span><br><span class=\"line\">\t\treq.Header.Set(&quot;User-Agent&quot;, userAgentHeader)</span><br><span class=\"line\">\t\treq.Header.Set(&quot;X-Prometheus-Scrape-Timeout-Seconds&quot;, fmt.Sprintf(&quot;%f&quot;, s.timeout.Seconds()))</span><br><span class=\"line\"></span><br><span class=\"line\">\t\ts.req &#x3D; req</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tresp, err :&#x3D; s.client.Do(s.req.WithContext(ctx))</span><br><span class=\"line\">\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tdefer func() &#123;</span><br><span class=\"line\">\t\tio.Copy(ioutil.Discard, resp.Body)</span><br><span class=\"line\">\t\tresp.Body.Close()</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\tif resp.StatusCode !&#x3D; http.StatusOK &#123;</span><br><span class=\"line\">\t\treturn &quot;&quot;, errors.Errorf(&quot;server returned HTTP status %s&quot;, resp.Status)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif resp.Header.Get(&quot;Content-Encoding&quot;) !&#x3D; &quot;gzip&quot; &#123;</span><br><span class=\"line\">\t\t_, err &#x3D; io.Copy(w, resp.Body)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treturn resp.Header.Get(&quot;Content-Type&quot;), nil</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif s.gzipr &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\ts.buf &#x3D; bufio.NewReader(resp.Body)</span><br><span class=\"line\">\t\ts.gzipr, err &#x3D; gzip.NewReader(s.buf)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\ts.buf.Reset(resp.Body)</span><br><span class=\"line\">\t\tif err &#x3D; s.gzipr.Reset(s.buf); err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t_, err &#x3D; io.Copy(w, s.gzipr)</span><br><span class=\"line\">\ts.gzipr.Close()</span><br><span class=\"line\">\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\treturn &quot;&quot;, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn resp.Header.Get(&quot;Content-Type&quot;), nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>ScrapeHttpClienttarget url contextScraperLoopRun</p>\n"},{"title":"Prometheus","date":"2019-10-05T12:51:38.000Z","_content":"\n\n<!-- ---\nlayout: post\ntitle: Prometheus\nauthor: Ray Chan(ray1888)\ndate: '2019-10-05 20:51:38 +0800'\ncategory: Prometheus\nsummary: Prometheus Service Discovery Module\nthumbnail: Prometheus.png\n--- -->\n\n# \n1.   \n2.   \n   2.1   \n   2.2 \n\n# \n\n prometheusmaster branch5a554df0855bf707a8c333c0dd830067d03422cf commit\n\n# \nPrometheusPrometheus[OpenStack] \n\nPrometheusprometheus/discoveryPrometheusAlertManager\n\n\n```\n//  cmd/main.go 350-352\n\tctxScrape, cancelScrape = context.WithCancel(context.Background())\n\tdiscoveryManagerScrape  = discovery.NewManager(ctxScrape, log.With(logger, \"component\", \"discovery manager scrape\"), discovery.Name(\"scrape\"))\n\n\tctxNotify, cancelNotify = context.WithCancel(context.Background())\n\tdiscoveryManagerNotify  = discovery.NewManager(ctxNotify, log.With(logger, \"component\", \"discovery manager notify\"), discovery.Name(\"notify\"))\n\n//  \n/* \n\tcmd/main.go line 555, ManagerscrapeManagerrestore scrape\n\tScrape\n\t*/\nerr := scrapeManager.Run(discoveryManagerScrape.SyncCh())\n\n/* \n\tcmd/main.go line 726, ManagernotifierManageralertManager\n\tNotifer\n\t*/\nnotifierManager.Run(discoveryManagerNotify.SyncCh())\n\n// main.go line 735, run Group g discoveryManagerRun\n```\n\n\n1. main.godiscoveryManager\n2. discovery configProvider\n3. discoveryManagerRun\n\n# \n\n## \n\n<!-- ![ServiceDiscoveryModule](/assets/img/posts/prometheus/DiscoverManager.png) -->\n{% asset_img DiscoverManager.png ServiceDiscoveryModule %}\n\n## \n1. ApplyConfig()service discoveryNewManagerservice DiscoveryaddProviders\n```\nadd := func(cfg interface{}, newDiscoverer func() (Discoverer, error)) {\n\t\tt := reflect.TypeOf(cfg).String()\n\t\tfor _, p := range m.providers {\n\t\t\tif reflect.DeepEqual(cfg, p.config) {\n\t\t\t\tp.subs = append(p.subs, setName)\n\t\t\t\tadded = true\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\n\t\td, err := newDiscoverer()\n\t\tif err != nil {\n\t\t\tlevel.Error(m.logger).Log(\"msg\", \"Cannot create service discovery\", \"err\", err, \"type\", t)\n\t\t\tfailedCount++\n\t\t\treturn\n\t\t}\n\n\t\tprovider := provider{\n\t\t\tname:   fmt.Sprintf(\"%s/%d\", t, len(m.providers)),\n\t\t\td:      d,\n\t\t\tconfig: cfg,\n\t\t\tsubs:   []string{setName},\n\t\t}\n\t\tm.providers = append(m.providers, &provider)\n\t\tadded = true\n\t}\n//  discovery/manager.go 356-417\n```\n\n2. Provider \n```\n\t// discovery/manager.go line 223-226\n\tfunc (m *Manager) startProvider(ctx context.Context, p *provider) {\n\t\tlevel.Debug(m.logger).Log(\"msg\", \"Starting provider\", \"provider\", p.name, \"subs\", fmt.Sprintf(\"%v\", p.subs))\n\t\tctx, cancel := context.WithCancel(ctx)\n\t\t// UpdateWatch\n\t\tupdates := make(chan []*targetgroup.Group)\n\t\tm.discoverCancel = append(m.discoverCancel, cancel)\n\n\t\t//  Watch\n\t\tgo p.d.Run(ctx, updates)\n\t\t// updatesManager\n\t\tgo m.updater(ctx, p, updates)\n\t}\n\n\t// discovery/manager.go line 205-207\n\tfor _, prov := range m.providers {\n\t\t\tm.startProvider(m.ctx, prov)\n\t}\n```\n\nApplyConfigRun\n```\n\tfunc (m *Manager) Run() error {\n\t\tgo m.sender()\n\t\tfor range m.ctx.Done() {\n\t\t\tm.cancelDiscoverers()\n\t\t\treturn m.ctx.Err()\n\t\t}\n\t\treturn nil\n\t}\n```\n\nManagerupdatertriggerchan,contextdoneManager.Updater()Manager.Sender()\n\n Manager.trigglechan is 1buffered channelupdates := make(chan []*targetgroup.Group), unbuffered channel \n```\n\tfunc (m *Manager) updater(ctx context.Context, p *provider, updates chan []*targetgroup.Group) {\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-ctx.Done():\n\t\t\t\treturn\n\t\t\tcase tgs, ok := <-updates:\n\t\t\t\treceivedUpdates.WithLabelValues(m.name).Inc()\n\t\t\t\tif !ok {\n\t\t\t\t\tlevel.Debug(m.logger).Log(\"msg\", \"discoverer channel closed\", \"provider\", p.name)\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tfor _, s := range p.subs {\n\t\t\t\t\tm.updateGroup(poolKey{setName: s, provider: p.name}, tgs)\n\t\t\t\t}\n\n\t\t\t\tselect {\n\t\t\t\tcase m.triggerSend <- struct{}{}:\n\t\t\t\tdefault:\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tfunc (m *Manager) sender() {\n\t\tticker := time.NewTicker(m.updatert)\n\t\tdefer ticker.Stop()\n\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-m.ctx.Done():\n\t\t\t\treturn\n\t\t\tcase <-ticker.C: // Some discoverers send updates too often so we throttle these with the ticker.\n\t\t\t\tselect {\n\t\t\t\tcase <-m.triggerSend:\n\t\t\t\t\tsentUpdates.WithLabelValues(m.name).Inc()\n\t\t\t\t\tselect {\n\t\t\t\t\tcase m.syncCh <- m.allGroups():\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tdelayedUpdates.WithLabelValues(m.name).Inc()\n\t\t\t\t\t\tlevel.Debug(m.logger).Log(\"msg\", \"discovery receiver's channel was full so will retry the next cycle\")\n\t\t\t\t\t\tselect {\n\t\t\t\t\t\tcase m.triggerSend <- struct{}{}:\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n```\n\n\n1. Provider updateupdate channel\n2. Manager.UpdaterManagerGrouptriggerSend channel\n3. Manager.SendertriggerSend ChannelsyncCh(MainsyncChScrapeManagerNotiferManager)\n\n\n\n##   \n### Provider  \n```\ntype Discoverer interface {\n\t// Run hands a channel to the discovery provider (Consul, DNS etc) through which it can send\n\t// updated target groups.\n\t// Must returns if the context gets canceled. It should not close the update\n\t// channel on returning.\n\tRun(ctx context.Context, up chan<- []*targetgroup.Group)\n}\n```\nProviderProviderDiscovererRunp.d.Run()\n\nProviderProviderzookeeperProvider\nProviderwatch&notifyApiwatch&notify\n\n#### FileProvider\n\nFileProviderjsonyaml  \n```\n// discovery/file/file.go line 39-46\nvar (\n\tpatFileSDName = regexp.MustCompile(`^[^*]*(\\*[^/]*)?\\.(json|yml|yaml|JSON|YML|YAML)$`)\n\n\t// DefaultSDConfig is the default file SD configuration.\n\tDefaultSDConfig = SDConfig{\n\t\tRefreshInterval: model.Duration(5 * time.Minute),\n\t}\n)\n```\n\nDiscovererRun\n```\nfunc (d *Discovery) Run(ctx context.Context, ch chan<- []*targetgroup.Group) {\n\twatcher, err := fsnotify.NewWatcher()\n\tif err != nil {\n\t\tlevel.Error(d.logger).Log(\"msg\", \"Error adding file watcher\", \"err\", err)\n\t\treturn\n\t}\n\td.watcher = watcher\n\tdefer d.stop()\n\n    //  confdiscoverer\n\td.refresh(ctx, ch)\n\n\tticker := time.NewTicker(d.interval)\n\tdefer ticker.Stop()\n\n\tfor {\n\t\tselect {\n\t\tcase <-ctx.Done():\n\t\t\treturn\n\n\t\tcase event := <-d.watcher.Events:\n\t\t\t// fsnotify sometimes sends a bunch of events without name or operation.\n\t\t\t// It's unclear what they are and why they are sent - filter them out.\n\t\t\tif len(event.Name) == 0 {\n\t\t\t\tbreak\n\t\t\t}\n\t\t\t// Everything but a chmod requires rereading.\n\t\t\tif event.Op^fsnotify.Chmod == 0 {\n\t\t\t\tbreak\n\t\t\t}\n\t\t\t// Changes to a file can spawn various sequences of events with\n\t\t\t// different combinations of operations. For all practical purposes\n\t\t\t// this is inaccurate.\n\t\t\t// The most reliable solution is to reload everything if anything happens.\n\t\t\td.refresh(ctx, ch)\n\n\t\tcase <-ticker.C:\n\t\t\t// Setting a new watch after an update might fail. Make sure we don't lose\n\t\t\t// those files forever.\n\t\t\td.refresh(ctx, ch)\n\n\t\tcase err := <-d.watcher.Errors:\n\t\t\tif err != nil {\n\t\t\t\tlevel.Error(d.logger).Log(\"msg\", \"Error watching file\", \"err\", err)\n\t\t\t}\n\t\t}\n\t}\n}\n```\n\nFile Discoverer Watch(ticker.C)event := <-d.watcher.Events)\n\nRefreshupdate channel\n```\nfunc (d *Discovery) refresh(ctx context.Context, ch chan<- []*targetgroup.Group) {\n\tt0 := time.Now()\n\tdefer func() {\n\t\tfileSDScanDuration.Observe(time.Since(t0).Seconds())\n\t}()\n\tref := map[string]int{}\n\t// \n\tfor _, p := range d.listFiles() {\n\t\t//  targets\n\t\ttgroups, err := d.readFile(p)\n\t\tif err != nil {\n\t\t\tfileSDReadErrorsCount.Inc()\n\n\t\t\tlevel.Error(d.logger).Log(\"msg\", \"Error reading file\", \"path\", p, \"err\", err)\n\t\t\t// Prevent deletion down below.\n\t\t\tref[p] = d.lastRefresh[p]\n\t\t\tcontinue\n\t\t}\n\t\tselect {\n\t\t\t// Update\n\t\tcase ch <- tgroups:\n\t\tcase <-ctx.Done():\n\t\t\treturn\n\t\t}\n\n\t\tref[p] = len(tgroups)\n\t}\n\t// Send empty updates for sources that disappeared.\n\tfor f, n := range d.lastRefresh {\n\t\tm, ok := ref[f]\n\t\tif !ok || n > m {\n\t\t\tlevel.Debug(d.logger).Log(\"msg\", \"file_sd refresh found file that should be removed\", \"file\", f)\n\t\t\td.deleteTimestamp(f)\n\t\t\tfor i := m; i < n; i++ {\n\t\t\t\tselect {\n\t\t\t\tcase ch <- []*targetgroup.Group{{Source: fileSource(f, i)}}:\n\t\t\t\tcase <-ctx.Done():\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\td.lastRefresh = ref\n\n\td.watchFiles()\n}\n```\n\n#### zookeeperProvider\n\nZookeeperProvider\n1. zookeeperzookeeper\n2. ServerSetPointNerveEndPointDiscoveryDiscovery\n3. \n\n```\n\ttype Discovery struct {\n\t\tconn *zk.Conn\n\n\t\tsources map[string]*targetgroup.Group\n\n\t\tupdates     chan treecache.ZookeeperTreeCacheEvent\n\t\tpathUpdates []chan treecache.ZookeeperTreeCacheEvent\n\t\ttreeCaches  []*treecache.ZookeeperTreeCache\n\n\t\tparse  func(data []byte, path string) (model.LabelSet, error)\n\t\tlogger log.Logger\n\t}\n\n\tfunc (d *Discovery) Run(ctx context.Context, ch chan<- []*targetgroup.Group) {\n\t\tdefer func() {\n\t\t\tfor _, tc := range d.treeCaches {\n\t\t\t\ttc.Stop()\n\t\t\t}\n\t\t\tfor _, pathUpdate := range d.pathUpdates {\n\t\t\t\t// Drain event channel in case the treecache leaks goroutines otherwise.\n\t\t\t\tfor range pathUpdate {\n\t\t\t\t}\n\t\t\t}\n\t\t\td.conn.Close()\n\t\t}()\n\n\t\tfor _, pathUpdate := range d.pathUpdates {\n\t\t\tgo func(update chan treecache.ZookeeperTreeCacheEvent) {\n\t\t\t\tfor event := range update {\n\t\t\t\t\tselect {\n\t\t\t\t\tcase d.updates <- event:\n\t\t\t\t\tcase <-ctx.Done():\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}(pathUpdate)\n\t\t}\n\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-ctx.Done():\n\t\t\t\treturn\n\t\t\tcase event := <-d.updates:\n\t\t\t\ttg := &targetgroup.Group{\n\t\t\t\t\tSource: event.Path,\n\t\t\t\t}\n\t\t\t\tif event.Data != nil {\n\t\t\t\t\tlabelSet, err := d.parse(*event.Data, event.Path)\n\t\t\t\t\tif err == nil {\n\t\t\t\t\t\ttg.Targets = []model.LabelSet{labelSet}\n\t\t\t\t\t\td.sources[event.Path] = tg\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdelete(d.sources, event.Path)\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tdelete(d.sources, event.Path)\n\t\t\t\t}\n\t\t\t\tselect {\n\t\t\t\tcase <-ctx.Done():\n\t\t\t\t\treturn\n\t\t\t\tcase ch <- []*targetgroup.Group{tg}:\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n```\n\nRun\n1. \n2. \n3. parseupdatechannelch","source":"_posts/prometheus-service-discovery.md","raw":"---\ntitle:  Prometheus\ndate: 2019-10-05 20:51:38\ntags: Prometheus\n---\n\n\n<!-- ---\nlayout: post\ntitle: Prometheus\nauthor: Ray Chan(ray1888)\ndate: '2019-10-05 20:51:38 +0800'\ncategory: Prometheus\nsummary: Prometheus Service Discovery Module\nthumbnail: Prometheus.png\n--- -->\n\n# \n1.   \n2.   \n   2.1   \n   2.2 \n\n# \n\n prometheusmaster branch5a554df0855bf707a8c333c0dd830067d03422cf commit\n\n# \nPrometheusPrometheus[OpenStack] \n\nPrometheusprometheus/discoveryPrometheusAlertManager\n\n\n```\n//  cmd/main.go 350-352\n\tctxScrape, cancelScrape = context.WithCancel(context.Background())\n\tdiscoveryManagerScrape  = discovery.NewManager(ctxScrape, log.With(logger, \"component\", \"discovery manager scrape\"), discovery.Name(\"scrape\"))\n\n\tctxNotify, cancelNotify = context.WithCancel(context.Background())\n\tdiscoveryManagerNotify  = discovery.NewManager(ctxNotify, log.With(logger, \"component\", \"discovery manager notify\"), discovery.Name(\"notify\"))\n\n//  \n/* \n\tcmd/main.go line 555, ManagerscrapeManagerrestore scrape\n\tScrape\n\t*/\nerr := scrapeManager.Run(discoveryManagerScrape.SyncCh())\n\n/* \n\tcmd/main.go line 726, ManagernotifierManageralertManager\n\tNotifer\n\t*/\nnotifierManager.Run(discoveryManagerNotify.SyncCh())\n\n// main.go line 735, run Group g discoveryManagerRun\n```\n\n\n1. main.godiscoveryManager\n2. discovery configProvider\n3. discoveryManagerRun\n\n# \n\n## \n\n<!-- ![ServiceDiscoveryModule](/assets/img/posts/prometheus/DiscoverManager.png) -->\n{% asset_img DiscoverManager.png ServiceDiscoveryModule %}\n\n## \n1. ApplyConfig()service discoveryNewManagerservice DiscoveryaddProviders\n```\nadd := func(cfg interface{}, newDiscoverer func() (Discoverer, error)) {\n\t\tt := reflect.TypeOf(cfg).String()\n\t\tfor _, p := range m.providers {\n\t\t\tif reflect.DeepEqual(cfg, p.config) {\n\t\t\t\tp.subs = append(p.subs, setName)\n\t\t\t\tadded = true\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\n\t\td, err := newDiscoverer()\n\t\tif err != nil {\n\t\t\tlevel.Error(m.logger).Log(\"msg\", \"Cannot create service discovery\", \"err\", err, \"type\", t)\n\t\t\tfailedCount++\n\t\t\treturn\n\t\t}\n\n\t\tprovider := provider{\n\t\t\tname:   fmt.Sprintf(\"%s/%d\", t, len(m.providers)),\n\t\t\td:      d,\n\t\t\tconfig: cfg,\n\t\t\tsubs:   []string{setName},\n\t\t}\n\t\tm.providers = append(m.providers, &provider)\n\t\tadded = true\n\t}\n//  discovery/manager.go 356-417\n```\n\n2. Provider \n```\n\t// discovery/manager.go line 223-226\n\tfunc (m *Manager) startProvider(ctx context.Context, p *provider) {\n\t\tlevel.Debug(m.logger).Log(\"msg\", \"Starting provider\", \"provider\", p.name, \"subs\", fmt.Sprintf(\"%v\", p.subs))\n\t\tctx, cancel := context.WithCancel(ctx)\n\t\t// UpdateWatch\n\t\tupdates := make(chan []*targetgroup.Group)\n\t\tm.discoverCancel = append(m.discoverCancel, cancel)\n\n\t\t//  Watch\n\t\tgo p.d.Run(ctx, updates)\n\t\t// updatesManager\n\t\tgo m.updater(ctx, p, updates)\n\t}\n\n\t// discovery/manager.go line 205-207\n\tfor _, prov := range m.providers {\n\t\t\tm.startProvider(m.ctx, prov)\n\t}\n```\n\nApplyConfigRun\n```\n\tfunc (m *Manager) Run() error {\n\t\tgo m.sender()\n\t\tfor range m.ctx.Done() {\n\t\t\tm.cancelDiscoverers()\n\t\t\treturn m.ctx.Err()\n\t\t}\n\t\treturn nil\n\t}\n```\n\nManagerupdatertriggerchan,contextdoneManager.Updater()Manager.Sender()\n\n Manager.trigglechan is 1buffered channelupdates := make(chan []*targetgroup.Group), unbuffered channel \n```\n\tfunc (m *Manager) updater(ctx context.Context, p *provider, updates chan []*targetgroup.Group) {\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-ctx.Done():\n\t\t\t\treturn\n\t\t\tcase tgs, ok := <-updates:\n\t\t\t\treceivedUpdates.WithLabelValues(m.name).Inc()\n\t\t\t\tif !ok {\n\t\t\t\t\tlevel.Debug(m.logger).Log(\"msg\", \"discoverer channel closed\", \"provider\", p.name)\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tfor _, s := range p.subs {\n\t\t\t\t\tm.updateGroup(poolKey{setName: s, provider: p.name}, tgs)\n\t\t\t\t}\n\n\t\t\t\tselect {\n\t\t\t\tcase m.triggerSend <- struct{}{}:\n\t\t\t\tdefault:\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tfunc (m *Manager) sender() {\n\t\tticker := time.NewTicker(m.updatert)\n\t\tdefer ticker.Stop()\n\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-m.ctx.Done():\n\t\t\t\treturn\n\t\t\tcase <-ticker.C: // Some discoverers send updates too often so we throttle these with the ticker.\n\t\t\t\tselect {\n\t\t\t\tcase <-m.triggerSend:\n\t\t\t\t\tsentUpdates.WithLabelValues(m.name).Inc()\n\t\t\t\t\tselect {\n\t\t\t\t\tcase m.syncCh <- m.allGroups():\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tdelayedUpdates.WithLabelValues(m.name).Inc()\n\t\t\t\t\t\tlevel.Debug(m.logger).Log(\"msg\", \"discovery receiver's channel was full so will retry the next cycle\")\n\t\t\t\t\t\tselect {\n\t\t\t\t\t\tcase m.triggerSend <- struct{}{}:\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n```\n\n\n1. Provider updateupdate channel\n2. Manager.UpdaterManagerGrouptriggerSend channel\n3. Manager.SendertriggerSend ChannelsyncCh(MainsyncChScrapeManagerNotiferManager)\n\n\n\n##   \n### Provider  \n```\ntype Discoverer interface {\n\t// Run hands a channel to the discovery provider (Consul, DNS etc) through which it can send\n\t// updated target groups.\n\t// Must returns if the context gets canceled. It should not close the update\n\t// channel on returning.\n\tRun(ctx context.Context, up chan<- []*targetgroup.Group)\n}\n```\nProviderProviderDiscovererRunp.d.Run()\n\nProviderProviderzookeeperProvider\nProviderwatch&notifyApiwatch&notify\n\n#### FileProvider\n\nFileProviderjsonyaml  \n```\n// discovery/file/file.go line 39-46\nvar (\n\tpatFileSDName = regexp.MustCompile(`^[^*]*(\\*[^/]*)?\\.(json|yml|yaml|JSON|YML|YAML)$`)\n\n\t// DefaultSDConfig is the default file SD configuration.\n\tDefaultSDConfig = SDConfig{\n\t\tRefreshInterval: model.Duration(5 * time.Minute),\n\t}\n)\n```\n\nDiscovererRun\n```\nfunc (d *Discovery) Run(ctx context.Context, ch chan<- []*targetgroup.Group) {\n\twatcher, err := fsnotify.NewWatcher()\n\tif err != nil {\n\t\tlevel.Error(d.logger).Log(\"msg\", \"Error adding file watcher\", \"err\", err)\n\t\treturn\n\t}\n\td.watcher = watcher\n\tdefer d.stop()\n\n    //  confdiscoverer\n\td.refresh(ctx, ch)\n\n\tticker := time.NewTicker(d.interval)\n\tdefer ticker.Stop()\n\n\tfor {\n\t\tselect {\n\t\tcase <-ctx.Done():\n\t\t\treturn\n\n\t\tcase event := <-d.watcher.Events:\n\t\t\t// fsnotify sometimes sends a bunch of events without name or operation.\n\t\t\t// It's unclear what they are and why they are sent - filter them out.\n\t\t\tif len(event.Name) == 0 {\n\t\t\t\tbreak\n\t\t\t}\n\t\t\t// Everything but a chmod requires rereading.\n\t\t\tif event.Op^fsnotify.Chmod == 0 {\n\t\t\t\tbreak\n\t\t\t}\n\t\t\t// Changes to a file can spawn various sequences of events with\n\t\t\t// different combinations of operations. For all practical purposes\n\t\t\t// this is inaccurate.\n\t\t\t// The most reliable solution is to reload everything if anything happens.\n\t\t\td.refresh(ctx, ch)\n\n\t\tcase <-ticker.C:\n\t\t\t// Setting a new watch after an update might fail. Make sure we don't lose\n\t\t\t// those files forever.\n\t\t\td.refresh(ctx, ch)\n\n\t\tcase err := <-d.watcher.Errors:\n\t\t\tif err != nil {\n\t\t\t\tlevel.Error(d.logger).Log(\"msg\", \"Error watching file\", \"err\", err)\n\t\t\t}\n\t\t}\n\t}\n}\n```\n\nFile Discoverer Watch(ticker.C)event := <-d.watcher.Events)\n\nRefreshupdate channel\n```\nfunc (d *Discovery) refresh(ctx context.Context, ch chan<- []*targetgroup.Group) {\n\tt0 := time.Now()\n\tdefer func() {\n\t\tfileSDScanDuration.Observe(time.Since(t0).Seconds())\n\t}()\n\tref := map[string]int{}\n\t// \n\tfor _, p := range d.listFiles() {\n\t\t//  targets\n\t\ttgroups, err := d.readFile(p)\n\t\tif err != nil {\n\t\t\tfileSDReadErrorsCount.Inc()\n\n\t\t\tlevel.Error(d.logger).Log(\"msg\", \"Error reading file\", \"path\", p, \"err\", err)\n\t\t\t// Prevent deletion down below.\n\t\t\tref[p] = d.lastRefresh[p]\n\t\t\tcontinue\n\t\t}\n\t\tselect {\n\t\t\t// Update\n\t\tcase ch <- tgroups:\n\t\tcase <-ctx.Done():\n\t\t\treturn\n\t\t}\n\n\t\tref[p] = len(tgroups)\n\t}\n\t// Send empty updates for sources that disappeared.\n\tfor f, n := range d.lastRefresh {\n\t\tm, ok := ref[f]\n\t\tif !ok || n > m {\n\t\t\tlevel.Debug(d.logger).Log(\"msg\", \"file_sd refresh found file that should be removed\", \"file\", f)\n\t\t\td.deleteTimestamp(f)\n\t\t\tfor i := m; i < n; i++ {\n\t\t\t\tselect {\n\t\t\t\tcase ch <- []*targetgroup.Group{{Source: fileSource(f, i)}}:\n\t\t\t\tcase <-ctx.Done():\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\td.lastRefresh = ref\n\n\td.watchFiles()\n}\n```\n\n#### zookeeperProvider\n\nZookeeperProvider\n1. zookeeperzookeeper\n2. ServerSetPointNerveEndPointDiscoveryDiscovery\n3. \n\n```\n\ttype Discovery struct {\n\t\tconn *zk.Conn\n\n\t\tsources map[string]*targetgroup.Group\n\n\t\tupdates     chan treecache.ZookeeperTreeCacheEvent\n\t\tpathUpdates []chan treecache.ZookeeperTreeCacheEvent\n\t\ttreeCaches  []*treecache.ZookeeperTreeCache\n\n\t\tparse  func(data []byte, path string) (model.LabelSet, error)\n\t\tlogger log.Logger\n\t}\n\n\tfunc (d *Discovery) Run(ctx context.Context, ch chan<- []*targetgroup.Group) {\n\t\tdefer func() {\n\t\t\tfor _, tc := range d.treeCaches {\n\t\t\t\ttc.Stop()\n\t\t\t}\n\t\t\tfor _, pathUpdate := range d.pathUpdates {\n\t\t\t\t// Drain event channel in case the treecache leaks goroutines otherwise.\n\t\t\t\tfor range pathUpdate {\n\t\t\t\t}\n\t\t\t}\n\t\t\td.conn.Close()\n\t\t}()\n\n\t\tfor _, pathUpdate := range d.pathUpdates {\n\t\t\tgo func(update chan treecache.ZookeeperTreeCacheEvent) {\n\t\t\t\tfor event := range update {\n\t\t\t\t\tselect {\n\t\t\t\t\tcase d.updates <- event:\n\t\t\t\t\tcase <-ctx.Done():\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}(pathUpdate)\n\t\t}\n\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-ctx.Done():\n\t\t\t\treturn\n\t\t\tcase event := <-d.updates:\n\t\t\t\ttg := &targetgroup.Group{\n\t\t\t\t\tSource: event.Path,\n\t\t\t\t}\n\t\t\t\tif event.Data != nil {\n\t\t\t\t\tlabelSet, err := d.parse(*event.Data, event.Path)\n\t\t\t\t\tif err == nil {\n\t\t\t\t\t\ttg.Targets = []model.LabelSet{labelSet}\n\t\t\t\t\t\td.sources[event.Path] = tg\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdelete(d.sources, event.Path)\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tdelete(d.sources, event.Path)\n\t\t\t\t}\n\t\t\t\tselect {\n\t\t\t\tcase <-ctx.Done():\n\t\t\t\t\treturn\n\t\t\t\tcase ch <- []*targetgroup.Group{tg}:\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n```\n\nRun\n1. \n2. \n3. parseupdatechannelch","slug":"prometheus-service-discovery","published":1,"updated":"2021-01-21T07:10:15.109Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk6irard0007k9i54bt9hz6n","content":"<!-- ---\nlayout: post\ntitle: Prometheus\nauthor: Ray Chan(ray1888)\ndate: '2019-10-05 20:51:38 +0800'\ncategory: Prometheus\nsummary: Prometheus Service Discovery Module\nthumbnail: Prometheus.png\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li>  </li>\n<li><br>2.1 <br>2.2 </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p> prometheusmaster branch5a554df0855bf707a8c333c0dd830067d03422cf commit</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>PrometheusPrometheus[OpenStack] </p>\n<p>Prometheusprometheus/discoveryPrometheusAlertManager<br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  cmd&#x2F;main.go 350-352</span><br><span class=\"line\">\tctxScrape, cancelScrape &#x3D; context.WithCancel(context.Background())</span><br><span class=\"line\">\tdiscoveryManagerScrape  &#x3D; discovery.NewManager(ctxScrape, log.With(logger, &quot;component&quot;, &quot;discovery manager scrape&quot;), discovery.Name(&quot;scrape&quot;))</span><br><span class=\"line\"></span><br><span class=\"line\">\tctxNotify, cancelNotify &#x3D; context.WithCancel(context.Background())</span><br><span class=\"line\">\tdiscoveryManagerNotify  &#x3D; discovery.NewManager(ctxNotify, log.With(logger, &quot;component&quot;, &quot;discovery manager notify&quot;), discovery.Name(&quot;notify&quot;))</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;  </span><br><span class=\"line\">&#x2F;* </span><br><span class=\"line\">\tcmd&#x2F;main.go line 555, ManagerscrapeManagerrestore scrape</span><br><span class=\"line\">\tScrape</span><br><span class=\"line\">\t*&#x2F;</span><br><span class=\"line\">err :&#x3D; scrapeManager.Run(discoveryManagerScrape.SyncCh())</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;* </span><br><span class=\"line\">\tcmd&#x2F;main.go line 726, ManagernotifierManageralertManager</span><br><span class=\"line\">\tNotifer</span><br><span class=\"line\">\t*&#x2F;</span><br><span class=\"line\">notifierManager.Run(discoveryManagerNotify.SyncCh())</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; main.go line 735, run Group g discoveryManagerRun</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<ol>\n<li>main.godiscoveryManager</li>\n<li>discovery configProvider</li>\n<li>discoveryManagerRun</li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <!-- ![ServiceDiscoveryModule](/assets/img/posts/prometheus/DiscoverManager.png) -->\n\n\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <ol>\n<li>ApplyConfig()service discoveryNewManagerservice DiscoveryaddProviders<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add :&#x3D; func(cfg interface&#123;&#125;, newDiscoverer func() (Discoverer, error)) &#123;</span><br><span class=\"line\">\t\tt :&#x3D; reflect.TypeOf(cfg).String()</span><br><span class=\"line\">\t\tfor _, p :&#x3D; range m.providers &#123;</span><br><span class=\"line\">\t\t\tif reflect.DeepEqual(cfg, p.config) &#123;</span><br><span class=\"line\">\t\t\t\tp.subs &#x3D; append(p.subs, setName)</span><br><span class=\"line\">\t\t\t\tadded &#x3D; true</span><br><span class=\"line\">\t\t\t\treturn</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\td, err :&#x3D; newDiscoverer()</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tlevel.Error(m.logger).Log(&quot;msg&quot;, &quot;Cannot create service discovery&quot;, &quot;err&quot;, err, &quot;type&quot;, t)</span><br><span class=\"line\">\t\t\tfailedCount++</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tprovider :&#x3D; provider&#123;</span><br><span class=\"line\">\t\t\tname:   fmt.Sprintf(&quot;%s&#x2F;%d&quot;, t, len(m.providers)),</span><br><span class=\"line\">\t\t\td:      d,</span><br><span class=\"line\">\t\t\tconfig: cfg,</span><br><span class=\"line\">\t\t\tsubs:   []string&#123;setName&#125;,</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tm.providers &#x3D; append(m.providers, &amp;provider)</span><br><span class=\"line\">\t\tadded &#x3D; true</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#x2F;&#x2F;  discovery&#x2F;manager.go 356-417</span><br></pre></td></tr></table></div></figure></li>\n<li>Provider <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; discovery&#x2F;manager.go line 223-226</span><br><span class=\"line\">func (m *Manager) startProvider(ctx context.Context, p *provider) &#123;</span><br><span class=\"line\">\tlevel.Debug(m.logger).Log(&quot;msg&quot;, &quot;Starting provider&quot;, &quot;provider&quot;, p.name, &quot;subs&quot;, fmt.Sprintf(&quot;%v&quot;, p.subs))</span><br><span class=\"line\">\tctx, cancel :&#x3D; context.WithCancel(ctx)</span><br><span class=\"line\">\t&#x2F;&#x2F; UpdateWatch</span><br><span class=\"line\">\tupdates :&#x3D; make(chan []*targetgroup.Group)</span><br><span class=\"line\">\tm.discoverCancel &#x3D; append(m.discoverCancel, cancel)</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F;  Watch</span><br><span class=\"line\">\tgo p.d.Run(ctx, updates)</span><br><span class=\"line\">\t&#x2F;&#x2F; updatesManager</span><br><span class=\"line\">\tgo m.updater(ctx, p, updates)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; discovery&#x2F;manager.go line 205-207</span><br><span class=\"line\">for _, prov :&#x3D; range m.providers &#123;</span><br><span class=\"line\">\t\tm.startProvider(m.ctx, prov)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\nApplyConfigRun<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (m *Manager) Run() error &#123;</span><br><span class=\"line\">\tgo m.sender()</span><br><span class=\"line\">\tfor range m.ctx.Done() &#123;</span><br><span class=\"line\">\t\tm.cancelDiscoverers()</span><br><span class=\"line\">\t\treturn m.ctx.Err()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\nManagerupdatertriggerchan,contextdoneManager.Updater()Manager.Sender()</li>\n</ol>\n<p> Manager.trigglechan is 1buffered channelupdates := make(chan []*targetgroup.Group), unbuffered channel </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (m *Manager) updater(ctx context.Context, p *provider, updates chan []*targetgroup.Group) &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase tgs, ok :&#x3D; &lt;-updates:</span><br><span class=\"line\">\t\t\treceivedUpdates.WithLabelValues(m.name).Inc()</span><br><span class=\"line\">\t\t\tif !ok &#123;</span><br><span class=\"line\">\t\t\t\tlevel.Debug(m.logger).Log(&quot;msg&quot;, &quot;discoverer channel closed&quot;, &quot;provider&quot;, p.name)</span><br><span class=\"line\">\t\t\t\treturn</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tfor _, s :&#x3D; range p.subs &#123;</span><br><span class=\"line\">\t\t\t\tm.updateGroup(poolKey&#123;setName: s, provider: p.name&#125;, tgs)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase m.triggerSend &lt;- struct&#123;&#125;&#123;&#125;:</span><br><span class=\"line\">\t\t\tdefault:</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (m *Manager) sender() &#123;</span><br><span class=\"line\">\tticker :&#x3D; time.NewTicker(m.updatert)</span><br><span class=\"line\">\tdefer ticker.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-m.ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase &lt;-ticker.C: &#x2F;&#x2F; Some discoverers send updates too often so we throttle these with the ticker.</span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase &lt;-m.triggerSend:</span><br><span class=\"line\">\t\t\t\tsentUpdates.WithLabelValues(m.name).Inc()</span><br><span class=\"line\">\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\tcase m.syncCh &lt;- m.allGroups():</span><br><span class=\"line\">\t\t\t\tdefault:</span><br><span class=\"line\">\t\t\t\t\tdelayedUpdates.WithLabelValues(m.name).Inc()</span><br><span class=\"line\">\t\t\t\t\tlevel.Debug(m.logger).Log(&quot;msg&quot;, &quot;discovery receiver&#39;s channel was full so will retry the next cycle&quot;)</span><br><span class=\"line\">\t\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\t\tcase m.triggerSend &lt;- struct&#123;&#125;&#123;&#125;:</span><br><span class=\"line\">\t\t\t\t\tdefault:</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\tdefault:</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<ol>\n<li>Provider updateupdate channel</li>\n<li>Manager.UpdaterManagerGrouptriggerSend channel</li>\n<li>Manager.SendertriggerSend ChannelsyncCh(MainsyncChScrapeManagerNotiferManager)</li>\n</ol>\n<p></p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      \n        <h3 id=\"Provider\"   >\n          <a href=\"#Provider\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Provider</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Discoverer interface &#123;</span><br><span class=\"line\">\t&#x2F;&#x2F; Run hands a channel to the discovery provider (Consul, DNS etc) through which it can send</span><br><span class=\"line\">\t&#x2F;&#x2F; updated target groups.</span><br><span class=\"line\">\t&#x2F;&#x2F; Must returns if the context gets canceled. It should not close the update</span><br><span class=\"line\">\t&#x2F;&#x2F; channel on returning.</span><br><span class=\"line\">\tRun(ctx context.Context, up chan&lt;- []*targetgroup.Group)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>ProviderProviderDiscovererRunp.d.Run()</p>\n<p>ProviderProviderzookeeperProvider<br>Providerwatch&amp;notifyApiwatch&amp;notify</p>\n\n        <h4 id=\"FileProvider\"   >\n          <a href=\"#FileProvider\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>FileProvider</h4>\n      <p>FileProviderjsonyaml  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; discovery&#x2F;file&#x2F;file.go line 39-46</span><br><span class=\"line\">var (</span><br><span class=\"line\">\tpatFileSDName &#x3D; regexp.MustCompile(&#96;^[^*]*(\\*[^&#x2F;]*)?\\.(json|yml|yaml|JSON|YML|YAML)$&#96;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; DefaultSDConfig is the default file SD configuration.</span><br><span class=\"line\">\tDefaultSDConfig &#x3D; SDConfig&#123;</span><br><span class=\"line\">\t\tRefreshInterval: model.Duration(5 * time.Minute),</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">)</span><br></pre></td></tr></table></div></figure>\n<p>DiscovererRun</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Discovery) Run(ctx context.Context, ch chan&lt;- []*targetgroup.Group) &#123;</span><br><span class=\"line\">\twatcher, err :&#x3D; fsnotify.NewWatcher()</span><br><span class=\"line\">\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\tlevel.Error(d.logger).Log(&quot;msg&quot;, &quot;Error adding file watcher&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\td.watcher &#x3D; watcher</span><br><span class=\"line\">\tdefer d.stop()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x2F;&#x2F;  confdiscoverer</span><br><span class=\"line\">\td.refresh(ctx, ch)</span><br><span class=\"line\"></span><br><span class=\"line\">\tticker :&#x3D; time.NewTicker(d.interval)</span><br><span class=\"line\">\tdefer ticker.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcase event :&#x3D; &lt;-d.watcher.Events:</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; fsnotify sometimes sends a bunch of events without name or operation.</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; It&#39;s unclear what they are and why they are sent - filter them out.</span><br><span class=\"line\">\t\t\tif len(event.Name) &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\t\tbreak</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Everything but a chmod requires rereading.</span><br><span class=\"line\">\t\t\tif event.Op^fsnotify.Chmod &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\t\tbreak</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Changes to a file can spawn various sequences of events with</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; different combinations of operations. For all practical purposes</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; this is inaccurate.</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; The most reliable solution is to reload everything if anything happens.</span><br><span class=\"line\">\t\t\td.refresh(ctx, ch)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcase &lt;-ticker.C:</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Setting a new watch after an update might fail. Make sure we don&#39;t lose</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; those files forever.</span><br><span class=\"line\">\t\t\td.refresh(ctx, ch)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcase err :&#x3D; &lt;-d.watcher.Errors:</span><br><span class=\"line\">\t\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\tlevel.Error(d.logger).Log(&quot;msg&quot;, &quot;Error watching file&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>File Discoverer Watch(ticker.C)event := &lt;-d.watcher.Events)</p>\n<p>Refreshupdate channel</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Discovery) refresh(ctx context.Context, ch chan&lt;- []*targetgroup.Group) &#123;</span><br><span class=\"line\">\tt0 :&#x3D; time.Now()</span><br><span class=\"line\">\tdefer func() &#123;</span><br><span class=\"line\">\t\tfileSDScanDuration.Observe(time.Since(t0).Seconds())</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\tref :&#x3D; map[string]int&#123;&#125;</span><br><span class=\"line\">\t&#x2F;&#x2F; </span><br><span class=\"line\">\tfor _, p :&#x3D; range d.listFiles() &#123;</span><br><span class=\"line\">\t\t&#x2F;&#x2F;  targets</span><br><span class=\"line\">\t\ttgroups, err :&#x3D; d.readFile(p)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tfileSDReadErrorsCount.Inc()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tlevel.Error(d.logger).Log(&quot;msg&quot;, &quot;Error reading file&quot;, &quot;path&quot;, p, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Prevent deletion down below.</span><br><span class=\"line\">\t\t\tref[p] &#x3D; d.lastRefresh[p]</span><br><span class=\"line\">\t\t\tcontinue</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Update</span><br><span class=\"line\">\t\tcase ch &lt;- tgroups:</span><br><span class=\"line\">\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tref[p] &#x3D; len(tgroups)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t&#x2F;&#x2F; Send empty updates for sources that disappeared.</span><br><span class=\"line\">\tfor f, n :&#x3D; range d.lastRefresh &#123;</span><br><span class=\"line\">\t\tm, ok :&#x3D; ref[f]</span><br><span class=\"line\">\t\tif !ok || n &gt; m &#123;</span><br><span class=\"line\">\t\t\tlevel.Debug(d.logger).Log(&quot;msg&quot;, &quot;file_sd refresh found file that should be removed&quot;, &quot;file&quot;, f)</span><br><span class=\"line\">\t\t\td.deleteTimestamp(f)</span><br><span class=\"line\">\t\t\tfor i :&#x3D; m; i &lt; n; i++ &#123;</span><br><span class=\"line\">\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\tcase ch &lt;- []*targetgroup.Group&#123;&#123;Source: fileSource(f, i)&#125;&#125;:</span><br><span class=\"line\">\t\t\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\t\t\treturn</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\td.lastRefresh &#x3D; ref</span><br><span class=\"line\"></span><br><span class=\"line\">\td.watchFiles()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"zookeeperProvider\"   >\n          <a href=\"#zookeeperProvider\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>zookeeperProvider</h4>\n      <p>ZookeeperProvider</p>\n<ol>\n<li>zookeeperzookeeper</li>\n<li>ServerSetPointNerveEndPointDiscoveryDiscovery</li>\n<li></li>\n</ol>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Discovery struct &#123;</span><br><span class=\"line\">\tconn *zk.Conn</span><br><span class=\"line\"></span><br><span class=\"line\">\tsources map[string]*targetgroup.Group</span><br><span class=\"line\"></span><br><span class=\"line\">\tupdates     chan treecache.ZookeeperTreeCacheEvent</span><br><span class=\"line\">\tpathUpdates []chan treecache.ZookeeperTreeCacheEvent</span><br><span class=\"line\">\ttreeCaches  []*treecache.ZookeeperTreeCache</span><br><span class=\"line\"></span><br><span class=\"line\">\tparse  func(data []byte, path string) (model.LabelSet, error)</span><br><span class=\"line\">\tlogger log.Logger</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (d *Discovery) Run(ctx context.Context, ch chan&lt;- []*targetgroup.Group) &#123;</span><br><span class=\"line\">\tdefer func() &#123;</span><br><span class=\"line\">\t\tfor _, tc :&#x3D; range d.treeCaches &#123;</span><br><span class=\"line\">\t\t\ttc.Stop()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tfor _, pathUpdate :&#x3D; range d.pathUpdates &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Drain event channel in case the treecache leaks goroutines otherwise.</span><br><span class=\"line\">\t\t\tfor range pathUpdate &#123;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\td.conn.Close()</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor _, pathUpdate :&#x3D; range d.pathUpdates &#123;</span><br><span class=\"line\">\t\tgo func(update chan treecache.ZookeeperTreeCacheEvent) &#123;</span><br><span class=\"line\">\t\t\tfor event :&#x3D; range update &#123;</span><br><span class=\"line\">\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\tcase d.updates &lt;- event:</span><br><span class=\"line\">\t\t\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\t\t\treturn</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;(pathUpdate)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase event :&#x3D; &lt;-d.updates:</span><br><span class=\"line\">\t\t\ttg :&#x3D; &amp;targetgroup.Group&#123;</span><br><span class=\"line\">\t\t\t\tSource: event.Path,</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tif event.Data !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\tlabelSet, err :&#x3D; d.parse(*event.Data, event.Path)</span><br><span class=\"line\">\t\t\t\tif err &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\t\ttg.Targets &#x3D; []model.LabelSet&#123;labelSet&#125;</span><br><span class=\"line\">\t\t\t\t\td.sources[event.Path] &#x3D; tg</span><br><span class=\"line\">\t\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\t\tdelete(d.sources, event.Path)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\tdelete(d.sources, event.Path)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\t\treturn</span><br><span class=\"line\">\t\t\tcase ch &lt;- []*targetgroup.Group&#123;tg&#125;:</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Run</p>\n<ol>\n<li></li>\n<li></li>\n<li>parseupdatechannelch</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<!-- ---\nlayout: post\ntitle: Prometheus\nauthor: Ray Chan(ray1888)\ndate: '2019-10-05 20:51:38 +0800'\ncategory: Prometheus\nsummary: Prometheus Service Discovery Module\nthumbnail: Prometheus.png\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li>  </li>\n<li><br>2.1 <br>2.2 </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p> prometheusmaster branch5a554df0855bf707a8c333c0dd830067d03422cf commit</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>PrometheusPrometheus[OpenStack] </p>\n<p>Prometheusprometheus/discoveryPrometheusAlertManager<br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  cmd&#x2F;main.go 350-352</span><br><span class=\"line\">\tctxScrape, cancelScrape &#x3D; context.WithCancel(context.Background())</span><br><span class=\"line\">\tdiscoveryManagerScrape  &#x3D; discovery.NewManager(ctxScrape, log.With(logger, &quot;component&quot;, &quot;discovery manager scrape&quot;), discovery.Name(&quot;scrape&quot;))</span><br><span class=\"line\"></span><br><span class=\"line\">\tctxNotify, cancelNotify &#x3D; context.WithCancel(context.Background())</span><br><span class=\"line\">\tdiscoveryManagerNotify  &#x3D; discovery.NewManager(ctxNotify, log.With(logger, &quot;component&quot;, &quot;discovery manager notify&quot;), discovery.Name(&quot;notify&quot;))</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;  </span><br><span class=\"line\">&#x2F;* </span><br><span class=\"line\">\tcmd&#x2F;main.go line 555, ManagerscrapeManagerrestore scrape</span><br><span class=\"line\">\tScrape</span><br><span class=\"line\">\t*&#x2F;</span><br><span class=\"line\">err :&#x3D; scrapeManager.Run(discoveryManagerScrape.SyncCh())</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;* </span><br><span class=\"line\">\tcmd&#x2F;main.go line 726, ManagernotifierManageralertManager</span><br><span class=\"line\">\tNotifer</span><br><span class=\"line\">\t*&#x2F;</span><br><span class=\"line\">notifierManager.Run(discoveryManagerNotify.SyncCh())</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; main.go line 735, run Group g discoveryManagerRun</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<ol>\n<li>main.godiscoveryManager</li>\n<li>discovery configProvider</li>\n<li>discoveryManagerRun</li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <!-- ![ServiceDiscoveryModule](/assets/img/posts/prometheus/DiscoverManager.png) -->\n\n\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <ol>\n<li>ApplyConfig()service discoveryNewManagerservice DiscoveryaddProviders<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add :&#x3D; func(cfg interface&#123;&#125;, newDiscoverer func() (Discoverer, error)) &#123;</span><br><span class=\"line\">\t\tt :&#x3D; reflect.TypeOf(cfg).String()</span><br><span class=\"line\">\t\tfor _, p :&#x3D; range m.providers &#123;</span><br><span class=\"line\">\t\t\tif reflect.DeepEqual(cfg, p.config) &#123;</span><br><span class=\"line\">\t\t\t\tp.subs &#x3D; append(p.subs, setName)</span><br><span class=\"line\">\t\t\t\tadded &#x3D; true</span><br><span class=\"line\">\t\t\t\treturn</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\td, err :&#x3D; newDiscoverer()</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tlevel.Error(m.logger).Log(&quot;msg&quot;, &quot;Cannot create service discovery&quot;, &quot;err&quot;, err, &quot;type&quot;, t)</span><br><span class=\"line\">\t\t\tfailedCount++</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tprovider :&#x3D; provider&#123;</span><br><span class=\"line\">\t\t\tname:   fmt.Sprintf(&quot;%s&#x2F;%d&quot;, t, len(m.providers)),</span><br><span class=\"line\">\t\t\td:      d,</span><br><span class=\"line\">\t\t\tconfig: cfg,</span><br><span class=\"line\">\t\t\tsubs:   []string&#123;setName&#125;,</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tm.providers &#x3D; append(m.providers, &amp;provider)</span><br><span class=\"line\">\t\tadded &#x3D; true</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#x2F;&#x2F;  discovery&#x2F;manager.go 356-417</span><br></pre></td></tr></table></div></figure></li>\n<li>Provider <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; discovery&#x2F;manager.go line 223-226</span><br><span class=\"line\">func (m *Manager) startProvider(ctx context.Context, p *provider) &#123;</span><br><span class=\"line\">\tlevel.Debug(m.logger).Log(&quot;msg&quot;, &quot;Starting provider&quot;, &quot;provider&quot;, p.name, &quot;subs&quot;, fmt.Sprintf(&quot;%v&quot;, p.subs))</span><br><span class=\"line\">\tctx, cancel :&#x3D; context.WithCancel(ctx)</span><br><span class=\"line\">\t&#x2F;&#x2F; UpdateWatch</span><br><span class=\"line\">\tupdates :&#x3D; make(chan []*targetgroup.Group)</span><br><span class=\"line\">\tm.discoverCancel &#x3D; append(m.discoverCancel, cancel)</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F;  Watch</span><br><span class=\"line\">\tgo p.d.Run(ctx, updates)</span><br><span class=\"line\">\t&#x2F;&#x2F; updatesManager</span><br><span class=\"line\">\tgo m.updater(ctx, p, updates)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; discovery&#x2F;manager.go line 205-207</span><br><span class=\"line\">for _, prov :&#x3D; range m.providers &#123;</span><br><span class=\"line\">\t\tm.startProvider(m.ctx, prov)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\nApplyConfigRun<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (m *Manager) Run() error &#123;</span><br><span class=\"line\">\tgo m.sender()</span><br><span class=\"line\">\tfor range m.ctx.Done() &#123;</span><br><span class=\"line\">\t\tm.cancelDiscoverers()</span><br><span class=\"line\">\t\treturn m.ctx.Err()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\nManagerupdatertriggerchan,contextdoneManager.Updater()Manager.Sender()</li>\n</ol>\n<p> Manager.trigglechan is 1buffered channelupdates := make(chan []*targetgroup.Group), unbuffered channel </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (m *Manager) updater(ctx context.Context, p *provider, updates chan []*targetgroup.Group) &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase tgs, ok :&#x3D; &lt;-updates:</span><br><span class=\"line\">\t\t\treceivedUpdates.WithLabelValues(m.name).Inc()</span><br><span class=\"line\">\t\t\tif !ok &#123;</span><br><span class=\"line\">\t\t\t\tlevel.Debug(m.logger).Log(&quot;msg&quot;, &quot;discoverer channel closed&quot;, &quot;provider&quot;, p.name)</span><br><span class=\"line\">\t\t\t\treturn</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tfor _, s :&#x3D; range p.subs &#123;</span><br><span class=\"line\">\t\t\t\tm.updateGroup(poolKey&#123;setName: s, provider: p.name&#125;, tgs)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase m.triggerSend &lt;- struct&#123;&#125;&#123;&#125;:</span><br><span class=\"line\">\t\t\tdefault:</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (m *Manager) sender() &#123;</span><br><span class=\"line\">\tticker :&#x3D; time.NewTicker(m.updatert)</span><br><span class=\"line\">\tdefer ticker.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-m.ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase &lt;-ticker.C: &#x2F;&#x2F; Some discoverers send updates too often so we throttle these with the ticker.</span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase &lt;-m.triggerSend:</span><br><span class=\"line\">\t\t\t\tsentUpdates.WithLabelValues(m.name).Inc()</span><br><span class=\"line\">\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\tcase m.syncCh &lt;- m.allGroups():</span><br><span class=\"line\">\t\t\t\tdefault:</span><br><span class=\"line\">\t\t\t\t\tdelayedUpdates.WithLabelValues(m.name).Inc()</span><br><span class=\"line\">\t\t\t\t\tlevel.Debug(m.logger).Log(&quot;msg&quot;, &quot;discovery receiver&#39;s channel was full so will retry the next cycle&quot;)</span><br><span class=\"line\">\t\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\t\tcase m.triggerSend &lt;- struct&#123;&#125;&#123;&#125;:</span><br><span class=\"line\">\t\t\t\t\tdefault:</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\tdefault:</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<ol>\n<li>Provider updateupdate channel</li>\n<li>Manager.UpdaterManagerGrouptriggerSend channel</li>\n<li>Manager.SendertriggerSend ChannelsyncCh(MainsyncChScrapeManagerNotiferManager)</li>\n</ol>\n<p></p>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      \n        <h3 id=\"Provider\"   >\n          <a href=\"#Provider\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Provider</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Discoverer interface &#123;</span><br><span class=\"line\">\t&#x2F;&#x2F; Run hands a channel to the discovery provider (Consul, DNS etc) through which it can send</span><br><span class=\"line\">\t&#x2F;&#x2F; updated target groups.</span><br><span class=\"line\">\t&#x2F;&#x2F; Must returns if the context gets canceled. It should not close the update</span><br><span class=\"line\">\t&#x2F;&#x2F; channel on returning.</span><br><span class=\"line\">\tRun(ctx context.Context, up chan&lt;- []*targetgroup.Group)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>ProviderProviderDiscovererRunp.d.Run()</p>\n<p>ProviderProviderzookeeperProvider<br>Providerwatch&amp;notifyApiwatch&amp;notify</p>\n\n        <h4 id=\"FileProvider\"   >\n          <a href=\"#FileProvider\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>FileProvider</h4>\n      <p>FileProviderjsonyaml  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; discovery&#x2F;file&#x2F;file.go line 39-46</span><br><span class=\"line\">var (</span><br><span class=\"line\">\tpatFileSDName &#x3D; regexp.MustCompile(&#96;^[^*]*(\\*[^&#x2F;]*)?\\.(json|yml|yaml|JSON|YML|YAML)$&#96;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#x2F;&#x2F; DefaultSDConfig is the default file SD configuration.</span><br><span class=\"line\">\tDefaultSDConfig &#x3D; SDConfig&#123;</span><br><span class=\"line\">\t\tRefreshInterval: model.Duration(5 * time.Minute),</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">)</span><br></pre></td></tr></table></div></figure>\n<p>DiscovererRun</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Discovery) Run(ctx context.Context, ch chan&lt;- []*targetgroup.Group) &#123;</span><br><span class=\"line\">\twatcher, err :&#x3D; fsnotify.NewWatcher()</span><br><span class=\"line\">\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\tlevel.Error(d.logger).Log(&quot;msg&quot;, &quot;Error adding file watcher&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\td.watcher &#x3D; watcher</span><br><span class=\"line\">\tdefer d.stop()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#x2F;&#x2F;  confdiscoverer</span><br><span class=\"line\">\td.refresh(ctx, ch)</span><br><span class=\"line\"></span><br><span class=\"line\">\tticker :&#x3D; time.NewTicker(d.interval)</span><br><span class=\"line\">\tdefer ticker.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcase event :&#x3D; &lt;-d.watcher.Events:</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; fsnotify sometimes sends a bunch of events without name or operation.</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; It&#39;s unclear what they are and why they are sent - filter them out.</span><br><span class=\"line\">\t\t\tif len(event.Name) &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\t\tbreak</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Everything but a chmod requires rereading.</span><br><span class=\"line\">\t\t\tif event.Op^fsnotify.Chmod &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\t\tbreak</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Changes to a file can spawn various sequences of events with</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; different combinations of operations. For all practical purposes</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; this is inaccurate.</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; The most reliable solution is to reload everything if anything happens.</span><br><span class=\"line\">\t\t\td.refresh(ctx, ch)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcase &lt;-ticker.C:</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Setting a new watch after an update might fail. Make sure we don&#39;t lose</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; those files forever.</span><br><span class=\"line\">\t\t\td.refresh(ctx, ch)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tcase err :&#x3D; &lt;-d.watcher.Errors:</span><br><span class=\"line\">\t\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\tlevel.Error(d.logger).Log(&quot;msg&quot;, &quot;Error watching file&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>File Discoverer Watch(ticker.C)event := &lt;-d.watcher.Events)</p>\n<p>Refreshupdate channel</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Discovery) refresh(ctx context.Context, ch chan&lt;- []*targetgroup.Group) &#123;</span><br><span class=\"line\">\tt0 :&#x3D; time.Now()</span><br><span class=\"line\">\tdefer func() &#123;</span><br><span class=\"line\">\t\tfileSDScanDuration.Observe(time.Since(t0).Seconds())</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\tref :&#x3D; map[string]int&#123;&#125;</span><br><span class=\"line\">\t&#x2F;&#x2F; </span><br><span class=\"line\">\tfor _, p :&#x3D; range d.listFiles() &#123;</span><br><span class=\"line\">\t\t&#x2F;&#x2F;  targets</span><br><span class=\"line\">\t\ttgroups, err :&#x3D; d.readFile(p)</span><br><span class=\"line\">\t\tif err !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\tfileSDReadErrorsCount.Inc()</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tlevel.Error(d.logger).Log(&quot;msg&quot;, &quot;Error reading file&quot;, &quot;path&quot;, p, &quot;err&quot;, err)</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Prevent deletion down below.</span><br><span class=\"line\">\t\t\tref[p] &#x3D; d.lastRefresh[p]</span><br><span class=\"line\">\t\t\tcontinue</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Update</span><br><span class=\"line\">\t\tcase ch &lt;- tgroups:</span><br><span class=\"line\">\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tref[p] &#x3D; len(tgroups)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t&#x2F;&#x2F; Send empty updates for sources that disappeared.</span><br><span class=\"line\">\tfor f, n :&#x3D; range d.lastRefresh &#123;</span><br><span class=\"line\">\t\tm, ok :&#x3D; ref[f]</span><br><span class=\"line\">\t\tif !ok || n &gt; m &#123;</span><br><span class=\"line\">\t\t\tlevel.Debug(d.logger).Log(&quot;msg&quot;, &quot;file_sd refresh found file that should be removed&quot;, &quot;file&quot;, f)</span><br><span class=\"line\">\t\t\td.deleteTimestamp(f)</span><br><span class=\"line\">\t\t\tfor i :&#x3D; m; i &lt; n; i++ &#123;</span><br><span class=\"line\">\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\tcase ch &lt;- []*targetgroup.Group&#123;&#123;Source: fileSource(f, i)&#125;&#125;:</span><br><span class=\"line\">\t\t\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\t\t\treturn</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\td.lastRefresh &#x3D; ref</span><br><span class=\"line\"></span><br><span class=\"line\">\td.watchFiles()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"zookeeperProvider\"   >\n          <a href=\"#zookeeperProvider\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>zookeeperProvider</h4>\n      <p>ZookeeperProvider</p>\n<ol>\n<li>zookeeperzookeeper</li>\n<li>ServerSetPointNerveEndPointDiscoveryDiscovery</li>\n<li></li>\n</ol>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Discovery struct &#123;</span><br><span class=\"line\">\tconn *zk.Conn</span><br><span class=\"line\"></span><br><span class=\"line\">\tsources map[string]*targetgroup.Group</span><br><span class=\"line\"></span><br><span class=\"line\">\tupdates     chan treecache.ZookeeperTreeCacheEvent</span><br><span class=\"line\">\tpathUpdates []chan treecache.ZookeeperTreeCacheEvent</span><br><span class=\"line\">\ttreeCaches  []*treecache.ZookeeperTreeCache</span><br><span class=\"line\"></span><br><span class=\"line\">\tparse  func(data []byte, path string) (model.LabelSet, error)</span><br><span class=\"line\">\tlogger log.Logger</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (d *Discovery) Run(ctx context.Context, ch chan&lt;- []*targetgroup.Group) &#123;</span><br><span class=\"line\">\tdefer func() &#123;</span><br><span class=\"line\">\t\tfor _, tc :&#x3D; range d.treeCaches &#123;</span><br><span class=\"line\">\t\t\ttc.Stop()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tfor _, pathUpdate :&#x3D; range d.pathUpdates &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; Drain event channel in case the treecache leaks goroutines otherwise.</span><br><span class=\"line\">\t\t\tfor range pathUpdate &#123;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\td.conn.Close()</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor _, pathUpdate :&#x3D; range d.pathUpdates &#123;</span><br><span class=\"line\">\t\tgo func(update chan treecache.ZookeeperTreeCacheEvent) &#123;</span><br><span class=\"line\">\t\t\tfor event :&#x3D; range update &#123;</span><br><span class=\"line\">\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\tcase d.updates &lt;- event:</span><br><span class=\"line\">\t\t\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\t\t\treturn</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;(pathUpdate)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\tcase event :&#x3D; &lt;-d.updates:</span><br><span class=\"line\">\t\t\ttg :&#x3D; &amp;targetgroup.Group&#123;</span><br><span class=\"line\">\t\t\t\tSource: event.Path,</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tif event.Data !&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\tlabelSet, err :&#x3D; d.parse(*event.Data, event.Path)</span><br><span class=\"line\">\t\t\t\tif err &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">\t\t\t\t\ttg.Targets &#x3D; []model.LabelSet&#123;labelSet&#125;</span><br><span class=\"line\">\t\t\t\t\td.sources[event.Path] &#x3D; tg</span><br><span class=\"line\">\t\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\t\tdelete(d.sources, event.Path)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\tdelete(d.sources, event.Path)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\tcase &lt;-ctx.Done():</span><br><span class=\"line\">\t\t\t\treturn</span><br><span class=\"line\">\t\t\tcase ch &lt;- []*targetgroup.Group&#123;tg&#125;:</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Run</p>\n<ol>\n<li></li>\n<li></li>\n<li>parseupdatechannelch</li>\n</ol>\n"},{"title":"MIT6.824 Lab3 ","date":"2019-08-29T07:05:38.000Z","_content":"\n<!-- ---\nlayout: post\ntitle:\nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: \nsummary: MIT6.824 Lab3 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n# \n1. \n2. \n\n# <a id=\"\"><span class=\"toptitle\"></span></a>\nlab3 KVGet(), Put(), Append()\n\n\n\n<!-- ![lab3](/assets/img/posts/Lab3-Process.png) -->\n{% asset_img Lab3-Process.png lab3 %}\n\nKVRaft  \nClientLeader  \nPS: KvDatabase RaftKVServer  \n\n:\n1. ClientKvDatabase\n2. KvDatabaseRaftStart APIRaft\n3. RaftLeader\n4. RaftApplyChKvDatabase\n5. KvDatabaseClient\n\n# <a id=\"\"><span class=\"toptitle\"></span></a>\n\n\n1. \n2. \n\n\n## <a id=\"\"><span class=\"secondtitle\"></span></a>\n\nKvDatabase RaftKVServer  \nKvRaft\n```\ntype KVServer struct {\n\tmu      sync.Mutex\n\tme      int\n    // Raft\n\trf      *raft.Raft\n    // Applych  Raft\n\tapplyCh chan raft.ApplyMsg\n\n\tmaxraftstate int // snapshot if log grows this big\n\tdatabase map[string]string\n\tdup map[int64]int\n\tchanResult map[int]chan Op\n}\n\n// Type OP\ntype Op struct {\n    // Key  Get()Put()Append()\n\tKey      string\n    // ValuePut()Append()Get\n\tValue    string\n    // \n\tName     string\n    // \n\tClientId int64\n    // \n\tSeq      int\n}\n```\n\nOpGetClientIdSeq[](https://ray1888.github.io/distributed-system/2019/08/20/distributed-consensus/)\n\nRaftRaft\n\nApplyCH\n\n```\nfunc (kv *KVServer) ApplyOPRoutine() {\n\t//this gorouine is to asyncly get the result of raft applych reply to\n\t// and to produce signal to reply client Rpc Request\n\tDPrintf(\"Apply gorountine runing \")\n\tfor {\n\t\tmsg := <-kv.applyCh\n\t\t//DPrintf(\"get apply msg from raftServer\")\n\t\tif msg.CommandValid {\n\t\t\tindex := msg.CommandIndex\n\t\t\tif cmd, ok := msg.Command.(Op); ok {\n\t\t\t\tkv.mu.Lock()\n                // \n\t\t\t\tif kv.dupcheck(cmd.ClientId, cmd.Seq) {\n\t\t\t\t\tif cmd.Name == PUT {\n\t\t\t\t\t\tkv.database[cmd.Key] = cmd.Value\n\t\t\t\t\t} else if cmd.Name == APPEND {\n\t\t\t\t\t\tif _, ok := kv.database[cmd.Key]; ok {\n\t\t\t\t\t\t\tkv.database[cmd.Key] += cmd.Value\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tkv.database[cmd.Key] = cmd.Value\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tkv.dup[cmd.ClientId] = cmd.Seq\n\t\t\t\t}\n\t\t\t\tres := Op{cmd.Key, kv.database[cmd.Key], cmd.Name,\n\t\t\t\t\tcmd.ClientId, cmd.Seq}\n\t\t\t\tch, ok := kv.chanResult[index]\n\t\t\t\tif ok {\n\t\t\t\t\tselect {\n\t\t\t\t\tcase <-ch:\n\t\t\t\t\tdefault:\n\t\t\t\t\t}\n\t\t\t\t\tch <- res\n\t\t\t\t\t//DPrintf(\"the cmd has been commited , push request return to chan\")\n\t\t\t\t}\n\t\t\t\tif kv.maxraftstate != -1 && kv.rf.GetStateSize() >= kv.maxraftstate && index == kv.rf.GetCommitedIndex() {\n\t\t\t\t\tDPrintf(\"Do snapshot for over the maxraftstate\")\n\t\t\t\t\tkv.DoSnapShot(index)\n\t\t\t\t}\n\t\t\t\tkv.mu.Unlock()\n\t\t\t}\n\t\t} else {\n\t\t\tkv.LoadSnapShot(msg.Snapshot)\n\n\t\t}\n\t}\n}\n\n//  OPRaft\nfunc(rf *Raft) StartCommand(cmd Op) (Err, string){\n    index, _, isLeader := kv.rf.Start(cmd)\n\t//DPrintf(\"start command %s , client id is %d, key is %s, value is %s\",\n\t//\tcmd.Name, cmd.ClientId, cmd.Key, cmd.Value)\n\tif !isLeader {\n\t\tkv.mu.Unlock()\n\t\t//DPrintf(\"not leader \")\n\t\treturn ERRWrongLeader, \"\"\n\t}\n\tch := make(chan Op, 1)\n\tkv.chanResult[index] = ch\n\tkv.mu.Unlock()\n\n\tdefer func() {\n\t\t// After finish the task\n\t\tkv.mu.Lock()\n\t\tdelete(kv.chanResult, index)\n\t\tkv.mu.Unlock()\n\t}()\n\tselect {\n\tcase c := <-ch:\n\t\t// this channel return is get data from ApplyRoutine\n\t\tif kv.CheckSame(c, cmd) {\n\t\t\tresvalue := \"\"\n\t\t\tif cmd.Name == GET {\n\t\t\t\tresvalue = c.Value\n\t\t\t}\n\t\t\treturn OK, resvalue\n\t\t} else {\n\t\t\tDPrintf(\"Leader has change, index %d op %s error\", index, cmd.Name)\n\t\t\treturn ERRWrongLeader, \"\"\n\t\t}\n\tcase <-time.After(time.Duration(200) * time.Millisecond):\n\t\tDPrintf(\"log get agree timeout, index is %d\", index)\n\t\treturn ERRTimeout, \"\"\n\t}\n}\n```\n\n## <a id=\"\"><span class=\"secondtitle\"></span></a>\n\nRaftKVDatabase  database  dup \n```\nfunc (kv *KVServer) DoSnapShot(index int) {\n\tkv.rf.SaveSnapShot(index, kv.database, kv.dup)\n}\n\n\n// \nfunc (kv *KVServer) LoadSnapShot(snapshot []byte) {\n\tif snapshot == nil || len(snapshot) < 1 {\n\t\tkv.mu.Lock()\n\t\tkv.database = make(map[string]string)\n\t\tkv.mu.Unlock()\n\t\treturn\n\t}\n\ts := bytes.NewBuffer(snapshot)\n\tdecoder := labgob.NewDecoder(s)\n\tvar kvdb map[string]string\n\tvar kvdup map[int64]int\n\tif decoder.Decode(&kvdb) != nil || decoder.Decode(&kvdup) != nil {\n\t\tDPrintf(\"server %d, Decode Snapshot error\", kv.me)\n\t} else {\n\t\tkv.mu.Lock()\n\t\tdefer kv.mu.Unlock()\n\t\tkv.database = kvdb\n\t\tkv.dup = kvdup\n\t\tDPrintf(\"msg snapshot db is %v, dup is %v\", kvdb, kvdup)\n\t\tDPrintf(\"server %d , load Snapshot success\", kv.me)\n\t}\n}\n\n```\n\nLog> maxraftstate \n\n\n\n","source":"_posts/raft-lab-3.md","raw":"---\ntitle:  MIT6.824 Lab3 \ndate: 2019-08-29 15:05:38\ntags: distributed-system\n---\n\n<!-- ---\nlayout: post\ntitle:\nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: \nsummary: MIT6.824 Lab3 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n# \n1. \n2. \n\n# <a id=\"\"><span class=\"toptitle\"></span></a>\nlab3 KVGet(), Put(), Append()\n\n\n\n<!-- ![lab3](/assets/img/posts/Lab3-Process.png) -->\n{% asset_img Lab3-Process.png lab3 %}\n\nKVRaft  \nClientLeader  \nPS: KvDatabase RaftKVServer  \n\n:\n1. ClientKvDatabase\n2. KvDatabaseRaftStart APIRaft\n3. RaftLeader\n4. RaftApplyChKvDatabase\n5. KvDatabaseClient\n\n# <a id=\"\"><span class=\"toptitle\"></span></a>\n\n\n1. \n2. \n\n\n## <a id=\"\"><span class=\"secondtitle\"></span></a>\n\nKvDatabase RaftKVServer  \nKvRaft\n```\ntype KVServer struct {\n\tmu      sync.Mutex\n\tme      int\n    // Raft\n\trf      *raft.Raft\n    // Applych  Raft\n\tapplyCh chan raft.ApplyMsg\n\n\tmaxraftstate int // snapshot if log grows this big\n\tdatabase map[string]string\n\tdup map[int64]int\n\tchanResult map[int]chan Op\n}\n\n// Type OP\ntype Op struct {\n    // Key  Get()Put()Append()\n\tKey      string\n    // ValuePut()Append()Get\n\tValue    string\n    // \n\tName     string\n    // \n\tClientId int64\n    // \n\tSeq      int\n}\n```\n\nOpGetClientIdSeq[](https://ray1888.github.io/distributed-system/2019/08/20/distributed-consensus/)\n\nRaftRaft\n\nApplyCH\n\n```\nfunc (kv *KVServer) ApplyOPRoutine() {\n\t//this gorouine is to asyncly get the result of raft applych reply to\n\t// and to produce signal to reply client Rpc Request\n\tDPrintf(\"Apply gorountine runing \")\n\tfor {\n\t\tmsg := <-kv.applyCh\n\t\t//DPrintf(\"get apply msg from raftServer\")\n\t\tif msg.CommandValid {\n\t\t\tindex := msg.CommandIndex\n\t\t\tif cmd, ok := msg.Command.(Op); ok {\n\t\t\t\tkv.mu.Lock()\n                // \n\t\t\t\tif kv.dupcheck(cmd.ClientId, cmd.Seq) {\n\t\t\t\t\tif cmd.Name == PUT {\n\t\t\t\t\t\tkv.database[cmd.Key] = cmd.Value\n\t\t\t\t\t} else if cmd.Name == APPEND {\n\t\t\t\t\t\tif _, ok := kv.database[cmd.Key]; ok {\n\t\t\t\t\t\t\tkv.database[cmd.Key] += cmd.Value\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tkv.database[cmd.Key] = cmd.Value\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tkv.dup[cmd.ClientId] = cmd.Seq\n\t\t\t\t}\n\t\t\t\tres := Op{cmd.Key, kv.database[cmd.Key], cmd.Name,\n\t\t\t\t\tcmd.ClientId, cmd.Seq}\n\t\t\t\tch, ok := kv.chanResult[index]\n\t\t\t\tif ok {\n\t\t\t\t\tselect {\n\t\t\t\t\tcase <-ch:\n\t\t\t\t\tdefault:\n\t\t\t\t\t}\n\t\t\t\t\tch <- res\n\t\t\t\t\t//DPrintf(\"the cmd has been commited , push request return to chan\")\n\t\t\t\t}\n\t\t\t\tif kv.maxraftstate != -1 && kv.rf.GetStateSize() >= kv.maxraftstate && index == kv.rf.GetCommitedIndex() {\n\t\t\t\t\tDPrintf(\"Do snapshot for over the maxraftstate\")\n\t\t\t\t\tkv.DoSnapShot(index)\n\t\t\t\t}\n\t\t\t\tkv.mu.Unlock()\n\t\t\t}\n\t\t} else {\n\t\t\tkv.LoadSnapShot(msg.Snapshot)\n\n\t\t}\n\t}\n}\n\n//  OPRaft\nfunc(rf *Raft) StartCommand(cmd Op) (Err, string){\n    index, _, isLeader := kv.rf.Start(cmd)\n\t//DPrintf(\"start command %s , client id is %d, key is %s, value is %s\",\n\t//\tcmd.Name, cmd.ClientId, cmd.Key, cmd.Value)\n\tif !isLeader {\n\t\tkv.mu.Unlock()\n\t\t//DPrintf(\"not leader \")\n\t\treturn ERRWrongLeader, \"\"\n\t}\n\tch := make(chan Op, 1)\n\tkv.chanResult[index] = ch\n\tkv.mu.Unlock()\n\n\tdefer func() {\n\t\t// After finish the task\n\t\tkv.mu.Lock()\n\t\tdelete(kv.chanResult, index)\n\t\tkv.mu.Unlock()\n\t}()\n\tselect {\n\tcase c := <-ch:\n\t\t// this channel return is get data from ApplyRoutine\n\t\tif kv.CheckSame(c, cmd) {\n\t\t\tresvalue := \"\"\n\t\t\tif cmd.Name == GET {\n\t\t\t\tresvalue = c.Value\n\t\t\t}\n\t\t\treturn OK, resvalue\n\t\t} else {\n\t\t\tDPrintf(\"Leader has change, index %d op %s error\", index, cmd.Name)\n\t\t\treturn ERRWrongLeader, \"\"\n\t\t}\n\tcase <-time.After(time.Duration(200) * time.Millisecond):\n\t\tDPrintf(\"log get agree timeout, index is %d\", index)\n\t\treturn ERRTimeout, \"\"\n\t}\n}\n```\n\n## <a id=\"\"><span class=\"secondtitle\"></span></a>\n\nRaftKVDatabase  database  dup \n```\nfunc (kv *KVServer) DoSnapShot(index int) {\n\tkv.rf.SaveSnapShot(index, kv.database, kv.dup)\n}\n\n\n// \nfunc (kv *KVServer) LoadSnapShot(snapshot []byte) {\n\tif snapshot == nil || len(snapshot) < 1 {\n\t\tkv.mu.Lock()\n\t\tkv.database = make(map[string]string)\n\t\tkv.mu.Unlock()\n\t\treturn\n\t}\n\ts := bytes.NewBuffer(snapshot)\n\tdecoder := labgob.NewDecoder(s)\n\tvar kvdb map[string]string\n\tvar kvdup map[int64]int\n\tif decoder.Decode(&kvdb) != nil || decoder.Decode(&kvdup) != nil {\n\t\tDPrintf(\"server %d, Decode Snapshot error\", kv.me)\n\t} else {\n\t\tkv.mu.Lock()\n\t\tdefer kv.mu.Unlock()\n\t\tkv.database = kvdb\n\t\tkv.dup = kvdup\n\t\tDPrintf(\"msg snapshot db is %v, dup is %v\", kvdb, kvdup)\n\t\tDPrintf(\"server %d , load Snapshot success\", kv.me)\n\t}\n}\n\n```\n\nLog> maxraftstate \n\n\n\n","slug":"raft-lab-3","published":1,"updated":"2021-01-21T07:27:32.636Z","_id":"ckk6irarf000ak9i58ywe0055","comments":1,"layout":"post","photos":[],"link":"","content":"<!-- ---\nlayout: post\ntitle:\nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: \nsummary: MIT6.824 Lab3 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li></li>\n<li></li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>lab3 KVGet(), Put(), Append()</p>\n<p></p>\n<!-- ![lab3](/assets/img/posts/Lab3-Process.png) -->\n<img src=\"/2019/08/29/raft-lab-3/Lab3-Process.png\" class=\"\" title=\"lab3\">\n<p><br>KVRaft<br>ClientLeader<br>PS: KvDatabase RaftKVServer  </p>\n<p>:</p>\n<ol>\n<li>ClientKvDatabase</li>\n<li>KvDatabaseRaftStart APIRaft</li>\n<li>RaftLeader</li>\n<li>RaftApplyChKvDatabase</li>\n<li>KvDatabaseClient</li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p></p>\n<ol>\n<li></li>\n<li></li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>KvDatabase RaftKVServer<br>KvRaft</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type KVServer struct &#123;</span><br><span class=\"line\">\tmu      sync.Mutex</span><br><span class=\"line\">\tme      int</span><br><span class=\"line\">    &#x2F;&#x2F; Raft</span><br><span class=\"line\">\trf      *raft.Raft</span><br><span class=\"line\">    &#x2F;&#x2F; Applych  Raft</span><br><span class=\"line\">\tapplyCh chan raft.ApplyMsg</span><br><span class=\"line\"></span><br><span class=\"line\">\tmaxraftstate int &#x2F;&#x2F; snapshot if log grows this big</span><br><span class=\"line\">\tdatabase map[string]string</span><br><span class=\"line\">\tdup map[int64]int</span><br><span class=\"line\">\tchanResult map[int]chan Op</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Type OP</span><br><span class=\"line\">type Op struct &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; Key  Get()Put()Append()</span><br><span class=\"line\">\tKey      string</span><br><span class=\"line\">    &#x2F;&#x2F; ValuePut()Append()Get</span><br><span class=\"line\">\tValue    string</span><br><span class=\"line\">    &#x2F;&#x2F; </span><br><span class=\"line\">\tName     string</span><br><span class=\"line\">    &#x2F;&#x2F; </span><br><span class=\"line\">\tClientId int64</span><br><span class=\"line\">    &#x2F;&#x2F; </span><br><span class=\"line\">\tSeq      int</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>OpGetClientIdSeq<span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://ray1888.github.io/distributed-system/2019/08/20/distributed-consensus/\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p>RaftRaft</p>\n<p>ApplyCH</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (kv *KVServer) ApplyOPRoutine() &#123;</span><br><span class=\"line\">\t&#x2F;&#x2F;this gorouine is to asyncly get the result of raft applych reply to</span><br><span class=\"line\">\t&#x2F;&#x2F; and to produce signal to reply client Rpc Request</span><br><span class=\"line\">\tDPrintf(&quot;Apply gorountine runing &quot;)</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tmsg :&#x3D; &lt;-kv.applyCh</span><br><span class=\"line\">\t\t&#x2F;&#x2F;DPrintf(&quot;get apply msg from raftServer&quot;)</span><br><span class=\"line\">\t\tif msg.CommandValid &#123;</span><br><span class=\"line\">\t\t\tindex :&#x3D; msg.CommandIndex</span><br><span class=\"line\">\t\t\tif cmd, ok :&#x3D; msg.Command.(Op); ok &#123;</span><br><span class=\"line\">\t\t\t\tkv.mu.Lock()</span><br><span class=\"line\">                &#x2F;&#x2F; </span><br><span class=\"line\">\t\t\t\tif kv.dupcheck(cmd.ClientId, cmd.Seq) &#123;</span><br><span class=\"line\">\t\t\t\t\tif cmd.Name &#x3D;&#x3D; PUT &#123;</span><br><span class=\"line\">\t\t\t\t\t\tkv.database[cmd.Key] &#x3D; cmd.Value</span><br><span class=\"line\">\t\t\t\t\t&#125; else if cmd.Name &#x3D;&#x3D; APPEND &#123;</span><br><span class=\"line\">\t\t\t\t\t\tif _, ok :&#x3D; kv.database[cmd.Key]; ok &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tkv.database[cmd.Key] +&#x3D; cmd.Value</span><br><span class=\"line\">\t\t\t\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tkv.database[cmd.Key] &#x3D; cmd.Value</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tkv.dup[cmd.ClientId] &#x3D; cmd.Seq</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tres :&#x3D; Op&#123;cmd.Key, kv.database[cmd.Key], cmd.Name,</span><br><span class=\"line\">\t\t\t\t\tcmd.ClientId, cmd.Seq&#125;</span><br><span class=\"line\">\t\t\t\tch, ok :&#x3D; kv.chanResult[index]</span><br><span class=\"line\">\t\t\t\tif ok &#123;</span><br><span class=\"line\">\t\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\t\tcase &lt;-ch:</span><br><span class=\"line\">\t\t\t\t\tdefault:</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tch &lt;- res</span><br><span class=\"line\">\t\t\t\t\t&#x2F;&#x2F;DPrintf(&quot;the cmd has been commited , push request return to chan&quot;)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tif kv.maxraftstate !&#x3D; -1 &amp;&amp; kv.rf.GetStateSize() &gt;&#x3D; kv.maxraftstate &amp;&amp; index &#x3D;&#x3D; kv.rf.GetCommitedIndex() &#123;</span><br><span class=\"line\">\t\t\t\t\tDPrintf(&quot;Do snapshot for over the maxraftstate&quot;)</span><br><span class=\"line\">\t\t\t\t\tkv.DoSnapShot(index)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\tkv.LoadSnapShot(msg.Snapshot)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;  OPRaft</span><br><span class=\"line\">func(rf *Raft) StartCommand(cmd Op) (Err, string)&#123;</span><br><span class=\"line\">    index, _, isLeader :&#x3D; kv.rf.Start(cmd)</span><br><span class=\"line\">\t&#x2F;&#x2F;DPrintf(&quot;start command %s , client id is %d, key is %s, value is %s&quot;,</span><br><span class=\"line\">\t&#x2F;&#x2F;\tcmd.Name, cmd.ClientId, cmd.Key, cmd.Value)</span><br><span class=\"line\">\tif !isLeader &#123;</span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\t&#x2F;&#x2F;DPrintf(&quot;not leader &quot;)</span><br><span class=\"line\">\t\treturn ERRWrongLeader, &quot;&quot;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tch :&#x3D; make(chan Op, 1)</span><br><span class=\"line\">\tkv.chanResult[index] &#x3D; ch</span><br><span class=\"line\">\tkv.mu.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\tdefer func() &#123;</span><br><span class=\"line\">\t\t&#x2F;&#x2F; After finish the task</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tdelete(kv.chanResult, index)</span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\tselect &#123;</span><br><span class=\"line\">\tcase c :&#x3D; &lt;-ch:</span><br><span class=\"line\">\t\t&#x2F;&#x2F; this channel return is get data from ApplyRoutine</span><br><span class=\"line\">\t\tif kv.CheckSame(c, cmd) &#123;</span><br><span class=\"line\">\t\t\tresvalue :&#x3D; &quot;&quot;</span><br><span class=\"line\">\t\t\tif cmd.Name &#x3D;&#x3D; GET &#123;</span><br><span class=\"line\">\t\t\t\tresvalue &#x3D; c.Value</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\treturn OK, resvalue</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\tDPrintf(&quot;Leader has change, index %d op %s error&quot;, index, cmd.Name)</span><br><span class=\"line\">\t\t\treturn ERRWrongLeader, &quot;&quot;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\tcase &lt;-time.After(time.Duration(200) * time.Millisecond):</span><br><span class=\"line\">\t\tDPrintf(&quot;log get agree timeout, index is %d&quot;, index)</span><br><span class=\"line\">\t\treturn ERRTimeout, &quot;&quot;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>RaftKVDatabase  database  dup </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (kv *KVServer) DoSnapShot(index int) &#123;</span><br><span class=\"line\">\tkv.rf.SaveSnapShot(index, kv.database, kv.dup)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">func (kv *KVServer) LoadSnapShot(snapshot []byte) &#123;</span><br><span class=\"line\">\tif snapshot &#x3D;&#x3D; nil || len(snapshot) &lt; 1 &#123;</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tkv.database &#x3D; make(map[string]string)</span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ts :&#x3D; bytes.NewBuffer(snapshot)</span><br><span class=\"line\">\tdecoder :&#x3D; labgob.NewDecoder(s)</span><br><span class=\"line\">\tvar kvdb map[string]string</span><br><span class=\"line\">\tvar kvdup map[int64]int</span><br><span class=\"line\">\tif decoder.Decode(&amp;kvdb) !&#x3D; nil || decoder.Decode(&amp;kvdup) !&#x3D; nil &#123;</span><br><span class=\"line\">\t\tDPrintf(&quot;server %d, Decode Snapshot error&quot;, kv.me)</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tdefer kv.mu.Unlock()</span><br><span class=\"line\">\t\tkv.database &#x3D; kvdb</span><br><span class=\"line\">\t\tkv.dup &#x3D; kvdup</span><br><span class=\"line\">\t\tDPrintf(&quot;msg snapshot db is %v, dup is %v&quot;, kvdb, kvdup)</span><br><span class=\"line\">\t\tDPrintf(&quot;server %d , load Snapshot success&quot;, kv.me)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>Log&gt; maxraftstate </p>\n","site":{"data":{}},"excerpt":"","more":"<!-- ---\nlayout: post\ntitle:\nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: \nsummary: MIT6.824 Lab3 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li></li>\n<li></li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>lab3 KVGet(), Put(), Append()</p>\n<p></p>\n<!-- ![lab3](/assets/img/posts/Lab3-Process.png) -->\n<img src=\"/2019/08/29/raft-lab-3/Lab3-Process.png\" class=\"\" title=\"lab3\">\n<p><br>KVRaft<br>ClientLeader<br>PS: KvDatabase RaftKVServer  </p>\n<p>:</p>\n<ol>\n<li>ClientKvDatabase</li>\n<li>KvDatabaseRaftStart APIRaft</li>\n<li>RaftLeader</li>\n<li>RaftApplyChKvDatabase</li>\n<li>KvDatabaseClient</li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p></p>\n<ol>\n<li></li>\n<li></li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>KvDatabase RaftKVServer<br>KvRaft</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type KVServer struct &#123;</span><br><span class=\"line\">\tmu      sync.Mutex</span><br><span class=\"line\">\tme      int</span><br><span class=\"line\">    &#x2F;&#x2F; Raft</span><br><span class=\"line\">\trf      *raft.Raft</span><br><span class=\"line\">    &#x2F;&#x2F; Applych  Raft</span><br><span class=\"line\">\tapplyCh chan raft.ApplyMsg</span><br><span class=\"line\"></span><br><span class=\"line\">\tmaxraftstate int &#x2F;&#x2F; snapshot if log grows this big</span><br><span class=\"line\">\tdatabase map[string]string</span><br><span class=\"line\">\tdup map[int64]int</span><br><span class=\"line\">\tchanResult map[int]chan Op</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Type OP</span><br><span class=\"line\">type Op struct &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; Key  Get()Put()Append()</span><br><span class=\"line\">\tKey      string</span><br><span class=\"line\">    &#x2F;&#x2F; ValuePut()Append()Get</span><br><span class=\"line\">\tValue    string</span><br><span class=\"line\">    &#x2F;&#x2F; </span><br><span class=\"line\">\tName     string</span><br><span class=\"line\">    &#x2F;&#x2F; </span><br><span class=\"line\">\tClientId int64</span><br><span class=\"line\">    &#x2F;&#x2F; </span><br><span class=\"line\">\tSeq      int</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>OpGetClientIdSeq<span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://ray1888.github.io/distributed-system/2019/08/20/distributed-consensus/\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p>RaftRaft</p>\n<p>ApplyCH</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (kv *KVServer) ApplyOPRoutine() &#123;</span><br><span class=\"line\">\t&#x2F;&#x2F;this gorouine is to asyncly get the result of raft applych reply to</span><br><span class=\"line\">\t&#x2F;&#x2F; and to produce signal to reply client Rpc Request</span><br><span class=\"line\">\tDPrintf(&quot;Apply gorountine runing &quot;)</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tmsg :&#x3D; &lt;-kv.applyCh</span><br><span class=\"line\">\t\t&#x2F;&#x2F;DPrintf(&quot;get apply msg from raftServer&quot;)</span><br><span class=\"line\">\t\tif msg.CommandValid &#123;</span><br><span class=\"line\">\t\t\tindex :&#x3D; msg.CommandIndex</span><br><span class=\"line\">\t\t\tif cmd, ok :&#x3D; msg.Command.(Op); ok &#123;</span><br><span class=\"line\">\t\t\t\tkv.mu.Lock()</span><br><span class=\"line\">                &#x2F;&#x2F; </span><br><span class=\"line\">\t\t\t\tif kv.dupcheck(cmd.ClientId, cmd.Seq) &#123;</span><br><span class=\"line\">\t\t\t\t\tif cmd.Name &#x3D;&#x3D; PUT &#123;</span><br><span class=\"line\">\t\t\t\t\t\tkv.database[cmd.Key] &#x3D; cmd.Value</span><br><span class=\"line\">\t\t\t\t\t&#125; else if cmd.Name &#x3D;&#x3D; APPEND &#123;</span><br><span class=\"line\">\t\t\t\t\t\tif _, ok :&#x3D; kv.database[cmd.Key]; ok &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tkv.database[cmd.Key] +&#x3D; cmd.Value</span><br><span class=\"line\">\t\t\t\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tkv.database[cmd.Key] &#x3D; cmd.Value</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tkv.dup[cmd.ClientId] &#x3D; cmd.Seq</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tres :&#x3D; Op&#123;cmd.Key, kv.database[cmd.Key], cmd.Name,</span><br><span class=\"line\">\t\t\t\t\tcmd.ClientId, cmd.Seq&#125;</span><br><span class=\"line\">\t\t\t\tch, ok :&#x3D; kv.chanResult[index]</span><br><span class=\"line\">\t\t\t\tif ok &#123;</span><br><span class=\"line\">\t\t\t\t\tselect &#123;</span><br><span class=\"line\">\t\t\t\t\tcase &lt;-ch:</span><br><span class=\"line\">\t\t\t\t\tdefault:</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tch &lt;- res</span><br><span class=\"line\">\t\t\t\t\t&#x2F;&#x2F;DPrintf(&quot;the cmd has been commited , push request return to chan&quot;)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tif kv.maxraftstate !&#x3D; -1 &amp;&amp; kv.rf.GetStateSize() &gt;&#x3D; kv.maxraftstate &amp;&amp; index &#x3D;&#x3D; kv.rf.GetCommitedIndex() &#123;</span><br><span class=\"line\">\t\t\t\t\tDPrintf(&quot;Do snapshot for over the maxraftstate&quot;)</span><br><span class=\"line\">\t\t\t\t\tkv.DoSnapShot(index)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\tkv.LoadSnapShot(msg.Snapshot)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;  OPRaft</span><br><span class=\"line\">func(rf *Raft) StartCommand(cmd Op) (Err, string)&#123;</span><br><span class=\"line\">    index, _, isLeader :&#x3D; kv.rf.Start(cmd)</span><br><span class=\"line\">\t&#x2F;&#x2F;DPrintf(&quot;start command %s , client id is %d, key is %s, value is %s&quot;,</span><br><span class=\"line\">\t&#x2F;&#x2F;\tcmd.Name, cmd.ClientId, cmd.Key, cmd.Value)</span><br><span class=\"line\">\tif !isLeader &#123;</span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\t&#x2F;&#x2F;DPrintf(&quot;not leader &quot;)</span><br><span class=\"line\">\t\treturn ERRWrongLeader, &quot;&quot;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tch :&#x3D; make(chan Op, 1)</span><br><span class=\"line\">\tkv.chanResult[index] &#x3D; ch</span><br><span class=\"line\">\tkv.mu.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\tdefer func() &#123;</span><br><span class=\"line\">\t\t&#x2F;&#x2F; After finish the task</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tdelete(kv.chanResult, index)</span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\">\tselect &#123;</span><br><span class=\"line\">\tcase c :&#x3D; &lt;-ch:</span><br><span class=\"line\">\t\t&#x2F;&#x2F; this channel return is get data from ApplyRoutine</span><br><span class=\"line\">\t\tif kv.CheckSame(c, cmd) &#123;</span><br><span class=\"line\">\t\t\tresvalue :&#x3D; &quot;&quot;</span><br><span class=\"line\">\t\t\tif cmd.Name &#x3D;&#x3D; GET &#123;</span><br><span class=\"line\">\t\t\t\tresvalue &#x3D; c.Value</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\treturn OK, resvalue</span><br><span class=\"line\">\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\tDPrintf(&quot;Leader has change, index %d op %s error&quot;, index, cmd.Name)</span><br><span class=\"line\">\t\t\treturn ERRWrongLeader, &quot;&quot;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\tcase &lt;-time.After(time.Duration(200) * time.Millisecond):</span><br><span class=\"line\">\t\tDPrintf(&quot;log get agree timeout, index is %d&quot;, index)</span><br><span class=\"line\">\t\treturn ERRTimeout, &quot;&quot;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>RaftKVDatabase  database  dup </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (kv *KVServer) DoSnapShot(index int) &#123;</span><br><span class=\"line\">\tkv.rf.SaveSnapShot(index, kv.database, kv.dup)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">func (kv *KVServer) LoadSnapShot(snapshot []byte) &#123;</span><br><span class=\"line\">\tif snapshot &#x3D;&#x3D; nil || len(snapshot) &lt; 1 &#123;</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tkv.database &#x3D; make(map[string]string)</span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\treturn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ts :&#x3D; bytes.NewBuffer(snapshot)</span><br><span class=\"line\">\tdecoder :&#x3D; labgob.NewDecoder(s)</span><br><span class=\"line\">\tvar kvdb map[string]string</span><br><span class=\"line\">\tvar kvdup map[int64]int</span><br><span class=\"line\">\tif decoder.Decode(&amp;kvdb) !&#x3D; nil || decoder.Decode(&amp;kvdup) !&#x3D; nil &#123;</span><br><span class=\"line\">\t\tDPrintf(&quot;server %d, Decode Snapshot error&quot;, kv.me)</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tdefer kv.mu.Unlock()</span><br><span class=\"line\">\t\tkv.database &#x3D; kvdb</span><br><span class=\"line\">\t\tkv.dup &#x3D; kvdup</span><br><span class=\"line\">\t\tDPrintf(&quot;msg snapshot db is %v, dup is %v&quot;, kvdb, kvdup)</span><br><span class=\"line\">\t\tDPrintf(&quot;server %d , load Snapshot success&quot;, kv.me)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>Log&gt; maxraftstate </p>\n"},{"title":"MIT6.824 Lab4 ","date":"2019-08-29T12:05:38.000Z","_content":"\n<!-- ---\nlayout: post\ntitle: MIT6.824 Lab4 \nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: distributed-system\nsummary: MIT6.824 Lab4 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n# \n1. [](#Purpose)  \n2. [](#Implementation)  \n   2.1 [lab4-1](#2.1)  \n   2.2 [lab4-2](#2.2)  \n\n\n# <a id=\"Purpose\"><span class=\"toptitle\"></span></a>\n\nlab4:\n1. lab4-1 KvRaftShardMasterK-vLab3\n2. lab4-2 ShardingkvRaftMulti-raft)\n\n\n\n<!-- ![lab4](/assets/img/posts/lab4.png) -->\n{% asset_img lab4.png lab4 %}\n\n\nKVRaft    \nClientLeader    \nPS: KvDatabase RaftKVServer    \n\n:\n1. ClientShardMasterKey\n2. ShardMasterKey\n3. ClientRaft Leader\n4. RaftApplyChKvDatabase\n5. KvDatabaseClient\n\n## \nMulti-Raft\n\n KeyModKeyMod  \n 0>=2  \n\n# <a id=\"Implementation\"><span class=\"toptitle\"></span></a>\n\n## <a id=\"2.1\"><span class=\"secondtitle\">lab4-1</span></a>\n\nLab3 Leave(), Move(), Join() Query()\nLab3  \n\n```\ntype ShardMaster struct {\n\tmu      sync.Mutex\n\tme      int\n\trf      *raft.Raft\n\tapplyCh chan raft.ApplyMsg\n\t// Your data here.\n    // Lab3 database map[string]string \n\tconfigs    []Config // indexed by config num\n\tdup        map[int64]Result\n\tchanResult map[int]chan Result\n}\n\n```\n\nshard  Group  \nGetLab3KvConfig  \n\n## <a id=\"2.2\"><span class=\"secondtitle\">lab4-2</span></a>\n\nKvKv\n\n\nKV3\n1. ShardMaster\n2. \n3. \n\n\n1. Lab3OPGetPullPutAppend\n2. Lab4-1Config\n3. RaftGroupLeaderKV\n\nShardMaster\n```\nfunc (kv *ShardKV) ConfigUpdateRoutine() {\n\tfor {\n\t\tkv.mu.Lock()\n\t\tcurConfigNum := kv.myconfig[0].Num\n\t\tkv.mu.Unlock()\n        // Query1\n\t\tconfig := kv.mck.Query(curConfigNum + 1)\n\t\t//DPrintf(\"get newConfig from SM group is %v, shard is %v\", config.Groups, config.Shards)\n\t\tkv.mu.Lock()\n\t\tif config.Num == kv.myconfig[0].Num+1 {\n\t\t\t// update with static NewConfig\n\t\t\tnewConfig := kv.makeEmptyConfig()\n\t\t\tkv.CopyConfig(&config, &newConfig)\n\t\t\tif _, isLeader := kv.rf.GetState(); isLeader {\n\t\t\t\tcfg := Cfg{newConfig, int64(kv.gid), kv.myconfig[0].Num}\n\t\t\t\tkv.rf.Start(cfg)\n\t\t\t\tDPrintf(\"Config: group %d-%d is start config %d into consueum\",\n\t\t\t\t\tkv.gid, kv.me, cfg.NewConfig.Num)\n\t\t\t\t//index, _, isleader := kv.rf.Start(cfg)\n\t\t\t\t//DPrintf(\"))))) server %d gid %d Start cfg index is %d, isleader is %t, kv is %v\",\n\t\t\t\t//\tkv.me, kv.gid, index, isleader, kv.database)\n\t\t\t}\n\t\t} \n\t\tkv.mu.Unlock()\n\t\ttime.Sleep(100 * time.Millisecond)\n\t}\n}\n\n```\n\nShard\n```\ncase Cfg:\n    if kv.CfgDupCheck(cmd.ClientId, cmd.Seq) {\n        kv.SwitchConfig(cmd)\n        if kv.CheckMigrateDone() {\n            // if migrate done, use new config, if not, do nothing to avoid replying the old group replied\n            kv.myconfig[0] = kv.myconfig[1]\n            //DPrintf(\"group %d-%d is applied new config , shard is %v, kv is %v\", kv.gid, kv.me, kv.myshards, kv.database)\n        }\n        kv.cfgdup[cmd.ClientId] = cmd.Seq\n        if kv.maxraftstate != -1 {\n            kv.SaveSnapshot(index)\n        }\n    }\n\nfunc (kv *ShardKV) SwitchConfig(newcfg Cfg) {\n\tif newcfg.NewConfig.Num == kv.myconfig[0].Num+1 {\n\t\tif kv.myconfig[0].Num != 0 {\n\t\t\tkv.GenShardChangeList(newcfg)\n\t\t} else if kv.myconfig[0].Num == 0 {\n\t\t\tfor i := 0; i < shardmaster.NShards; i++ {\n\t\t\t\tif newcfg.NewConfig.Shards[i] == kv.gid {\n\t\t\t\t\tkv.myshards[i] = 1\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tnewc := kv.makeEmptyConfig()\n\t\tkv.CopyConfig(&newcfg.NewConfig, &newc)\n\t\tkv.myconfig[1] = newc\n\t}\n}\n\n// \nfunc (kv *ShardKV) GenShardChangeList(newcfg Cfg) {\n\tfor i := 0; i < shardmaster.NShards; i++ {\n\t\tif kv.myconfig[0].Shards[i] == kv.gid && newcfg.NewConfig.Shards[i] != kv.gid {\n\t\t\t//need to send\n\t\t\tkv.needsend[i] = newcfg.NewConfig.Shards[i]\n\t\t}\n\t\tif kv.myconfig[0].Shards[i] != kv.gid && newcfg.NewConfig.Shards[i] == kv.gid {\n\t\t\t//need to recv\n\t\t\t_, ok := kv.needrecv[kv.myconfig[0].Shards[i]]\n\t\t\tif !ok {\n\t\t\t\tkv.needrecv[kv.myconfig[0].Shards[i]] = make([]int, 0)\n\t\t\t}\n\t\t\tkv.needrecv[kv.myconfig[0].Shards[i]] = append(kv.needrecv[kv.myconfig[0].Shards[i]], i)\n\t\t}\n\t}\n\tDPrintf(\"!!! group %d-%d, new config need to send is %v, need to receive is %v\", kv.gid, kv.me, kv.needsend, kv.needrecv)\n}\n```\n\n\n  \nLeaderLeaderRPCPull DatabaseDUP  \n\n```\nfunc (kv *ShardKV) MigrationRoutine() {\n\tfor {\n\t\tif _, isLeader := kv.rf.GetState(); isLeader {\n\t\t\tkv.mu.Lock()\n\t\t\tfor k, v := range kv.needrecv {\n\t\t\t\t//DPrintf(\"group %d-%d needrecv \")\n\t\t\t\tneedshard := make([]int, 0)\n\t\t\t\tfor i := 0; i < len(v); i++ {\n\t\t\t\t\tneedshard = append(needshard, v[i])\n\t\t\t\t}\n\n\t\t\t\targs := PullArgs{Shard: needshard, ClientId: int64(kv.gid), Seq: kv.myconfig[0].Num}\n\t\t\t\tgo func(mgid int, arg *PullArgs) {\n\t\t\t\t\tservers := kv.myconfig[0].Groups[mgid]\n\t\t\t\t\tDPrintf(\"Migrate: group %d-%d get Gid %d Servers is %v\",\n\t\t\t\t\t\tkv.gid, kv.me, mgid, servers)\n\t\t\t\t\tfor {\n\t\t\t\t\t\tfor _, si := range servers {\n\t\t\t\t\t\t\treply := PullReply{}\n\t\t\t\t\t\t\tsrv := kv.make_end(si)\n\t\t\t\t\t\t\tDPrintf(\"group %d-%d start call to gid %d\", kv.gid, kv.me, mgid)\n                            // GroupA\n\t\t\t\t\t\t\tok := srv.Call(\"ShardKV.Pull\", arg, &reply)\n\t\t\t\t\t\t\t//DPrintf(\"Migrate: group %d-%d  calling for server %v rpc pull, result is %t\",\n\t\t\t\t\t\t\t//\t    kv.gid, kv.me, si, ok)\n\t\t\t\t\t\t\tif !ok {\n\t\t\t\t\t\t\t\tDPrintf(\"Migrate Failed: group %d-%d  calling for server %v rpc pull, result is %t\",\n\t\t\t\t\t\t\t\t\tkv.gid, kv.me, si, ok)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ok && reply.WrongLeader == false {\n\t\t\t\t\t\t\t\tif reply.Err == ErrNeedWait {\n\t\t\t\t\t\t\t\t\tDPrintf(\"Migrate: waiting server %v to pull new config from SM\", si)\n\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif _, isleader := kv.rf.GetState(); isleader {\n\t\t\t\t\t\t\t\t\tnewmapkv := make(map[string]string)\n\t\t\t\t\t\t\t\t\tfor k, v := range reply.MapKV {\n\t\t\t\t\t\t\t\t\t\tnewmapkv[k] = v\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tvar newdup [shardmaster.NShards]map[int64]int\n\t\t\t\t\t\t\t\t\tfor i := 0; i < shardmaster.NShards; i++ {\n\t\t\t\t\t\t\t\t\t\tnewdup[i] = make(map[int64]int)\n\t\t\t\t\t\t\t\t\t\tfor k, v := range reply.ShardDup[i] {\n\t\t\t\t\t\t\t\t\t\t\tnewdup[i][k] = v\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tmig := Migrate{newmapkv, newdup, arg.Seq, mgid}\n\t\t\t\t\t\t\t\t\tkv.mu.Lock()\n\t\t\t\t\t\t\t\t\t// this is how partition data can be repliacated\n\t\t\t\t\t\t\t\t\tkv.rf.Start(mig)\n\t\t\t\t\t\t\t\t\tDPrintf(\"Migrate: group %d-%d start migrate the data pulled from %d\", kv.gid, kv.me, mgid)\n\t\t\t\t\t\t\t\t\tkv.mu.Unlock()\n\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tDPrintf(\"Migrate Failed: group %d-%d call %d-%v meet wrong leader\",\n\t\t\t\t\t\t\t\t\tkv.gid, kv.me, mgid, si)\n\t\t\t\t\t\t\t\tDPrintf(\"!!!server is %v\", servers)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\ttime.Sleep(20 * time.Millisecond)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}(k, &args)\n\t\t\t}\n\t\t\tkv.mu.Unlock()\n\t\t}\n\t\ttime.Sleep(100 * time.Millisecond)\n\t}\n}\n\n```\n\nLeaderKV\n```\ncase Migrate:\n    if kv.MigrateDupCheck(cmd.Gid, cmd.Num) {\n        //DPrintf(\"group %d-%d apply the migrate data from %d and config num %d\", kv.gid, kv.me, cmd.Gid, cmd.Num)\n        //DPrintf(\"group %d-%d database before migrate is %v\", kv.gid, kv.me, kv.database)\n        for k, v := range cmd.MapKV {\n            kv.database[k] = v\n        }\n        //DPrintf(\"group %d-%d database after migrate is %v\", kv.gid, kv.me, kv.database)\n        for i := 0; i < shardmaster.NShards; i++ {\n            for k, v := range cmd.ShardDup[i] {\n                kv.dup[i][k] = v\n            }\n        }\n        for i := 0; i < len(kv.needrecv[cmd.Gid]); i++ {\n            kv.myshards[kv.needrecv[cmd.Gid][i]] = 1\n        }\n        delete(kv.needrecv, cmd.Gid)\n        if kv.CheckMigrateDone() {\n            kv.myconfig[0] = kv.myconfig[1]\n            DPrintf(\"Migrate: group %d-%d successful switch to config %d\", kv.gid, kv.me, kv.myconfig[0].Num)\n            //DPrintf(\"group %d-%d is applied new config , shard is %v\", kv.gid, kv.me, kv.myshards)\n        }\n        kv.migratedup[cmd.Gid] = cmd.Num\n        if kv.maxraftstate != -1 {\n            kv.SaveSnapshot(index)\n        }\n    }\n```","source":"_posts/raft-lab-4.md","raw":"---\ntitle: MIT6.824 Lab4 \ndate: 2019-08-29 20:05:38\ntags: distributed-system\n---\n\n<!-- ---\nlayout: post\ntitle: MIT6.824 Lab4 \nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: distributed-system\nsummary: MIT6.824 Lab4 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n# \n1. [](#Purpose)  \n2. [](#Implementation)  \n   2.1 [lab4-1](#2.1)  \n   2.2 [lab4-2](#2.2)  \n\n\n# <a id=\"Purpose\"><span class=\"toptitle\"></span></a>\n\nlab4:\n1. lab4-1 KvRaftShardMasterK-vLab3\n2. lab4-2 ShardingkvRaftMulti-raft)\n\n\n\n<!-- ![lab4](/assets/img/posts/lab4.png) -->\n{% asset_img lab4.png lab4 %}\n\n\nKVRaft    \nClientLeader    \nPS: KvDatabase RaftKVServer    \n\n:\n1. ClientShardMasterKey\n2. ShardMasterKey\n3. ClientRaft Leader\n4. RaftApplyChKvDatabase\n5. KvDatabaseClient\n\n## \nMulti-Raft\n\n KeyModKeyMod  \n 0>=2  \n\n# <a id=\"Implementation\"><span class=\"toptitle\"></span></a>\n\n## <a id=\"2.1\"><span class=\"secondtitle\">lab4-1</span></a>\n\nLab3 Leave(), Move(), Join() Query()\nLab3  \n\n```\ntype ShardMaster struct {\n\tmu      sync.Mutex\n\tme      int\n\trf      *raft.Raft\n\tapplyCh chan raft.ApplyMsg\n\t// Your data here.\n    // Lab3 database map[string]string \n\tconfigs    []Config // indexed by config num\n\tdup        map[int64]Result\n\tchanResult map[int]chan Result\n}\n\n```\n\nshard  Group  \nGetLab3KvConfig  \n\n## <a id=\"2.2\"><span class=\"secondtitle\">lab4-2</span></a>\n\nKvKv\n\n\nKV3\n1. ShardMaster\n2. \n3. \n\n\n1. Lab3OPGetPullPutAppend\n2. Lab4-1Config\n3. RaftGroupLeaderKV\n\nShardMaster\n```\nfunc (kv *ShardKV) ConfigUpdateRoutine() {\n\tfor {\n\t\tkv.mu.Lock()\n\t\tcurConfigNum := kv.myconfig[0].Num\n\t\tkv.mu.Unlock()\n        // Query1\n\t\tconfig := kv.mck.Query(curConfigNum + 1)\n\t\t//DPrintf(\"get newConfig from SM group is %v, shard is %v\", config.Groups, config.Shards)\n\t\tkv.mu.Lock()\n\t\tif config.Num == kv.myconfig[0].Num+1 {\n\t\t\t// update with static NewConfig\n\t\t\tnewConfig := kv.makeEmptyConfig()\n\t\t\tkv.CopyConfig(&config, &newConfig)\n\t\t\tif _, isLeader := kv.rf.GetState(); isLeader {\n\t\t\t\tcfg := Cfg{newConfig, int64(kv.gid), kv.myconfig[0].Num}\n\t\t\t\tkv.rf.Start(cfg)\n\t\t\t\tDPrintf(\"Config: group %d-%d is start config %d into consueum\",\n\t\t\t\t\tkv.gid, kv.me, cfg.NewConfig.Num)\n\t\t\t\t//index, _, isleader := kv.rf.Start(cfg)\n\t\t\t\t//DPrintf(\"))))) server %d gid %d Start cfg index is %d, isleader is %t, kv is %v\",\n\t\t\t\t//\tkv.me, kv.gid, index, isleader, kv.database)\n\t\t\t}\n\t\t} \n\t\tkv.mu.Unlock()\n\t\ttime.Sleep(100 * time.Millisecond)\n\t}\n}\n\n```\n\nShard\n```\ncase Cfg:\n    if kv.CfgDupCheck(cmd.ClientId, cmd.Seq) {\n        kv.SwitchConfig(cmd)\n        if kv.CheckMigrateDone() {\n            // if migrate done, use new config, if not, do nothing to avoid replying the old group replied\n            kv.myconfig[0] = kv.myconfig[1]\n            //DPrintf(\"group %d-%d is applied new config , shard is %v, kv is %v\", kv.gid, kv.me, kv.myshards, kv.database)\n        }\n        kv.cfgdup[cmd.ClientId] = cmd.Seq\n        if kv.maxraftstate != -1 {\n            kv.SaveSnapshot(index)\n        }\n    }\n\nfunc (kv *ShardKV) SwitchConfig(newcfg Cfg) {\n\tif newcfg.NewConfig.Num == kv.myconfig[0].Num+1 {\n\t\tif kv.myconfig[0].Num != 0 {\n\t\t\tkv.GenShardChangeList(newcfg)\n\t\t} else if kv.myconfig[0].Num == 0 {\n\t\t\tfor i := 0; i < shardmaster.NShards; i++ {\n\t\t\t\tif newcfg.NewConfig.Shards[i] == kv.gid {\n\t\t\t\t\tkv.myshards[i] = 1\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tnewc := kv.makeEmptyConfig()\n\t\tkv.CopyConfig(&newcfg.NewConfig, &newc)\n\t\tkv.myconfig[1] = newc\n\t}\n}\n\n// \nfunc (kv *ShardKV) GenShardChangeList(newcfg Cfg) {\n\tfor i := 0; i < shardmaster.NShards; i++ {\n\t\tif kv.myconfig[0].Shards[i] == kv.gid && newcfg.NewConfig.Shards[i] != kv.gid {\n\t\t\t//need to send\n\t\t\tkv.needsend[i] = newcfg.NewConfig.Shards[i]\n\t\t}\n\t\tif kv.myconfig[0].Shards[i] != kv.gid && newcfg.NewConfig.Shards[i] == kv.gid {\n\t\t\t//need to recv\n\t\t\t_, ok := kv.needrecv[kv.myconfig[0].Shards[i]]\n\t\t\tif !ok {\n\t\t\t\tkv.needrecv[kv.myconfig[0].Shards[i]] = make([]int, 0)\n\t\t\t}\n\t\t\tkv.needrecv[kv.myconfig[0].Shards[i]] = append(kv.needrecv[kv.myconfig[0].Shards[i]], i)\n\t\t}\n\t}\n\tDPrintf(\"!!! group %d-%d, new config need to send is %v, need to receive is %v\", kv.gid, kv.me, kv.needsend, kv.needrecv)\n}\n```\n\n\n  \nLeaderLeaderRPCPull DatabaseDUP  \n\n```\nfunc (kv *ShardKV) MigrationRoutine() {\n\tfor {\n\t\tif _, isLeader := kv.rf.GetState(); isLeader {\n\t\t\tkv.mu.Lock()\n\t\t\tfor k, v := range kv.needrecv {\n\t\t\t\t//DPrintf(\"group %d-%d needrecv \")\n\t\t\t\tneedshard := make([]int, 0)\n\t\t\t\tfor i := 0; i < len(v); i++ {\n\t\t\t\t\tneedshard = append(needshard, v[i])\n\t\t\t\t}\n\n\t\t\t\targs := PullArgs{Shard: needshard, ClientId: int64(kv.gid), Seq: kv.myconfig[0].Num}\n\t\t\t\tgo func(mgid int, arg *PullArgs) {\n\t\t\t\t\tservers := kv.myconfig[0].Groups[mgid]\n\t\t\t\t\tDPrintf(\"Migrate: group %d-%d get Gid %d Servers is %v\",\n\t\t\t\t\t\tkv.gid, kv.me, mgid, servers)\n\t\t\t\t\tfor {\n\t\t\t\t\t\tfor _, si := range servers {\n\t\t\t\t\t\t\treply := PullReply{}\n\t\t\t\t\t\t\tsrv := kv.make_end(si)\n\t\t\t\t\t\t\tDPrintf(\"group %d-%d start call to gid %d\", kv.gid, kv.me, mgid)\n                            // GroupA\n\t\t\t\t\t\t\tok := srv.Call(\"ShardKV.Pull\", arg, &reply)\n\t\t\t\t\t\t\t//DPrintf(\"Migrate: group %d-%d  calling for server %v rpc pull, result is %t\",\n\t\t\t\t\t\t\t//\t    kv.gid, kv.me, si, ok)\n\t\t\t\t\t\t\tif !ok {\n\t\t\t\t\t\t\t\tDPrintf(\"Migrate Failed: group %d-%d  calling for server %v rpc pull, result is %t\",\n\t\t\t\t\t\t\t\t\tkv.gid, kv.me, si, ok)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ok && reply.WrongLeader == false {\n\t\t\t\t\t\t\t\tif reply.Err == ErrNeedWait {\n\t\t\t\t\t\t\t\t\tDPrintf(\"Migrate: waiting server %v to pull new config from SM\", si)\n\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif _, isleader := kv.rf.GetState(); isleader {\n\t\t\t\t\t\t\t\t\tnewmapkv := make(map[string]string)\n\t\t\t\t\t\t\t\t\tfor k, v := range reply.MapKV {\n\t\t\t\t\t\t\t\t\t\tnewmapkv[k] = v\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tvar newdup [shardmaster.NShards]map[int64]int\n\t\t\t\t\t\t\t\t\tfor i := 0; i < shardmaster.NShards; i++ {\n\t\t\t\t\t\t\t\t\t\tnewdup[i] = make(map[int64]int)\n\t\t\t\t\t\t\t\t\t\tfor k, v := range reply.ShardDup[i] {\n\t\t\t\t\t\t\t\t\t\t\tnewdup[i][k] = v\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tmig := Migrate{newmapkv, newdup, arg.Seq, mgid}\n\t\t\t\t\t\t\t\t\tkv.mu.Lock()\n\t\t\t\t\t\t\t\t\t// this is how partition data can be repliacated\n\t\t\t\t\t\t\t\t\tkv.rf.Start(mig)\n\t\t\t\t\t\t\t\t\tDPrintf(\"Migrate: group %d-%d start migrate the data pulled from %d\", kv.gid, kv.me, mgid)\n\t\t\t\t\t\t\t\t\tkv.mu.Unlock()\n\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tDPrintf(\"Migrate Failed: group %d-%d call %d-%v meet wrong leader\",\n\t\t\t\t\t\t\t\t\tkv.gid, kv.me, mgid, si)\n\t\t\t\t\t\t\t\tDPrintf(\"!!!server is %v\", servers)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\ttime.Sleep(20 * time.Millisecond)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}(k, &args)\n\t\t\t}\n\t\t\tkv.mu.Unlock()\n\t\t}\n\t\ttime.Sleep(100 * time.Millisecond)\n\t}\n}\n\n```\n\nLeaderKV\n```\ncase Migrate:\n    if kv.MigrateDupCheck(cmd.Gid, cmd.Num) {\n        //DPrintf(\"group %d-%d apply the migrate data from %d and config num %d\", kv.gid, kv.me, cmd.Gid, cmd.Num)\n        //DPrintf(\"group %d-%d database before migrate is %v\", kv.gid, kv.me, kv.database)\n        for k, v := range cmd.MapKV {\n            kv.database[k] = v\n        }\n        //DPrintf(\"group %d-%d database after migrate is %v\", kv.gid, kv.me, kv.database)\n        for i := 0; i < shardmaster.NShards; i++ {\n            for k, v := range cmd.ShardDup[i] {\n                kv.dup[i][k] = v\n            }\n        }\n        for i := 0; i < len(kv.needrecv[cmd.Gid]); i++ {\n            kv.myshards[kv.needrecv[cmd.Gid][i]] = 1\n        }\n        delete(kv.needrecv, cmd.Gid)\n        if kv.CheckMigrateDone() {\n            kv.myconfig[0] = kv.myconfig[1]\n            DPrintf(\"Migrate: group %d-%d successful switch to config %d\", kv.gid, kv.me, kv.myconfig[0].Num)\n            //DPrintf(\"group %d-%d is applied new config , shard is %v\", kv.gid, kv.me, kv.myshards)\n        }\n        kv.migratedup[cmd.Gid] = cmd.Num\n        if kv.maxraftstate != -1 {\n            kv.SaveSnapshot(index)\n        }\n    }\n```","slug":"raft-lab-4","published":1,"updated":"2021-01-21T07:28:28.088Z","_id":"ckk6irarh000dk9i5944l19ix","comments":1,"layout":"post","photos":[],"link":"","content":"<!-- ---\nlayout: post\ntitle: MIT6.824 Lab4 \nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: distributed-system\nsummary: MIT6.824 Lab4 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#Purpose\"></a>  </li>\n<li><a href=\"#Implementation\"></a><br>2.1 <a href=\"#2.1\">lab4-1</a><br>2.2 <a href=\"#2.2\">lab4-2</a>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>lab4:</p>\n<ol>\n<li>lab4-1 KvRaftShardMasterK-vLab3</li>\n<li>lab4-2 ShardingkvRaftMulti-raft)</li>\n</ol>\n<p></p>\n<!-- ![lab4](/assets/img/posts/lab4.png) -->\n<img src=\"/2019/08/29/raft-lab-4/lab4.png\" class=\"\" title=\"lab4\">\n\n<p><br>KVRaft<br>ClientLeader<br>PS: KvDatabase RaftKVServer    </p>\n<p>:</p>\n<ol>\n<li>ClientShardMasterKey</li>\n<li>ShardMasterKey</li>\n<li>ClientRaft Leader</li>\n<li>RaftApplyChKvDatabase</li>\n<li>KvDatabaseClient</li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>Multi-Raft</p>\n<p> KeyModKeyMod<br> 0&gt;=2  </p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"lab4-1\"   >\n          <a href=\"#lab4-1\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>lab4-1</h2>\n      <p>Lab3 Leave(), Move(), Join() Query()<br>Lab3  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type ShardMaster struct &#123;</span><br><span class=\"line\">\tmu      sync.Mutex</span><br><span class=\"line\">\tme      int</span><br><span class=\"line\">\trf      *raft.Raft</span><br><span class=\"line\">\tapplyCh chan raft.ApplyMsg</span><br><span class=\"line\">\t&#x2F;&#x2F; Your data here.</span><br><span class=\"line\">    &#x2F;&#x2F; Lab3 database map[string]string </span><br><span class=\"line\">\tconfigs    []Config &#x2F;&#x2F; indexed by config num</span><br><span class=\"line\">\tdup        map[int64]Result</span><br><span class=\"line\">\tchanResult map[int]chan Result</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>shard  Group<br>GetLab3KvConfig  </p>\n\n        <h2 id=\"lab4-2\"   >\n          <a href=\"#lab4-2\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>lab4-2</h2>\n      <p>KvKv</p>\n<p><br>KV3</p>\n<ol>\n<li>ShardMaster</li>\n<li></li>\n<li></li>\n</ol>\n<p></p>\n<ol>\n<li>Lab3OPGetPullPutAppend</li>\n<li>Lab4-1Config</li>\n<li>RaftGroupLeaderKV</li>\n</ol>\n<p>ShardMaster</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (kv *ShardKV) ConfigUpdateRoutine() &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tcurConfigNum :&#x3D; kv.myconfig[0].Num</span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">        &#x2F;&#x2F; Query1</span><br><span class=\"line\">\t\tconfig :&#x3D; kv.mck.Query(curConfigNum + 1)</span><br><span class=\"line\">\t\t&#x2F;&#x2F;DPrintf(&quot;get newConfig from SM group is %v, shard is %v&quot;, config.Groups, config.Shards)</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tif config.Num &#x3D;&#x3D; kv.myconfig[0].Num+1 &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; update with static NewConfig</span><br><span class=\"line\">\t\t\tnewConfig :&#x3D; kv.makeEmptyConfig()</span><br><span class=\"line\">\t\t\tkv.CopyConfig(&amp;config, &amp;newConfig)</span><br><span class=\"line\">\t\t\tif _, isLeader :&#x3D; kv.rf.GetState(); isLeader &#123;</span><br><span class=\"line\">\t\t\t\tcfg :&#x3D; Cfg&#123;newConfig, int64(kv.gid), kv.myconfig[0].Num&#125;</span><br><span class=\"line\">\t\t\t\tkv.rf.Start(cfg)</span><br><span class=\"line\">\t\t\t\tDPrintf(&quot;Config: group %d-%d is start config %d into consueum&quot;,</span><br><span class=\"line\">\t\t\t\t\tkv.gid, kv.me, cfg.NewConfig.Num)</span><br><span class=\"line\">\t\t\t\t&#x2F;&#x2F;index, _, isleader :&#x3D; kv.rf.Start(cfg)</span><br><span class=\"line\">\t\t\t\t&#x2F;&#x2F;DPrintf(&quot;))))) server %d gid %d Start cfg index is %d, isleader is %t, kv is %v&quot;,</span><br><span class=\"line\">\t\t\t\t&#x2F;&#x2F;\tkv.me, kv.gid, index, isleader, kv.database)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125; </span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\ttime.Sleep(100 * time.Millisecond)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>Shard</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case Cfg:</span><br><span class=\"line\">    if kv.CfgDupCheck(cmd.ClientId, cmd.Seq) &#123;</span><br><span class=\"line\">        kv.SwitchConfig(cmd)</span><br><span class=\"line\">        if kv.CheckMigrateDone() &#123;</span><br><span class=\"line\">            &#x2F;&#x2F; if migrate done, use new config, if not, do nothing to avoid replying the old group replied</span><br><span class=\"line\">            kv.myconfig[0] &#x3D; kv.myconfig[1]</span><br><span class=\"line\">            &#x2F;&#x2F;DPrintf(&quot;group %d-%d is applied new config , shard is %v, kv is %v&quot;, kv.gid, kv.me, kv.myshards, kv.database)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        kv.cfgdup[cmd.ClientId] &#x3D; cmd.Seq</span><br><span class=\"line\">        if kv.maxraftstate !&#x3D; -1 &#123;</span><br><span class=\"line\">            kv.SaveSnapshot(index)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (kv *ShardKV) SwitchConfig(newcfg Cfg) &#123;</span><br><span class=\"line\">\tif newcfg.NewConfig.Num &#x3D;&#x3D; kv.myconfig[0].Num+1 &#123;</span><br><span class=\"line\">\t\tif kv.myconfig[0].Num !&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\tkv.GenShardChangeList(newcfg)</span><br><span class=\"line\">\t\t&#125; else if kv.myconfig[0].Num &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\tfor i :&#x3D; 0; i &lt; shardmaster.NShards; i++ &#123;</span><br><span class=\"line\">\t\t\t\tif newcfg.NewConfig.Shards[i] &#x3D;&#x3D; kv.gid &#123;</span><br><span class=\"line\">\t\t\t\t\tkv.myshards[i] &#x3D; 1</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tnewc :&#x3D; kv.makeEmptyConfig()</span><br><span class=\"line\">\t\tkv.CopyConfig(&amp;newcfg.NewConfig, &amp;newc)</span><br><span class=\"line\">\t\tkv.myconfig[1] &#x3D; newc</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">func (kv *ShardKV) GenShardChangeList(newcfg Cfg) &#123;</span><br><span class=\"line\">\tfor i :&#x3D; 0; i &lt; shardmaster.NShards; i++ &#123;</span><br><span class=\"line\">\t\tif kv.myconfig[0].Shards[i] &#x3D;&#x3D; kv.gid &amp;&amp; newcfg.NewConfig.Shards[i] !&#x3D; kv.gid &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F;need to send</span><br><span class=\"line\">\t\t\tkv.needsend[i] &#x3D; newcfg.NewConfig.Shards[i]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tif kv.myconfig[0].Shards[i] !&#x3D; kv.gid &amp;&amp; newcfg.NewConfig.Shards[i] &#x3D;&#x3D; kv.gid &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F;need to recv</span><br><span class=\"line\">\t\t\t_, ok :&#x3D; kv.needrecv[kv.myconfig[0].Shards[i]]</span><br><span class=\"line\">\t\t\tif !ok &#123;</span><br><span class=\"line\">\t\t\t\tkv.needrecv[kv.myconfig[0].Shards[i]] &#x3D; make([]int, 0)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tkv.needrecv[kv.myconfig[0].Shards[i]] &#x3D; append(kv.needrecv[kv.myconfig[0].Shards[i]], i)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDPrintf(&quot;!!! group %d-%d, new config need to send is %v, need to receive is %v&quot;, kv.gid, kv.me, kv.needsend, kv.needrecv)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p><br>LeaderLeaderRPCPull DatabaseDUP<br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (kv *ShardKV) MigrationRoutine() &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tif _, isLeader :&#x3D; kv.rf.GetState(); isLeader &#123;</span><br><span class=\"line\">\t\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\t\tfor k, v :&#x3D; range kv.needrecv &#123;</span><br><span class=\"line\">\t\t\t\t&#x2F;&#x2F;DPrintf(&quot;group %d-%d needrecv &quot;)</span><br><span class=\"line\">\t\t\t\tneedshard :&#x3D; make([]int, 0)</span><br><span class=\"line\">\t\t\t\tfor i :&#x3D; 0; i &lt; len(v); i++ &#123;</span><br><span class=\"line\">\t\t\t\t\tneedshard &#x3D; append(needshard, v[i])</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\targs :&#x3D; PullArgs&#123;Shard: needshard, ClientId: int64(kv.gid), Seq: kv.myconfig[0].Num&#125;</span><br><span class=\"line\">\t\t\t\tgo func(mgid int, arg *PullArgs) &#123;</span><br><span class=\"line\">\t\t\t\t\tservers :&#x3D; kv.myconfig[0].Groups[mgid]</span><br><span class=\"line\">\t\t\t\t\tDPrintf(&quot;Migrate: group %d-%d get Gid %d Servers is %v&quot;,</span><br><span class=\"line\">\t\t\t\t\t\tkv.gid, kv.me, mgid, servers)</span><br><span class=\"line\">\t\t\t\t\tfor &#123;</span><br><span class=\"line\">\t\t\t\t\t\tfor _, si :&#x3D; range servers &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\treply :&#x3D; PullReply&#123;&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\tsrv :&#x3D; kv.make_end(si)</span><br><span class=\"line\">\t\t\t\t\t\t\tDPrintf(&quot;group %d-%d start call to gid %d&quot;, kv.gid, kv.me, mgid)</span><br><span class=\"line\">                            &#x2F;&#x2F; GroupA</span><br><span class=\"line\">\t\t\t\t\t\t\tok :&#x3D; srv.Call(&quot;ShardKV.Pull&quot;, arg, &amp;reply)</span><br><span class=\"line\">\t\t\t\t\t\t\t&#x2F;&#x2F;DPrintf(&quot;Migrate: group %d-%d  calling for server %v rpc pull, result is %t&quot;,</span><br><span class=\"line\">\t\t\t\t\t\t\t&#x2F;&#x2F;\t    kv.gid, kv.me, si, ok)</span><br><span class=\"line\">\t\t\t\t\t\t\tif !ok &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tDPrintf(&quot;Migrate Failed: group %d-%d  calling for server %v rpc pull, result is %t&quot;,</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.gid, kv.me, si, ok)</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\tif ok &amp;&amp; reply.WrongLeader &#x3D;&#x3D; false &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tif reply.Err &#x3D;&#x3D; ErrNeedWait &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tDPrintf(&quot;Migrate: waiting server %v to pull new config from SM&quot;, si)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\treturn</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tif _, isleader :&#x3D; kv.rf.GetState(); isleader &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tnewmapkv :&#x3D; make(map[string]string)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tfor k, v :&#x3D; range reply.MapKV &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tnewmapkv[k] &#x3D; v</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tvar newdup [shardmaster.NShards]map[int64]int</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tfor i :&#x3D; 0; i &lt; shardmaster.NShards; i++ &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tnewdup[i] &#x3D; make(map[int64]int)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tfor k, v :&#x3D; range reply.ShardDup[i] &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\tnewdup[i][k] &#x3D; v</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tmig :&#x3D; Migrate&#123;newmapkv, newdup, arg.Seq, mgid&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#x2F;&#x2F; this is how partition data can be repliacated</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.rf.Start(mig)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tDPrintf(&quot;Migrate: group %d-%d start migrate the data pulled from %d&quot;, kv.gid, kv.me, mgid)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\treturn</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tDPrintf(&quot;Migrate Failed: group %d-%d call %d-%v meet wrong leader&quot;,</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.gid, kv.me, mgid, si)</span><br><span class=\"line\">\t\t\t\t\t\t\t\tDPrintf(&quot;!!!server is %v&quot;, servers)</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\ttime.Sleep(20 * time.Millisecond)</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;(k, &amp;args)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\ttime.Sleep(100 * time.Millisecond)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>LeaderKV</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case Migrate:</span><br><span class=\"line\">    if kv.MigrateDupCheck(cmd.Gid, cmd.Num) &#123;</span><br><span class=\"line\">        &#x2F;&#x2F;DPrintf(&quot;group %d-%d apply the migrate data from %d and config num %d&quot;, kv.gid, kv.me, cmd.Gid, cmd.Num)</span><br><span class=\"line\">        &#x2F;&#x2F;DPrintf(&quot;group %d-%d database before migrate is %v&quot;, kv.gid, kv.me, kv.database)</span><br><span class=\"line\">        for k, v :&#x3D; range cmd.MapKV &#123;</span><br><span class=\"line\">            kv.database[k] &#x3D; v</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        &#x2F;&#x2F;DPrintf(&quot;group %d-%d database after migrate is %v&quot;, kv.gid, kv.me, kv.database)</span><br><span class=\"line\">        for i :&#x3D; 0; i &lt; shardmaster.NShards; i++ &#123;</span><br><span class=\"line\">            for k, v :&#x3D; range cmd.ShardDup[i] &#123;</span><br><span class=\"line\">                kv.dup[i][k] &#x3D; v</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        for i :&#x3D; 0; i &lt; len(kv.needrecv[cmd.Gid]); i++ &#123;</span><br><span class=\"line\">            kv.myshards[kv.needrecv[cmd.Gid][i]] &#x3D; 1</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        delete(kv.needrecv, cmd.Gid)</span><br><span class=\"line\">        if kv.CheckMigrateDone() &#123;</span><br><span class=\"line\">            kv.myconfig[0] &#x3D; kv.myconfig[1]</span><br><span class=\"line\">            DPrintf(&quot;Migrate: group %d-%d successful switch to config %d&quot;, kv.gid, kv.me, kv.myconfig[0].Num)</span><br><span class=\"line\">            &#x2F;&#x2F;DPrintf(&quot;group %d-%d is applied new config , shard is %v&quot;, kv.gid, kv.me, kv.myshards)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        kv.migratedup[cmd.Gid] &#x3D; cmd.Num</span><br><span class=\"line\">        if kv.maxraftstate !&#x3D; -1 &#123;</span><br><span class=\"line\">            kv.SaveSnapshot(index)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></div></figure>","site":{"data":{}},"excerpt":"","more":"<!-- ---\nlayout: post\ntitle: MIT6.824 Lab4 \nauthor: Ray Chan(ray1888)\ndate: '2019-08-20 12:05:38 +0800'\ncategory: distributed-system\nsummary: MIT6.824 Lab4 Implemantation and detail explains\nthumbnail: distributed-db.jpg\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#Purpose\"></a>  </li>\n<li><a href=\"#Implementation\"></a><br>2.1 <a href=\"#2.1\">lab4-1</a><br>2.2 <a href=\"#2.2\">lab4-2</a>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>lab4:</p>\n<ol>\n<li>lab4-1 KvRaftShardMasterK-vLab3</li>\n<li>lab4-2 ShardingkvRaftMulti-raft)</li>\n</ol>\n<p></p>\n<!-- ![lab4](/assets/img/posts/lab4.png) -->\n<img src=\"/2019/08/29/raft-lab-4/lab4.png\" class=\"\" title=\"lab4\">\n\n<p><br>KVRaft<br>ClientLeader<br>PS: KvDatabase RaftKVServer    </p>\n<p>:</p>\n<ol>\n<li>ClientShardMasterKey</li>\n<li>ShardMasterKey</li>\n<li>ClientRaft Leader</li>\n<li>RaftApplyChKvDatabase</li>\n<li>KvDatabaseClient</li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>Multi-Raft</p>\n<p> KeyModKeyMod<br> 0&gt;=2  </p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"lab4-1\"   >\n          <a href=\"#lab4-1\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>lab4-1</h2>\n      <p>Lab3 Leave(), Move(), Join() Query()<br>Lab3  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type ShardMaster struct &#123;</span><br><span class=\"line\">\tmu      sync.Mutex</span><br><span class=\"line\">\tme      int</span><br><span class=\"line\">\trf      *raft.Raft</span><br><span class=\"line\">\tapplyCh chan raft.ApplyMsg</span><br><span class=\"line\">\t&#x2F;&#x2F; Your data here.</span><br><span class=\"line\">    &#x2F;&#x2F; Lab3 database map[string]string </span><br><span class=\"line\">\tconfigs    []Config &#x2F;&#x2F; indexed by config num</span><br><span class=\"line\">\tdup        map[int64]Result</span><br><span class=\"line\">\tchanResult map[int]chan Result</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>shard  Group<br>GetLab3KvConfig  </p>\n\n        <h2 id=\"lab4-2\"   >\n          <a href=\"#lab4-2\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>lab4-2</h2>\n      <p>KvKv</p>\n<p><br>KV3</p>\n<ol>\n<li>ShardMaster</li>\n<li></li>\n<li></li>\n</ol>\n<p></p>\n<ol>\n<li>Lab3OPGetPullPutAppend</li>\n<li>Lab4-1Config</li>\n<li>RaftGroupLeaderKV</li>\n</ol>\n<p>ShardMaster</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (kv *ShardKV) ConfigUpdateRoutine() &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tcurConfigNum :&#x3D; kv.myconfig[0].Num</span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">        &#x2F;&#x2F; Query1</span><br><span class=\"line\">\t\tconfig :&#x3D; kv.mck.Query(curConfigNum + 1)</span><br><span class=\"line\">\t\t&#x2F;&#x2F;DPrintf(&quot;get newConfig from SM group is %v, shard is %v&quot;, config.Groups, config.Shards)</span><br><span class=\"line\">\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\tif config.Num &#x3D;&#x3D; kv.myconfig[0].Num+1 &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F; update with static NewConfig</span><br><span class=\"line\">\t\t\tnewConfig :&#x3D; kv.makeEmptyConfig()</span><br><span class=\"line\">\t\t\tkv.CopyConfig(&amp;config, &amp;newConfig)</span><br><span class=\"line\">\t\t\tif _, isLeader :&#x3D; kv.rf.GetState(); isLeader &#123;</span><br><span class=\"line\">\t\t\t\tcfg :&#x3D; Cfg&#123;newConfig, int64(kv.gid), kv.myconfig[0].Num&#125;</span><br><span class=\"line\">\t\t\t\tkv.rf.Start(cfg)</span><br><span class=\"line\">\t\t\t\tDPrintf(&quot;Config: group %d-%d is start config %d into consueum&quot;,</span><br><span class=\"line\">\t\t\t\t\tkv.gid, kv.me, cfg.NewConfig.Num)</span><br><span class=\"line\">\t\t\t\t&#x2F;&#x2F;index, _, isleader :&#x3D; kv.rf.Start(cfg)</span><br><span class=\"line\">\t\t\t\t&#x2F;&#x2F;DPrintf(&quot;))))) server %d gid %d Start cfg index is %d, isleader is %t, kv is %v&quot;,</span><br><span class=\"line\">\t\t\t\t&#x2F;&#x2F;\tkv.me, kv.gid, index, isleader, kv.database)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125; </span><br><span class=\"line\">\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\ttime.Sleep(100 * time.Millisecond)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>Shard</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case Cfg:</span><br><span class=\"line\">    if kv.CfgDupCheck(cmd.ClientId, cmd.Seq) &#123;</span><br><span class=\"line\">        kv.SwitchConfig(cmd)</span><br><span class=\"line\">        if kv.CheckMigrateDone() &#123;</span><br><span class=\"line\">            &#x2F;&#x2F; if migrate done, use new config, if not, do nothing to avoid replying the old group replied</span><br><span class=\"line\">            kv.myconfig[0] &#x3D; kv.myconfig[1]</span><br><span class=\"line\">            &#x2F;&#x2F;DPrintf(&quot;group %d-%d is applied new config , shard is %v, kv is %v&quot;, kv.gid, kv.me, kv.myshards, kv.database)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        kv.cfgdup[cmd.ClientId] &#x3D; cmd.Seq</span><br><span class=\"line\">        if kv.maxraftstate !&#x3D; -1 &#123;</span><br><span class=\"line\">            kv.SaveSnapshot(index)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (kv *ShardKV) SwitchConfig(newcfg Cfg) &#123;</span><br><span class=\"line\">\tif newcfg.NewConfig.Num &#x3D;&#x3D; kv.myconfig[0].Num+1 &#123;</span><br><span class=\"line\">\t\tif kv.myconfig[0].Num !&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\tkv.GenShardChangeList(newcfg)</span><br><span class=\"line\">\t\t&#125; else if kv.myconfig[0].Num &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">\t\t\tfor i :&#x3D; 0; i &lt; shardmaster.NShards; i++ &#123;</span><br><span class=\"line\">\t\t\t\tif newcfg.NewConfig.Shards[i] &#x3D;&#x3D; kv.gid &#123;</span><br><span class=\"line\">\t\t\t\t\tkv.myshards[i] &#x3D; 1</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tnewc :&#x3D; kv.makeEmptyConfig()</span><br><span class=\"line\">\t\tkv.CopyConfig(&amp;newcfg.NewConfig, &amp;newc)</span><br><span class=\"line\">\t\tkv.myconfig[1] &#x3D; newc</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">func (kv *ShardKV) GenShardChangeList(newcfg Cfg) &#123;</span><br><span class=\"line\">\tfor i :&#x3D; 0; i &lt; shardmaster.NShards; i++ &#123;</span><br><span class=\"line\">\t\tif kv.myconfig[0].Shards[i] &#x3D;&#x3D; kv.gid &amp;&amp; newcfg.NewConfig.Shards[i] !&#x3D; kv.gid &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F;need to send</span><br><span class=\"line\">\t\t\tkv.needsend[i] &#x3D; newcfg.NewConfig.Shards[i]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tif kv.myconfig[0].Shards[i] !&#x3D; kv.gid &amp;&amp; newcfg.NewConfig.Shards[i] &#x3D;&#x3D; kv.gid &#123;</span><br><span class=\"line\">\t\t\t&#x2F;&#x2F;need to recv</span><br><span class=\"line\">\t\t\t_, ok :&#x3D; kv.needrecv[kv.myconfig[0].Shards[i]]</span><br><span class=\"line\">\t\t\tif !ok &#123;</span><br><span class=\"line\">\t\t\t\tkv.needrecv[kv.myconfig[0].Shards[i]] &#x3D; make([]int, 0)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tkv.needrecv[kv.myconfig[0].Shards[i]] &#x3D; append(kv.needrecv[kv.myconfig[0].Shards[i]], i)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDPrintf(&quot;!!! group %d-%d, new config need to send is %v, need to receive is %v&quot;, kv.gid, kv.me, kv.needsend, kv.needrecv)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p><br>LeaderLeaderRPCPull DatabaseDUP<br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (kv *ShardKV) MigrationRoutine() &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tif _, isLeader :&#x3D; kv.rf.GetState(); isLeader &#123;</span><br><span class=\"line\">\t\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\t\tfor k, v :&#x3D; range kv.needrecv &#123;</span><br><span class=\"line\">\t\t\t\t&#x2F;&#x2F;DPrintf(&quot;group %d-%d needrecv &quot;)</span><br><span class=\"line\">\t\t\t\tneedshard :&#x3D; make([]int, 0)</span><br><span class=\"line\">\t\t\t\tfor i :&#x3D; 0; i &lt; len(v); i++ &#123;</span><br><span class=\"line\">\t\t\t\t\tneedshard &#x3D; append(needshard, v[i])</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\targs :&#x3D; PullArgs&#123;Shard: needshard, ClientId: int64(kv.gid), Seq: kv.myconfig[0].Num&#125;</span><br><span class=\"line\">\t\t\t\tgo func(mgid int, arg *PullArgs) &#123;</span><br><span class=\"line\">\t\t\t\t\tservers :&#x3D; kv.myconfig[0].Groups[mgid]</span><br><span class=\"line\">\t\t\t\t\tDPrintf(&quot;Migrate: group %d-%d get Gid %d Servers is %v&quot;,</span><br><span class=\"line\">\t\t\t\t\t\tkv.gid, kv.me, mgid, servers)</span><br><span class=\"line\">\t\t\t\t\tfor &#123;</span><br><span class=\"line\">\t\t\t\t\t\tfor _, si :&#x3D; range servers &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\treply :&#x3D; PullReply&#123;&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\tsrv :&#x3D; kv.make_end(si)</span><br><span class=\"line\">\t\t\t\t\t\t\tDPrintf(&quot;group %d-%d start call to gid %d&quot;, kv.gid, kv.me, mgid)</span><br><span class=\"line\">                            &#x2F;&#x2F; GroupA</span><br><span class=\"line\">\t\t\t\t\t\t\tok :&#x3D; srv.Call(&quot;ShardKV.Pull&quot;, arg, &amp;reply)</span><br><span class=\"line\">\t\t\t\t\t\t\t&#x2F;&#x2F;DPrintf(&quot;Migrate: group %d-%d  calling for server %v rpc pull, result is %t&quot;,</span><br><span class=\"line\">\t\t\t\t\t\t\t&#x2F;&#x2F;\t    kv.gid, kv.me, si, ok)</span><br><span class=\"line\">\t\t\t\t\t\t\tif !ok &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tDPrintf(&quot;Migrate Failed: group %d-%d  calling for server %v rpc pull, result is %t&quot;,</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.gid, kv.me, si, ok)</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\tif ok &amp;&amp; reply.WrongLeader &#x3D;&#x3D; false &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tif reply.Err &#x3D;&#x3D; ErrNeedWait &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tDPrintf(&quot;Migrate: waiting server %v to pull new config from SM&quot;, si)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\treturn</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tif _, isleader :&#x3D; kv.rf.GetState(); isleader &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tnewmapkv :&#x3D; make(map[string]string)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tfor k, v :&#x3D; range reply.MapKV &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tnewmapkv[k] &#x3D; v</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tvar newdup [shardmaster.NShards]map[int64]int</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tfor i :&#x3D; 0; i &lt; shardmaster.NShards; i++ &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tnewdup[i] &#x3D; make(map[int64]int)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\tfor k, v :&#x3D; range reply.ShardDup[i] &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\tnewdup[i][k] &#x3D; v</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tmig :&#x3D; Migrate&#123;newmapkv, newdup, arg.Seq, mgid&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.mu.Lock()</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t&#x2F;&#x2F; this is how partition data can be repliacated</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.rf.Start(mig)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tDPrintf(&quot;Migrate: group %d-%d start migrate the data pulled from %d&quot;, kv.gid, kv.me, mgid)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\treturn</span><br><span class=\"line\">\t\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t\tDPrintf(&quot;Migrate Failed: group %d-%d call %d-%v meet wrong leader&quot;,</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\tkv.gid, kv.me, mgid, si)</span><br><span class=\"line\">\t\t\t\t\t\t\t\tDPrintf(&quot;!!!server is %v&quot;, servers)</span><br><span class=\"line\">\t\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t\ttime.Sleep(20 * time.Millisecond)</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;(k, &amp;args)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tkv.mu.Unlock()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\ttime.Sleep(100 * time.Millisecond)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>LeaderKV</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case Migrate:</span><br><span class=\"line\">    if kv.MigrateDupCheck(cmd.Gid, cmd.Num) &#123;</span><br><span class=\"line\">        &#x2F;&#x2F;DPrintf(&quot;group %d-%d apply the migrate data from %d and config num %d&quot;, kv.gid, kv.me, cmd.Gid, cmd.Num)</span><br><span class=\"line\">        &#x2F;&#x2F;DPrintf(&quot;group %d-%d database before migrate is %v&quot;, kv.gid, kv.me, kv.database)</span><br><span class=\"line\">        for k, v :&#x3D; range cmd.MapKV &#123;</span><br><span class=\"line\">            kv.database[k] &#x3D; v</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        &#x2F;&#x2F;DPrintf(&quot;group %d-%d database after migrate is %v&quot;, kv.gid, kv.me, kv.database)</span><br><span class=\"line\">        for i :&#x3D; 0; i &lt; shardmaster.NShards; i++ &#123;</span><br><span class=\"line\">            for k, v :&#x3D; range cmd.ShardDup[i] &#123;</span><br><span class=\"line\">                kv.dup[i][k] &#x3D; v</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        for i :&#x3D; 0; i &lt; len(kv.needrecv[cmd.Gid]); i++ &#123;</span><br><span class=\"line\">            kv.myshards[kv.needrecv[cmd.Gid][i]] &#x3D; 1</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        delete(kv.needrecv, cmd.Gid)</span><br><span class=\"line\">        if kv.CheckMigrateDone() &#123;</span><br><span class=\"line\">            kv.myconfig[0] &#x3D; kv.myconfig[1]</span><br><span class=\"line\">            DPrintf(&quot;Migrate: group %d-%d successful switch to config %d&quot;, kv.gid, kv.me, kv.myconfig[0].Num)</span><br><span class=\"line\">            &#x2F;&#x2F;DPrintf(&quot;group %d-%d is applied new config , shard is %v&quot;, kv.gid, kv.me, kv.myshards)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        kv.migratedup[cmd.Gid] &#x3D; cmd.Num</span><br><span class=\"line\">        if kv.maxraftstate !&#x3D; -1 &#123;</span><br><span class=\"line\">            kv.SaveSnapshot(index)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></div></figure>"},{"title":"Effective Go Reading","date":"2019-09-16T03:07:38.000Z","_content":"\n\n<!-- --- -->\n<!-- layout: post\ntitle: Effective Go Reading\nauthor: Ray Chan(ray1888)\ndate: '2019-09-16 11:07:38 +0800'\ncategory: go\nsummary: Effective Go \nthumbnail: go.png\n--- -->\n\nEffective GO\n\n# \n1. [Method](#Method)  \n   1.1 [Pointers vs Values](#PvV)  \n2. [Data](#Data)\n   2.1 [New vs Make](#NewMake)  \n   2.2 [Array](#Array)  \n   2.3 [Slice](#Slice)  \n   2.4 [Map](#Map)  \n   2.5 [Append](#Append)  \n3. [Interface](#InterFace)\n4. [Error](#Error)\n5. [PackageInit](#Init)  \n6. [Defer](#Defer)\n7. [ShareNote](#ShareNote)\n\n# <a id=\"Method\"><span class=\"toptitle\">Method</span></a>\n\n## <a id=\"PvV\"><span class=\"secondtitle\">Pointers vs Values</span></a>\n\n\n\n```\npackage main\n\nimport \"fmt\"\n\ntype ByteSlice []byte\n\nfunc (slice ByteSlice) Append(data []byte) []byte {\n\t// Body exactly the same as the Append function defined above.\n\tl := len(slice)\n\tif l+len(data) > cap(slice) { // reallocate\n\t\t// Allocate double what's needed, for future growth.\n\t\tnewSlice := make([]byte, (l+len(data))*2)\n\t\t// The copy function is predeclared and works for any slice type.\n\t\tcopy(newSlice, slice)\n\t\tslice = newSlice\n\t}\n\tslice = slice[0 : l+len(data)]\n\tcopy(slice[l:], data)\n\treturn slice\n}\n\nfunc (p *ByteSlice) Append2(data []byte) {\n\tslice := *p\n\t// Body as above, without the return.\n\tl := len(slice)\n\tif l+len(data) > cap(slice) { // reallocate\n\t\t// Allocate double what's needed, for future growth.\n\t\tnewSlice := make([]byte, (l+len(data))*2)\n\t\t// The copy function is predeclared and works for any slice type.\n\t\tcopy(newSlice, slice)\n\t\tslice = newSlice\n\t}\n\tslice = slice[0 : l+len(data)]\n\tcopy(slice[l:], data)\n\t*p = slice\n}\n\nfunc (p *ByteSlice) Write(data []byte) (n int, err error) {\n\tslice := *p\n\t// Body as above, without the return.\n\tl := len(slice)\n\tif l+len(data) > cap(slice) { // reallocate\n\t\t// Allocate double what's needed, for future growth.\n\t\tnewSlice := make([]byte, (l+len(data))*2)\n\t\t// The copy function is predeclared and works for any slice type.\n\t\tcopy(newSlice, slice)\n\t\tslice = newSlice\n\t}\n\tslice = slice[0 : l+len(data)]\n\tcopy(slice[l:], data)\n\t*p = slice\n\t*p = slice\n\treturn len(data), nil\n}\n\nfunc main() {\n\tvar b ByteSlice\n\tb = b.Append([]byte{1, 2, 3})\n\tfmt.Printf(\"byteSlice 1 is %v\", b)\n\tb.Write([]byte{7, 8, 9})\n\tfmt.Printf(\"byteSlice 2 is %v\", b)\n    /*\n    func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error)\n    */\n\tfmt.Fprintf(&b, \"This hour has %d days\\n\", 7)\n    /*\n    if use below code , will throw error \n    fmt.Fprintf(b, \"This hour has %d days\\n\", 7)\n    */\n\tb.Append2([]byte{4, 5, 6})\n\tfmt.Printf(\"byteSlice 3 is %v\", b)\n}\n```\n\nBio.WriterWriteWrite\n```\nas type io.Writer in argument to fmt.Fprintf:\n\tByteSlice does not implement io.Writer (Write method has pointer receiver)\n```\n\n\n```\nThe rule about pointers vs. values for receivers is that value methods can be invoked on pointers and values, but pointer methods can only be invoked on pointers.\n\nThis rule arises because pointer methods can modify the receiver; invoking them on a value would cause the method to receive a copy of the value, so any modifications would be discarded. The language therefore disallows this mistake. There is a handy exception, though. When the value is addressable, the language takes care of the common case of invoking a pointer method on a value by inserting the address operator automatically. In our example, the variable b is addressable, so we can call its Write method with just b.Write. The compiler will rewrite that to (&b).Write for us.\n```\n\n\n \n\n goReturn +  \n\n\n# <a id=\"Data\"><span class=\"toptitle\">Data</span></a>\n\n## <a id=\"NewMake\"><span class=\"secondtitle\">New vs Make</span></a>\n\n### <a id=\"New\"><span class=\"thirdtitle\">New</span></a>\nNew  GoZero0\n\nnew00\n\n\n```\nFor example, the documentation for bytes.Buffer states that \"the zero value for Buffer is an empty buffer ready to use.\" Similarly, sync.Mutex does not have an explicit constructor or Init method. Instead, the zero value for a sync.Mutex is defined to be an unlocked mutex.\n\nThe zero-value-is-useful property works transitively. Consider this type declaration.\n\ntype SyncedBuffer struct {\n    lock    sync.Mutex\n    buffer  bytes.Buffer\n}\n\n```\n\n0\n```\nfunc NewFile(fd int, name string) *File {\n    if fd < 0 {\n        return nil\n    }\n    f := new(File)\n    f.fd = fd\n    f.name = name\n    f.dirinfo = nil\n    f.nepipe = 0\n    return f\n}\n```\n\n\n```\nfunc NewFile(fd int, name string) *File {\n    if fd < 0 {\n        return nil\n    }\n    f := File{fd, name, nil, 0}\n    return &f\n}\n```\n\n  \n```\nf := File{fd, name, nil, 0}\n    return &f\n=== \n\nreturn &File{fd, name, nil, 0}\n```\n\n with the field labels being indices or map keys as appropriate\n\n\n\n\n### <a id=\"Make\"><span class=\"thirdtitle\">Make</span></a>\n\nMake nil  \n\nchannel  \n\n```\nmake([]int,10,100)  // 100100\n```\n\nmake\n```\nFor slices, maps, and channels, make initializes the internal data structure and prepares the value for use.\n```\n\n\n\n\n### <a id=\"MakediffNew\"><span class=\"thirdtitle\">Diff</span></a>\nMakeNewchannel  \nnewnilmakenil  \n\n```\npackage main\n\nimport \"fmt\"\n\nfunc main(){\n\t // allocates slice structure; *p == nil; rarely useful\n\tvar p *[]int = new([]int)     \n\t// the slice v now refers to a new array of 100 ints \n\tvar v []int = make([]int, 5) \n\tfmt.Printf(\"p values is %v%v\\n\", p, *p==nil)\n\tfmt.Printf(\"v values is %v, %v\\n\", v, v==nil)\n\t\n}\n\n------------------\np values is &[]true\nv values is [0 0 0 0 0], false\n\n```\n\n## <a id=\"Array\"><span class=\"secondtitle\">Array</span></a>\n\nGo\n1. \n2. [10]int[20]int\n3. Array\n\n  \nGoSlice  \n\n## <a id=\"Slice\"><span class=\"secondtitle\">Slice</span></a>\n\nGo Slice  \n\n### \n\n  \n```\ntype Transform [3][3]float64  // A 3x3 array, really an array of arrays.\ntype LinesOfText [][]byte     // A slice of byte slices.\n\ntext := LinesOfText{\n\t[]byte(\"Now is the time\"),\n\t[]byte(\"for all good gophers\"),\n\t[]byte(\"to bring some fun to the party.\"),\n}\n```\n\nMake  \n\n size(Allocate)\n```\n// First Method\npicture := make([][]uint8, YSize)\nfor i:= range picture{\n    picture[i] = make([]uint8, XSize)\n}\n\n// Second Method \npicture := make([][]uint8, YSize)\npixels := make([]uint8, XSize * YSize)\n\nfor i := range picture{\n    picture[i], pixels = pixels[:XSize], pixels[XSize:]\n}\n\n```\n\n## <a id=\"Map\"><span class=\"secondtitle\">Map</span></a>\nKeyMap\n```\nvar tz map[string]int\nvar ds string = \"abc\"\nif val, ok := tz[ds]; ok{\n    return val\n}\n```\n\nKeyMap\n```\nvar tz map[string]int\nvar ds string = \"abc\"\n_, exist := tz[ds]\nif !exist {\n    return \"is not exist\"\n}\n```\n\n,delete\n```\nvar tz map[string]int\nvar ds string = \"abc\"\n// delete(map, key)\ndelete(tz, ds)\n```\n\n## <a id=\"Append\"><span class=\"secondtitle\">Append</span></a>\n\nAppend \n```\nfunc append(slice []T, elements ...T) []T\n\n// use case \nx := []int{1,2,3}\nx = append(x, 4, 5, 6)\nfmt.Println(x)\n```\n\n\n```\nx := []int{1,2,3}\ny := []int{4,5,6}\nx = append(x, y...)\nfmt.Println(x)\n```\n\n# <a id=\"InterFace\"><span class=\"toptitle\">InterFace</span></a>\n\n## Interface\n\n\n```\ntype Sequence []int\n\n// Methods required by sort.Interface.\nfunc (s Sequence) Len() int {\n    return len(s)\n}\nfunc (s Sequence) Less(i, j int) bool {\n    return s[i] < s[j]\n}\nfunc (s Sequence) Swap(i, j int) {\n    s[i], s[j] = s[j], s[i]\n}\n\n// Copy returns a copy of the Sequence.\nfunc (s Sequence) Copy() Sequence {\n    copy := make(Sequence, 0, len(s))\n    return append(copy, s...)\n}\n\n// Method for printing - sorts the elements before printing.\nfunc (s Sequence) String() string {\n    s = s.Copy() // Make a copy; don't overwrite argument.\n    sort.Sort(s)\n    str := \"[\"\n    for i, elem := range s { // Loop is O(N); will fix that in next example.\n        if i > 0 {\n            str += \" \"\n        }\n        str += fmt.Sprint(elem)\n    }\n    return str + \"]\"\n}\n```\n\n## Coversions\n\nfmtSprintSprint[]intSequence\n[]int  \n\n```\n// \nfunc (s Sequence) String() string {\n    s = s.Copy()\n    sort.Sort(s)\n    return fmt.Sprint([]int(s))\n}\n\n// \ntype Sequence []int\n\n// Method for printing - sorts the elements before printing\nfunc (s Sequence) String() string {\n    s = s.Copy()\n    sort.IntSlice(s).Sort()\n    return fmt.Sprint([]int(s))\n}\n```\n\n## type assertions\n\nType switch   \nstring, String()\n```\ntype Stringer interface {\n    String() string\n}\n\nvar value interface{} // Value provided by caller.\nswitch str := value.(type) {\ncase string:\n    return str\ncase Stringer:\n    return str.String()\n}\n```\n\n\n```\n// \nstr, ok := value.(string)\n```\n\nInterface\n\n##  Generality\n\n\nHashcrc32.NewIEEE  adler32.New Hash.Hash32\n\n## interface & method\n\n.\n\n\n# <a id=\"Error\"><span class=\"toptitle\">Error</span></a>\n\n## <a id=\"Defination\"><span class=\"secondtitle\">Defination</span></a>\nError \n```\ntype error interface {\n    Error() string\n}\n```\n\nError\n```\n// PathError records an error and the operation and\n// file path that caused it.\ntype PathError struct {\n    Op string    // \"open\", \"unlink\", etc.\n    Path string  // The associated file.\n    Err error    // Returned by the system call.\n}\n\nfunc (e *PathError) Error() string {\n    return e.Op + \" \" + e.Path + \": \" + e.Err.Error()\n}\n```\n\n  \nswitch\n```\nfor try := 0; try < 2; try++ {\n    file, err = os.Create(filename)\n    if err == nil {\n        return\n    }\n    if e, ok := err.(*os.PathError); ok && e.Err == syscall.ENOSPC {\n        deleteTempFiles()  // Recover some space.\n        continue\n    }\n    return\n}\n```\n\n## <a id=\"Panic\"><span class=\"secondtitle\">Panic</span></a>\n.\n```\n\nfunc Get() (string, Error){\n    return \"\", nil\n}\n\nk, err := Get()\n```\n  \nPanic()Runtime Error  \nPanic\n```\nfunc CubeRoot(x float64) float64 {\n    z := x/3   // Arbitrary initial value\n    for i := 0; i < 1e6; i++ {\n        prevz := z\n        z -= (z*z*z-x) / (3*z*z)\n        if veryClose(z, prevz) {\n            return z\n        }\n    }\n    // A million iterations has not converged; something is wrong.\n    panic(fmt.Sprintf(\"CubeRoot(%g) did not converge\", x))\n}\n```\n\nPanic\n\n\n## <a id=\"Recover\"><span class=\"secondtitle\">Recover</span></a>\n\nPanicGoroutinepanicdefer Recover\n```\nfunc server(workChan <-chan *Work) {\n    for work := range workChan {\n        go safelyDo(work)\n    }\n}\n\nfunc safelyDo(work *Work) {\n    defer func() {\n        if err := recover(); err != nil {\n            log.Println(\"work failed:\", err)\n        }\n    }()\n    do(work)\n}\n```\n\nRegexp\n```\n// Error is the type of a parse error; it satisfies the error interface.\ntype Error string\nfunc (e Error) Error() string {\n    return string(e)\n}\n\n// error is a method of *Regexp that reports parsing errors by\n// panicking with an Error.\nfunc (regexp *Regexp) error(err string) {\n    panic(Error(err))\n}\n\n// Compile returns a parsed representation of the regular expression.\nfunc Compile(str string) (regexp *Regexp, err error) {\n    regexp = new(Regexp)\n    // doParse will panic if there is a parse error.\n    defer func() {\n        if e := recover(); e != nil {\n            regexp = nil    // Clear return value.\n            err = e.(Error) // Will re-panic if not a parse error.\n        }\n    }()\n    return regexp.doParse(str), nil\n}\n```\n\nregexp nileError\n```\nif pos == 0 {\n    re.error(\"'*' illegal at start of expression\")\n}\n```\nre-panicClient  \nre-panic\n\n# <a id=\"Init\"><span class=\"toptitle\">PackageInit</span></a>\n\n[](https://zhuanlan.zhihu.com/p/34211611)\n\n[](https://medium.com/golangspec/init-functions-in-go-eac191b3860a)\n\n# <a id=\"Defer\"><span class=\"toptitle\">Defer</span></a>\n\nDeferPythonWith\n\n```\nfunc Contents(filename string) (string, error) {\n    f, err := os.Open(filename)\n    if err != nil {\n        return \"\", err\n    }\n    defer f.Close()  // f.Close will run when we're finished.\n\n    var result []byte\n    buf := make([]byte, 100)\n    for {\n        n, err := f.Read(buf[0:])\n        result = append(result, buf[0:n]...) // append is discussed later.\n        if err != nil {\n            if err == io.EOF {\n                break\n            }\n            return \"\", err  // f will be closed if we return here.\n        }\n    }\n    return string(result), nil // f will be closed if we return here.\n}\n```\n\n```\nDefer\n1. \n2. \n```\n\n\n```\npackage main\n\nimport (\n\t\"fmt\"\n)\n\nfunc main() {\n\tfor i := 0; i < 5; i++ {\n    \t\tdefer fmt.Printf(\"%d \", i)\n\t}\n}\n\n-------\noutput:\n4 3 2 1 0 \n```\nDeferLIFOLastInFirstOut)\n\n\n\n```\npackage main\n\nimport \"fmt\"\n\nfunc trace(s string) string {\n    fmt.Println(\"entering:\", s)\n    return s\n}\n\nfunc un(s string) {\n    fmt.Println(\"leaving:\", s)\n}\n\nfunc a() {\n    defer un(trace(\"a\"))\n    fmt.Println(\"in a\")\n}\n\nfunc b() {\n    defer un(trace(\"b\"))\n    fmt.Println(\"in b\")\n    a()\n}\n\nfunc main() {\n    b()\n}\n-------------------\noutput\nentering: b\nin b\nentering: a\nin a\nleaving: a\nleaving: b\n```\n\ndefer defer un(trace()), trace()un()defer\n\n[](https://mp.weixin.qq.com/s/_wZQID0VatIlAiH6-x3U6A)\n\n# <a id=\"ShareNote\"><span class=\"toptitle\">ShareNote</span></a>\n1. [EffectiveGo](https://golang.org/doc/effective_go.html)\n2. [GoInitFunc](https://medium.com/golangspec/init-functions-in-go-eac191b3860a)\n3. [GoInitFunc](https://zhuanlan.zhihu.com/p/34211611)","source":"_posts/effective-go.md","raw":"---\ntitle: Effective Go Reading\ndate: 2019-09-16 11:07:38\ntags: Go\n---\n\n\n<!-- --- -->\n<!-- layout: post\ntitle: Effective Go Reading\nauthor: Ray Chan(ray1888)\ndate: '2019-09-16 11:07:38 +0800'\ncategory: go\nsummary: Effective Go \nthumbnail: go.png\n--- -->\n\nEffective GO\n\n# \n1. [Method](#Method)  \n   1.1 [Pointers vs Values](#PvV)  \n2. [Data](#Data)\n   2.1 [New vs Make](#NewMake)  \n   2.2 [Array](#Array)  \n   2.3 [Slice](#Slice)  \n   2.4 [Map](#Map)  \n   2.5 [Append](#Append)  \n3. [Interface](#InterFace)\n4. [Error](#Error)\n5. [PackageInit](#Init)  \n6. [Defer](#Defer)\n7. [ShareNote](#ShareNote)\n\n# <a id=\"Method\"><span class=\"toptitle\">Method</span></a>\n\n## <a id=\"PvV\"><span class=\"secondtitle\">Pointers vs Values</span></a>\n\n\n\n```\npackage main\n\nimport \"fmt\"\n\ntype ByteSlice []byte\n\nfunc (slice ByteSlice) Append(data []byte) []byte {\n\t// Body exactly the same as the Append function defined above.\n\tl := len(slice)\n\tif l+len(data) > cap(slice) { // reallocate\n\t\t// Allocate double what's needed, for future growth.\n\t\tnewSlice := make([]byte, (l+len(data))*2)\n\t\t// The copy function is predeclared and works for any slice type.\n\t\tcopy(newSlice, slice)\n\t\tslice = newSlice\n\t}\n\tslice = slice[0 : l+len(data)]\n\tcopy(slice[l:], data)\n\treturn slice\n}\n\nfunc (p *ByteSlice) Append2(data []byte) {\n\tslice := *p\n\t// Body as above, without the return.\n\tl := len(slice)\n\tif l+len(data) > cap(slice) { // reallocate\n\t\t// Allocate double what's needed, for future growth.\n\t\tnewSlice := make([]byte, (l+len(data))*2)\n\t\t// The copy function is predeclared and works for any slice type.\n\t\tcopy(newSlice, slice)\n\t\tslice = newSlice\n\t}\n\tslice = slice[0 : l+len(data)]\n\tcopy(slice[l:], data)\n\t*p = slice\n}\n\nfunc (p *ByteSlice) Write(data []byte) (n int, err error) {\n\tslice := *p\n\t// Body as above, without the return.\n\tl := len(slice)\n\tif l+len(data) > cap(slice) { // reallocate\n\t\t// Allocate double what's needed, for future growth.\n\t\tnewSlice := make([]byte, (l+len(data))*2)\n\t\t// The copy function is predeclared and works for any slice type.\n\t\tcopy(newSlice, slice)\n\t\tslice = newSlice\n\t}\n\tslice = slice[0 : l+len(data)]\n\tcopy(slice[l:], data)\n\t*p = slice\n\t*p = slice\n\treturn len(data), nil\n}\n\nfunc main() {\n\tvar b ByteSlice\n\tb = b.Append([]byte{1, 2, 3})\n\tfmt.Printf(\"byteSlice 1 is %v\", b)\n\tb.Write([]byte{7, 8, 9})\n\tfmt.Printf(\"byteSlice 2 is %v\", b)\n    /*\n    func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error)\n    */\n\tfmt.Fprintf(&b, \"This hour has %d days\\n\", 7)\n    /*\n    if use below code , will throw error \n    fmt.Fprintf(b, \"This hour has %d days\\n\", 7)\n    */\n\tb.Append2([]byte{4, 5, 6})\n\tfmt.Printf(\"byteSlice 3 is %v\", b)\n}\n```\n\nBio.WriterWriteWrite\n```\nas type io.Writer in argument to fmt.Fprintf:\n\tByteSlice does not implement io.Writer (Write method has pointer receiver)\n```\n\n\n```\nThe rule about pointers vs. values for receivers is that value methods can be invoked on pointers and values, but pointer methods can only be invoked on pointers.\n\nThis rule arises because pointer methods can modify the receiver; invoking them on a value would cause the method to receive a copy of the value, so any modifications would be discarded. The language therefore disallows this mistake. There is a handy exception, though. When the value is addressable, the language takes care of the common case of invoking a pointer method on a value by inserting the address operator automatically. In our example, the variable b is addressable, so we can call its Write method with just b.Write. The compiler will rewrite that to (&b).Write for us.\n```\n\n\n \n\n goReturn +  \n\n\n# <a id=\"Data\"><span class=\"toptitle\">Data</span></a>\n\n## <a id=\"NewMake\"><span class=\"secondtitle\">New vs Make</span></a>\n\n### <a id=\"New\"><span class=\"thirdtitle\">New</span></a>\nNew  GoZero0\n\nnew00\n\n\n```\nFor example, the documentation for bytes.Buffer states that \"the zero value for Buffer is an empty buffer ready to use.\" Similarly, sync.Mutex does not have an explicit constructor or Init method. Instead, the zero value for a sync.Mutex is defined to be an unlocked mutex.\n\nThe zero-value-is-useful property works transitively. Consider this type declaration.\n\ntype SyncedBuffer struct {\n    lock    sync.Mutex\n    buffer  bytes.Buffer\n}\n\n```\n\n0\n```\nfunc NewFile(fd int, name string) *File {\n    if fd < 0 {\n        return nil\n    }\n    f := new(File)\n    f.fd = fd\n    f.name = name\n    f.dirinfo = nil\n    f.nepipe = 0\n    return f\n}\n```\n\n\n```\nfunc NewFile(fd int, name string) *File {\n    if fd < 0 {\n        return nil\n    }\n    f := File{fd, name, nil, 0}\n    return &f\n}\n```\n\n  \n```\nf := File{fd, name, nil, 0}\n    return &f\n=== \n\nreturn &File{fd, name, nil, 0}\n```\n\n with the field labels being indices or map keys as appropriate\n\n\n\n\n### <a id=\"Make\"><span class=\"thirdtitle\">Make</span></a>\n\nMake nil  \n\nchannel  \n\n```\nmake([]int,10,100)  // 100100\n```\n\nmake\n```\nFor slices, maps, and channels, make initializes the internal data structure and prepares the value for use.\n```\n\n\n\n\n### <a id=\"MakediffNew\"><span class=\"thirdtitle\">Diff</span></a>\nMakeNewchannel  \nnewnilmakenil  \n\n```\npackage main\n\nimport \"fmt\"\n\nfunc main(){\n\t // allocates slice structure; *p == nil; rarely useful\n\tvar p *[]int = new([]int)     \n\t// the slice v now refers to a new array of 100 ints \n\tvar v []int = make([]int, 5) \n\tfmt.Printf(\"p values is %v%v\\n\", p, *p==nil)\n\tfmt.Printf(\"v values is %v, %v\\n\", v, v==nil)\n\t\n}\n\n------------------\np values is &[]true\nv values is [0 0 0 0 0], false\n\n```\n\n## <a id=\"Array\"><span class=\"secondtitle\">Array</span></a>\n\nGo\n1. \n2. [10]int[20]int\n3. Array\n\n  \nGoSlice  \n\n## <a id=\"Slice\"><span class=\"secondtitle\">Slice</span></a>\n\nGo Slice  \n\n### \n\n  \n```\ntype Transform [3][3]float64  // A 3x3 array, really an array of arrays.\ntype LinesOfText [][]byte     // A slice of byte slices.\n\ntext := LinesOfText{\n\t[]byte(\"Now is the time\"),\n\t[]byte(\"for all good gophers\"),\n\t[]byte(\"to bring some fun to the party.\"),\n}\n```\n\nMake  \n\n size(Allocate)\n```\n// First Method\npicture := make([][]uint8, YSize)\nfor i:= range picture{\n    picture[i] = make([]uint8, XSize)\n}\n\n// Second Method \npicture := make([][]uint8, YSize)\npixels := make([]uint8, XSize * YSize)\n\nfor i := range picture{\n    picture[i], pixels = pixels[:XSize], pixels[XSize:]\n}\n\n```\n\n## <a id=\"Map\"><span class=\"secondtitle\">Map</span></a>\nKeyMap\n```\nvar tz map[string]int\nvar ds string = \"abc\"\nif val, ok := tz[ds]; ok{\n    return val\n}\n```\n\nKeyMap\n```\nvar tz map[string]int\nvar ds string = \"abc\"\n_, exist := tz[ds]\nif !exist {\n    return \"is not exist\"\n}\n```\n\n,delete\n```\nvar tz map[string]int\nvar ds string = \"abc\"\n// delete(map, key)\ndelete(tz, ds)\n```\n\n## <a id=\"Append\"><span class=\"secondtitle\">Append</span></a>\n\nAppend \n```\nfunc append(slice []T, elements ...T) []T\n\n// use case \nx := []int{1,2,3}\nx = append(x, 4, 5, 6)\nfmt.Println(x)\n```\n\n\n```\nx := []int{1,2,3}\ny := []int{4,5,6}\nx = append(x, y...)\nfmt.Println(x)\n```\n\n# <a id=\"InterFace\"><span class=\"toptitle\">InterFace</span></a>\n\n## Interface\n\n\n```\ntype Sequence []int\n\n// Methods required by sort.Interface.\nfunc (s Sequence) Len() int {\n    return len(s)\n}\nfunc (s Sequence) Less(i, j int) bool {\n    return s[i] < s[j]\n}\nfunc (s Sequence) Swap(i, j int) {\n    s[i], s[j] = s[j], s[i]\n}\n\n// Copy returns a copy of the Sequence.\nfunc (s Sequence) Copy() Sequence {\n    copy := make(Sequence, 0, len(s))\n    return append(copy, s...)\n}\n\n// Method for printing - sorts the elements before printing.\nfunc (s Sequence) String() string {\n    s = s.Copy() // Make a copy; don't overwrite argument.\n    sort.Sort(s)\n    str := \"[\"\n    for i, elem := range s { // Loop is O(N); will fix that in next example.\n        if i > 0 {\n            str += \" \"\n        }\n        str += fmt.Sprint(elem)\n    }\n    return str + \"]\"\n}\n```\n\n## Coversions\n\nfmtSprintSprint[]intSequence\n[]int  \n\n```\n// \nfunc (s Sequence) String() string {\n    s = s.Copy()\n    sort.Sort(s)\n    return fmt.Sprint([]int(s))\n}\n\n// \ntype Sequence []int\n\n// Method for printing - sorts the elements before printing\nfunc (s Sequence) String() string {\n    s = s.Copy()\n    sort.IntSlice(s).Sort()\n    return fmt.Sprint([]int(s))\n}\n```\n\n## type assertions\n\nType switch   \nstring, String()\n```\ntype Stringer interface {\n    String() string\n}\n\nvar value interface{} // Value provided by caller.\nswitch str := value.(type) {\ncase string:\n    return str\ncase Stringer:\n    return str.String()\n}\n```\n\n\n```\n// \nstr, ok := value.(string)\n```\n\nInterface\n\n##  Generality\n\n\nHashcrc32.NewIEEE  adler32.New Hash.Hash32\n\n## interface & method\n\n.\n\n\n# <a id=\"Error\"><span class=\"toptitle\">Error</span></a>\n\n## <a id=\"Defination\"><span class=\"secondtitle\">Defination</span></a>\nError \n```\ntype error interface {\n    Error() string\n}\n```\n\nError\n```\n// PathError records an error and the operation and\n// file path that caused it.\ntype PathError struct {\n    Op string    // \"open\", \"unlink\", etc.\n    Path string  // The associated file.\n    Err error    // Returned by the system call.\n}\n\nfunc (e *PathError) Error() string {\n    return e.Op + \" \" + e.Path + \": \" + e.Err.Error()\n}\n```\n\n  \nswitch\n```\nfor try := 0; try < 2; try++ {\n    file, err = os.Create(filename)\n    if err == nil {\n        return\n    }\n    if e, ok := err.(*os.PathError); ok && e.Err == syscall.ENOSPC {\n        deleteTempFiles()  // Recover some space.\n        continue\n    }\n    return\n}\n```\n\n## <a id=\"Panic\"><span class=\"secondtitle\">Panic</span></a>\n.\n```\n\nfunc Get() (string, Error){\n    return \"\", nil\n}\n\nk, err := Get()\n```\n  \nPanic()Runtime Error  \nPanic\n```\nfunc CubeRoot(x float64) float64 {\n    z := x/3   // Arbitrary initial value\n    for i := 0; i < 1e6; i++ {\n        prevz := z\n        z -= (z*z*z-x) / (3*z*z)\n        if veryClose(z, prevz) {\n            return z\n        }\n    }\n    // A million iterations has not converged; something is wrong.\n    panic(fmt.Sprintf(\"CubeRoot(%g) did not converge\", x))\n}\n```\n\nPanic\n\n\n## <a id=\"Recover\"><span class=\"secondtitle\">Recover</span></a>\n\nPanicGoroutinepanicdefer Recover\n```\nfunc server(workChan <-chan *Work) {\n    for work := range workChan {\n        go safelyDo(work)\n    }\n}\n\nfunc safelyDo(work *Work) {\n    defer func() {\n        if err := recover(); err != nil {\n            log.Println(\"work failed:\", err)\n        }\n    }()\n    do(work)\n}\n```\n\nRegexp\n```\n// Error is the type of a parse error; it satisfies the error interface.\ntype Error string\nfunc (e Error) Error() string {\n    return string(e)\n}\n\n// error is a method of *Regexp that reports parsing errors by\n// panicking with an Error.\nfunc (regexp *Regexp) error(err string) {\n    panic(Error(err))\n}\n\n// Compile returns a parsed representation of the regular expression.\nfunc Compile(str string) (regexp *Regexp, err error) {\n    regexp = new(Regexp)\n    // doParse will panic if there is a parse error.\n    defer func() {\n        if e := recover(); e != nil {\n            regexp = nil    // Clear return value.\n            err = e.(Error) // Will re-panic if not a parse error.\n        }\n    }()\n    return regexp.doParse(str), nil\n}\n```\n\nregexp nileError\n```\nif pos == 0 {\n    re.error(\"'*' illegal at start of expression\")\n}\n```\nre-panicClient  \nre-panic\n\n# <a id=\"Init\"><span class=\"toptitle\">PackageInit</span></a>\n\n[](https://zhuanlan.zhihu.com/p/34211611)\n\n[](https://medium.com/golangspec/init-functions-in-go-eac191b3860a)\n\n# <a id=\"Defer\"><span class=\"toptitle\">Defer</span></a>\n\nDeferPythonWith\n\n```\nfunc Contents(filename string) (string, error) {\n    f, err := os.Open(filename)\n    if err != nil {\n        return \"\", err\n    }\n    defer f.Close()  // f.Close will run when we're finished.\n\n    var result []byte\n    buf := make([]byte, 100)\n    for {\n        n, err := f.Read(buf[0:])\n        result = append(result, buf[0:n]...) // append is discussed later.\n        if err != nil {\n            if err == io.EOF {\n                break\n            }\n            return \"\", err  // f will be closed if we return here.\n        }\n    }\n    return string(result), nil // f will be closed if we return here.\n}\n```\n\n```\nDefer\n1. \n2. \n```\n\n\n```\npackage main\n\nimport (\n\t\"fmt\"\n)\n\nfunc main() {\n\tfor i := 0; i < 5; i++ {\n    \t\tdefer fmt.Printf(\"%d \", i)\n\t}\n}\n\n-------\noutput:\n4 3 2 1 0 \n```\nDeferLIFOLastInFirstOut)\n\n\n\n```\npackage main\n\nimport \"fmt\"\n\nfunc trace(s string) string {\n    fmt.Println(\"entering:\", s)\n    return s\n}\n\nfunc un(s string) {\n    fmt.Println(\"leaving:\", s)\n}\n\nfunc a() {\n    defer un(trace(\"a\"))\n    fmt.Println(\"in a\")\n}\n\nfunc b() {\n    defer un(trace(\"b\"))\n    fmt.Println(\"in b\")\n    a()\n}\n\nfunc main() {\n    b()\n}\n-------------------\noutput\nentering: b\nin b\nentering: a\nin a\nleaving: a\nleaving: b\n```\n\ndefer defer un(trace()), trace()un()defer\n\n[](https://mp.weixin.qq.com/s/_wZQID0VatIlAiH6-x3U6A)\n\n# <a id=\"ShareNote\"><span class=\"toptitle\">ShareNote</span></a>\n1. [EffectiveGo](https://golang.org/doc/effective_go.html)\n2. [GoInitFunc](https://medium.com/golangspec/init-functions-in-go-eac191b3860a)\n3. [GoInitFunc](https://zhuanlan.zhihu.com/p/34211611)","slug":"effective-go","published":1,"updated":"2021-01-21T07:12:05.053Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk6irarw000lk9i5fhb04215","content":"<!-- --- -->\n<!-- layout: post\ntitle: Effective Go Reading\nauthor: Ray Chan(ray1888)\ndate: '2019-09-16 11:07:38 +0800'\ncategory: go\nsummary: Effective Go \nthumbnail: go.png\n--- -->\n\n<p>Effective GO</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#Method\">Method</a><br>1.1 <a href=\"#PvV\">Pointers vs Values</a>  </li>\n<li><a href=\"#Data\">Data</a><br>2.1 <a href=\"#NewMake\">New vs Make</a><br>2.2 <a href=\"#Array\">Array</a><br>2.3 <a href=\"#Slice\">Slice</a><br>2.4 <a href=\"#Map\">Map</a><br>2.5 <a href=\"#Append\">Append</a>  </li>\n<li><a href=\"#InterFace\">Interface</a></li>\n<li><a href=\"#Error\">Error</a></li>\n<li><a href=\"#Init\">PackageInit</a>  </li>\n<li><a href=\"#Defer\">Defer</a></li>\n<li><a href=\"#ShareNote\">ShareNote</a></li>\n</ol>\n\n        <h1 id=\"Method\"   >\n          <a href=\"#Method\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Method</h1>\n      \n        <h2 id=\"Pointers-vs-Values\"   >\n          <a href=\"#Pointers-vs-Values\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Pointers vs Values</h2>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">type ByteSlice []byte</span><br><span class=\"line\"></span><br><span class=\"line\">func (slice ByteSlice) Append(data []byte) []byte &#123;</span><br><span class=\"line\">\t&#x2F;&#x2F; Body exactly the same as the Append function defined above.</span><br><span class=\"line\">\tl :&#x3D; len(slice)</span><br><span class=\"line\">\tif l+len(data) &gt; cap(slice) &#123; &#x2F;&#x2F; reallocate</span><br><span class=\"line\">\t\t&#x2F;&#x2F; Allocate double what&#39;s needed, for future growth.</span><br><span class=\"line\">\t\tnewSlice :&#x3D; make([]byte, (l+len(data))*2)</span><br><span class=\"line\">\t\t&#x2F;&#x2F; The copy function is predeclared and works for any slice type.</span><br><span class=\"line\">\t\tcopy(newSlice, slice)</span><br><span class=\"line\">\t\tslice &#x3D; newSlice</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tslice &#x3D; slice[0 : l+len(data)]</span><br><span class=\"line\">\tcopy(slice[l:], data)</span><br><span class=\"line\">\treturn slice</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *ByteSlice) Append2(data []byte) &#123;</span><br><span class=\"line\">\tslice :&#x3D; *p</span><br><span class=\"line\">\t&#x2F;&#x2F; Body as above, without the return.</span><br><span class=\"line\">\tl :&#x3D; len(slice)</span><br><span class=\"line\">\tif l+len(data) &gt; cap(slice) &#123; &#x2F;&#x2F; reallocate</span><br><span class=\"line\">\t\t&#x2F;&#x2F; Allocate double what&#39;s needed, for future growth.</span><br><span class=\"line\">\t\tnewSlice :&#x3D; make([]byte, (l+len(data))*2)</span><br><span class=\"line\">\t\t&#x2F;&#x2F; The copy function is predeclared and works for any slice type.</span><br><span class=\"line\">\t\tcopy(newSlice, slice)</span><br><span class=\"line\">\t\tslice &#x3D; newSlice</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tslice &#x3D; slice[0 : l+len(data)]</span><br><span class=\"line\">\tcopy(slice[l:], data)</span><br><span class=\"line\">\t*p &#x3D; slice</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *ByteSlice) Write(data []byte) (n int, err error) &#123;</span><br><span class=\"line\">\tslice :&#x3D; *p</span><br><span class=\"line\">\t&#x2F;&#x2F; Body as above, without the return.</span><br><span class=\"line\">\tl :&#x3D; len(slice)</span><br><span class=\"line\">\tif l+len(data) &gt; cap(slice) &#123; &#x2F;&#x2F; reallocate</span><br><span class=\"line\">\t\t&#x2F;&#x2F; Allocate double what&#39;s needed, for future growth.</span><br><span class=\"line\">\t\tnewSlice :&#x3D; make([]byte, (l+len(data))*2)</span><br><span class=\"line\">\t\t&#x2F;&#x2F; The copy function is predeclared and works for any slice type.</span><br><span class=\"line\">\t\tcopy(newSlice, slice)</span><br><span class=\"line\">\t\tslice &#x3D; newSlice</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tslice &#x3D; slice[0 : l+len(data)]</span><br><span class=\"line\">\tcopy(slice[l:], data)</span><br><span class=\"line\">\t*p &#x3D; slice</span><br><span class=\"line\">\t*p &#x3D; slice</span><br><span class=\"line\">\treturn len(data), nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tvar b ByteSlice</span><br><span class=\"line\">\tb &#x3D; b.Append([]byte&#123;1, 2, 3&#125;)</span><br><span class=\"line\">\tfmt.Printf(&quot;byteSlice 1 is %v&quot;, b)</span><br><span class=\"line\">\tb.Write([]byte&#123;7, 8, 9&#125;)</span><br><span class=\"line\">\tfmt.Printf(&quot;byteSlice 2 is %v&quot;, b)</span><br><span class=\"line\">    &#x2F;*</span><br><span class=\"line\">    func Fprintf(w io.Writer, format string, a ...interface&#123;&#125;) (n int, err error)</span><br><span class=\"line\">    *&#x2F;</span><br><span class=\"line\">\tfmt.Fprintf(&amp;b, &quot;This hour has %d days\\n&quot;, 7)</span><br><span class=\"line\">    &#x2F;*</span><br><span class=\"line\">    if use below code , will throw error </span><br><span class=\"line\">    fmt.Fprintf(b, &quot;This hour has %d days\\n&quot;, 7)</span><br><span class=\"line\">    *&#x2F;</span><br><span class=\"line\">\tb.Append2([]byte&#123;4, 5, 6&#125;)</span><br><span class=\"line\">\tfmt.Printf(&quot;byteSlice 3 is %v&quot;, b)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Bio.WriterWriteWrite</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">as type io.Writer in argument to fmt.Fprintf:</span><br><span class=\"line\">\tByteSlice does not implement io.Writer (Write method has pointer receiver)</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The rule about pointers vs. values for receivers is that value methods can be invoked on pointers and values, but pointer methods can only be invoked on pointers.</span><br><span class=\"line\"></span><br><span class=\"line\">This rule arises because pointer methods can modify the receiver; invoking them on a value would cause the method to receive a copy of the value, so any modifications would be discarded. The language therefore disallows this mistake. There is a handy exception, though. When the value is addressable, the language takes care of the common case of invoking a pointer method on a value by inserting the address operator automatically. In our example, the variable b is addressable, so we can call its Write method with just b.Write. The compiler will rewrite that to (&amp;b).Write for us.</span><br></pre></td></tr></table></div></figure>\n<p><br> </p>\n<p> goReturn +  </p>\n\n        <h1 id=\"Data\"   >\n          <a href=\"#Data\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Data</h1>\n      \n        <h2 id=\"New-vs-Make\"   >\n          <a href=\"#New-vs-Make\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>New vs Make</h2>\n      \n        <h3 id=\"New\"   >\n          <a href=\"#New\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>New</h3>\n      <p>New  GoZero0</p>\n<p>new00</p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">For example, the documentation for bytes.Buffer states that &quot;the zero value for Buffer is an empty buffer ready to use.&quot; Similarly, sync.Mutex does not have an explicit constructor or Init method. Instead, the zero value for a sync.Mutex is defined to be an unlocked mutex.</span><br><span class=\"line\"></span><br><span class=\"line\">The zero-value-is-useful property works transitively. Consider this type declaration.</span><br><span class=\"line\"></span><br><span class=\"line\">type SyncedBuffer struct &#123;</span><br><span class=\"line\">    lock    sync.Mutex</span><br><span class=\"line\">    buffer  bytes.Buffer</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>0</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func NewFile(fd int, name string) *File &#123;</span><br><span class=\"line\">    if fd &lt; 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    f :&#x3D; new(File)</span><br><span class=\"line\">    f.fd &#x3D; fd</span><br><span class=\"line\">    f.name &#x3D; name</span><br><span class=\"line\">    f.dirinfo &#x3D; nil</span><br><span class=\"line\">    f.nepipe &#x3D; 0</span><br><span class=\"line\">    return f</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func NewFile(fd int, name string) *File &#123;</span><br><span class=\"line\">    if fd &lt; 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    f :&#x3D; File&#123;fd, name, nil, 0&#125;</span><br><span class=\"line\">    return &amp;f</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f :&#x3D; File&#123;fd, name, nil, 0&#125;</span><br><span class=\"line\">    return &amp;f</span><br><span class=\"line\">&#x3D;&#x3D;&#x3D; </span><br><span class=\"line\"></span><br><span class=\"line\">return &amp;File&#123;fd, name, nil, 0&#125;</span><br></pre></td></tr></table></div></figure>\n<p> with the field labels being indices or map keys as appropriate</p>\n<p><br></p>\n\n        <h3 id=\"Make\"   >\n          <a href=\"#Make\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Make</h3>\n      <p>Make nil<br><br>channel  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make([]int,10,100)  &#x2F;&#x2F; 100100</span><br></pre></td></tr></table></div></figure>\n<p>make</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">For slices, maps, and channels, make initializes the internal data structure and prepares the value for use.</span><br></pre></td></tr></table></div></figure>\n<p><br></p>\n\n        <h3 id=\"Diff\"   >\n          <a href=\"#Diff\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Diff</h3>\n      <p>MakeNewchannel<br>newnilmakenil<br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">func main()&#123;</span><br><span class=\"line\">\t &#x2F;&#x2F; allocates slice structure; *p &#x3D;&#x3D; nil; rarely useful</span><br><span class=\"line\">\tvar p *[]int &#x3D; new([]int)     </span><br><span class=\"line\">\t&#x2F;&#x2F; the slice v now refers to a new array of 100 ints </span><br><span class=\"line\">\tvar v []int &#x3D; make([]int, 5) </span><br><span class=\"line\">\tfmt.Printf(&quot;p values is %v%v\\n&quot;, p, *p&#x3D;&#x3D;nil)</span><br><span class=\"line\">\tfmt.Printf(&quot;v values is %v, %v\\n&quot;, v, v&#x3D;&#x3D;nil)</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">------------------</span><br><span class=\"line\">p values is &amp;[]true</span><br><span class=\"line\">v values is [0 0 0 0 0], false</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Array\"   >\n          <a href=\"#Array\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Array</h2>\n      <p>Go</p>\n<ol>\n<li></li>\n<li>[10]int[20]int</li>\n<li>Array</li>\n</ol>\n<p><br>GoSlice  </p>\n\n        <h2 id=\"Slice\"   >\n          <a href=\"#Slice\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Slice</h2>\n      <p>Go Slice  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Transform [3][3]float64  &#x2F;&#x2F; A 3x3 array, really an array of arrays.</span><br><span class=\"line\">type LinesOfText [][]byte     &#x2F;&#x2F; A slice of byte slices.</span><br><span class=\"line\"></span><br><span class=\"line\">text :&#x3D; LinesOfText&#123;</span><br><span class=\"line\">\t[]byte(&quot;Now is the time&quot;),</span><br><span class=\"line\">\t[]byte(&quot;for all good gophers&quot;),</span><br><span class=\"line\">\t[]byte(&quot;to bring some fun to the party.&quot;),</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Make<br><br> size(Allocate)</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; First Method</span><br><span class=\"line\">picture :&#x3D; make([][]uint8, YSize)</span><br><span class=\"line\">for i:&#x3D; range picture&#123;</span><br><span class=\"line\">    picture[i] &#x3D; make([]uint8, XSize)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Second Method </span><br><span class=\"line\">picture :&#x3D; make([][]uint8, YSize)</span><br><span class=\"line\">pixels :&#x3D; make([]uint8, XSize * YSize)</span><br><span class=\"line\"></span><br><span class=\"line\">for i :&#x3D; range picture&#123;</span><br><span class=\"line\">    picture[i], pixels &#x3D; pixels[:XSize], pixels[XSize:]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Map\"   >\n          <a href=\"#Map\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Map</h2>\n      <p>KeyMap</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var tz map[string]int</span><br><span class=\"line\">var ds string &#x3D; &quot;abc&quot;</span><br><span class=\"line\">if val, ok :&#x3D; tz[ds]; ok&#123;</span><br><span class=\"line\">    return val</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>KeyMap</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var tz map[string]int</span><br><span class=\"line\">var ds string &#x3D; &quot;abc&quot;</span><br><span class=\"line\">_, exist :&#x3D; tz[ds]</span><br><span class=\"line\">if !exist &#123;</span><br><span class=\"line\">    return &quot;is not exist&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>,delete</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var tz map[string]int</span><br><span class=\"line\">var ds string &#x3D; &quot;abc&quot;</span><br><span class=\"line\">&#x2F;&#x2F; delete(map, key)</span><br><span class=\"line\">delete(tz, ds)</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Append\"   >\n          <a href=\"#Append\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Append</h2>\n      <p>Append </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func append(slice []T, elements ...T) []T</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; use case </span><br><span class=\"line\">x :&#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">x &#x3D; append(x, 4, 5, 6)</span><br><span class=\"line\">fmt.Println(x)</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">x :&#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">y :&#x3D; []int&#123;4,5,6&#125;</span><br><span class=\"line\">x &#x3D; append(x, y...)</span><br><span class=\"line\">fmt.Println(x)</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"InterFace\"   >\n          <a href=\"#InterFace\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>InterFace</h1>\n      \n        <h2 id=\"Interface\"   >\n          <a href=\"#Interface\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Interface</h2>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Sequence []int</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Methods required by sort.Interface.</span><br><span class=\"line\">func (s Sequence) Len() int &#123;</span><br><span class=\"line\">    return len(s)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func (s Sequence) Less(i, j int) bool &#123;</span><br><span class=\"line\">    return s[i] &lt; s[j]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func (s Sequence) Swap(i, j int) &#123;</span><br><span class=\"line\">    s[i], s[j] &#x3D; s[j], s[i]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Copy returns a copy of the Sequence.</span><br><span class=\"line\">func (s Sequence) Copy() Sequence &#123;</span><br><span class=\"line\">    copy :&#x3D; make(Sequence, 0, len(s))</span><br><span class=\"line\">    return append(copy, s...)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Method for printing - sorts the elements before printing.</span><br><span class=\"line\">func (s Sequence) String() string &#123;</span><br><span class=\"line\">    s &#x3D; s.Copy() &#x2F;&#x2F; Make a copy; don&#39;t overwrite argument.</span><br><span class=\"line\">    sort.Sort(s)</span><br><span class=\"line\">    str :&#x3D; &quot;[&quot;</span><br><span class=\"line\">    for i, elem :&#x3D; range s &#123; &#x2F;&#x2F; Loop is O(N); will fix that in next example.</span><br><span class=\"line\">        if i &gt; 0 &#123;</span><br><span class=\"line\">            str +&#x3D; &quot; &quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        str +&#x3D; fmt.Sprint(elem)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return str + &quot;]&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Coversions\"   >\n          <a href=\"#Coversions\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Coversions</h2>\n      <p>fmtSprintSprint[]intSequence<br>[]int  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">func (s Sequence) String() string &#123;</span><br><span class=\"line\">    s &#x3D; s.Copy()</span><br><span class=\"line\">    sort.Sort(s)</span><br><span class=\"line\">    return fmt.Sprint([]int(s))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">type Sequence []int</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Method for printing - sorts the elements before printing</span><br><span class=\"line\">func (s Sequence) String() string &#123;</span><br><span class=\"line\">    s &#x3D; s.Copy()</span><br><span class=\"line\">    sort.IntSlice(s).Sort()</span><br><span class=\"line\">    return fmt.Sprint([]int(s))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"type-assertions\"   >\n          <a href=\"#type-assertions\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>type assertions</h2>\n      <p>Type switch <br>string, String()</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Stringer interface &#123;</span><br><span class=\"line\">    String() string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">var value interface&#123;&#125; &#x2F;&#x2F; Value provided by caller.</span><br><span class=\"line\">switch str :&#x3D; value.(type) &#123;</span><br><span class=\"line\">case string:</span><br><span class=\"line\">    return str</span><br><span class=\"line\">case Stringer:</span><br><span class=\"line\">    return str.String()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">str, ok :&#x3D; value.(string)</span><br></pre></td></tr></table></div></figure>\n<p>Interface</p>\n\n        <h2 id=\"Generality\"   >\n          <a href=\"#Generality\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Generality</h2>\n      <p><br>Hashcrc32.NewIEEE  adler32.New Hash.Hash32</p>\n\n        <h2 id=\"interface-amp-method\"   >\n          <a href=\"#interface-amp-method\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>interface &amp; method</h2>\n      <p>.</p>\n\n        <h1 id=\"Error\"   >\n          <a href=\"#Error\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Error</h1>\n      \n        <h2 id=\"Defination\"   >\n          <a href=\"#Defination\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Defination</h2>\n      <p>Error </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type error interface &#123;</span><br><span class=\"line\">    Error() string</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Error</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; PathError records an error and the operation and</span><br><span class=\"line\">&#x2F;&#x2F; file path that caused it.</span><br><span class=\"line\">type PathError struct &#123;</span><br><span class=\"line\">    Op string    &#x2F;&#x2F; &quot;open&quot;, &quot;unlink&quot;, etc.</span><br><span class=\"line\">    Path string  &#x2F;&#x2F; The associated file.</span><br><span class=\"line\">    Err error    &#x2F;&#x2F; Returned by the system call.</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (e *PathError) Error() string &#123;</span><br><span class=\"line\">    return e.Op + &quot; &quot; + e.Path + &quot;: &quot; + e.Err.Error()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p><br>switch</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for try :&#x3D; 0; try &lt; 2; try++ &#123;</span><br><span class=\"line\">    file, err &#x3D; os.Create(filename)</span><br><span class=\"line\">    if err &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if e, ok :&#x3D; err.(*os.PathError); ok &amp;&amp; e.Err &#x3D;&#x3D; syscall.ENOSPC &#123;</span><br><span class=\"line\">        deleteTempFiles()  &#x2F;&#x2F; Recover some space.</span><br><span class=\"line\">        continue</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Panic\"   >\n          <a href=\"#Panic\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Panic</h2>\n      <p>.</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">func Get() (string, Error)&#123;</span><br><span class=\"line\">    return &quot;&quot;, nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">k, err :&#x3D; Get()</span><br></pre></td></tr></table></div></figure>\n<p><br>Panic()Runtime Error<br>Panic</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func CubeRoot(x float64) float64 &#123;</span><br><span class=\"line\">    z :&#x3D; x&#x2F;3   &#x2F;&#x2F; Arbitrary initial value</span><br><span class=\"line\">    for i :&#x3D; 0; i &lt; 1e6; i++ &#123;</span><br><span class=\"line\">        prevz :&#x3D; z</span><br><span class=\"line\">        z -&#x3D; (z*z*z-x) &#x2F; (3*z*z)</span><br><span class=\"line\">        if veryClose(z, prevz) &#123;</span><br><span class=\"line\">            return z</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#x2F;&#x2F; A million iterations has not converged; something is wrong.</span><br><span class=\"line\">    panic(fmt.Sprintf(&quot;CubeRoot(%g) did not converge&quot;, x))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Panic<br></p>\n\n        <h2 id=\"Recover\"   >\n          <a href=\"#Recover\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Recover</h2>\n      <p>PanicGoroutinepanicdefer Recover</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func server(workChan &lt;-chan *Work) &#123;</span><br><span class=\"line\">    for work :&#x3D; range workChan &#123;</span><br><span class=\"line\">        go safelyDo(work)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func safelyDo(work *Work) &#123;</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        if err :&#x3D; recover(); err !&#x3D; nil &#123;</span><br><span class=\"line\">            log.Println(&quot;work failed:&quot;, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    do(work)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Regexp</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; Error is the type of a parse error; it satisfies the error interface.</span><br><span class=\"line\">type Error string</span><br><span class=\"line\">func (e Error) Error() string &#123;</span><br><span class=\"line\">    return string(e)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; error is a method of *Regexp that reports parsing errors by</span><br><span class=\"line\">&#x2F;&#x2F; panicking with an Error.</span><br><span class=\"line\">func (regexp *Regexp) error(err string) &#123;</span><br><span class=\"line\">    panic(Error(err))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Compile returns a parsed representation of the regular expression.</span><br><span class=\"line\">func Compile(str string) (regexp *Regexp, err error) &#123;</span><br><span class=\"line\">    regexp &#x3D; new(Regexp)</span><br><span class=\"line\">    &#x2F;&#x2F; doParse will panic if there is a parse error.</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        if e :&#x3D; recover(); e !&#x3D; nil &#123;</span><br><span class=\"line\">            regexp &#x3D; nil    &#x2F;&#x2F; Clear return value.</span><br><span class=\"line\">            err &#x3D; e.(Error) &#x2F;&#x2F; Will re-panic if not a parse error.</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    return regexp.doParse(str), nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>regexp nileError</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if pos &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">    re.error(&quot;&#39;*&#39; illegal at start of expression&quot;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>re-panicClient<br>re-panic</p>\n\n        <h1 id=\"PackageInit\"   >\n          <a href=\"#PackageInit\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>PackageInit</h1>\n      <p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://zhuanlan.zhihu.com/p/34211611\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://medium.com/golangspec/init-functions-in-go-eac191b3860a\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h1 id=\"Defer\"   >\n          <a href=\"#Defer\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Defer</h1>\n      <p>DeferPythonWith</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func Contents(filename string) (string, error) &#123;</span><br><span class=\"line\">    f, err :&#x3D; os.Open(filename)</span><br><span class=\"line\">    if err !&#x3D; nil &#123;</span><br><span class=\"line\">        return &quot;&quot;, err</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    defer f.Close()  &#x2F;&#x2F; f.Close will run when we&#39;re finished.</span><br><span class=\"line\"></span><br><span class=\"line\">    var result []byte</span><br><span class=\"line\">    buf :&#x3D; make([]byte, 100)</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        n, err :&#x3D; f.Read(buf[0:])</span><br><span class=\"line\">        result &#x3D; append(result, buf[0:n]...) &#x2F;&#x2F; append is discussed later.</span><br><span class=\"line\">        if err !&#x3D; nil &#123;</span><br><span class=\"line\">            if err &#x3D;&#x3D; io.EOF &#123;</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            return &quot;&quot;, err  &#x2F;&#x2F; f will be closed if we return here.</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return string(result), nil &#x2F;&#x2F; f will be closed if we return here.</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Defer</span><br><span class=\"line\">1. </span><br><span class=\"line\">2. </span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">\t&quot;fmt&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tfor i :&#x3D; 0; i &lt; 5; i++ &#123;</span><br><span class=\"line\">    \t\tdefer fmt.Printf(&quot;%d &quot;, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">-------</span><br><span class=\"line\">output:</span><br><span class=\"line\">4 3 2 1 0 </span><br></pre></td></tr></table></div></figure>\n<p>DeferLIFOLastInFirstOut)</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">func trace(s string) string &#123;</span><br><span class=\"line\">    fmt.Println(&quot;entering:&quot;, s)</span><br><span class=\"line\">    return s</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func un(s string) &#123;</span><br><span class=\"line\">    fmt.Println(&quot;leaving:&quot;, s)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func a() &#123;</span><br><span class=\"line\">    defer un(trace(&quot;a&quot;))</span><br><span class=\"line\">    fmt.Println(&quot;in a&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func b() &#123;</span><br><span class=\"line\">    defer un(trace(&quot;b&quot;))</span><br><span class=\"line\">    fmt.Println(&quot;in b&quot;)</span><br><span class=\"line\">    a()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    b()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">-------------------</span><br><span class=\"line\">output</span><br><span class=\"line\">entering: b</span><br><span class=\"line\">in b</span><br><span class=\"line\">entering: a</span><br><span class=\"line\">in a</span><br><span class=\"line\">leaving: a</span><br><span class=\"line\">leaving: b</span><br></pre></td></tr></table></div></figure>\n<p>defer defer un(trace()), trace()un()defer</p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://mp.weixin.qq.com/s/_wZQID0VatIlAiH6-x3U6A\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h1 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote</h1>\n      <ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://golang.org/doc/effective_go.html\" >EffectiveGo</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://medium.com/golangspec/init-functions-in-go-eac191b3860a\" >GoInitFunc</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://zhuanlan.zhihu.com/p/34211611\" >GoInitFunc</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<!-- --- -->\n<!-- layout: post\ntitle: Effective Go Reading\nauthor: Ray Chan(ray1888)\ndate: '2019-09-16 11:07:38 +0800'\ncategory: go\nsummary: Effective Go \nthumbnail: go.png\n--- -->\n\n<p>Effective GO</p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#Method\">Method</a><br>1.1 <a href=\"#PvV\">Pointers vs Values</a>  </li>\n<li><a href=\"#Data\">Data</a><br>2.1 <a href=\"#NewMake\">New vs Make</a><br>2.2 <a href=\"#Array\">Array</a><br>2.3 <a href=\"#Slice\">Slice</a><br>2.4 <a href=\"#Map\">Map</a><br>2.5 <a href=\"#Append\">Append</a>  </li>\n<li><a href=\"#InterFace\">Interface</a></li>\n<li><a href=\"#Error\">Error</a></li>\n<li><a href=\"#Init\">PackageInit</a>  </li>\n<li><a href=\"#Defer\">Defer</a></li>\n<li><a href=\"#ShareNote\">ShareNote</a></li>\n</ol>\n\n        <h1 id=\"Method\"   >\n          <a href=\"#Method\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Method</h1>\n      \n        <h2 id=\"Pointers-vs-Values\"   >\n          <a href=\"#Pointers-vs-Values\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Pointers vs Values</h2>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">type ByteSlice []byte</span><br><span class=\"line\"></span><br><span class=\"line\">func (slice ByteSlice) Append(data []byte) []byte &#123;</span><br><span class=\"line\">\t&#x2F;&#x2F; Body exactly the same as the Append function defined above.</span><br><span class=\"line\">\tl :&#x3D; len(slice)</span><br><span class=\"line\">\tif l+len(data) &gt; cap(slice) &#123; &#x2F;&#x2F; reallocate</span><br><span class=\"line\">\t\t&#x2F;&#x2F; Allocate double what&#39;s needed, for future growth.</span><br><span class=\"line\">\t\tnewSlice :&#x3D; make([]byte, (l+len(data))*2)</span><br><span class=\"line\">\t\t&#x2F;&#x2F; The copy function is predeclared and works for any slice type.</span><br><span class=\"line\">\t\tcopy(newSlice, slice)</span><br><span class=\"line\">\t\tslice &#x3D; newSlice</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tslice &#x3D; slice[0 : l+len(data)]</span><br><span class=\"line\">\tcopy(slice[l:], data)</span><br><span class=\"line\">\treturn slice</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *ByteSlice) Append2(data []byte) &#123;</span><br><span class=\"line\">\tslice :&#x3D; *p</span><br><span class=\"line\">\t&#x2F;&#x2F; Body as above, without the return.</span><br><span class=\"line\">\tl :&#x3D; len(slice)</span><br><span class=\"line\">\tif l+len(data) &gt; cap(slice) &#123; &#x2F;&#x2F; reallocate</span><br><span class=\"line\">\t\t&#x2F;&#x2F; Allocate double what&#39;s needed, for future growth.</span><br><span class=\"line\">\t\tnewSlice :&#x3D; make([]byte, (l+len(data))*2)</span><br><span class=\"line\">\t\t&#x2F;&#x2F; The copy function is predeclared and works for any slice type.</span><br><span class=\"line\">\t\tcopy(newSlice, slice)</span><br><span class=\"line\">\t\tslice &#x3D; newSlice</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tslice &#x3D; slice[0 : l+len(data)]</span><br><span class=\"line\">\tcopy(slice[l:], data)</span><br><span class=\"line\">\t*p &#x3D; slice</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *ByteSlice) Write(data []byte) (n int, err error) &#123;</span><br><span class=\"line\">\tslice :&#x3D; *p</span><br><span class=\"line\">\t&#x2F;&#x2F; Body as above, without the return.</span><br><span class=\"line\">\tl :&#x3D; len(slice)</span><br><span class=\"line\">\tif l+len(data) &gt; cap(slice) &#123; &#x2F;&#x2F; reallocate</span><br><span class=\"line\">\t\t&#x2F;&#x2F; Allocate double what&#39;s needed, for future growth.</span><br><span class=\"line\">\t\tnewSlice :&#x3D; make([]byte, (l+len(data))*2)</span><br><span class=\"line\">\t\t&#x2F;&#x2F; The copy function is predeclared and works for any slice type.</span><br><span class=\"line\">\t\tcopy(newSlice, slice)</span><br><span class=\"line\">\t\tslice &#x3D; newSlice</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tslice &#x3D; slice[0 : l+len(data)]</span><br><span class=\"line\">\tcopy(slice[l:], data)</span><br><span class=\"line\">\t*p &#x3D; slice</span><br><span class=\"line\">\t*p &#x3D; slice</span><br><span class=\"line\">\treturn len(data), nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tvar b ByteSlice</span><br><span class=\"line\">\tb &#x3D; b.Append([]byte&#123;1, 2, 3&#125;)</span><br><span class=\"line\">\tfmt.Printf(&quot;byteSlice 1 is %v&quot;, b)</span><br><span class=\"line\">\tb.Write([]byte&#123;7, 8, 9&#125;)</span><br><span class=\"line\">\tfmt.Printf(&quot;byteSlice 2 is %v&quot;, b)</span><br><span class=\"line\">    &#x2F;*</span><br><span class=\"line\">    func Fprintf(w io.Writer, format string, a ...interface&#123;&#125;) (n int, err error)</span><br><span class=\"line\">    *&#x2F;</span><br><span class=\"line\">\tfmt.Fprintf(&amp;b, &quot;This hour has %d days\\n&quot;, 7)</span><br><span class=\"line\">    &#x2F;*</span><br><span class=\"line\">    if use below code , will throw error </span><br><span class=\"line\">    fmt.Fprintf(b, &quot;This hour has %d days\\n&quot;, 7)</span><br><span class=\"line\">    *&#x2F;</span><br><span class=\"line\">\tb.Append2([]byte&#123;4, 5, 6&#125;)</span><br><span class=\"line\">\tfmt.Printf(&quot;byteSlice 3 is %v&quot;, b)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Bio.WriterWriteWrite</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">as type io.Writer in argument to fmt.Fprintf:</span><br><span class=\"line\">\tByteSlice does not implement io.Writer (Write method has pointer receiver)</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The rule about pointers vs. values for receivers is that value methods can be invoked on pointers and values, but pointer methods can only be invoked on pointers.</span><br><span class=\"line\"></span><br><span class=\"line\">This rule arises because pointer methods can modify the receiver; invoking them on a value would cause the method to receive a copy of the value, so any modifications would be discarded. The language therefore disallows this mistake. There is a handy exception, though. When the value is addressable, the language takes care of the common case of invoking a pointer method on a value by inserting the address operator automatically. In our example, the variable b is addressable, so we can call its Write method with just b.Write. The compiler will rewrite that to (&amp;b).Write for us.</span><br></pre></td></tr></table></div></figure>\n<p><br> </p>\n<p> goReturn +  </p>\n\n        <h1 id=\"Data\"   >\n          <a href=\"#Data\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Data</h1>\n      \n        <h2 id=\"New-vs-Make\"   >\n          <a href=\"#New-vs-Make\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>New vs Make</h2>\n      \n        <h3 id=\"New\"   >\n          <a href=\"#New\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>New</h3>\n      <p>New  GoZero0</p>\n<p>new00</p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">For example, the documentation for bytes.Buffer states that &quot;the zero value for Buffer is an empty buffer ready to use.&quot; Similarly, sync.Mutex does not have an explicit constructor or Init method. Instead, the zero value for a sync.Mutex is defined to be an unlocked mutex.</span><br><span class=\"line\"></span><br><span class=\"line\">The zero-value-is-useful property works transitively. Consider this type declaration.</span><br><span class=\"line\"></span><br><span class=\"line\">type SyncedBuffer struct &#123;</span><br><span class=\"line\">    lock    sync.Mutex</span><br><span class=\"line\">    buffer  bytes.Buffer</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>0</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func NewFile(fd int, name string) *File &#123;</span><br><span class=\"line\">    if fd &lt; 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    f :&#x3D; new(File)</span><br><span class=\"line\">    f.fd &#x3D; fd</span><br><span class=\"line\">    f.name &#x3D; name</span><br><span class=\"line\">    f.dirinfo &#x3D; nil</span><br><span class=\"line\">    f.nepipe &#x3D; 0</span><br><span class=\"line\">    return f</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func NewFile(fd int, name string) *File &#123;</span><br><span class=\"line\">    if fd &lt; 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    f :&#x3D; File&#123;fd, name, nil, 0&#125;</span><br><span class=\"line\">    return &amp;f</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f :&#x3D; File&#123;fd, name, nil, 0&#125;</span><br><span class=\"line\">    return &amp;f</span><br><span class=\"line\">&#x3D;&#x3D;&#x3D; </span><br><span class=\"line\"></span><br><span class=\"line\">return &amp;File&#123;fd, name, nil, 0&#125;</span><br></pre></td></tr></table></div></figure>\n<p> with the field labels being indices or map keys as appropriate</p>\n<p><br></p>\n\n        <h3 id=\"Make\"   >\n          <a href=\"#Make\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Make</h3>\n      <p>Make nil<br><br>channel  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make([]int,10,100)  &#x2F;&#x2F; 100100</span><br></pre></td></tr></table></div></figure>\n<p>make</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">For slices, maps, and channels, make initializes the internal data structure and prepares the value for use.</span><br></pre></td></tr></table></div></figure>\n<p><br></p>\n\n        <h3 id=\"Diff\"   >\n          <a href=\"#Diff\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Diff</h3>\n      <p>MakeNewchannel<br>newnilmakenil<br></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">func main()&#123;</span><br><span class=\"line\">\t &#x2F;&#x2F; allocates slice structure; *p &#x3D;&#x3D; nil; rarely useful</span><br><span class=\"line\">\tvar p *[]int &#x3D; new([]int)     </span><br><span class=\"line\">\t&#x2F;&#x2F; the slice v now refers to a new array of 100 ints </span><br><span class=\"line\">\tvar v []int &#x3D; make([]int, 5) </span><br><span class=\"line\">\tfmt.Printf(&quot;p values is %v%v\\n&quot;, p, *p&#x3D;&#x3D;nil)</span><br><span class=\"line\">\tfmt.Printf(&quot;v values is %v, %v\\n&quot;, v, v&#x3D;&#x3D;nil)</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">------------------</span><br><span class=\"line\">p values is &amp;[]true</span><br><span class=\"line\">v values is [0 0 0 0 0], false</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Array\"   >\n          <a href=\"#Array\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Array</h2>\n      <p>Go</p>\n<ol>\n<li></li>\n<li>[10]int[20]int</li>\n<li>Array</li>\n</ol>\n<p><br>GoSlice  </p>\n\n        <h2 id=\"Slice\"   >\n          <a href=\"#Slice\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Slice</h2>\n      <p>Go Slice  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Transform [3][3]float64  &#x2F;&#x2F; A 3x3 array, really an array of arrays.</span><br><span class=\"line\">type LinesOfText [][]byte     &#x2F;&#x2F; A slice of byte slices.</span><br><span class=\"line\"></span><br><span class=\"line\">text :&#x3D; LinesOfText&#123;</span><br><span class=\"line\">\t[]byte(&quot;Now is the time&quot;),</span><br><span class=\"line\">\t[]byte(&quot;for all good gophers&quot;),</span><br><span class=\"line\">\t[]byte(&quot;to bring some fun to the party.&quot;),</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Make<br><br> size(Allocate)</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; First Method</span><br><span class=\"line\">picture :&#x3D; make([][]uint8, YSize)</span><br><span class=\"line\">for i:&#x3D; range picture&#123;</span><br><span class=\"line\">    picture[i] &#x3D; make([]uint8, XSize)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Second Method </span><br><span class=\"line\">picture :&#x3D; make([][]uint8, YSize)</span><br><span class=\"line\">pixels :&#x3D; make([]uint8, XSize * YSize)</span><br><span class=\"line\"></span><br><span class=\"line\">for i :&#x3D; range picture&#123;</span><br><span class=\"line\">    picture[i], pixels &#x3D; pixels[:XSize], pixels[XSize:]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Map\"   >\n          <a href=\"#Map\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Map</h2>\n      <p>KeyMap</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var tz map[string]int</span><br><span class=\"line\">var ds string &#x3D; &quot;abc&quot;</span><br><span class=\"line\">if val, ok :&#x3D; tz[ds]; ok&#123;</span><br><span class=\"line\">    return val</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>KeyMap</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var tz map[string]int</span><br><span class=\"line\">var ds string &#x3D; &quot;abc&quot;</span><br><span class=\"line\">_, exist :&#x3D; tz[ds]</span><br><span class=\"line\">if !exist &#123;</span><br><span class=\"line\">    return &quot;is not exist&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>,delete</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var tz map[string]int</span><br><span class=\"line\">var ds string &#x3D; &quot;abc&quot;</span><br><span class=\"line\">&#x2F;&#x2F; delete(map, key)</span><br><span class=\"line\">delete(tz, ds)</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Append\"   >\n          <a href=\"#Append\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Append</h2>\n      <p>Append </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func append(slice []T, elements ...T) []T</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; use case </span><br><span class=\"line\">x :&#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">x &#x3D; append(x, 4, 5, 6)</span><br><span class=\"line\">fmt.Println(x)</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">x :&#x3D; []int&#123;1,2,3&#125;</span><br><span class=\"line\">y :&#x3D; []int&#123;4,5,6&#125;</span><br><span class=\"line\">x &#x3D; append(x, y...)</span><br><span class=\"line\">fmt.Println(x)</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"InterFace\"   >\n          <a href=\"#InterFace\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>InterFace</h1>\n      \n        <h2 id=\"Interface\"   >\n          <a href=\"#Interface\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Interface</h2>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Sequence []int</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Methods required by sort.Interface.</span><br><span class=\"line\">func (s Sequence) Len() int &#123;</span><br><span class=\"line\">    return len(s)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func (s Sequence) Less(i, j int) bool &#123;</span><br><span class=\"line\">    return s[i] &lt; s[j]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func (s Sequence) Swap(i, j int) &#123;</span><br><span class=\"line\">    s[i], s[j] &#x3D; s[j], s[i]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Copy returns a copy of the Sequence.</span><br><span class=\"line\">func (s Sequence) Copy() Sequence &#123;</span><br><span class=\"line\">    copy :&#x3D; make(Sequence, 0, len(s))</span><br><span class=\"line\">    return append(copy, s...)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Method for printing - sorts the elements before printing.</span><br><span class=\"line\">func (s Sequence) String() string &#123;</span><br><span class=\"line\">    s &#x3D; s.Copy() &#x2F;&#x2F; Make a copy; don&#39;t overwrite argument.</span><br><span class=\"line\">    sort.Sort(s)</span><br><span class=\"line\">    str :&#x3D; &quot;[&quot;</span><br><span class=\"line\">    for i, elem :&#x3D; range s &#123; &#x2F;&#x2F; Loop is O(N); will fix that in next example.</span><br><span class=\"line\">        if i &gt; 0 &#123;</span><br><span class=\"line\">            str +&#x3D; &quot; &quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        str +&#x3D; fmt.Sprint(elem)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return str + &quot;]&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Coversions\"   >\n          <a href=\"#Coversions\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Coversions</h2>\n      <p>fmtSprintSprint[]intSequence<br>[]int  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">func (s Sequence) String() string &#123;</span><br><span class=\"line\">    s &#x3D; s.Copy()</span><br><span class=\"line\">    sort.Sort(s)</span><br><span class=\"line\">    return fmt.Sprint([]int(s))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">type Sequence []int</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Method for printing - sorts the elements before printing</span><br><span class=\"line\">func (s Sequence) String() string &#123;</span><br><span class=\"line\">    s &#x3D; s.Copy()</span><br><span class=\"line\">    sort.IntSlice(s).Sort()</span><br><span class=\"line\">    return fmt.Sprint([]int(s))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"type-assertions\"   >\n          <a href=\"#type-assertions\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>type assertions</h2>\n      <p>Type switch <br>string, String()</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Stringer interface &#123;</span><br><span class=\"line\">    String() string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">var value interface&#123;&#125; &#x2F;&#x2F; Value provided by caller.</span><br><span class=\"line\">switch str :&#x3D; value.(type) &#123;</span><br><span class=\"line\">case string:</span><br><span class=\"line\">    return str</span><br><span class=\"line\">case Stringer:</span><br><span class=\"line\">    return str.String()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">str, ok :&#x3D; value.(string)</span><br></pre></td></tr></table></div></figure>\n<p>Interface</p>\n\n        <h2 id=\"Generality\"   >\n          <a href=\"#Generality\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Generality</h2>\n      <p><br>Hashcrc32.NewIEEE  adler32.New Hash.Hash32</p>\n\n        <h2 id=\"interface-amp-method\"   >\n          <a href=\"#interface-amp-method\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>interface &amp; method</h2>\n      <p>.</p>\n\n        <h1 id=\"Error\"   >\n          <a href=\"#Error\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Error</h1>\n      \n        <h2 id=\"Defination\"   >\n          <a href=\"#Defination\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Defination</h2>\n      <p>Error </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type error interface &#123;</span><br><span class=\"line\">    Error() string</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Error</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; PathError records an error and the operation and</span><br><span class=\"line\">&#x2F;&#x2F; file path that caused it.</span><br><span class=\"line\">type PathError struct &#123;</span><br><span class=\"line\">    Op string    &#x2F;&#x2F; &quot;open&quot;, &quot;unlink&quot;, etc.</span><br><span class=\"line\">    Path string  &#x2F;&#x2F; The associated file.</span><br><span class=\"line\">    Err error    &#x2F;&#x2F; Returned by the system call.</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (e *PathError) Error() string &#123;</span><br><span class=\"line\">    return e.Op + &quot; &quot; + e.Path + &quot;: &quot; + e.Err.Error()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p><br>switch</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for try :&#x3D; 0; try &lt; 2; try++ &#123;</span><br><span class=\"line\">    file, err &#x3D; os.Create(filename)</span><br><span class=\"line\">    if err &#x3D;&#x3D; nil &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if e, ok :&#x3D; err.(*os.PathError); ok &amp;&amp; e.Err &#x3D;&#x3D; syscall.ENOSPC &#123;</span><br><span class=\"line\">        deleteTempFiles()  &#x2F;&#x2F; Recover some space.</span><br><span class=\"line\">        continue</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Panic\"   >\n          <a href=\"#Panic\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Panic</h2>\n      <p>.</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">func Get() (string, Error)&#123;</span><br><span class=\"line\">    return &quot;&quot;, nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">k, err :&#x3D; Get()</span><br></pre></td></tr></table></div></figure>\n<p><br>Panic()Runtime Error<br>Panic</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func CubeRoot(x float64) float64 &#123;</span><br><span class=\"line\">    z :&#x3D; x&#x2F;3   &#x2F;&#x2F; Arbitrary initial value</span><br><span class=\"line\">    for i :&#x3D; 0; i &lt; 1e6; i++ &#123;</span><br><span class=\"line\">        prevz :&#x3D; z</span><br><span class=\"line\">        z -&#x3D; (z*z*z-x) &#x2F; (3*z*z)</span><br><span class=\"line\">        if veryClose(z, prevz) &#123;</span><br><span class=\"line\">            return z</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#x2F;&#x2F; A million iterations has not converged; something is wrong.</span><br><span class=\"line\">    panic(fmt.Sprintf(&quot;CubeRoot(%g) did not converge&quot;, x))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Panic<br></p>\n\n        <h2 id=\"Recover\"   >\n          <a href=\"#Recover\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Recover</h2>\n      <p>PanicGoroutinepanicdefer Recover</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func server(workChan &lt;-chan *Work) &#123;</span><br><span class=\"line\">    for work :&#x3D; range workChan &#123;</span><br><span class=\"line\">        go safelyDo(work)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func safelyDo(work *Work) &#123;</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        if err :&#x3D; recover(); err !&#x3D; nil &#123;</span><br><span class=\"line\">            log.Println(&quot;work failed:&quot;, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    do(work)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>Regexp</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; Error is the type of a parse error; it satisfies the error interface.</span><br><span class=\"line\">type Error string</span><br><span class=\"line\">func (e Error) Error() string &#123;</span><br><span class=\"line\">    return string(e)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; error is a method of *Regexp that reports parsing errors by</span><br><span class=\"line\">&#x2F;&#x2F; panicking with an Error.</span><br><span class=\"line\">func (regexp *Regexp) error(err string) &#123;</span><br><span class=\"line\">    panic(Error(err))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; Compile returns a parsed representation of the regular expression.</span><br><span class=\"line\">func Compile(str string) (regexp *Regexp, err error) &#123;</span><br><span class=\"line\">    regexp &#x3D; new(Regexp)</span><br><span class=\"line\">    &#x2F;&#x2F; doParse will panic if there is a parse error.</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        if e :&#x3D; recover(); e !&#x3D; nil &#123;</span><br><span class=\"line\">            regexp &#x3D; nil    &#x2F;&#x2F; Clear return value.</span><br><span class=\"line\">            err &#x3D; e.(Error) &#x2F;&#x2F; Will re-panic if not a parse error.</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    return regexp.doParse(str), nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>regexp nileError</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if pos &#x3D;&#x3D; 0 &#123;</span><br><span class=\"line\">    re.error(&quot;&#39;*&#39; illegal at start of expression&quot;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>re-panicClient<br>re-panic</p>\n\n        <h1 id=\"PackageInit\"   >\n          <a href=\"#PackageInit\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>PackageInit</h1>\n      <p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://zhuanlan.zhihu.com/p/34211611\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://medium.com/golangspec/init-functions-in-go-eac191b3860a\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h1 id=\"Defer\"   >\n          <a href=\"#Defer\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Defer</h1>\n      <p>DeferPythonWith</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func Contents(filename string) (string, error) &#123;</span><br><span class=\"line\">    f, err :&#x3D; os.Open(filename)</span><br><span class=\"line\">    if err !&#x3D; nil &#123;</span><br><span class=\"line\">        return &quot;&quot;, err</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    defer f.Close()  &#x2F;&#x2F; f.Close will run when we&#39;re finished.</span><br><span class=\"line\"></span><br><span class=\"line\">    var result []byte</span><br><span class=\"line\">    buf :&#x3D; make([]byte, 100)</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        n, err :&#x3D; f.Read(buf[0:])</span><br><span class=\"line\">        result &#x3D; append(result, buf[0:n]...) &#x2F;&#x2F; append is discussed later.</span><br><span class=\"line\">        if err !&#x3D; nil &#123;</span><br><span class=\"line\">            if err &#x3D;&#x3D; io.EOF &#123;</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            return &quot;&quot;, err  &#x2F;&#x2F; f will be closed if we return here.</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return string(result), nil &#x2F;&#x2F; f will be closed if we return here.</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Defer</span><br><span class=\"line\">1. </span><br><span class=\"line\">2. </span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">\t&quot;fmt&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\tfor i :&#x3D; 0; i &lt; 5; i++ &#123;</span><br><span class=\"line\">    \t\tdefer fmt.Printf(&quot;%d &quot;, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">-------</span><br><span class=\"line\">output:</span><br><span class=\"line\">4 3 2 1 0 </span><br></pre></td></tr></table></div></figure>\n<p>DeferLIFOLastInFirstOut)</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;fmt&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">func trace(s string) string &#123;</span><br><span class=\"line\">    fmt.Println(&quot;entering:&quot;, s)</span><br><span class=\"line\">    return s</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func un(s string) &#123;</span><br><span class=\"line\">    fmt.Println(&quot;leaving:&quot;, s)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func a() &#123;</span><br><span class=\"line\">    defer un(trace(&quot;a&quot;))</span><br><span class=\"line\">    fmt.Println(&quot;in a&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func b() &#123;</span><br><span class=\"line\">    defer un(trace(&quot;b&quot;))</span><br><span class=\"line\">    fmt.Println(&quot;in b&quot;)</span><br><span class=\"line\">    a()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">    b()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">-------------------</span><br><span class=\"line\">output</span><br><span class=\"line\">entering: b</span><br><span class=\"line\">in b</span><br><span class=\"line\">entering: a</span><br><span class=\"line\">in a</span><br><span class=\"line\">leaving: a</span><br><span class=\"line\">leaving: b</span><br></pre></td></tr></table></div></figure>\n<p>defer defer un(trace()), trace()un()defer</p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://mp.weixin.qq.com/s/_wZQID0VatIlAiH6-x3U6A\" ></a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h1 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote</h1>\n      <ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://golang.org/doc/effective_go.html\" >EffectiveGo</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://medium.com/golangspec/init-functions-in-go-eac191b3860a\" >GoInitFunc</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://zhuanlan.zhihu.com/p/34211611\" >GoInitFunc</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n"},{"title":"SQL","date":"2019-09-10T02:05:38.000Z","_content":"\n<!-- ---\nlayout: post\ntitle: SQL\nauthor: Ray Chan(ray1888)\ndate: '2019-09-10 10:05:38 +0800'\ncategory: sql\nsummary: sql-revise for interview \nthumbnail: sql.jfif\n--- -->\n\n# \n1. [Join](#Join)    \n    1.1 [Join](#BasicJoin)  \n    1.2 [Join](#AdvanceJoin)\n2. [](#ViewNSubquery)  \n    2.1 [](#View)  \n    2.2 [](#Subquery)  \n3. [](#Gramma)  \n    3.1 [Select](#Select)  \n    3.2 [OrderBy](#OrderBy)   \n    3.3 [Update](#Update)  \n    3.4 [Delete](#Delete)  \n4. [Having & GroupBy](#HavingNGroupBy)  \n5. [](#Notice)  \n6. [ShareNote](#ShareNote)  \n\n# \nPythonORMSQLSql\n\n# <a id=\"Join\"><span class=\"toptitle\">Join</span></a> \n## \n```\nTABLE_A\n  PK Value\n---- ----------\n   1 FOX\n   2 COP\n   3 TAXI\n   6 WASHINGTON\n   7 DELL\n   5 ARIZONA\n   4 LINCOLN\n  10 LUCENT\n\nTABLE_B\n  PK Value\n---- ----------\n   1 TROT\n   2 CAR\n   3 CAB\n   6 MONUMENT\n   7 PC\n   8 MICROSOFT\n   9 APPLE\n  11 SCOTCH\n```\n\n## <a id=\"BasicJoin\"><span class=\"secondtitle\">Join</span></a>\n\n### InnerJoin\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/INNER_JOIN.png) -->\n{% asset_img INNER_JOIN.png InnerJoin %}\n\nAB    \n\n```\n-- INNER JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\n       B.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nINNER JOIN Table_B B\nON A.PK = B.PK\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   1 FOX        TROT          1\n   2 COP        CAR           2\n   3 TAXI       CAB           3\n   6 WASHINGTON MONUMENT      6\n   7 DELL       PC            7\n\n(5 row(s) affected)\n```\n\n### LeftJoin\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/LEFT_JOIN.png) -->\n{% asset_img LEFT_JOIN.png LeftJoin %}\n\nA, BIDNull  \n\n```\n-- LEFT JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nLEFT JOIN Table_B B\nON A.PK = B.PK\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   1 FOX        TROT          1\n   2 COP        CAR           2\n   3 TAXI       CAB           3\n   4 LINCOLN    NULL       NULL\n   5 ARIZONA    NULL       NULL\n   6 WASHINGTON MONUMENT      6\n   7 DELL       PC            7\n  10 LUCENT     NULL       NULL\n\n(8 row(s) affected)\n```\n\n### RightJoin\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/RIGHT_JOIN.png) -->\n{% asset_img RIGHT_JOIN.png RightJoin %}\n\nBAIDNull  \n\n```\n-- RIGHT JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nRIGHT JOIN Table_B B\nON A.PK = B.PK\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   1 FOX        TROT          1\n   2 COP        CAR           2\n   3 TAXI       CAB           3\n   6 WASHINGTON MONUMENT      6\n   7 DELL       PC            7\nNULL NULL       MICROSOFT     8\nNULL NULL       APPLE         9\nNULL NULL       SCOTCH       11\n\n(8 row(s) affected)\n```\n\n### OuterJoin\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/FULL_OUTER_JOIN.png) -->\n{% asset_img FULL_OUTER_JOIN.png FullOuterJoin %}\n\nAB,NUll  \n\n```\n-- OUTER JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nFULL OUTER JOIN Table_B B\nON A.PK = B.PK\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   1 FOX        TROT          1\n   2 COP        CAR           2\n   3 TAXI       CAB           3\n   6 WASHINGTON MONUMENT      6\n   7 DELL       PC            7\nNULL NULL       MICROSOFT     8\nNULL NULL       APPLE         9\nNULL NULL       SCOTCH       11\n   5 ARIZONA    NULL       NULL\n   4 LINCOLN    NULL       NULL\n  10 LUCENT     NULL       NULL\n\n(11 row(s) affected)\n```\n\n## <a id=\"AdvanceJoin\"><span class=\"secondtitle\">Join</span></a>\n\n### LEFT JOIN EXCLUDING INNER JOIN\n\n<!-- ![LeftJoin](/assets/img/posts/sqlJoin/LEFT_EXCLUDING_JOIN.png) -->\n{% asset_img LEFT_EXCLUDING_JOIN.png LeftExcludeJoin %}\n\nABAB  \n```\n-- LEFT EXCLUDING JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nLEFT JOIN Table_B B\nON A.PK = B.PK\nWHERE B.PK IS NULL\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   4 LINCOLN    NULL       NULL\n   5 ARIZONA    NULL       NULL\n  10 LUCENT     NULL       NULL\n(3 row(s) affected)\n```\n\n### RIGHT JOIN EXCLUDING INNER JOIN\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/RIGHT_EXCLUDING_JOIN.png) -->\n{% asset_img RIGHT_EXCLUDING_JOIN.png RightExcludeJoin %}\n\n\nABBA  \n```\n-- RIGHT EXCLUDING JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nRIGHT JOIN Table_B B\nON A.PK = B.PK\nWHERE A.PK IS NULL\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\nNULL NULL       MICROSOFT     8\nNULL NULL       APPLE         9\nNULL NULL       SCOTCH       11\n\n(3 row(s) affected)\n```\n\n### OUTER JOIN EXCLUDING INNER JOIN\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/OUTER_EXCLUDING_JOIN.png) -->\n{% asset_img OUTER_EXCLUDING_JOIN.png InnerJoin %}\n\nABABBA  \n```\n-- OUTER EXCLUDING JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nFULL OUTER JOIN Table_B B\nON A.PK = B.PK\nWHERE A.PK IS NULL\nOR B.PK IS NULL\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\nNULL NULL       MICROSOFT     8\nNULL NULL       APPLE         9\nNULL NULL       SCOTCH       11\n   5 ARIZONA    NULL       NULL\n   4 LINCOLN    NULL       NULL\n  10 LUCENT     NULL       NULL\n\n(6 row(s) affected)\n```\n\n\n# <a id=\"ViewNSubquery\"><span class=\"toptitle\"></span></a>\n\n## <a id=\"View\"><span class=\"secondtitle\"></span></a>\nSELECT   \n\nSQL SQL   \n  \nSELECT 5-1SELECT \n\ncreate view \n\n\n### \n1. Group By DB\n\n\n## <a id=\"Subquery\"><span class=\"secondtitle\"></span></a>\n\nSELECTSELECT  \n\n```\nselect col_1 from (select col2_ from j  where $cond 1) p where $cond2\n\n\npselect col2_ from j  where $cond 1  j \n```\n\n### \n\n1 1  \n= <>   \n\n#### \n SELECT GROUP BY HAVING ORDERBY   \n\n\n# <a id=\"Gramma\"><span class=\"toptitle\"></span></a>\n\n## <a id=\"Select\"><span class=\"secondtitle\">select</span></a>\n\n\n```\nselect col1, col2, col..... from table1... where $cond\n```\n\n### Select  \n```\nselect * from (select sal as salary, comm as commission from emp) x where salary < 5000\n```\n  \n1. (Sum()Min()Max())\n2. \n3. \n4. \n  \n\n WHERE SELECT WHERE   \nSALARY COMMISSION WHERE   \nFROM WHERE FROM   \nWHERE WHERE   \n  \n  \n### \n```\nselect col1 , col2 ,\n       case when col2 <= 2000 then \"UnderPAID\"\n            when col2 > 4000 then \"OVERPAID\"\n        end as status\n    from emp \n```\n\n[col1, status]  \n\n### \n\n```\n select * from emp limit 1\n```\n\n\n```\nselect * from emp order by rand() limit 5 \n```\n\n### Null\n\n```\n//  col1 \nselect * from emp where col1 is null\n//  col2 \nselect * from emp where col2 is not null\n```\n\n### Union \n\n```\nselect deptno from emp \nunion \nselect deptno from dept \n``` \n  \nUnionunion all   \n```\n// union all \nselect distinct deptno from\n(select deptno from emp \nunion all \nselect deptno from dept )\n```\n\n### Join  \n\n#### \n\n```\nselect e.name, d.loc from emp e , dept d \nwhere e.deptno = 10 and e.deptno = d.deptno\n```\n\n\n\n\n\n\nFROM \n\n\n<!-- ![Union1](/assets/img/posts/sqlPost/Union-1.png) -->\n{% asset_img Union-1.png Union1 %}\nEMP 10 DEPT \nWHERE e.deptno d.deptno EMP.DEPTNO DEPT.DEPTNO\n\n<!-- ![Union2](/assets/img/posts/sqlPost/Union-2.png) -->\n{% asset_img Union-2.png Union2 %}\n\n```\nJoin\nselect e.name, d.loc from emp e  \n   inner join  dept d on e.deptno = d.deptno\n   where e.deptno = 10 \n```\n\n10,Join\n```\nselect e.name, d.loc from emp e  \n   inner join  dept d on e.deptno = d.deptno\n   where (e.deptno = 10) or (e.deptno < 10)\n```\n\n#### \n\n Clerk  \n\n 1. Clerk  \n       2. empJoin  \n```\nselect e.empno, e.name, e.job, e.sal, e.deptno from emp e, \n(select ename, job, sal from emp where job = \"CLERK\") V \nwhere V.ename = e.ename and \n      V.job = e.job and \n      V.sal = e.sal\n```\n\nJoin  \n```\nselect e.empno, e.name, e.job, e.sal, e.deptno from emp e\njoin (select ename, job, sal from emp where job = \"CLERK\") V on (\n    V.ename = e.ename\n    V.job = e.job\n    V.sal = e.sal)\n```\n\n\n#### \n\nnot in Null  \nnull  \nMysql not in  in    or null OrIn Not in   \n\nNull\n```\n// In\nselect deptno from dept where deptno in (10, 50, null)\n~~~~~~~~~~\nDeptno\n--------\n10\n\nselect deptno from dept where (deptno=10 or deptno=50 or deptno=null)\n~~~~~~~~~~\nDeptno\n--------\n10\n\n//Not in \n\nselect deptno from dept where deptno not in (10, 50, null)\n~~~~~~~~~~\nDeptno\n--------\nno rows\n\nselect deptno from dept where deptno not  (deptno=10 or deptno=50 or deptno=null)\n~~~~~~~~~~\nDeptno\n--------\nno rows\n\n```\n\nnull  Not exists  \n```\nselect d.deptno from dept d where\nnot exists (select null from emp e where d.deptno = e.deptno)\n~~~~~~~~~\nDeptno\n--------\n40\n```\n\n\n#### \n\n<!-- ![Union3](/assets/img/posts/sqlPost/Union-3.png) -->\n  \n{% asset_img Union-3.png Union3 %}\n\n```\ncreate view v as \nselect * from emp where deptno != 10\nunion all \nselect * from emp where ename = \"ward\"\n\n```\n\nUNION ALL V EMP EMP V   \n\n```\n//  EMP v\nselect * from (\n   select e.empno, e.ename, e.job, e.mgr, e.hiredate,\n          e.sal, e.comm, e.deptno, count(*) as cnt from emp e\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) e \n) where not exists (\n   select null from (\n      select v.empno, v.ename, v.job, v.mgr, v.hiredate,\n          v.sal, v.comm, v.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) v\n      where v.empno = e.empno and \n            v.ename = e.ename and\n            v.job = e.job and\n            v.mgr = e.mgr and\n            v.hiredate = e.hiredate and\n            v.sal = e.sal and\n            v.deptno = e.deptno and\n            v.cnt = e.cnt and \n            coalesce(v.comm, 0) = coalesce(e.comm, 0)\n   )  \n)\n```\n\n```\n//  V EMP\nselect * from (\n   select v.empno, v.ename, v.job, v.mgr, v.hiredate,\n          v.sal, v.comm, v.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) v\n) where not exists (\n   select null from (\n      select e.empno, e.ename, e.job, e.mgr, e.hiredate,\n          e.sal, e.comm, e.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) e\n      where v.empno = e.empno and \n            v.ename = e.ename and\n            v.job = e.job and\n            v.mgr = e.mgr and\n            v.hiredate = e.hiredate and\n            v.sal = e.sal and\n            v.deptno = e.deptno and\n            v.cnt = e.cnt and \n            coalesce(v.comm, 0) = coalesce(e.comm, 0)\n   )  \n)\n```\n\n```\n// \nselect * from (\n   select e.empno, e.ename, e.job, e.mgr, e.hiredate,\n          e.sal, e.comm, e.deptno, count(*) as cnt from emp e\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) e \n) where not exists (\n   select null from (\n      select v.empno, v.ename, v.job, v.mgr, v.hiredate,\n          v.sal, v.comm, v.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) v\n      where v.empno = e.empno and \n            v.ename = e.ename and\n            v.job = e.job and\n            v.mgr = e.mgr and\n            v.hiredate = e.hiredate and\n            v.sal = e.sal and\n            v.deptno = e.deptno and\n            v.cnt = e.cnt and \n            coalesce(v.comm, 0) = coalesce(e.comm, 0)\n   )  \n)\nUnoin all\nselect * from (\n   select v.empno, v.ename, v.job, v.mgr, v.hiredate,\n          v.sal, v.comm, v.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) v\n) where not exists (\n   select null from (\n      select e.empno, e.ename, e.job, e.mgr, e.hiredate,\n          e.sal, e.comm, e.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) e\n      where v.empno = e.empno and \n            v.ename = e.ename and\n            v.job = e.job and\n            v.mgr = e.mgr and\n            v.hiredate = e.hiredate and\n            v.sal = e.sal and\n            v.deptno = e.deptno and\n            v.cnt = e.cnt and \n            coalesce(v.comm, 0) = coalesce(e.comm, 0)\n   )  \n)\n```\n\n### <a id=\"AdvanceApp\"><span class=\"thirdtitle\"></span></a>\n#### \n\nMysql PG  limit  offset  \n```\nselect sal from emp order by sal limit 5 offset 0\n\nselect sal from emp order by sal limit 5 offset 5 \n```\n\n#### \n\nMod\n```\nselect x.name from (\n   select a.ename , (\n      select count(*) from emp b where\n      b.ename <= a.ename\n   ) as rn from emp a \n) x where mod(rn,2) = 1\n```\n\n#### OR\n1. JoinOr\n```\nselect e.ename, d.deptno , d.dname, d.loc from dept d \nleft join emp e on (d.deptno = e.deptno\n                    and (e.deptno=10 or e.deptno=20))\norder by 2 \n```\n\n2. Join\n\nselect e.ename, d.deptno , d.dname, d.loc from dept d\nleft join (select * from emp e where e.deptno=10 or e.deptno=20)\non d.deptno = e.deptno order by 2 \n\n\n#### \n1   \n2 1125  \n\n()\n\n```\nselect distinct v1.* from V v1, V v2 where\n        v1.test1 = v2.test2\n        and v1.test2 = v2.test1\n        and v1.test1 <= v1.test2\n```\n\n#### N\n\nRNK\n```\n// \nselect ename, sal from (\n   select (\n      select (count(distinct b.sal) from emp b where \n             a.sal <= b.sal) as rnk,\n             a.sal,\n             a.ename\n   ) from emp a \n) where rnk <=5\n```\n\n\n\n## <a id=\"OrderBy\"><span class=\"secondtitle\">OrderBy</span></a>\n\n### \n```\n// \nselect * from emp order by col2 asc;\n// \nselect * from emp order by col2 desc;\n```\n\n### \n```\nselect empno, deptno, sal, ename, job from emp order by deptno (asc), sal desc;\n```\n\n### \n```\nselect ename, sal, job, comm from emp order by \n       case when job = \"salesman\" then comm\n            else  sal \n       end;\n```\n\n\n## <a id=\"Update\"><span class=\"secondtitle\"> update </span></a>\n\n### \n```\nupdate table name set col_name = xxx where $cond\n```\n\n## <a id=\"Delete\"><span class=\"secondtitle\">delete</span></a>\n\n  \n```\ndelete from table_name where $cond\n```\n\n\n```\ndelete from table where id not in (select min(id) from table group by name)\n```\n\n# <a id=\"HavingNGroupBy\"><span class=\"toptitle\">Having & GroupBy</span></a>\n```\nwiki\nA HAVING clause in SQL specifies that an SQL SELECT statement should only return rows where aggregate values meet the specified conditions. It was added to the SQL language because the WHERE keyword could not be used with aggregate functions.\nThe HAVING clause filters the data on the group row but not on the individual row.\nTo view the present condition formed by the GROUP BY clause, the HAVING clause is used.\n```\n\nHavingGroupByWhereWhereSum()Count()Avg()   where sum(column_a) , HavingGroupRow\n\n\n```\nselect * from table_a A group by columa_a having count (A.column_a ) > 200\n```\n\n# <a id=\"Notice\"><span class=\"toptitle\"></span></a>\n\n1. Sum max min , avg select \n```\nselect max(Salary) as SecondHighestSalary from employee where salary<(select max(distinct(salary)) from employee)\n```\n\n2. sql \nif (expr1, expr2, expr3)\nexpr2expr3\n\n\n\n# <a id=\"ShareNote\"><span class=\"toptitle\">ShareNote</span></a>\n1. [Visual-Representation-of-SQL](https://www.codeproject.com/Articles/33052/Visual-Representation-of-SQL-Joins)\n2. [Having-Sql-Cluse-wiki](https://en.wikipedia.org/wiki/Having_(SQL))\n3. [Sql](https://book.douban.com/subject/30259463/)\n4. [Sql](https://www.ituring.com.cn/book/miniarticle/47448)","source":"_posts/sql-revise.md","raw":"---\ntitle: SQL\ndate: 2019-09-10 10:05:38\ntags: SQL\n---\n\n<!-- ---\nlayout: post\ntitle: SQL\nauthor: Ray Chan(ray1888)\ndate: '2019-09-10 10:05:38 +0800'\ncategory: sql\nsummary: sql-revise for interview \nthumbnail: sql.jfif\n--- -->\n\n# \n1. [Join](#Join)    \n    1.1 [Join](#BasicJoin)  \n    1.2 [Join](#AdvanceJoin)\n2. [](#ViewNSubquery)  \n    2.1 [](#View)  \n    2.2 [](#Subquery)  \n3. [](#Gramma)  \n    3.1 [Select](#Select)  \n    3.2 [OrderBy](#OrderBy)   \n    3.3 [Update](#Update)  \n    3.4 [Delete](#Delete)  \n4. [Having & GroupBy](#HavingNGroupBy)  \n5. [](#Notice)  \n6. [ShareNote](#ShareNote)  \n\n# \nPythonORMSQLSql\n\n# <a id=\"Join\"><span class=\"toptitle\">Join</span></a> \n## \n```\nTABLE_A\n  PK Value\n---- ----------\n   1 FOX\n   2 COP\n   3 TAXI\n   6 WASHINGTON\n   7 DELL\n   5 ARIZONA\n   4 LINCOLN\n  10 LUCENT\n\nTABLE_B\n  PK Value\n---- ----------\n   1 TROT\n   2 CAR\n   3 CAB\n   6 MONUMENT\n   7 PC\n   8 MICROSOFT\n   9 APPLE\n  11 SCOTCH\n```\n\n## <a id=\"BasicJoin\"><span class=\"secondtitle\">Join</span></a>\n\n### InnerJoin\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/INNER_JOIN.png) -->\n{% asset_img INNER_JOIN.png InnerJoin %}\n\nAB    \n\n```\n-- INNER JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\n       B.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nINNER JOIN Table_B B\nON A.PK = B.PK\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   1 FOX        TROT          1\n   2 COP        CAR           2\n   3 TAXI       CAB           3\n   6 WASHINGTON MONUMENT      6\n   7 DELL       PC            7\n\n(5 row(s) affected)\n```\n\n### LeftJoin\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/LEFT_JOIN.png) -->\n{% asset_img LEFT_JOIN.png LeftJoin %}\n\nA, BIDNull  \n\n```\n-- LEFT JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nLEFT JOIN Table_B B\nON A.PK = B.PK\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   1 FOX        TROT          1\n   2 COP        CAR           2\n   3 TAXI       CAB           3\n   4 LINCOLN    NULL       NULL\n   5 ARIZONA    NULL       NULL\n   6 WASHINGTON MONUMENT      6\n   7 DELL       PC            7\n  10 LUCENT     NULL       NULL\n\n(8 row(s) affected)\n```\n\n### RightJoin\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/RIGHT_JOIN.png) -->\n{% asset_img RIGHT_JOIN.png RightJoin %}\n\nBAIDNull  \n\n```\n-- RIGHT JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nRIGHT JOIN Table_B B\nON A.PK = B.PK\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   1 FOX        TROT          1\n   2 COP        CAR           2\n   3 TAXI       CAB           3\n   6 WASHINGTON MONUMENT      6\n   7 DELL       PC            7\nNULL NULL       MICROSOFT     8\nNULL NULL       APPLE         9\nNULL NULL       SCOTCH       11\n\n(8 row(s) affected)\n```\n\n### OuterJoin\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/FULL_OUTER_JOIN.png) -->\n{% asset_img FULL_OUTER_JOIN.png FullOuterJoin %}\n\nAB,NUll  \n\n```\n-- OUTER JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nFULL OUTER JOIN Table_B B\nON A.PK = B.PK\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   1 FOX        TROT          1\n   2 COP        CAR           2\n   3 TAXI       CAB           3\n   6 WASHINGTON MONUMENT      6\n   7 DELL       PC            7\nNULL NULL       MICROSOFT     8\nNULL NULL       APPLE         9\nNULL NULL       SCOTCH       11\n   5 ARIZONA    NULL       NULL\n   4 LINCOLN    NULL       NULL\n  10 LUCENT     NULL       NULL\n\n(11 row(s) affected)\n```\n\n## <a id=\"AdvanceJoin\"><span class=\"secondtitle\">Join</span></a>\n\n### LEFT JOIN EXCLUDING INNER JOIN\n\n<!-- ![LeftJoin](/assets/img/posts/sqlJoin/LEFT_EXCLUDING_JOIN.png) -->\n{% asset_img LEFT_EXCLUDING_JOIN.png LeftExcludeJoin %}\n\nABAB  \n```\n-- LEFT EXCLUDING JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nLEFT JOIN Table_B B\nON A.PK = B.PK\nWHERE B.PK IS NULL\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\n   4 LINCOLN    NULL       NULL\n   5 ARIZONA    NULL       NULL\n  10 LUCENT     NULL       NULL\n(3 row(s) affected)\n```\n\n### RIGHT JOIN EXCLUDING INNER JOIN\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/RIGHT_EXCLUDING_JOIN.png) -->\n{% asset_img RIGHT_EXCLUDING_JOIN.png RightExcludeJoin %}\n\n\nABBA  \n```\n-- RIGHT EXCLUDING JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nRIGHT JOIN Table_B B\nON A.PK = B.PK\nWHERE A.PK IS NULL\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\nNULL NULL       MICROSOFT     8\nNULL NULL       APPLE         9\nNULL NULL       SCOTCH       11\n\n(3 row(s) affected)\n```\n\n### OUTER JOIN EXCLUDING INNER JOIN\n\n<!-- ![InnerJoin](/assets/img/posts/sqlJoin/OUTER_EXCLUDING_JOIN.png) -->\n{% asset_img OUTER_EXCLUDING_JOIN.png InnerJoin %}\n\nABABBA  \n```\n-- OUTER EXCLUDING JOIN\nSELECT A.PK AS A_PK, A.Value AS A_Value,\nB.Value AS B_Value, B.PK AS B_PK\nFROM Table_A A\nFULL OUTER JOIN Table_B B\nON A.PK = B.PK\nWHERE A.PK IS NULL\nOR B.PK IS NULL\n\nA_PK A_Value    B_Value    B_PK\n---- ---------- ---------- ----\nNULL NULL       MICROSOFT     8\nNULL NULL       APPLE         9\nNULL NULL       SCOTCH       11\n   5 ARIZONA    NULL       NULL\n   4 LINCOLN    NULL       NULL\n  10 LUCENT     NULL       NULL\n\n(6 row(s) affected)\n```\n\n\n# <a id=\"ViewNSubquery\"><span class=\"toptitle\"></span></a>\n\n## <a id=\"View\"><span class=\"secondtitle\"></span></a>\nSELECT   \n\nSQL SQL   \n  \nSELECT 5-1SELECT \n\ncreate view \n\n\n### \n1. Group By DB\n\n\n## <a id=\"Subquery\"><span class=\"secondtitle\"></span></a>\n\nSELECTSELECT  \n\n```\nselect col_1 from (select col2_ from j  where $cond 1) p where $cond2\n\n\npselect col2_ from j  where $cond 1  j \n```\n\n### \n\n1 1  \n= <>   \n\n#### \n SELECT GROUP BY HAVING ORDERBY   \n\n\n# <a id=\"Gramma\"><span class=\"toptitle\"></span></a>\n\n## <a id=\"Select\"><span class=\"secondtitle\">select</span></a>\n\n\n```\nselect col1, col2, col..... from table1... where $cond\n```\n\n### Select  \n```\nselect * from (select sal as salary, comm as commission from emp) x where salary < 5000\n```\n  \n1. (Sum()Min()Max())\n2. \n3. \n4. \n  \n\n WHERE SELECT WHERE   \nSALARY COMMISSION WHERE   \nFROM WHERE FROM   \nWHERE WHERE   \n  \n  \n### \n```\nselect col1 , col2 ,\n       case when col2 <= 2000 then \"UnderPAID\"\n            when col2 > 4000 then \"OVERPAID\"\n        end as status\n    from emp \n```\n\n[col1, status]  \n\n### \n\n```\n select * from emp limit 1\n```\n\n\n```\nselect * from emp order by rand() limit 5 \n```\n\n### Null\n\n```\n//  col1 \nselect * from emp where col1 is null\n//  col2 \nselect * from emp where col2 is not null\n```\n\n### Union \n\n```\nselect deptno from emp \nunion \nselect deptno from dept \n``` \n  \nUnionunion all   \n```\n// union all \nselect distinct deptno from\n(select deptno from emp \nunion all \nselect deptno from dept )\n```\n\n### Join  \n\n#### \n\n```\nselect e.name, d.loc from emp e , dept d \nwhere e.deptno = 10 and e.deptno = d.deptno\n```\n\n\n\n\n\n\nFROM \n\n\n<!-- ![Union1](/assets/img/posts/sqlPost/Union-1.png) -->\n{% asset_img Union-1.png Union1 %}\nEMP 10 DEPT \nWHERE e.deptno d.deptno EMP.DEPTNO DEPT.DEPTNO\n\n<!-- ![Union2](/assets/img/posts/sqlPost/Union-2.png) -->\n{% asset_img Union-2.png Union2 %}\n\n```\nJoin\nselect e.name, d.loc from emp e  \n   inner join  dept d on e.deptno = d.deptno\n   where e.deptno = 10 \n```\n\n10,Join\n```\nselect e.name, d.loc from emp e  \n   inner join  dept d on e.deptno = d.deptno\n   where (e.deptno = 10) or (e.deptno < 10)\n```\n\n#### \n\n Clerk  \n\n 1. Clerk  \n       2. empJoin  \n```\nselect e.empno, e.name, e.job, e.sal, e.deptno from emp e, \n(select ename, job, sal from emp where job = \"CLERK\") V \nwhere V.ename = e.ename and \n      V.job = e.job and \n      V.sal = e.sal\n```\n\nJoin  \n```\nselect e.empno, e.name, e.job, e.sal, e.deptno from emp e\njoin (select ename, job, sal from emp where job = \"CLERK\") V on (\n    V.ename = e.ename\n    V.job = e.job\n    V.sal = e.sal)\n```\n\n\n#### \n\nnot in Null  \nnull  \nMysql not in  in    or null OrIn Not in   \n\nNull\n```\n// In\nselect deptno from dept where deptno in (10, 50, null)\n~~~~~~~~~~\nDeptno\n--------\n10\n\nselect deptno from dept where (deptno=10 or deptno=50 or deptno=null)\n~~~~~~~~~~\nDeptno\n--------\n10\n\n//Not in \n\nselect deptno from dept where deptno not in (10, 50, null)\n~~~~~~~~~~\nDeptno\n--------\nno rows\n\nselect deptno from dept where deptno not  (deptno=10 or deptno=50 or deptno=null)\n~~~~~~~~~~\nDeptno\n--------\nno rows\n\n```\n\nnull  Not exists  \n```\nselect d.deptno from dept d where\nnot exists (select null from emp e where d.deptno = e.deptno)\n~~~~~~~~~\nDeptno\n--------\n40\n```\n\n\n#### \n\n<!-- ![Union3](/assets/img/posts/sqlPost/Union-3.png) -->\n  \n{% asset_img Union-3.png Union3 %}\n\n```\ncreate view v as \nselect * from emp where deptno != 10\nunion all \nselect * from emp where ename = \"ward\"\n\n```\n\nUNION ALL V EMP EMP V   \n\n```\n//  EMP v\nselect * from (\n   select e.empno, e.ename, e.job, e.mgr, e.hiredate,\n          e.sal, e.comm, e.deptno, count(*) as cnt from emp e\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) e \n) where not exists (\n   select null from (\n      select v.empno, v.ename, v.job, v.mgr, v.hiredate,\n          v.sal, v.comm, v.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) v\n      where v.empno = e.empno and \n            v.ename = e.ename and\n            v.job = e.job and\n            v.mgr = e.mgr and\n            v.hiredate = e.hiredate and\n            v.sal = e.sal and\n            v.deptno = e.deptno and\n            v.cnt = e.cnt and \n            coalesce(v.comm, 0) = coalesce(e.comm, 0)\n   )  \n)\n```\n\n```\n//  V EMP\nselect * from (\n   select v.empno, v.ename, v.job, v.mgr, v.hiredate,\n          v.sal, v.comm, v.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) v\n) where not exists (\n   select null from (\n      select e.empno, e.ename, e.job, e.mgr, e.hiredate,\n          e.sal, e.comm, e.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) e\n      where v.empno = e.empno and \n            v.ename = e.ename and\n            v.job = e.job and\n            v.mgr = e.mgr and\n            v.hiredate = e.hiredate and\n            v.sal = e.sal and\n            v.deptno = e.deptno and\n            v.cnt = e.cnt and \n            coalesce(v.comm, 0) = coalesce(e.comm, 0)\n   )  \n)\n```\n\n```\n// \nselect * from (\n   select e.empno, e.ename, e.job, e.mgr, e.hiredate,\n          e.sal, e.comm, e.deptno, count(*) as cnt from emp e\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) e \n) where not exists (\n   select null from (\n      select v.empno, v.ename, v.job, v.mgr, v.hiredate,\n          v.sal, v.comm, v.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) v\n      where v.empno = e.empno and \n            v.ename = e.ename and\n            v.job = e.job and\n            v.mgr = e.mgr and\n            v.hiredate = e.hiredate and\n            v.sal = e.sal and\n            v.deptno = e.deptno and\n            v.cnt = e.cnt and \n            coalesce(v.comm, 0) = coalesce(e.comm, 0)\n   )  \n)\nUnoin all\nselect * from (\n   select v.empno, v.ename, v.job, v.mgr, v.hiredate,\n          v.sal, v.comm, v.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) v\n) where not exists (\n   select null from (\n      select e.empno, e.ename, e.job, e.mgr, e.hiredate,\n          e.sal, e.comm, e.deptno, count(*) as cnt from v\n          group by empno, ename, job, mgr, hiredate,\n                   sal, comm, deptno) e\n      where v.empno = e.empno and \n            v.ename = e.ename and\n            v.job = e.job and\n            v.mgr = e.mgr and\n            v.hiredate = e.hiredate and\n            v.sal = e.sal and\n            v.deptno = e.deptno and\n            v.cnt = e.cnt and \n            coalesce(v.comm, 0) = coalesce(e.comm, 0)\n   )  \n)\n```\n\n### <a id=\"AdvanceApp\"><span class=\"thirdtitle\"></span></a>\n#### \n\nMysql PG  limit  offset  \n```\nselect sal from emp order by sal limit 5 offset 0\n\nselect sal from emp order by sal limit 5 offset 5 \n```\n\n#### \n\nMod\n```\nselect x.name from (\n   select a.ename , (\n      select count(*) from emp b where\n      b.ename <= a.ename\n   ) as rn from emp a \n) x where mod(rn,2) = 1\n```\n\n#### OR\n1. JoinOr\n```\nselect e.ename, d.deptno , d.dname, d.loc from dept d \nleft join emp e on (d.deptno = e.deptno\n                    and (e.deptno=10 or e.deptno=20))\norder by 2 \n```\n\n2. Join\n\nselect e.ename, d.deptno , d.dname, d.loc from dept d\nleft join (select * from emp e where e.deptno=10 or e.deptno=20)\non d.deptno = e.deptno order by 2 \n\n\n#### \n1   \n2 1125  \n\n()\n\n```\nselect distinct v1.* from V v1, V v2 where\n        v1.test1 = v2.test2\n        and v1.test2 = v2.test1\n        and v1.test1 <= v1.test2\n```\n\n#### N\n\nRNK\n```\n// \nselect ename, sal from (\n   select (\n      select (count(distinct b.sal) from emp b where \n             a.sal <= b.sal) as rnk,\n             a.sal,\n             a.ename\n   ) from emp a \n) where rnk <=5\n```\n\n\n\n## <a id=\"OrderBy\"><span class=\"secondtitle\">OrderBy</span></a>\n\n### \n```\n// \nselect * from emp order by col2 asc;\n// \nselect * from emp order by col2 desc;\n```\n\n### \n```\nselect empno, deptno, sal, ename, job from emp order by deptno (asc), sal desc;\n```\n\n### \n```\nselect ename, sal, job, comm from emp order by \n       case when job = \"salesman\" then comm\n            else  sal \n       end;\n```\n\n\n## <a id=\"Update\"><span class=\"secondtitle\"> update </span></a>\n\n### \n```\nupdate table name set col_name = xxx where $cond\n```\n\n## <a id=\"Delete\"><span class=\"secondtitle\">delete</span></a>\n\n  \n```\ndelete from table_name where $cond\n```\n\n\n```\ndelete from table where id not in (select min(id) from table group by name)\n```\n\n# <a id=\"HavingNGroupBy\"><span class=\"toptitle\">Having & GroupBy</span></a>\n```\nwiki\nA HAVING clause in SQL specifies that an SQL SELECT statement should only return rows where aggregate values meet the specified conditions. It was added to the SQL language because the WHERE keyword could not be used with aggregate functions.\nThe HAVING clause filters the data on the group row but not on the individual row.\nTo view the present condition formed by the GROUP BY clause, the HAVING clause is used.\n```\n\nHavingGroupByWhereWhereSum()Count()Avg()   where sum(column_a) , HavingGroupRow\n\n\n```\nselect * from table_a A group by columa_a having count (A.column_a ) > 200\n```\n\n# <a id=\"Notice\"><span class=\"toptitle\"></span></a>\n\n1. Sum max min , avg select \n```\nselect max(Salary) as SecondHighestSalary from employee where salary<(select max(distinct(salary)) from employee)\n```\n\n2. sql \nif (expr1, expr2, expr3)\nexpr2expr3\n\n\n\n# <a id=\"ShareNote\"><span class=\"toptitle\">ShareNote</span></a>\n1. [Visual-Representation-of-SQL](https://www.codeproject.com/Articles/33052/Visual-Representation-of-SQL-Joins)\n2. [Having-Sql-Cluse-wiki](https://en.wikipedia.org/wiki/Having_(SQL))\n3. [Sql](https://book.douban.com/subject/30259463/)\n4. [Sql](https://www.ituring.com.cn/book/miniarticle/47448)","slug":"sql-revise","published":1,"updated":"2021-01-21T07:01:46.844Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk6iras3000nk9i5dse38iw3","content":"<!-- ---\nlayout: post\ntitle: SQL\nauthor: Ray Chan(ray1888)\ndate: '2019-09-10 10:05:38 +0800'\ncategory: sql\nsummary: sql-revise for interview \nthumbnail: sql.jfif\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#Join\">Join</a><br> 1.1 <a href=\"#BasicJoin\">Join</a><br> 1.2 <a href=\"#AdvanceJoin\">Join</a></li>\n<li><a href=\"#ViewNSubquery\"></a><br> 2.1 <a href=\"#View\"></a><br> 2.2 <a href=\"#Subquery\"></a>  </li>\n<li><a href=\"#Gramma\"></a><br> 3.1 <a href=\"#Select\">Select</a><br> 3.2 <a href=\"#OrderBy\">OrderBy</a><br> 3.3 <a href=\"#Update\">Update</a><br> 3.4 <a href=\"#Delete\">Delete</a>  </li>\n<li><a href=\"#HavingNGroupBy\">Having &amp; GroupBy</a>  </li>\n<li><a href=\"#Notice\"></a>  </li>\n<li><a href=\"#ShareNote\">ShareNote</a>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>PythonORMSQLSql</p>\n\n        <h1 id=\"Join\"   >\n          <a href=\"#Join\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Join</h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TABLE_A</span><br><span class=\"line\">  PK Value</span><br><span class=\"line\">---- ----------</span><br><span class=\"line\">   1 FOX</span><br><span class=\"line\">   2 COP</span><br><span class=\"line\">   3 TAXI</span><br><span class=\"line\">   6 WASHINGTON</span><br><span class=\"line\">   7 DELL</span><br><span class=\"line\">   5 ARIZONA</span><br><span class=\"line\">   4 LINCOLN</span><br><span class=\"line\">  10 LUCENT</span><br><span class=\"line\"></span><br><span class=\"line\">TABLE_B</span><br><span class=\"line\">  PK Value</span><br><span class=\"line\">---- ----------</span><br><span class=\"line\">   1 TROT</span><br><span class=\"line\">   2 CAR</span><br><span class=\"line\">   3 CAB</span><br><span class=\"line\">   6 MONUMENT</span><br><span class=\"line\">   7 PC</span><br><span class=\"line\">   8 MICROSOFT</span><br><span class=\"line\">   9 APPLE</span><br><span class=\"line\">  11 SCOTCH</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Join\"   >\n          <a href=\"#Join\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Join</h2>\n      \n        <h3 id=\"InnerJoin\"   >\n          <a href=\"#InnerJoin\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>InnerJoin</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/INNER_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/INNER_JOIN.png\" class=\"\" title=\"InnerJoin\">\n\n<p>AB    </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- INNER JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">       B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">INNER JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   1 FOX        TROT          1</span><br><span class=\"line\">   2 COP        CAR           2</span><br><span class=\"line\">   3 TAXI       CAB           3</span><br><span class=\"line\">   6 WASHINGTON MONUMENT      6</span><br><span class=\"line\">   7 DELL       PC            7</span><br><span class=\"line\"></span><br><span class=\"line\">(5 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"LeftJoin\"   >\n          <a href=\"#LeftJoin\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>LeftJoin</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/LEFT_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/LEFT_JOIN.png\" class=\"\" title=\"LeftJoin\">\n\n<p>A, BIDNull  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- LEFT JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">LEFT JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   1 FOX        TROT          1</span><br><span class=\"line\">   2 COP        CAR           2</span><br><span class=\"line\">   3 TAXI       CAB           3</span><br><span class=\"line\">   4 LINCOLN    NULL       NULL</span><br><span class=\"line\">   5 ARIZONA    NULL       NULL</span><br><span class=\"line\">   6 WASHINGTON MONUMENT      6</span><br><span class=\"line\">   7 DELL       PC            7</span><br><span class=\"line\">  10 LUCENT     NULL       NULL</span><br><span class=\"line\"></span><br><span class=\"line\">(8 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"RightJoin\"   >\n          <a href=\"#RightJoin\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>RightJoin</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/RIGHT_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/RIGHT_JOIN.png\" class=\"\" title=\"RightJoin\">\n\n<p>BAIDNull  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- RIGHT JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">RIGHT JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   1 FOX        TROT          1</span><br><span class=\"line\">   2 COP        CAR           2</span><br><span class=\"line\">   3 TAXI       CAB           3</span><br><span class=\"line\">   6 WASHINGTON MONUMENT      6</span><br><span class=\"line\">   7 DELL       PC            7</span><br><span class=\"line\">NULL NULL       MICROSOFT     8</span><br><span class=\"line\">NULL NULL       APPLE         9</span><br><span class=\"line\">NULL NULL       SCOTCH       11</span><br><span class=\"line\"></span><br><span class=\"line\">(8 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"OuterJoin\"   >\n          <a href=\"#OuterJoin\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>OuterJoin</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/FULL_OUTER_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/FULL_OUTER_JOIN.png\" class=\"\" title=\"FullOuterJoin\">\n\n<p>AB,NUll  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- OUTER JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">FULL OUTER JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   1 FOX        TROT          1</span><br><span class=\"line\">   2 COP        CAR           2</span><br><span class=\"line\">   3 TAXI       CAB           3</span><br><span class=\"line\">   6 WASHINGTON MONUMENT      6</span><br><span class=\"line\">   7 DELL       PC            7</span><br><span class=\"line\">NULL NULL       MICROSOFT     8</span><br><span class=\"line\">NULL NULL       APPLE         9</span><br><span class=\"line\">NULL NULL       SCOTCH       11</span><br><span class=\"line\">   5 ARIZONA    NULL       NULL</span><br><span class=\"line\">   4 LINCOLN    NULL       NULL</span><br><span class=\"line\">  10 LUCENT     NULL       NULL</span><br><span class=\"line\"></span><br><span class=\"line\">(11 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Join\"   >\n          <a href=\"#Join\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Join</h2>\n      \n        <h3 id=\"LEFT-JOIN-EXCLUDING-INNER-JOIN\"   >\n          <a href=\"#LEFT-JOIN-EXCLUDING-INNER-JOIN\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>LEFT JOIN EXCLUDING INNER JOIN</h3>\n      <!-- ![LeftJoin](/assets/img/posts/sqlJoin/LEFT_EXCLUDING_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/LEFT_EXCLUDING_JOIN.png\" class=\"\" title=\"LeftExcludeJoin\">\n\n<p>ABAB  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- LEFT EXCLUDING JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">LEFT JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\">WHERE B.PK IS NULL</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   4 LINCOLN    NULL       NULL</span><br><span class=\"line\">   5 ARIZONA    NULL       NULL</span><br><span class=\"line\">  10 LUCENT     NULL       NULL</span><br><span class=\"line\">(3 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"RIGHT-JOIN-EXCLUDING-INNER-JOIN\"   >\n          <a href=\"#RIGHT-JOIN-EXCLUDING-INNER-JOIN\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>RIGHT JOIN EXCLUDING INNER JOIN</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/RIGHT_EXCLUDING_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/RIGHT_EXCLUDING_JOIN.png\" class=\"\" title=\"RightExcludeJoin\">\n\n\n<p>ABBA  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- RIGHT EXCLUDING JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">RIGHT JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\">WHERE A.PK IS NULL</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">NULL NULL       MICROSOFT     8</span><br><span class=\"line\">NULL NULL       APPLE         9</span><br><span class=\"line\">NULL NULL       SCOTCH       11</span><br><span class=\"line\"></span><br><span class=\"line\">(3 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"OUTER-JOIN-EXCLUDING-INNER-JOIN\"   >\n          <a href=\"#OUTER-JOIN-EXCLUDING-INNER-JOIN\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>OUTER JOIN EXCLUDING INNER JOIN</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/OUTER_EXCLUDING_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/OUTER_EXCLUDING_JOIN.png\" class=\"\" title=\"InnerJoin\">\n\n<p>ABABBA  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- OUTER EXCLUDING JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">FULL OUTER JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\">WHERE A.PK IS NULL</span><br><span class=\"line\">OR B.PK IS NULL</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">NULL NULL       MICROSOFT     8</span><br><span class=\"line\">NULL NULL       APPLE         9</span><br><span class=\"line\">NULL NULL       SCOTCH       11</span><br><span class=\"line\">   5 ARIZONA    NULL       NULL</span><br><span class=\"line\">   4 LINCOLN    NULL       NULL</span><br><span class=\"line\">  10 LUCENT     NULL       NULL</span><br><span class=\"line\"></span><br><span class=\"line\">(6 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>SELECT   </p>\n<p>SQL SQL <br><br>SELECT 5-1SELECT </p>\n<p>create view </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li>Group By DB</li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>SELECTSELECT  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select col_1 from (select col2_ from j  where $cond 1) p where $cond2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pselect col2_ from j  where $cond 1  j </span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>1 1<br>= &lt;&gt;   </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> SELECT GROUP BY HAVING ORDERBY   </p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"select\"   >\n          <a href=\"#select\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>select</h2>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select col1, col2, col..... from table1... where $cond</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"Select--\"   >\n          <a href=\"#Select--\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Select  </h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from (select sal as salary, comm as commission from emp) x where salary &lt; 5000</span><br></pre></td></tr></table></div></figure>\n<p>  </p>\n<ol>\n<li>(Sum()Min()Max())</li>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p><br> WHERE SELECT WHERE <br>SALARY COMMISSION WHERE <br>FROM WHERE FROM <br>WHERE WHERE <br>  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select col1 , col2 ,</span><br><span class=\"line\">       case when col2 &lt;&#x3D; 2000 then &quot;UnderPAID&quot;</span><br><span class=\"line\">            when col2 &gt; 4000 then &quot;OVERPAID&quot;</span><br><span class=\"line\">        end as status</span><br><span class=\"line\">    from emp </span><br></pre></td></tr></table></div></figure>\n<p>[col1, status]  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from emp limit 1</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from emp order by rand() limit 5 </span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"Null\"   >\n          <a href=\"#Null\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Null</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  col1 </span><br><span class=\"line\">select * from emp where col1 is null</span><br><span class=\"line\">&#x2F;&#x2F;  col2 </span><br><span class=\"line\">select * from emp where col2 is not null</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"Union\"   >\n          <a href=\"#Union\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Union</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select deptno from emp </span><br><span class=\"line\">union </span><br><span class=\"line\">select deptno from dept </span><br></pre></td></tr></table></div></figure>\n\n<p>Unionunion all   </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; union all </span><br><span class=\"line\">select distinct deptno from</span><br><span class=\"line\">(select deptno from emp </span><br><span class=\"line\">union all </span><br><span class=\"line\">select deptno from dept )</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"Join\"   >\n          <a href=\"#Join\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Join</h3>\n      \n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.name, d.loc from emp e , dept d </span><br><span class=\"line\">where e.deptno &#x3D; 10 and e.deptno &#x3D; d.deptno</span><br></pre></td></tr></table></div></figure>\n<p><br><br><br></p>\n<p>FROM <br></p>\n<!-- ![Union1](/assets/img/posts/sqlPost/Union-1.png) -->\n<img src=\"/2019/09/10/sql-revise/Union-1.png\" class=\"\" title=\"Union1\">\n<p>EMP 10 DEPT <br>WHERE e.deptno d.deptno EMP.DEPTNO DEPT.DEPTNO<br></p>\n<!-- ![Union2](/assets/img/posts/sqlPost/Union-2.png) -->\n<img src=\"/2019/09/10/sql-revise/Union-2.png\" class=\"\" title=\"Union2\">\n\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Join</span><br><span class=\"line\">select e.name, d.loc from emp e  </span><br><span class=\"line\">   inner join  dept d on e.deptno &#x3D; d.deptno</span><br><span class=\"line\">   where e.deptno &#x3D; 10 </span><br></pre></td></tr></table></div></figure>\n<p>10,Join</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.name, d.loc from emp e  </span><br><span class=\"line\">   inner join  dept d on e.deptno &#x3D; d.deptno</span><br><span class=\"line\">   where (e.deptno &#x3D; 10) or (e.deptno &lt; 10)</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> Clerk  </p>\n<p> 1. Clerk<br>       2. empJoin  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.empno, e.name, e.job, e.sal, e.deptno from emp e, </span><br><span class=\"line\">(select ename, job, sal from emp where job &#x3D; &quot;CLERK&quot;) V </span><br><span class=\"line\">where V.ename &#x3D; e.ename and </span><br><span class=\"line\">      V.job &#x3D; e.job and </span><br><span class=\"line\">      V.sal &#x3D; e.sal</span><br></pre></td></tr></table></div></figure>\n<p>Join  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.empno, e.name, e.job, e.sal, e.deptno from emp e</span><br><span class=\"line\">join (select ename, job, sal from emp where job &#x3D; &quot;CLERK&quot;) V on (</span><br><span class=\"line\">    V.ename &#x3D; e.ename</span><br><span class=\"line\">    V.job &#x3D; e.job</span><br><span class=\"line\">    V.sal &#x3D; e.sal)</span><br></pre></td></tr></table></div></figure>\n\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>not in Null<br>null<br>Mysql not in  in    or null OrIn Not in   </p>\n<p>Null</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; In</span><br><span class=\"line\">select deptno from dept where deptno in (10, 50, null)</span><br><span class=\"line\">~~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">10</span><br><span class=\"line\"></span><br><span class=\"line\">select deptno from dept where (deptno&#x3D;10 or deptno&#x3D;50 or deptno&#x3D;null)</span><br><span class=\"line\">~~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">10</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;Not in </span><br><span class=\"line\"></span><br><span class=\"line\">select deptno from dept where deptno not in (10, 50, null)</span><br><span class=\"line\">~~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">no rows</span><br><span class=\"line\"></span><br><span class=\"line\">select deptno from dept where deptno not  (deptno&#x3D;10 or deptno&#x3D;50 or deptno&#x3D;null)</span><br><span class=\"line\">~~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">no rows</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>null  Not exists  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select d.deptno from dept d where</span><br><span class=\"line\">not exists (select null from emp e where d.deptno &#x3D; e.deptno)</span><br><span class=\"line\">~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">40</span><br></pre></td></tr></table></div></figure>\n\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <!-- ![Union3](/assets/img/posts/sqlPost/Union-3.png) -->\n<p>  </p>\n<img src=\"/2019/09/10/sql-revise/Union-3.png\" class=\"\" title=\"Union3\">\n\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create view v as </span><br><span class=\"line\">select * from emp where deptno !&#x3D; 10</span><br><span class=\"line\">union all </span><br><span class=\"line\">select * from emp where ename &#x3D; &quot;ward&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>UNION ALL V EMP EMP V   </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  EMP v</span><br><span class=\"line\">select * from (</span><br><span class=\"line\">   select e.empno, e.ename, e.job, e.mgr, e.hiredate,</span><br><span class=\"line\">          e.sal, e.comm, e.deptno, count(*) as cnt from emp e</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) e </span><br><span class=\"line\">) where not exists (</span><br><span class=\"line\">   select null from (</span><br><span class=\"line\">      select v.empno, v.ename, v.job, v.mgr, v.hiredate,</span><br><span class=\"line\">          v.sal, v.comm, v.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) v</span><br><span class=\"line\">      where v.empno &#x3D; e.empno and </span><br><span class=\"line\">            v.ename &#x3D; e.ename and</span><br><span class=\"line\">            v.job &#x3D; e.job and</span><br><span class=\"line\">            v.mgr &#x3D; e.mgr and</span><br><span class=\"line\">            v.hiredate &#x3D; e.hiredate and</span><br><span class=\"line\">            v.sal &#x3D; e.sal and</span><br><span class=\"line\">            v.deptno &#x3D; e.deptno and</span><br><span class=\"line\">            v.cnt &#x3D; e.cnt and </span><br><span class=\"line\">            coalesce(v.comm, 0) &#x3D; coalesce(e.comm, 0)</span><br><span class=\"line\">   )  </span><br><span class=\"line\">)</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  V EMP</span><br><span class=\"line\">select * from (</span><br><span class=\"line\">   select v.empno, v.ename, v.job, v.mgr, v.hiredate,</span><br><span class=\"line\">          v.sal, v.comm, v.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) v</span><br><span class=\"line\">) where not exists (</span><br><span class=\"line\">   select null from (</span><br><span class=\"line\">      select e.empno, e.ename, e.job, e.mgr, e.hiredate,</span><br><span class=\"line\">          e.sal, e.comm, e.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) e</span><br><span class=\"line\">      where v.empno &#x3D; e.empno and </span><br><span class=\"line\">            v.ename &#x3D; e.ename and</span><br><span class=\"line\">            v.job &#x3D; e.job and</span><br><span class=\"line\">            v.mgr &#x3D; e.mgr and</span><br><span class=\"line\">            v.hiredate &#x3D; e.hiredate and</span><br><span class=\"line\">            v.sal &#x3D; e.sal and</span><br><span class=\"line\">            v.deptno &#x3D; e.deptno and</span><br><span class=\"line\">            v.cnt &#x3D; e.cnt and </span><br><span class=\"line\">            coalesce(v.comm, 0) &#x3D; coalesce(e.comm, 0)</span><br><span class=\"line\">   )  </span><br><span class=\"line\">)</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">select * from (</span><br><span class=\"line\">   select e.empno, e.ename, e.job, e.mgr, e.hiredate,</span><br><span class=\"line\">          e.sal, e.comm, e.deptno, count(*) as cnt from emp e</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) e </span><br><span class=\"line\">) where not exists (</span><br><span class=\"line\">   select null from (</span><br><span class=\"line\">      select v.empno, v.ename, v.job, v.mgr, v.hiredate,</span><br><span class=\"line\">          v.sal, v.comm, v.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) v</span><br><span class=\"line\">      where v.empno &#x3D; e.empno and </span><br><span class=\"line\">            v.ename &#x3D; e.ename and</span><br><span class=\"line\">            v.job &#x3D; e.job and</span><br><span class=\"line\">            v.mgr &#x3D; e.mgr and</span><br><span class=\"line\">            v.hiredate &#x3D; e.hiredate and</span><br><span class=\"line\">            v.sal &#x3D; e.sal and</span><br><span class=\"line\">            v.deptno &#x3D; e.deptno and</span><br><span class=\"line\">            v.cnt &#x3D; e.cnt and </span><br><span class=\"line\">            coalesce(v.comm, 0) &#x3D; coalesce(e.comm, 0)</span><br><span class=\"line\">   )  </span><br><span class=\"line\">)</span><br><span class=\"line\">Unoin all</span><br><span class=\"line\">select * from (</span><br><span class=\"line\">   select v.empno, v.ename, v.job, v.mgr, v.hiredate,</span><br><span class=\"line\">          v.sal, v.comm, v.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) v</span><br><span class=\"line\">) where not exists (</span><br><span class=\"line\">   select null from (</span><br><span class=\"line\">      select e.empno, e.ename, e.job, e.mgr, e.hiredate,</span><br><span class=\"line\">          e.sal, e.comm, e.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) e</span><br><span class=\"line\">      where v.empno &#x3D; e.empno and </span><br><span class=\"line\">            v.ename &#x3D; e.ename and</span><br><span class=\"line\">            v.job &#x3D; e.job and</span><br><span class=\"line\">            v.mgr &#x3D; e.mgr and</span><br><span class=\"line\">            v.hiredate &#x3D; e.hiredate and</span><br><span class=\"line\">            v.sal &#x3D; e.sal and</span><br><span class=\"line\">            v.deptno &#x3D; e.deptno and</span><br><span class=\"line\">            v.cnt &#x3D; e.cnt and </span><br><span class=\"line\">            coalesce(v.comm, 0) &#x3D; coalesce(e.comm, 0)</span><br><span class=\"line\">   )  </span><br><span class=\"line\">)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      \n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>Mysql PG  limit  offset  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select sal from emp order by sal limit 5 offset 0</span><br><span class=\"line\"></span><br><span class=\"line\">select sal from emp order by sal limit 5 offset 5 </span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><br>Mod</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select x.name from (</span><br><span class=\"line\">   select a.ename , (</span><br><span class=\"line\">      select count(*) from emp b where</span><br><span class=\"line\">      b.ename &lt;&#x3D; a.ename</span><br><span class=\"line\">   ) as rn from emp a </span><br><span class=\"line\">) x where mod(rn,2) &#x3D; 1</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"OR\"   >\n          <a href=\"#OR\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>OR</h4>\n      <ol>\n<li>JoinOr<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.ename, d.deptno , d.dname, d.loc from dept d </span><br><span class=\"line\">left join emp e on (d.deptno &#x3D; e.deptno</span><br><span class=\"line\">                    and (e.deptno&#x3D;10 or e.deptno&#x3D;20))</span><br><span class=\"line\">order by 2 </span><br></pre></td></tr></table></div></figure></li>\n<li>Join</li>\n</ol>\n<p>select e.ename, d.deptno , d.dname, d.loc from dept d<br>left join (select * from emp e where e.deptno=10 or e.deptno=20)<br>on d.deptno = e.deptno order by 2 </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>1 <br>2 1125  </p>\n<p>()</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select distinct v1.* from V v1, V v2 where</span><br><span class=\"line\">        v1.test1 &#x3D; v2.test2</span><br><span class=\"line\">        and v1.test2 &#x3D; v2.test1</span><br><span class=\"line\">        and v1.test1 &lt;&#x3D; v1.test2</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"N\"   >\n          <a href=\"#N\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>N</h4>\n      <p>RNK</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">select ename, sal from (</span><br><span class=\"line\">   select (</span><br><span class=\"line\">      select (count(distinct b.sal) from emp b where </span><br><span class=\"line\">             a.sal &lt;&#x3D; b.sal) as rnk,</span><br><span class=\"line\">             a.sal,</span><br><span class=\"line\">             a.ename</span><br><span class=\"line\">   ) from emp a </span><br><span class=\"line\">) where rnk &lt;&#x3D;5</span><br></pre></td></tr></table></div></figure>\n\n\n\n        <h2 id=\"OrderBy\"   >\n          <a href=\"#OrderBy\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>OrderBy</h2>\n      \n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">select * from emp order by col2 asc;</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">select * from emp order by col2 desc;</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select empno, deptno, sal, ename, job from emp order by deptno (asc), sal desc;</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select ename, sal, job, comm from emp order by </span><br><span class=\"line\">       case when job &#x3D; &quot;salesman&quot; then comm</span><br><span class=\"line\">            else  sal </span><br><span class=\"line\">       end;</span><br></pre></td></tr></table></div></figure>\n\n\n        <h2 id=\"update\"   >\n          <a href=\"#update\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>update</h2>\n      \n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">update table name set col_name &#x3D; xxx where $cond</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"delete\"   >\n          <a href=\"#delete\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>delete</h2>\n      <p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delete from table_name where $cond</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delete from table where id not in (select min(id) from table group by name)</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"Having-amp-GroupBy\"   >\n          <a href=\"#Having-amp-GroupBy\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Having &amp; GroupBy</h1>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wiki</span><br><span class=\"line\">A HAVING clause in SQL specifies that an SQL SELECT statement should only return rows where aggregate values meet the specified conditions. It was added to the SQL language because the WHERE keyword could not be used with aggregate functions.</span><br><span class=\"line\">The HAVING clause filters the data on the group row but not on the individual row.</span><br><span class=\"line\">To view the present condition formed by the GROUP BY clause, the HAVING clause is used.</span><br></pre></td></tr></table></div></figure>\n<p>HavingGroupByWhereWhereSum()Count()Avg()   where sum(column_a) , HavingGroupRow</p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from table_a A group by columa_a having count (A.column_a ) &gt; 200</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li>Sum max min , avg select <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select max(Salary) as SecondHighestSalary from employee where salary&lt;(select max(distinct(salary)) from employee)</span><br></pre></td></tr></table></div></figure></li>\n<li>sql <br>if (expr1, expr2, expr3)<br>expr2expr3</li>\n</ol>\n\n        <h1 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote</h1>\n      <ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.codeproject.com/Articles/33052/Visual-Representation-of-SQL-Joins\" >Visual-Representation-of-SQL</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://en.wikipedia.org/wiki/Having_(SQL)\" >Having-Sql-Cluse-wiki</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://book.douban.com/subject/30259463/\" >Sql</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.ituring.com.cn/book/miniarticle/47448\" >Sql</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<!-- ---\nlayout: post\ntitle: SQL\nauthor: Ray Chan(ray1888)\ndate: '2019-09-10 10:05:38 +0800'\ncategory: sql\nsummary: sql-revise for interview \nthumbnail: sql.jfif\n--- -->\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li><a href=\"#Join\">Join</a><br> 1.1 <a href=\"#BasicJoin\">Join</a><br> 1.2 <a href=\"#AdvanceJoin\">Join</a></li>\n<li><a href=\"#ViewNSubquery\"></a><br> 2.1 <a href=\"#View\"></a><br> 2.2 <a href=\"#Subquery\"></a>  </li>\n<li><a href=\"#Gramma\"></a><br> 3.1 <a href=\"#Select\">Select</a><br> 3.2 <a href=\"#OrderBy\">OrderBy</a><br> 3.3 <a href=\"#Update\">Update</a><br> 3.4 <a href=\"#Delete\">Delete</a>  </li>\n<li><a href=\"#HavingNGroupBy\">Having &amp; GroupBy</a>  </li>\n<li><a href=\"#Notice\"></a>  </li>\n<li><a href=\"#ShareNote\">ShareNote</a>  </li>\n</ol>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <p>PythonORMSQLSql</p>\n\n        <h1 id=\"Join\"   >\n          <a href=\"#Join\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Join</h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TABLE_A</span><br><span class=\"line\">  PK Value</span><br><span class=\"line\">---- ----------</span><br><span class=\"line\">   1 FOX</span><br><span class=\"line\">   2 COP</span><br><span class=\"line\">   3 TAXI</span><br><span class=\"line\">   6 WASHINGTON</span><br><span class=\"line\">   7 DELL</span><br><span class=\"line\">   5 ARIZONA</span><br><span class=\"line\">   4 LINCOLN</span><br><span class=\"line\">  10 LUCENT</span><br><span class=\"line\"></span><br><span class=\"line\">TABLE_B</span><br><span class=\"line\">  PK Value</span><br><span class=\"line\">---- ----------</span><br><span class=\"line\">   1 TROT</span><br><span class=\"line\">   2 CAR</span><br><span class=\"line\">   3 CAB</span><br><span class=\"line\">   6 MONUMENT</span><br><span class=\"line\">   7 PC</span><br><span class=\"line\">   8 MICROSOFT</span><br><span class=\"line\">   9 APPLE</span><br><span class=\"line\">  11 SCOTCH</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Join\"   >\n          <a href=\"#Join\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Join</h2>\n      \n        <h3 id=\"InnerJoin\"   >\n          <a href=\"#InnerJoin\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>InnerJoin</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/INNER_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/INNER_JOIN.png\" class=\"\" title=\"InnerJoin\">\n\n<p>AB    </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- INNER JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">       B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">INNER JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   1 FOX        TROT          1</span><br><span class=\"line\">   2 COP        CAR           2</span><br><span class=\"line\">   3 TAXI       CAB           3</span><br><span class=\"line\">   6 WASHINGTON MONUMENT      6</span><br><span class=\"line\">   7 DELL       PC            7</span><br><span class=\"line\"></span><br><span class=\"line\">(5 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"LeftJoin\"   >\n          <a href=\"#LeftJoin\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>LeftJoin</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/LEFT_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/LEFT_JOIN.png\" class=\"\" title=\"LeftJoin\">\n\n<p>A, BIDNull  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- LEFT JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">LEFT JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   1 FOX        TROT          1</span><br><span class=\"line\">   2 COP        CAR           2</span><br><span class=\"line\">   3 TAXI       CAB           3</span><br><span class=\"line\">   4 LINCOLN    NULL       NULL</span><br><span class=\"line\">   5 ARIZONA    NULL       NULL</span><br><span class=\"line\">   6 WASHINGTON MONUMENT      6</span><br><span class=\"line\">   7 DELL       PC            7</span><br><span class=\"line\">  10 LUCENT     NULL       NULL</span><br><span class=\"line\"></span><br><span class=\"line\">(8 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"RightJoin\"   >\n          <a href=\"#RightJoin\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>RightJoin</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/RIGHT_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/RIGHT_JOIN.png\" class=\"\" title=\"RightJoin\">\n\n<p>BAIDNull  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- RIGHT JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">RIGHT JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   1 FOX        TROT          1</span><br><span class=\"line\">   2 COP        CAR           2</span><br><span class=\"line\">   3 TAXI       CAB           3</span><br><span class=\"line\">   6 WASHINGTON MONUMENT      6</span><br><span class=\"line\">   7 DELL       PC            7</span><br><span class=\"line\">NULL NULL       MICROSOFT     8</span><br><span class=\"line\">NULL NULL       APPLE         9</span><br><span class=\"line\">NULL NULL       SCOTCH       11</span><br><span class=\"line\"></span><br><span class=\"line\">(8 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"OuterJoin\"   >\n          <a href=\"#OuterJoin\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>OuterJoin</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/FULL_OUTER_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/FULL_OUTER_JOIN.png\" class=\"\" title=\"FullOuterJoin\">\n\n<p>AB,NUll  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- OUTER JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">FULL OUTER JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   1 FOX        TROT          1</span><br><span class=\"line\">   2 COP        CAR           2</span><br><span class=\"line\">   3 TAXI       CAB           3</span><br><span class=\"line\">   6 WASHINGTON MONUMENT      6</span><br><span class=\"line\">   7 DELL       PC            7</span><br><span class=\"line\">NULL NULL       MICROSOFT     8</span><br><span class=\"line\">NULL NULL       APPLE         9</span><br><span class=\"line\">NULL NULL       SCOTCH       11</span><br><span class=\"line\">   5 ARIZONA    NULL       NULL</span><br><span class=\"line\">   4 LINCOLN    NULL       NULL</span><br><span class=\"line\">  10 LUCENT     NULL       NULL</span><br><span class=\"line\"></span><br><span class=\"line\">(11 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"Join\"   >\n          <a href=\"#Join\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Join</h2>\n      \n        <h3 id=\"LEFT-JOIN-EXCLUDING-INNER-JOIN\"   >\n          <a href=\"#LEFT-JOIN-EXCLUDING-INNER-JOIN\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>LEFT JOIN EXCLUDING INNER JOIN</h3>\n      <!-- ![LeftJoin](/assets/img/posts/sqlJoin/LEFT_EXCLUDING_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/LEFT_EXCLUDING_JOIN.png\" class=\"\" title=\"LeftExcludeJoin\">\n\n<p>ABAB  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- LEFT EXCLUDING JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">LEFT JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\">WHERE B.PK IS NULL</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">   4 LINCOLN    NULL       NULL</span><br><span class=\"line\">   5 ARIZONA    NULL       NULL</span><br><span class=\"line\">  10 LUCENT     NULL       NULL</span><br><span class=\"line\">(3 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"RIGHT-JOIN-EXCLUDING-INNER-JOIN\"   >\n          <a href=\"#RIGHT-JOIN-EXCLUDING-INNER-JOIN\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>RIGHT JOIN EXCLUDING INNER JOIN</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/RIGHT_EXCLUDING_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/RIGHT_EXCLUDING_JOIN.png\" class=\"\" title=\"RightExcludeJoin\">\n\n\n<p>ABBA  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- RIGHT EXCLUDING JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">RIGHT JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\">WHERE A.PK IS NULL</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">NULL NULL       MICROSOFT     8</span><br><span class=\"line\">NULL NULL       APPLE         9</span><br><span class=\"line\">NULL NULL       SCOTCH       11</span><br><span class=\"line\"></span><br><span class=\"line\">(3 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"OUTER-JOIN-EXCLUDING-INNER-JOIN\"   >\n          <a href=\"#OUTER-JOIN-EXCLUDING-INNER-JOIN\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>OUTER JOIN EXCLUDING INNER JOIN</h3>\n      <!-- ![InnerJoin](/assets/img/posts/sqlJoin/OUTER_EXCLUDING_JOIN.png) -->\n<img src=\"/2019/09/10/sql-revise/OUTER_EXCLUDING_JOIN.png\" class=\"\" title=\"InnerJoin\">\n\n<p>ABABBA  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- OUTER EXCLUDING JOIN</span><br><span class=\"line\">SELECT A.PK AS A_PK, A.Value AS A_Value,</span><br><span class=\"line\">B.Value AS B_Value, B.PK AS B_PK</span><br><span class=\"line\">FROM Table_A A</span><br><span class=\"line\">FULL OUTER JOIN Table_B B</span><br><span class=\"line\">ON A.PK &#x3D; B.PK</span><br><span class=\"line\">WHERE A.PK IS NULL</span><br><span class=\"line\">OR B.PK IS NULL</span><br><span class=\"line\"></span><br><span class=\"line\">A_PK A_Value    B_Value    B_PK</span><br><span class=\"line\">---- ---------- ---------- ----</span><br><span class=\"line\">NULL NULL       MICROSOFT     8</span><br><span class=\"line\">NULL NULL       APPLE         9</span><br><span class=\"line\">NULL NULL       SCOTCH       11</span><br><span class=\"line\">   5 ARIZONA    NULL       NULL</span><br><span class=\"line\">   4 LINCOLN    NULL       NULL</span><br><span class=\"line\">  10 LUCENT     NULL       NULL</span><br><span class=\"line\"></span><br><span class=\"line\">(6 row(s) affected)</span><br></pre></td></tr></table></div></figure>\n\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>SELECT   </p>\n<p>SQL SQL <br><br>SELECT 5-1SELECT </p>\n<p>create view </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <ol>\n<li>Group By DB</li>\n</ol>\n\n        <h2 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h2>\n      <p>SELECTSELECT  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select col_1 from (select col2_ from j  where $cond 1) p where $cond2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pselect col2_ from j  where $cond 1  j </span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <p>1 1<br>= &lt;&gt;   </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> SELECT GROUP BY HAVING ORDERBY   </p>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      \n        <h2 id=\"select\"   >\n          <a href=\"#select\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>select</h2>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select col1, col2, col..... from table1... where $cond</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"Select--\"   >\n          <a href=\"#Select--\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Select  </h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from (select sal as salary, comm as commission from emp) x where salary &lt; 5000</span><br></pre></td></tr></table></div></figure>\n<p>  </p>\n<ol>\n<li>(Sum()Min()Max())</li>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p><br> WHERE SELECT WHERE <br>SALARY COMMISSION WHERE <br>FROM WHERE FROM <br>WHERE WHERE <br>  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select col1 , col2 ,</span><br><span class=\"line\">       case when col2 &lt;&#x3D; 2000 then &quot;UnderPAID&quot;</span><br><span class=\"line\">            when col2 &gt; 4000 then &quot;OVERPAID&quot;</span><br><span class=\"line\">        end as status</span><br><span class=\"line\">    from emp </span><br></pre></td></tr></table></div></figure>\n<p>[col1, status]  </p>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from emp limit 1</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from emp order by rand() limit 5 </span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"Null\"   >\n          <a href=\"#Null\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Null</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  col1 </span><br><span class=\"line\">select * from emp where col1 is null</span><br><span class=\"line\">&#x2F;&#x2F;  col2 </span><br><span class=\"line\">select * from emp where col2 is not null</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"Union\"   >\n          <a href=\"#Union\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Union</h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select deptno from emp </span><br><span class=\"line\">union </span><br><span class=\"line\">select deptno from dept </span><br></pre></td></tr></table></div></figure>\n\n<p>Unionunion all   </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; union all </span><br><span class=\"line\">select distinct deptno from</span><br><span class=\"line\">(select deptno from emp </span><br><span class=\"line\">union all </span><br><span class=\"line\">select deptno from dept )</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"Join\"   >\n          <a href=\"#Join\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Join</h3>\n      \n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.name, d.loc from emp e , dept d </span><br><span class=\"line\">where e.deptno &#x3D; 10 and e.deptno &#x3D; d.deptno</span><br></pre></td></tr></table></div></figure>\n<p><br><br><br></p>\n<p>FROM <br></p>\n<!-- ![Union1](/assets/img/posts/sqlPost/Union-1.png) -->\n<img src=\"/2019/09/10/sql-revise/Union-1.png\" class=\"\" title=\"Union1\">\n<p>EMP 10 DEPT <br>WHERE e.deptno d.deptno EMP.DEPTNO DEPT.DEPTNO<br></p>\n<!-- ![Union2](/assets/img/posts/sqlPost/Union-2.png) -->\n<img src=\"/2019/09/10/sql-revise/Union-2.png\" class=\"\" title=\"Union2\">\n\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Join</span><br><span class=\"line\">select e.name, d.loc from emp e  </span><br><span class=\"line\">   inner join  dept d on e.deptno &#x3D; d.deptno</span><br><span class=\"line\">   where e.deptno &#x3D; 10 </span><br></pre></td></tr></table></div></figure>\n<p>10,Join</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.name, d.loc from emp e  </span><br><span class=\"line\">   inner join  dept d on e.deptno &#x3D; d.deptno</span><br><span class=\"line\">   where (e.deptno &#x3D; 10) or (e.deptno &lt; 10)</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p> Clerk  </p>\n<p> 1. Clerk<br>       2. empJoin  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.empno, e.name, e.job, e.sal, e.deptno from emp e, </span><br><span class=\"line\">(select ename, job, sal from emp where job &#x3D; &quot;CLERK&quot;) V </span><br><span class=\"line\">where V.ename &#x3D; e.ename and </span><br><span class=\"line\">      V.job &#x3D; e.job and </span><br><span class=\"line\">      V.sal &#x3D; e.sal</span><br></pre></td></tr></table></div></figure>\n<p>Join  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.empno, e.name, e.job, e.sal, e.deptno from emp e</span><br><span class=\"line\">join (select ename, job, sal from emp where job &#x3D; &quot;CLERK&quot;) V on (</span><br><span class=\"line\">    V.ename &#x3D; e.ename</span><br><span class=\"line\">    V.job &#x3D; e.job</span><br><span class=\"line\">    V.sal &#x3D; e.sal)</span><br></pre></td></tr></table></div></figure>\n\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>not in Null<br>null<br>Mysql not in  in    or null OrIn Not in   </p>\n<p>Null</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; In</span><br><span class=\"line\">select deptno from dept where deptno in (10, 50, null)</span><br><span class=\"line\">~~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">10</span><br><span class=\"line\"></span><br><span class=\"line\">select deptno from dept where (deptno&#x3D;10 or deptno&#x3D;50 or deptno&#x3D;null)</span><br><span class=\"line\">~~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">10</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;Not in </span><br><span class=\"line\"></span><br><span class=\"line\">select deptno from dept where deptno not in (10, 50, null)</span><br><span class=\"line\">~~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">no rows</span><br><span class=\"line\"></span><br><span class=\"line\">select deptno from dept where deptno not  (deptno&#x3D;10 or deptno&#x3D;50 or deptno&#x3D;null)</span><br><span class=\"line\">~~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">no rows</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>null  Not exists  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select d.deptno from dept d where</span><br><span class=\"line\">not exists (select null from emp e where d.deptno &#x3D; e.deptno)</span><br><span class=\"line\">~~~~~~~~~</span><br><span class=\"line\">Deptno</span><br><span class=\"line\">--------</span><br><span class=\"line\">40</span><br></pre></td></tr></table></div></figure>\n\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <!-- ![Union3](/assets/img/posts/sqlPost/Union-3.png) -->\n<p>  </p>\n<img src=\"/2019/09/10/sql-revise/Union-3.png\" class=\"\" title=\"Union3\">\n\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create view v as </span><br><span class=\"line\">select * from emp where deptno !&#x3D; 10</span><br><span class=\"line\">union all </span><br><span class=\"line\">select * from emp where ename &#x3D; &quot;ward&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></div></figure>\n<p>UNION ALL V EMP EMP V   </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  EMP v</span><br><span class=\"line\">select * from (</span><br><span class=\"line\">   select e.empno, e.ename, e.job, e.mgr, e.hiredate,</span><br><span class=\"line\">          e.sal, e.comm, e.deptno, count(*) as cnt from emp e</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) e </span><br><span class=\"line\">) where not exists (</span><br><span class=\"line\">   select null from (</span><br><span class=\"line\">      select v.empno, v.ename, v.job, v.mgr, v.hiredate,</span><br><span class=\"line\">          v.sal, v.comm, v.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) v</span><br><span class=\"line\">      where v.empno &#x3D; e.empno and </span><br><span class=\"line\">            v.ename &#x3D; e.ename and</span><br><span class=\"line\">            v.job &#x3D; e.job and</span><br><span class=\"line\">            v.mgr &#x3D; e.mgr and</span><br><span class=\"line\">            v.hiredate &#x3D; e.hiredate and</span><br><span class=\"line\">            v.sal &#x3D; e.sal and</span><br><span class=\"line\">            v.deptno &#x3D; e.deptno and</span><br><span class=\"line\">            v.cnt &#x3D; e.cnt and </span><br><span class=\"line\">            coalesce(v.comm, 0) &#x3D; coalesce(e.comm, 0)</span><br><span class=\"line\">   )  </span><br><span class=\"line\">)</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;  V EMP</span><br><span class=\"line\">select * from (</span><br><span class=\"line\">   select v.empno, v.ename, v.job, v.mgr, v.hiredate,</span><br><span class=\"line\">          v.sal, v.comm, v.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) v</span><br><span class=\"line\">) where not exists (</span><br><span class=\"line\">   select null from (</span><br><span class=\"line\">      select e.empno, e.ename, e.job, e.mgr, e.hiredate,</span><br><span class=\"line\">          e.sal, e.comm, e.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) e</span><br><span class=\"line\">      where v.empno &#x3D; e.empno and </span><br><span class=\"line\">            v.ename &#x3D; e.ename and</span><br><span class=\"line\">            v.job &#x3D; e.job and</span><br><span class=\"line\">            v.mgr &#x3D; e.mgr and</span><br><span class=\"line\">            v.hiredate &#x3D; e.hiredate and</span><br><span class=\"line\">            v.sal &#x3D; e.sal and</span><br><span class=\"line\">            v.deptno &#x3D; e.deptno and</span><br><span class=\"line\">            v.cnt &#x3D; e.cnt and </span><br><span class=\"line\">            coalesce(v.comm, 0) &#x3D; coalesce(e.comm, 0)</span><br><span class=\"line\">   )  </span><br><span class=\"line\">)</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">select * from (</span><br><span class=\"line\">   select e.empno, e.ename, e.job, e.mgr, e.hiredate,</span><br><span class=\"line\">          e.sal, e.comm, e.deptno, count(*) as cnt from emp e</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) e </span><br><span class=\"line\">) where not exists (</span><br><span class=\"line\">   select null from (</span><br><span class=\"line\">      select v.empno, v.ename, v.job, v.mgr, v.hiredate,</span><br><span class=\"line\">          v.sal, v.comm, v.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) v</span><br><span class=\"line\">      where v.empno &#x3D; e.empno and </span><br><span class=\"line\">            v.ename &#x3D; e.ename and</span><br><span class=\"line\">            v.job &#x3D; e.job and</span><br><span class=\"line\">            v.mgr &#x3D; e.mgr and</span><br><span class=\"line\">            v.hiredate &#x3D; e.hiredate and</span><br><span class=\"line\">            v.sal &#x3D; e.sal and</span><br><span class=\"line\">            v.deptno &#x3D; e.deptno and</span><br><span class=\"line\">            v.cnt &#x3D; e.cnt and </span><br><span class=\"line\">            coalesce(v.comm, 0) &#x3D; coalesce(e.comm, 0)</span><br><span class=\"line\">   )  </span><br><span class=\"line\">)</span><br><span class=\"line\">Unoin all</span><br><span class=\"line\">select * from (</span><br><span class=\"line\">   select v.empno, v.ename, v.job, v.mgr, v.hiredate,</span><br><span class=\"line\">          v.sal, v.comm, v.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) v</span><br><span class=\"line\">) where not exists (</span><br><span class=\"line\">   select null from (</span><br><span class=\"line\">      select e.empno, e.ename, e.job, e.mgr, e.hiredate,</span><br><span class=\"line\">          e.sal, e.comm, e.deptno, count(*) as cnt from v</span><br><span class=\"line\">          group by empno, ename, job, mgr, hiredate,</span><br><span class=\"line\">                   sal, comm, deptno) e</span><br><span class=\"line\">      where v.empno &#x3D; e.empno and </span><br><span class=\"line\">            v.ename &#x3D; e.ename and</span><br><span class=\"line\">            v.job &#x3D; e.job and</span><br><span class=\"line\">            v.mgr &#x3D; e.mgr and</span><br><span class=\"line\">            v.hiredate &#x3D; e.hiredate and</span><br><span class=\"line\">            v.sal &#x3D; e.sal and</span><br><span class=\"line\">            v.deptno &#x3D; e.deptno and</span><br><span class=\"line\">            v.cnt &#x3D; e.cnt and </span><br><span class=\"line\">            coalesce(v.comm, 0) &#x3D; coalesce(e.comm, 0)</span><br><span class=\"line\">   )  </span><br><span class=\"line\">)</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      \n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>Mysql PG  limit  offset  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select sal from emp order by sal limit 5 offset 0</span><br><span class=\"line\"></span><br><span class=\"line\">select sal from emp order by sal limit 5 offset 5 </span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p><br>Mod</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select x.name from (</span><br><span class=\"line\">   select a.ename , (</span><br><span class=\"line\">      select count(*) from emp b where</span><br><span class=\"line\">      b.ename &lt;&#x3D; a.ename</span><br><span class=\"line\">   ) as rn from emp a </span><br><span class=\"line\">) x where mod(rn,2) &#x3D; 1</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"OR\"   >\n          <a href=\"#OR\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>OR</h4>\n      <ol>\n<li>JoinOr<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select e.ename, d.deptno , d.dname, d.loc from dept d </span><br><span class=\"line\">left join emp e on (d.deptno &#x3D; e.deptno</span><br><span class=\"line\">                    and (e.deptno&#x3D;10 or e.deptno&#x3D;20))</span><br><span class=\"line\">order by 2 </span><br></pre></td></tr></table></div></figure></li>\n<li>Join</li>\n</ol>\n<p>select e.ename, d.deptno , d.dname, d.loc from dept d<br>left join (select * from emp e where e.deptno=10 or e.deptno=20)<br>on d.deptno = e.deptno order by 2 </p>\n\n        <h4 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h4>\n      <p>1 <br>2 1125  </p>\n<p>()</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select distinct v1.* from V v1, V v2 where</span><br><span class=\"line\">        v1.test1 &#x3D; v2.test2</span><br><span class=\"line\">        and v1.test2 &#x3D; v2.test1</span><br><span class=\"line\">        and v1.test1 &lt;&#x3D; v1.test2</span><br></pre></td></tr></table></div></figure>\n\n        <h4 id=\"N\"   >\n          <a href=\"#N\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>N</h4>\n      <p>RNK</p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">select ename, sal from (</span><br><span class=\"line\">   select (</span><br><span class=\"line\">      select (count(distinct b.sal) from emp b where </span><br><span class=\"line\">             a.sal &lt;&#x3D; b.sal) as rnk,</span><br><span class=\"line\">             a.sal,</span><br><span class=\"line\">             a.ename</span><br><span class=\"line\">   ) from emp a </span><br><span class=\"line\">) where rnk &lt;&#x3D;5</span><br></pre></td></tr></table></div></figure>\n\n\n\n        <h2 id=\"OrderBy\"   >\n          <a href=\"#OrderBy\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>OrderBy</h2>\n      \n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">select * from emp order by col2 asc;</span><br><span class=\"line\">&#x2F;&#x2F; </span><br><span class=\"line\">select * from emp order by col2 desc;</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select empno, deptno, sal, ename, job from emp order by deptno (asc), sal desc;</span><br></pre></td></tr></table></div></figure>\n\n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select ename, sal, job, comm from emp order by </span><br><span class=\"line\">       case when job &#x3D; &quot;salesman&quot; then comm</span><br><span class=\"line\">            else  sal </span><br><span class=\"line\">       end;</span><br></pre></td></tr></table></div></figure>\n\n\n        <h2 id=\"update\"   >\n          <a href=\"#update\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>update</h2>\n      \n        <h3 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h3>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">update table name set col_name &#x3D; xxx where $cond</span><br></pre></td></tr></table></div></figure>\n\n        <h2 id=\"delete\"   >\n          <a href=\"#delete\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>delete</h2>\n      <p>  </p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delete from table_name where $cond</span><br></pre></td></tr></table></div></figure>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delete from table where id not in (select min(id) from table group by name)</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"Having-amp-GroupBy\"   >\n          <a href=\"#Having-amp-GroupBy\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Having &amp; GroupBy</h1>\n      <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wiki</span><br><span class=\"line\">A HAVING clause in SQL specifies that an SQL SELECT statement should only return rows where aggregate values meet the specified conditions. It was added to the SQL language because the WHERE keyword could not be used with aggregate functions.</span><br><span class=\"line\">The HAVING clause filters the data on the group row but not on the individual row.</span><br><span class=\"line\">To view the present condition formed by the GROUP BY clause, the HAVING clause is used.</span><br></pre></td></tr></table></div></figure>\n<p>HavingGroupByWhereWhereSum()Count()Avg()   where sum(column_a) , HavingGroupRow</p>\n<p></p>\n<figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from table_a A group by columa_a having count (A.column_a ) &gt; 200</span><br></pre></td></tr></table></div></figure>\n\n        <h1 id=\"\"   >\n          <a href=\"#\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a></h1>\n      <ol>\n<li>Sum max min , avg select <figure class=\"highlight plain\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select max(Salary) as SecondHighestSalary from employee where salary&lt;(select max(distinct(salary)) from employee)</span><br></pre></td></tr></table></div></figure></li>\n<li>sql <br>if (expr1, expr2, expr3)<br>expr2expr3</li>\n</ol>\n\n        <h1 id=\"ShareNote\"   >\n          <a href=\"#ShareNote\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>ShareNote</h1>\n      <ol>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.codeproject.com/Articles/33052/Visual-Representation-of-SQL-Joins\" >Visual-Representation-of-SQL</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://en.wikipedia.org/wiki/Having_(SQL)\" >Having-Sql-Cluse-wiki</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://book.douban.com/subject/30259463/\" >Sql</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n<li><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.ituring.com.cn/book/miniarticle/47448\" >Sql</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></li>\n</ol>\n"},{"title":"Hello World","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","source":"_posts/hello-world.md","raw":"---\ntitle: Hello World\n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","slug":"hello-world","published":1,"date":"2021-01-22T02:45:15.113Z","updated":"2021-01-22T02:45:15.113Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk7orni80000c6i55f0k565k","content":"<p>Welcome to <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/\" >Hexo</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span>! This is your very first post. Check <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/\" >documentation</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/troubleshooting.html\" >troubleshooting</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span> or you can ask me on <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/hexojs/hexo/issues\" >GitHub</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span>.</p>\n\n        <h2 id=\"Quick-Start\"   >\n          <a href=\"#Quick-Start\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Quick Start</h2>\n      \n        <h3 id=\"Create-a-new-post\"   >\n          <a href=\"#Create-a-new-post\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Create a new post</h3>\n      <figure class=\"highlight bash\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></div></figure>\n<p>More info: <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/writing.html\" >Writing</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h3 id=\"Run-server\"   >\n          <a href=\"#Run-server\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Run server</h3>\n      <figure class=\"highlight bash\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></div></figure>\n<p>More info: <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/server.html\" >Server</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h3 id=\"Generate-static-files\"   >\n          <a href=\"#Generate-static-files\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Generate static files</h3>\n      <figure class=\"highlight bash\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></div></figure>\n<p>More info: <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/generating.html\" >Generating</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h3 id=\"Deploy-to-remote-sites\"   >\n          <a href=\"#Deploy-to-remote-sites\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Deploy to remote sites</h3>\n      <figure class=\"highlight bash\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></div></figure>\n<p>More info: <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/one-command-deployment.html\" >Deployment</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n","site":{"data":{}},"excerpt":"","more":"<p>Welcome to <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/\" >Hexo</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span>! This is your very first post. Check <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/\" >documentation</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/troubleshooting.html\" >troubleshooting</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span> or you can ask me on <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://github.com/hexojs/hexo/issues\" >GitHub</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span>.</p>\n\n        <h2 id=\"Quick-Start\"   >\n          <a href=\"#Quick-Start\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Quick Start</h2>\n      \n        <h3 id=\"Create-a-new-post\"   >\n          <a href=\"#Create-a-new-post\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Create a new post</h3>\n      <figure class=\"highlight bash\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></div></figure>\n<p>More info: <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/writing.html\" >Writing</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h3 id=\"Run-server\"   >\n          <a href=\"#Run-server\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Run server</h3>\n      <figure class=\"highlight bash\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></div></figure>\n<p>More info: <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/server.html\" >Server</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h3 id=\"Generate-static-files\"   >\n          <a href=\"#Generate-static-files\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Generate static files</h3>\n      <figure class=\"highlight bash\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></div></figure>\n<p>More info: <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/generating.html\" >Generating</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n\n        <h3 id=\"Deploy-to-remote-sites\"   >\n          <a href=\"#Deploy-to-remote-sites\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a>Deploy to remote sites</h3>\n      <figure class=\"highlight bash\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></div></figure>\n<p>More info: <span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://hexo.io/docs/one-command-deployment.html\" >Deployment</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n"},{"type":"categories","_content":"Golang  \nBackendDevelop\nDevops\nMonitorSystem\n","source":"_posts/categories/index.md","raw":"---\ntype: \"categories\"\n---\nGolang  \nBackendDevelop\nDevops\nMonitorSystem\n","slug":"categories/index","published":1,"date":"2021-01-22T02:48:08.211Z","updated":"2021-01-22T02:47:19.019Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk7ornib0001c6i55vecdobc","content":"<p>Golang<br>BackendDevelop<br>Devops<br>MonitorSystem</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Golang<br>BackendDevelop<br>Devops<br>MonitorSystem</p>\n"},{"type":"tags","_content":"","source":"_posts/tags/index.md","raw":"---\ntype: \"tags\"\n---\n","slug":"tags/index","published":1,"date":"2021-01-22T02:48:08.227Z","updated":"2021-01-22T02:47:19.031Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"ckk7ornib0002c6i58a1q806n","content":"","site":{"data":{}},"excerpt":"","more":""}],"PostAsset":[{"_id":"source/_posts/intro-distributed-system/SchdulerTimeJump.png","slug":"SchdulerTimeJump.png","post":"ckk6h2epk0004eci5cgca101l","modified":0,"renderable":0},{"_id":"source/_posts/intro-distributed-system/Time&EventMissmatch.png","slug":"Time&EventMissmatch.png","post":"ckk6h2epk0004eci5cgca101l","modified":0,"renderable":0},{"_id":"source/_posts/intro-distributed-system/TimeJump.png","slug":"TimeJump.png","post":"ckk6h2epk0004eci5cgca101l","modified":0,"renderable":0},{"_id":"source/_posts/intro-distributed-system/lockingproblem.png","slug":"lockingproblem.png","post":"ckk6h2epk0004eci5cgca101l","modified":0,"renderable":0},{"_id":"source/_posts/intro-distributed-system/lockingproblem2.png","slug":"lockingproblem2.png","post":"ckk6h2epk0004eci5cgca101l","modified":0,"renderable":0},{"_id":"source/_posts/distribute-system-consensus/LamportTimestamp.png","slug":"LamportTimestamp.png","post":"ckk6h2epk0003eci51vj6gdyl","modified":0,"renderable":0},{"_id":"source/_posts/distribute-system-consensus/generate-line.png","slug":"generate-line.png","post":"ckk6h2epk0003eci51vj6gdyl","modified":0,"renderable":0},{"_id":"source/_posts/distribute-system-consensus/line-final.png","slug":"line-final.png","post":"ckk6h2epk0003eci51vj6gdyl","modified":0,"renderable":0},{"_id":"source/_posts/distribute-system-consensus/more-detail-line.png","slug":"more-detail-line.png","post":"ckk6h2epk0003eci51vj6gdyl","modified":0,"renderable":0},{"_id":"source/_posts/distribute-system-consensus/non-linearized-example.png","slug":"non-linearized-example.png","post":"ckk6h2epk0003eci51vj6gdyl","modified":0,"renderable":0},{"_id":"source/_posts/distribute-system-consensus/quroum-fail.png","slug":"quroum-fail.png","post":"ckk6h2epk0003eci51vj6gdyl","modified":0,"renderable":0},{"_id":"source/_posts/raft-lab-2/RaftProcess.png","slug":"RaftProcess.png","post":"ckk6h2epb0000eci53tuy7iuk","modified":0,"renderable":0},{"_id":"source/_posts/raft-lab-2/RaftStateMachine.png","slug":"RaftStateMachine.png","post":"ckk6h2epb0000eci53tuy7iuk","modified":0,"renderable":0},{"_id":"source/_posts/go-slice/GoSlice.png","slug":"GoSlice.png","post":"ckk6irar50001k9i59fu05t2q","modified":0,"renderable":0},{"_id":"source/_posts/go-slice/GoSliceExtend.png","slug":"GoSliceExtend.png","post":"ckk6irar50001k9i59fu05t2q","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-scrape/ScrapeModule.png","slug":"ScrapeModule.png","post":"ckk6irard0006k9i5gsd7bfrr","modified":0,"renderable":0},{"_id":"source/_posts/raft-lab-3/Lab3-Process.png","slug":"Lab3-Process.png","post":"ckk6irarf000ak9i58ywe0055","modified":0,"renderable":0},{"_id":"source/_posts/raft-lab-4/lab4.png","slug":"lab4.png","post":"ckk6irarh000dk9i5944l19ix","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/FULL_OUTER_JOIN.png","slug":"FULL_OUTER_JOIN.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/INNER_JOIN.png","slug":"INNER_JOIN.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/LEFT_EXCLUDING_JOIN.png","slug":"LEFT_EXCLUDING_JOIN.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/LEFT_JOIN.png","slug":"LEFT_JOIN.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/OUTER_EXCLUDING_JOIN.png","slug":"OUTER_EXCLUDING_JOIN.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/RIGHT_EXCLUDING_JOIN.png","slug":"RIGHT_EXCLUDING_JOIN.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/RIGHT_JOIN.png","slug":"RIGHT_JOIN.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/Union-1.png","slug":"Union-1.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/Union-2.png","slug":"Union-2.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/Union-3.png","slug":"Union-3.png","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0},{"_id":"source/_posts/sql-revise/Visual_SQL_JOINS_orig.jpg","slug":"Visual_SQL_JOINS_orig.jpg","post":"ckk6iras3000nk9i5dse38iw3","modified":0,"renderable":0}],"PostCategory":[],"PostTag":[{"post_id":"ckk6h2epb0000eci53tuy7iuk","tag_id":"ckk6h2epf0001eci515jx2v09","_id":"ckk6h2epg0002eci50sji7mbp"},{"post_id":"ckk6h2epk0003eci51vj6gdyl","tag_id":"ckk6h2epf0001eci515jx2v09","_id":"ckk6h2epl0005eci5av1qg3g3"},{"post_id":"ckk6h2epk0004eci5cgca101l","tag_id":"ckk6h2epf0001eci515jx2v09","_id":"ckk6h2epl0006eci5duzvch6d"},{"post_id":"ckk6irar50001k9i59fu05t2q","tag_id":"ckk6irara0004k9i502oscp0w","_id":"ckk6irarf0009k9i5ap5b3w4o"},{"post_id":"ckk6irar90003k9i55pq9f6d4","tag_id":"ckk6irara0004k9i502oscp0w","_id":"ckk6irarg000ck9i5fkjf71cr"},{"post_id":"ckk6irarf000ak9i58ywe0055","tag_id":"ckk6h2epf0001eci515jx2v09","_id":"ckk6irarh000ek9i59yx417s1"},{"post_id":"ckk6irarh000dk9i5944l19ix","tag_id":"ckk6h2epf0001eci515jx2v09","_id":"ckk6irari000gk9i51fro0xms"},{"post_id":"ckk6irarc0005k9i5b6x757te","tag_id":"ckk6irarg000bk9i52szw42nk","_id":"ckk6irari000hk9i59kb8ctlm"},{"post_id":"ckk6irard0006k9i5gsd7bfrr","tag_id":"ckk6irarh000fk9i5eax6e036","_id":"ckk6irari000jk9i5h8o97uws"},{"post_id":"ckk6irard0007k9i54bt9hz6n","tag_id":"ckk6irarh000fk9i5eax6e036","_id":"ckk6irari000kk9i5e2yv3ls7"},{"post_id":"ckk6irarw000lk9i5fhb04215","tag_id":"ckk6irara0004k9i502oscp0w","_id":"ckk6irarw000mk9i55hpcdsue"},{"post_id":"ckk6iras3000nk9i5dse38iw3","tag_id":"ckk6iras4000ok9i58ztc974n","_id":"ckk6iras4000pk9i51w4848zg"}],"Tag":[{"name":"distributed-system","_id":"ckk6h2epf0001eci515jx2v09"},{"name":"Go","_id":"ckk6irara0004k9i502oscp0w"},{"name":"distributed-system, mit6.824","_id":"ckk6irarg000bk9i52szw42nk"},{"name":"Prometheus","_id":"ckk6irarh000fk9i5eax6e036"},{"name":"SQL","_id":"ckk6iras4000ok9i58ztc974n"}]}}